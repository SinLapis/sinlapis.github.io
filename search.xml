<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>使用redis+lettuce实现消息队列和生产消费</title>
      <link href="/2020/01/29/%E4%BD%BF%E7%94%A8redis-lettuce%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8C%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9/"/>
      <url>/2020/01/29/%E4%BD%BF%E7%94%A8redis-lettuce%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%92%8C%E7%94%9F%E4%BA%A7%E6%B6%88%E8%B4%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><h2 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h2><p>使用Docker部署redis</p><pre class=" language-shell"><code class="language-shell">docker run --name redis-mq -d -p 6379:6379 redis redis-server --appendonly yes</code></pre><h2 id="创建stream和group"><a href="#创建stream和group" class="headerlink" title="创建stream和group"></a>创建stream和group</h2><p>安装redis-cli</p><pre class=" language-shell"><code class="language-shell">apt install -y redis-cli</code></pre><p>进入redis-cli</p><pre class=" language-shell"><code class="language-shell">redis-cli -h localhost -p 6379</code></pre><p>创建空的stream和对应的group</p><pre><code>xgroup create testTask testGroup $ mkstream</code></pre><h1 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h1><h2 id="配置依赖"><a href="#配置依赖" class="headerlink" title="配置依赖"></a>配置依赖</h2><p>使用lettuce作为redis连接库</p><pre class=" language-kotlin"><code class="language-kotlin">dependencies <span class="token punctuation">{</span>    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token function">kotlin</span><span class="token punctuation">(</span><span class="token string">"stdlib-jdk8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token function">implementation</span><span class="token punctuation">(</span><span class="token string">"io.lettuce:lettuce-core:5.2.1.RELEASE"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h2 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h2><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> client <span class="token operator">=</span> RedisClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"redis://192.168.75.120:6379/0"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> connection <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> commands <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> consumer <span class="token operator">=</span> io<span class="token punctuation">.</span>lettuce<span class="token punctuation">.</span>core<span class="token punctuation">.</span>Consumer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"testGroup"</span><span class="token punctuation">,</span> <span class="token string">"testTask"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> content <span class="token operator">=</span> commands<span class="token punctuation">.</span><span class="token function">xreadgroup</span><span class="token punctuation">(</span>        consumer<span class="token punctuation">,</span> XReadArgs<span class="token punctuation">.</span>StreamOffset<span class="token punctuation">.</span><span class="token function">lastConsumed</span><span class="token punctuation">(</span><span class="token string">"testTask"</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span>    <span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>size<span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>c <span class="token keyword">in</span> content<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>k <span class="token keyword">in</span> c<span class="token punctuation">.</span>body<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"<span class="token interpolation variable">$k</span>: <span class="token interpolation"><span class="token delimiter variable">${</span>c<span class="token punctuation">.</span>body<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h2><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">val</span> client <span class="token operator">=</span> RedisClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"redis://192.168.75.120:6379/0"</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> connection <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> commands <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">val</span> body <span class="token operator">=</span> HashMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token keyword">in</span> <span class="token number">1</span><span class="token operator">..</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        body<span class="token punctuation">[</span>i<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"test"</span>    <span class="token punctuation">}</span>    commands<span class="token punctuation">.</span><span class="token function">xadd</span><span class="token punctuation">(</span><span class="token string">"testTask"</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> redis </tag>
            
            <tag> lettuce </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Gradle打包Kotlin代码以及所有依赖</title>
      <link href="/2020/01/14/%E4%BD%BF%E7%94%A8Gradle%E6%89%93%E5%8C%85Kotlin%E4%BB%A3%E7%A0%81%E4%BB%A5%E5%8F%8A%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96/"/>
      <url>/2020/01/14/%E4%BD%BF%E7%94%A8Gradle%E6%89%93%E5%8C%85Kotlin%E4%BB%A3%E7%A0%81%E4%BB%A5%E5%8F%8A%E6%89%80%E6%9C%89%E4%BE%9D%E8%B5%96/</url>
      
        <content type="html"><![CDATA[<p>使用插件<code>Shadow</code>进行打包。<code>build.gradle</code>如下：</p><pre class=" language-groovy"><code class="language-groovy">plugins <span class="token punctuation">{</span>    id <span class="token string">'org.jetbrains.kotlin.jvm'</span> version <span class="token string">'1.3.61'</span>    id <span class="token string">'com.github.johnrengelman.shadow'</span> version <span class="token string">'5.2.0'</span><span class="token punctuation">}</span>group <span class="token string">'org.example'</span>version <span class="token string">'1.0-SNAPSHOT'</span>repositories <span class="token punctuation">{</span>    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>dependencies <span class="token punctuation">{</span>    implementation <span class="token string">"org.jetbrains.kotlin:kotlin-stdlib-jdk8"</span>    implementation <span class="token string">"org.apache.kafka:kafka-clients:2.4.0"</span>    implementation <span class="token string">"org.apache.kafka:kafka-streams:2.4.0"</span>    implementation <span class="token string">"org.apache.logging.log4j:log4j-api:2.13.0"</span>    implementation <span class="token string">"org.apache.logging.log4j:log4j-core:2.13.0"</span>    implementation <span class="token string">"org.slf4j:slf4j-log4j12:1.7.30"</span><span class="token punctuation">}</span>compileKotlin <span class="token punctuation">{</span>    kotlinOptions<span class="token operator">.</span>jvmTarget <span class="token operator">=</span> <span class="token string">"1.8"</span><span class="token punctuation">}</span>compileTestKotlin <span class="token punctuation">{</span>    kotlinOptions<span class="token operator">.</span>jvmTarget <span class="token operator">=</span> <span class="token string">"1.8"</span><span class="token punctuation">}</span>jar <span class="token punctuation">{</span>    manifest <span class="token punctuation">{</span>        attributes <span class="token string">"Main-Class"</span><span class="token punctuation">:</span> <span class="token string">"org.example.testK8s.MainKt"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>之后执行下面的指令（或者在IDEA右侧的Gradle面板可以找到）进行打包：</p><pre class=" language-shell"><code class="language-shell">gradle shadowJar</code></pre>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gradle </tag>
            
            <tag> Kotlin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用Java/Kotlin等外部消费者无法消费Kafka消息</title>
      <link href="/2020/01/14/%E4%BD%BF%E7%94%A8Java-Kotlin%E7%AD%89%E5%A4%96%E9%83%A8%E6%B6%88%E8%B4%B9%E8%80%85%E6%97%A0%E6%B3%95%E6%B6%88%E8%B4%B9Kafka%E6%B6%88%E6%81%AF/"/>
      <url>/2020/01/14/%E4%BD%BF%E7%94%A8Java-Kotlin%E7%AD%89%E5%A4%96%E9%83%A8%E6%B6%88%E8%B4%B9%E8%80%85%E6%97%A0%E6%B3%95%E6%B6%88%E8%B4%B9Kafka%E6%B6%88%E6%81%AF/</url>
      
        <content type="html"><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>有一Kafka集群，在集群内机器上生产消费消息均正常，但是使用外部机器（未部署Kafka）无法消费。</p><h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>在Kafka配置<code>server.properties</code>中加入字段：</p><pre class=" language-properties"><code class="language-properties"><span class="token attr-name">port</span><span class="token punctuation">=</span><span class="token attr-value">9092</span><span class="token attr-name">advertised.host.name</span><span class="token punctuation">=</span><span class="token attr-value">192.168.226.10</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>使用K8s和Kafka实现工作队列的并行处理</title>
      <link href="/2020/01/10/%E4%BD%BF%E7%94%A8K8s%E5%92%8CKafka%E5%AE%9E%E7%8E%B0%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E7%9A%84%E5%B9%B6%E8%A1%8C%E5%A4%84%E7%90%86/"/>
      <url>/2020/01/10/%E4%BD%BF%E7%94%A8K8s%E5%92%8CKafka%E5%AE%9E%E7%8E%B0%E5%B7%A5%E4%BD%9C%E9%98%9F%E5%88%97%E7%9A%84%E5%B9%B6%E8%A1%8C%E5%A4%84%E7%90%86/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>使用K3s搭建Kubernetes集群</title>
      <link href="/2020/01/09/%E4%BD%BF%E7%94%A8K3s%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/"/>
      <url>/2020/01/09/%E4%BD%BF%E7%94%A8K3s%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/</url>
      
        <content type="html"><![CDATA[<h1 id="使用K3s搭建Kubernetes集群"><a href="#使用K3s搭建Kubernetes集群" class="headerlink" title="使用K3s搭建Kubernetes集群"></a>使用K3s搭建Kubernetes集群</h1><p>主要参考<a href="https://blog.ilemonrain.com/docker/rancher-with-k3s.html" target="_blank" rel="noopener">你的第一次轻量级K8S体验 —— 记一次Rancher 2.2 + K3S集成部署过程</a></p><p>需要至少2台机器。</p><p>当前各软件版本为：</p><table><thead><tr><th>软件名</th><th>版本</th></tr></thead><tbody><tr><td>Docker</td><td>18.09.9</td></tr><tr><td>K3s</td><td>v1.17.0+k3s.1</td></tr><tr><td>rancher</td><td>v2.3.3</td></tr></tbody></table><h2 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h2><p>直接参考<a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" target="_blank" rel="noopener">官方文档</a></p><blockquote><p>安装依赖使<code>apt</code>可以使用HTTPS的仓库</p><pre class=" language-shell"><code class="language-shell">apt install -y \    apt-transport-https \    ca-certificates \    curl \    gnupg-agent \    software-properties-common</code></pre><p>添加Docker官方的GPG密钥</p><pre class=" language-shell"><code class="language-shell">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</code></pre><p>添加Docker稳定版仓库</p><pre class=" language-shell"><code class="language-shell">add-apt-repository \   "deb [arch=amd64] https://download.docker.com/linux/ubuntu \   $(lsb_release -cs) \   stable"</code></pre><p>更新<code>apt</code>索引</p><pre class=" language-shell"><code class="language-shell">apt update</code></pre><p>安装Docker</p><pre class=" language-shell"><code class="language-shell">apt-get install -y docker-ce docker-ce-cli containerd.io</code></pre></blockquote><p>配置registry</p><pre class=" language-shell"><code class="language-shell">docker pull registry:2docker run -d -p 5000:5000 --restart=always --name registry \    -v /var/data:/var/lib/registry registry:2</code></pre><p>修改Docker配置<code>/etc/docker/daemon.json</code></p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>      <span class="token property">"insecure-registries"</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"192.168.226.11:5000"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><h2 id="rancher安装"><a href="#rancher安装" class="headerlink" title="rancher安装"></a>rancher安装</h2><p>选择一台安装rancher server，这台不安装k3s，好像会有冲突。</p><pre class=" language-shell"><code class="language-shell">docker run -d -v /data/docker/rancher-server/var/lib/rancher/:/var/lib/rancher/ --restart=unless-stopped --name rancher-server -p 80:80 -p 443:443 rancher/rancher:stable</code></pre><p>之后访问<code>http://192.168.226.10/</code>（改成自己的ip）进行初始化部署。设定密码和地址后，可选切换语言。</p><p>选择<code>添加集群 -&gt; 导入</code>，输入集群名，然后点击<code>创建</code>。保存最后一条指令，记得在<code>kubectl</code>前添加<code>k3s</code>。</p><h2 id="k3s安装"><a href="#k3s安装" class="headerlink" title="k3s安装"></a>k3s安装</h2><p>到<a href="https://github.com/rancher/k3s/releases" target="_blank" rel="noopener">k3s - Releases</a>下载<code>k3s</code>文件（约50MB的那个），上传至<code>/usr/local/bin/</code>，并执行下面指令</p><pre class=" language-shell"><code class="language-shell">chmod +x /usr/local/bin/k3s</code></pre><p>下载<code>pause</code>镜像</p><pre class=" language-shell"><code class="language-shell">docker pull kubernetes/pause:latestdocker tag kubernetes/pause:latest k8s.gcr.io/pause</code></pre><p>执行官方安装脚本</p><pre class=" language-shell"><code class="language-shell">curl -sfL https://get.k3s.io | sh -</code></pre><p>配置容器引擎使用Docker</p><pre class=" language-shell"><code class="language-shell">vim /etc/systemd/system/multi-user.target.wants/k3s.service</code></pre><p>在文件中<code>ExecStart</code>字段最后一个<code>\</code>后添加一行，并填入<code>--docker</code>，类似下面</p><pre class=" language-ini"><code class="language-ini"><span class="token constant">ExecStart</span><span class="token attr-value"><span class="token punctuation">=</span>/usr/local/bin/k3s \</span>    server \    --docker</code></pre><p>保存配置并重启<code>k3s</code></p><pre class=" language-shell"><code class="language-shell">systemctl daemon-reloadsystemctl restart k3s</code></pre><p>执行之前保存的指令，注意不要直接使用下面的样例，主机地址和<code>yaml</code>文件名要使用刚才生成的。</p><pre class=" language-shell"><code class="language-shell">curl --insecure -sfL https://192.168.226.11/v3/import/nb4hcqpzsvggwhcsfgpj5vjss8s2wsqbhv82d72s68hx8cf6gfzhsj.yaml | k3s kubectl apply -f -</code></pre><p>稍等一会界面就会出现节点状态。</p><h2 id="容器执行测试"><a href="#容器执行测试" class="headerlink" title="容器执行测试"></a>容器执行测试</h2><p>参考<a href="https://kubernetes.io/docs/tasks/job/automated-tasks-with-cron-jobs/" target="_blank" rel="noopener">Kubernetes官方文档</a></p><p>先准备一个镜像</p><pre class=" language-shell"><code class="language-shell">docker pull busyboxdocker tag busybox:latest 192.168.226.11:5000/busybox:latestdocker push 192.168.226.11:5000/busybox:latest</code></pre><p>假设现在我们从私有仓库拉取一个镜像并执行。</p><p>创建<code>job.yaml</code>文件</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"*/1 * * * *"</span>  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">template</span><span class="token punctuation">:</span>        <span class="token key atrule">spec</span><span class="token punctuation">:</span>          <span class="token key atrule">containers</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello            <span class="token key atrule">image</span><span class="token punctuation">:</span> 192.168.226.11<span class="token punctuation">:</span>5000/busybox            <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /bin/sh            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c            <span class="token punctuation">-</span> date; echo Hello from the Kubernetes cluster          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure</code></pre><p>创建<code>Job</code></p><pre class=" language-shell"><code class="language-shell">k3s kubectl create -f job.yaml</code></pre><p>查看<code>Job</code>状态</p><pre class=" language-shell"><code class="language-shell">kubectl get cronjob hello</code></pre><p>查看<code>Job</code>创建的<code>Pod</code></p><pre class=" language-shell"><code class="language-shell">kubectl get jobs</code></pre><p>选择上面的一个已完成的<code>pod</code>的id，例如<code>hello-1578545280</code>。获取这个<code>pod</code>的输出</p><pre class=" language-shell"><code class="language-shell">pods=$(kubectl get pods --selector=job-name=hello-1578545280 --output=jsonpath={.items[*].metadata.name})kubectl logs $pods</code></pre><h2 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h2><p>新节点同样先安装Docker。安装k3s按如下步骤。</p><p>查看主节点的<code>node-token</code></p><pre class=" language-shell"><code class="language-shell">cat /var/lib/rancher/k3s/server/node-token</code></pre><p>在新节点上安装并启动为普通节点，注意ip地址和token改成自己的。</p><pre class=" language-shell"><code class="language-shell">curl -sfL https://get.k3s.io | K3S_URL=https://192.168.226.11:6443 K3S_TOKEN=K105933dce21eca704fb3913c26976e0c13c36878fc0c846a0780915c12fccdd78e::server:1a8e2a73e1247868ccb5b3ce0b3cbc7e sh -</code></pre><p>同样需要配置容器引擎使用Docker</p><pre class=" language-shell"><code class="language-shell">vim /etc/systemd/system/multi-user.target.wants/k3s-agent.service </code></pre><p>修改方式和主节点一样，然后重启<code>k3s-agent</code>，在<code>rancher</code>界面即可看到新加入的节点。</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> k8s </tag>
            
            <tag> docker </tag>
            
            <tag> k3s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>microk8s部署多节点k8s集群</title>
      <link href="/2019/12/31/microk8s%E9%83%A8%E7%BD%B2%E5%A4%9A%E8%8A%82%E7%82%B9k8s%E9%9B%86%E7%BE%A4/"/>
      <url>/2019/12/31/microk8s%E9%83%A8%E7%BD%B2%E5%A4%9A%E8%8A%82%E7%82%B9k8s%E9%9B%86%E7%BE%A4/</url>
      
        <content type="html"><![CDATA[<h1 id="microk8s部署多节点Kubernetes集群"><a href="#microk8s部署多节点Kubernetes集群" class="headerlink" title="microk8s部署多节点Kubernetes集群"></a>microk8s部署多节点Kubernetes集群</h1><p>为了增加工作量，想上一个k8s。microk8s安装简单还支持多节点，就选它了。</p><h2 id="准备和安装"><a href="#准备和安装" class="headerlink" title="准备和安装"></a>准备和安装</h2><p>snap没有换源一说，只能设置代理。</p><p>先设置<code>systemd editor</code>的默认编辑器为<code>vim</code></p><pre class=" language-shell"><code class="language-shell">vim /etc/profile</code></pre><p>加入以下内容</p><pre class=" language-shell"><code class="language-shell">export SYSTEMD_EDITOR="/usr/bin/vim"</code></pre><p>使设置生效</p><pre class=" language-shell"><code class="language-shell">source /etc/profile</code></pre><p>配置snapd</p><pre class=" language-shell"><code class="language-shell">systemctl edit snapd</code></pre><p>加入以下内容</p><pre class=" language-ini"><code class="language-ini"><span class="token selector">[Service]</span><span class="token constant">Environment</span><span class="token attr-value"><span class="token punctuation">=</span>"http_proxy=http://127.0.0.1:1080"</span><span class="token constant">Environment</span><span class="token attr-value"><span class="token punctuation">=</span>"https_proxy=http://127.0.0.1:1080"</span></code></pre><p>配置生效</p><pre class=" language-shell"><code class="language-shell">systemctl daemon-reloadsystemctl restart snapd</code></pre><p>安装microk8s</p><pre class=" language-shell"><code class="language-shell">snap install microk8s --classic</code></pre><p>查看组件状态</p><pre class=" language-shell"><code class="language-shell">> microk8s.statusmicrok8s is runningaddons:cilium: disableddashboard: disableddns: disabledfluentd: disabledgpu: disabledhelm: disabledingress: disabledistio: disabledjaeger: disabledjuju: disabledknative: disabledkubeflow: disabledlinkerd: disabledmetallb: disabledmetrics-server: disabledprometheus: disabledrbac: disabledregistry: disabledstorage: disabled</code></pre><h2 id="构建多节点集群"><a href="#构建多节点集群" class="headerlink" title="构建多节点集群"></a>构建多节点集群</h2><p>在一台机器上执行</p><pre class=" language-shell"><code class="language-shell">microk8s.add-node</code></pre><p>会出现以下内容</p><pre><code>Join node with: microk8s.join ip-172-31-20-243:25000/DDOkUupkmaBezNnMheTBqFYHLWINGDbf</code></pre><p>复制<code>join</code>指令到其它已经安装了microk8s的机器上执行。</p><p>查看集群内节点</p><pre class=" language-shell"><code class="language-shell">> microk8s.kubectl get no10.22.254.79       Ready    <none>   27s   v1.15.3ip-172-31-20-243   Ready    <none>   53s   v1.15.3</code></pre>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> k8s </tag>
            
            <tag> docker </tag>
            
            <tag> microk8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kotlin+puppeteer写爬虫</title>
      <link href="/2019/12/11/kotlin-puppeteer%E5%86%99%E7%88%AC%E8%99%AB/"/>
      <url>/2019/12/11/kotlin-puppeteer%E5%86%99%E7%88%AC%E8%99%AB/</url>
      
        <content type="html"><![CDATA[<h1 id="kotlin-puppeteer写爬虫"><a href="#kotlin-puppeteer写爬虫" class="headerlink" title="kotlin + puppeteer写爬虫"></a>kotlin + puppeteer写爬虫</h1><p>环境搞的很郁闷，这个代码倒是简单解决了，多亏了一位日本老哥。</p><p>主要参考：<a href="https://qiita.com/numa08/items/214c6c9d06d5094add3a" target="_blank" rel="noopener">バックグラウンドで使うpuppeteer with Kotlin</a></p><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>build.gradle中添加：</p><pre class=" language-groovy"><code class="language-groovy">dependencies <span class="token punctuation">{</span>    implementation <span class="token string">'org.jetbrains.kotlinx:kotlinx-coroutines-core-js:1.1.1'</span><span class="token punctuation">}</span></code></pre><h2 id="让kotlin使用async-await"><a href="#让kotlin使用async-await" class="headerlink" title="让kotlin使用async/await"></a>让kotlin使用async/await</h2><p>接口有变动，参考中代码部分失效。</p><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span><span class="token operator">*</span><span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>js<span class="token punctuation">.</span>Promisesuspend <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> Promise<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token operator">=</span> suspendCoroutine <span class="token punctuation">{</span> cont <span class="token operator">-></span>    <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">{</span> cont<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cont<span class="token punctuation">.</span><span class="token function">resumeWithException</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">async</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token function">suspend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Promise <span class="token punctuation">{</span> resolve<span class="token punctuation">,</span> reject <span class="token operator">-></span>        x<span class="token punctuation">.</span><span class="token function">startCoroutine</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">override</span> <span class="token keyword">val</span> context <span class="token operator">=</span> EmptyCoroutineContext            <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">resumeWith</span><span class="token punctuation">(</span>result<span class="token operator">:</span> Result<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>isSuccess<span class="token punctuation">)</span>                    <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">)</span>                <span class="token keyword">else</span>                    <span class="token function">reject</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">exceptionOrNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">!!</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="封装puppeteer接口"><a href="#封装puppeteer接口" class="headerlink" title="封装puppeteer接口"></a>封装puppeteer接口</h2><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">import</span> kotlin<span class="token punctuation">.</span>js<span class="token punctuation">.</span>Promise<span class="token annotation builtin">@Suppress</span><span class="token punctuation">(</span><span class="token string">"FunctionName"</span><span class="token punctuation">)</span><span class="token annotation builtin">@JsModule</span><span class="token punctuation">(</span><span class="token string">"puppeteer"</span><span class="token punctuation">)</span>external <span class="token keyword">object</span> Puppeteer <span class="token punctuation">{</span>    <span class="token keyword">class</span> Page <span class="token punctuation">{</span>        <span class="token keyword">fun</span> <span class="token function">goto</span><span class="token punctuation">(</span>url<span class="token operator">:</span> String<span class="token punctuation">,</span> options<span class="token operator">:</span> dynamic<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">waitFor</span><span class="token punctuation">(</span>element<span class="token operator">:</span> String<span class="token punctuation">,</span> options<span class="token operator">:</span> dynamic<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">waitFor</span><span class="token punctuation">(</span>num<span class="token operator">:</span> Int<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">click</span><span class="token punctuation">(</span>selector<span class="token operator">:</span> dynamic<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>pageFunction<span class="token operator">:</span> Function<span class="token operator">&lt;</span>dynamic<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>    <span class="token punctuation">}</span>    <span class="token keyword">class</span> Browser <span class="token punctuation">{</span>        <span class="token keyword">fun</span> <span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Page<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>dynamic<span class="token operator">></span>        <span class="token keyword">fun</span> <span class="token function">wsEndpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> String    <span class="token punctuation">}</span>    <span class="token keyword">fun</span> <span class="token function">launch</span><span class="token punctuation">(</span>options<span class="token operator">:</span> dynamic<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>Browser<span class="token operator">></span><span class="token punctuation">}</span></code></pre><h2 id="爬虫代码"><a href="#爬虫代码" class="headerlink" title="爬虫代码"></a>爬虫代码</h2><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    async <span class="token punctuation">{</span>        <span class="token keyword">val</span> browser <span class="token operator">=</span> Puppeteer<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> it<span class="token operator">:</span> dynamic <span class="token operator">-></span>            it<span class="token punctuation">.</span>devtools <span class="token operator">=</span> <span class="token boolean">true</span>            it<span class="token punctuation">.</span>args <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">"--no-sandbox"</span><span class="token punctuation">,</span> <span class="token string">"--disable-setuid-sandbox"</span><span class="token punctuation">)</span>            it<span class="token punctuation">.</span>headless <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">val</span> page <span class="token operator">=</span> browser<span class="token punctuation">.</span><span class="token function">newPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            page<span class="token punctuation">.</span><span class="token function">goto</span><span class="token punctuation">(</span><span class="token string">"http://www.baidu.com"</span><span class="token punctuation">,</span> <span class="token keyword">object</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{</span> it<span class="token operator">:</span> dynamic <span class="token operator">-></span> it<span class="token punctuation">.</span>timeout <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            page<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">val</span> content <span class="token operator">=</span> page<span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token function">println</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            browser<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>注意<code>it.headless = true</code>为开启Chrome的Headless模式，需要显示界面调试置为<code>false</code>即可。</p>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> 爬虫 </tag>
            
            <tag> puppeteer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kotlin+nodejs+idea+gradle项目构建</title>
      <link href="/2019/12/11/kotlin-nodejs-idea-gradle%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/"/>
      <url>/2019/12/11/kotlin-nodejs-idea-gradle%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="kotlin-nodejs-idea-gradle项目构建"><a href="#kotlin-nodejs-idea-gradle项目构建" class="headerlink" title="kotlin + nodejs + idea + gradle项目构建"></a>kotlin + nodejs + idea + gradle项目构建</h1><p>kotlin转nodejs的插件只能用gradle，maven虽然也有但是不会用。这玩意我居然搞了一天才看到”Hello, JavaScript!”，人老了。</p><p>主要参考：<a href="https://www.bennyhuo.com/2019/03/11/kotlin-nodejs/" target="_blank" rel="noopener">基于 Node.js 环境的 KotlinJs 工程的完美搭建</a>。</p><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><p>现在nodejs已经是IDEA中自带插件了，不再需要手动安装。直接创建项目，选gradle -&gt; kotlin(JavaScript)。</p><p>之后需要等IDEA将项目配置完毕。</p><h2 id="配置build-gradle"><a href="#配置build-gradle" class="headerlink" title="配置build.gradle"></a>配置build.gradle</h2><pre class=" language-groovy"><code class="language-groovy">group <span class="token string">'org.ndp'</span>version <span class="token string">'1'</span>buildscript <span class="token punctuation">{</span>    ext<span class="token operator">.</span>kotlin_version <span class="token operator">=</span> <span class="token string">'1.3.60'</span>    repositories <span class="token punctuation">{</span>        <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    dependencies <span class="token punctuation">{</span>        classpath <span class="token string">"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>apply plugin<span class="token punctuation">:</span> <span class="token string">'kotlin2js'</span>buildscript <span class="token punctuation">{</span>    repositories <span class="token punctuation">{</span>        maven <span class="token punctuation">{</span>            url <span class="token string">"https://dl.bintray.com/kotlin/kotlin-eap"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    dependencies <span class="token punctuation">{</span>        classpath <span class="token string">"org.jetbrains.kotlin:kotlin-frontend-plugin:0.0.45"</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>apply plugin<span class="token punctuation">:</span> <span class="token string">'org.jetbrains.kotlin.frontend'</span>repositories <span class="token punctuation">{</span>    <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>dependencies <span class="token punctuation">{</span>    compile <span class="token string">"org.jetbrains.kotlin:kotlin-stdlib-js:$kotlin_version"</span><span class="token punctuation">}</span>compileKotlin2Js <span class="token punctuation">{</span>    kotlinOptions<span class="token operator">.</span>moduleKind <span class="token operator">=</span> <span class="token string">"commonjs"</span>    kotlinOptions<span class="token operator">.</span>sourceMap <span class="token operator">=</span> <span class="token boolean">true</span>    kotlinOptions<span class="token operator">.</span>metaInfo <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">}</span>kotlinFrontend <span class="token punctuation">{</span>    npm <span class="token punctuation">{</span>        devDependency <span class="token string">"karma"</span>     <span class="token comment" spellcheck="true">// development dependency</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>之后需要静待gradle配置好，时间比较长。</p><p>不要在<code>compileKotlin2Js</code>中设置输出目录，会导致<code>Error: Cannot find module &#39;kotlin&#39;</code>。</p><h2 id="编写Kotlin"><a href="#编写Kotlin" class="headerlink" title="编写Kotlin"></a>编写Kotlin</h2><p>在<code>src/main/kotlin/</code>下新建kt文件：</p><pre class=" language-kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello JavaScript!"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><p>点击<code>main</code>旁边的运行即可看到结果。</p>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idea </tag>
            
            <tag> gradle </tag>
            
            <tag> nodejs </tag>
            
            <tag> kotlin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>maven的kotlin项目打包以及添加kotlin依赖</title>
      <link href="/2019/12/02/maven%E7%9A%84kotlin%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E4%BB%A5%E5%8F%8A%E6%B7%BB%E5%8A%A0kotlin%E4%BE%9D%E8%B5%96/"/>
      <url>/2019/12/02/maven%E7%9A%84kotlin%E9%A1%B9%E7%9B%AE%E6%89%93%E5%8C%85%E4%BB%A5%E5%8F%8A%E6%B7%BB%E5%8A%A0kotlin%E4%BE%9D%E8%B5%96/</url>
      
        <content type="html"><![CDATA[<h1 id="maven的kotlin项目打包以及添加kotlin依赖"><a href="#maven的kotlin项目打包以及添加kotlin依赖" class="headerlink" title="maven的kotlin项目打包以及添加kotlin依赖"></a>maven的kotlin项目打包以及添加kotlin依赖</h1><p>准备了一个纯jre的docker镜像，想运行kotlin的jar包，结果找了一圈还是在官网找到了解决办法。</p><h2 id="不包含kotlin依赖"><a href="#不包含kotlin依赖" class="headerlink" title="不包含kotlin依赖"></a>不包含kotlin依赖</h2><p>在<code>pom.xml</code>中<code>build -&gt; plugins</code>中添加</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-jar-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>addClasspath</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>addClasspath</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">></span></span>${main.class}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></code></pre><h2 id="包含kotlin依赖"><a href="#包含kotlin依赖" class="headerlink" title="包含kotlin依赖"></a>包含kotlin依赖</h2><p>在<code>pom.xml</code>中<code>build -&gt; plugins</code>中添加</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">></span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">></span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mainClass</span><span class="token punctuation">></span></span>${main.class}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mainClass</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">></span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 杂项 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kotlin </tag>
            
            <tag> maven </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>React0x00</title>
      <link href="/2019/10/28/React0x00/"/>
      <url>/2019/10/28/React0x00/</url>
      
        <content type="html"><![CDATA[<h1 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello, world!"></a>Hello, world!</h1><p>创建项目直接使用Webstorm，选择React App。然后执行：</p><pre class=" language-shell"><code class="language-shell">react-scripts eject</code></pre><p>清空<code>src</code>中的文件，重新建立文件<code>index.js</code>，即React入口， 输入：</p><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">,</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>render</code>的第一个参数为jsx，可以理解为React的元素，可以作为js变量的值。</p><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token keyword">const</span> ele <span class="token operator">=</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> world<span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>    ele<span class="token punctuation">,</span>    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1 id="创建组件"><a href="#创建组件" class="headerlink" title="创建组件"></a>创建组件</h1><h2 id="箭头函数"><a href="#箭头函数" class="headerlink" title="箭头函数"></a>箭头函数</h2><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token keyword">const</span> Ele <span class="token operator">=</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>Hello<span class="token punctuation">,</span> <span class="token punctuation">{</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token operator">!</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">}</span><span class="token punctuation">;</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Ele</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>React<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span class="token punctuation">,</span>    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token keyword">class</span> <span class="token class-name">Ele</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span><span class="token keyword">class</span> <span class="token class-name">app</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Ele</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>arg<span class="token punctuation">"</span>/</span><span class="token punctuation">></span></span><span class="token punctuation">,</span>    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="组件嵌套"><a href="#组件嵌套" class="headerlink" title="组件嵌套"></a>组件嵌套</h3><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">import</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token keyword">import</span> ReactDOM <span class="token keyword">from</span> <span class="token string">'react-dom'</span><span class="token keyword">const</span> Title <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>app title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span><span class="token keyword">class</span> <span class="token class-name">Ele</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Title</span> <span class="token punctuation">/></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>        <span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>ReactDOM<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Ele</span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>test</span> <span class="token attr-name">arg"</span><span class="token punctuation">/></span></span><span class="token punctuation">,</span>    document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#root'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1 id="组件样式"><a href="#组件样式" class="headerlink" title="组件样式"></a>组件样式</h1><h2 id="使用js"><a href="#使用js" class="headerlink" title="使用js"></a>使用js</h2><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">const</span> Title <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">style</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">{</span>color<span class="token punctuation">:</span> <span class="token string">'#0099ff'</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>app title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code></pre><h2 id="使用class"><a href="#使用class" class="headerlink" title="使用class"></a>使用class</h2><pre class=" language-css"><code class="language-css"><span class="token selector"><span class="token class">.blue-title</span> </span><span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#0099ff</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token string">'./index.css'</span><span class="token keyword">const</span> Title <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>blue-title<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>app title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code></pre><h2 id="使用第三方库classnames"><a href="#使用第三方库classnames" class="headerlink" title="使用第三方库classnames"></a>使用第三方库classnames</h2><p>安装。</p><pre class=" language-shell"><code class="language-shell">npm i -D classnames</code></pre><pre class=" language-css"><code class="language-css"><span class="token selector"><span class="token class">.blue-title</span> </span><span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#0099ff</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.red-title</span> </span><span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#ff6666</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector"><span class="token class">.bg</span> </span><span class="token punctuation">{</span>    <span class="token property">background-color</span><span class="token punctuation">:</span> antiquewhite<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-jsx"><code class="language-jsx"><span class="token keyword">import</span> <span class="token string">'./index.css'</span><span class="token keyword">import</span> classNames <span class="token keyword">from</span> <span class="token string">'classnames'</span><span class="token keyword">const</span> Title <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">className</span><span class="token script language-javascript"><span class="token punctuation">=</span><span class="token punctuation">{</span><span class="token function">classNames</span><span class="token punctuation">(</span><span class="token string">'bg'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'blue-title'</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">'red-title'</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">></span></span>app title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> React </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
            <tag> React </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>less基础</title>
      <link href="/2019/10/23/less%E5%9F%BA%E7%A1%80/"/>
      <url>/2019/10/23/less%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="less基础"><a href="#less基础" class="headerlink" title="less基础"></a>less基础</h1><p>再摸一个less。</p><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>使用node.js中less编译。</p><pre><code>npm i -D less</code></pre><pre><code>lessc test.less test.css</code></pre><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p><code>//</code>不会出现在css文件中，<code>/* */</code>会。</p><h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>支持选择器、属性和属性值。选择器和属性在引用时要使用<code>{}</code>，但一般只使用值作为变量。</p><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token variable">@attr<span class="token punctuation">:</span></span> color<span class="token punctuation">;</span><span class="token variable">@selector<span class="token punctuation">:</span></span> body<span class="token punctuation">;</span><span class="token selector">@{selector}</span> <span class="token punctuation">{</span>  <span class="token property">@{attr}</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>less中变量的作用域是块级，并且会延迟加载，即会在块执行完毕后才看变量值。</p><h2 id="嵌套"><a href="#嵌套" class="headerlink" title="嵌套"></a>嵌套</h2><p>less可以实现类似html中的嵌套。</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zh<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>&lt;%= htmlWebpackPlugin.options.title %><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    outer    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>test word.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>green<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>hello, world!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span>  <span class="token selector">h1</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">.green</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> aqua<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>设置元素状态时需要修正嵌套级别。</p><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span>  <span class="token selector">h1</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">.green</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> aqua<span class="token punctuation">;</span>    <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>      <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#66cccc</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="混合"><a href="#混合" class="headerlink" title="混合"></a>混合</h2><p>可以理解为less的方法？</p><p>可以省去大段重复css代码。</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zh<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>&lt;%= htmlWebpackPlugin.options.title %><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    outer    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text1<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>test word.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>hello, world!<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token selector">.textHover</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> aqua<span class="token punctuation">;</span>  <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#66cccc</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span>  <span class="token selector">h1</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text1, #text2</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>混合的css会输出到编译后的css文件里，会有重复，可以使用如下的方式来避免。</p><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token selector">.textHover()</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> aqua<span class="token punctuation">;</span>  <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token hexcode">#66cccc</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span>  <span class="token selector">h1</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text1, #text2</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>混合可以带有参数。</p><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token selector">.textHover(<span class="token variable">@origin</span>, <span class="token variable">@hover</span>)</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@origin</span><span class="token punctuation">;</span>  <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@hover</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span>  <span class="token selector">h1</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text1</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">(</span>aqua<span class="token punctuation">,</span> <span class="token hexcode">#44cccc</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text2</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">(</span>pink<span class="token punctuation">,</span> <span class="token hexcode">#dda0ba</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>混合中参数可以有默认值。</p><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token selector">.textHover(<span class="token variable">@origin</span>: aqua, <span class="token variable">@hover</span>: #44cccc)</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@origin</span><span class="token punctuation">;</span>  <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@hover</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span>  <span class="token selector">h1</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text1</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text2</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">(</span>pink<span class="token punctuation">,</span> <span class="token hexcode">#dda0ba</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>参数有默认值时可以指定部分参数。</p>]]></content>
      
      
      <categories>
          
          <category> less </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
            <tag> less </tag>
            
            <tag> css </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Webpack配置</title>
      <link href="/2019/10/22/Webpack%E9%85%8D%E7%BD%AE/"/>
      <url>/2019/10/22/Webpack%E9%85%8D%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="Webpack配置"><a href="#Webpack配置" class="headerlink" title="Webpack配置"></a>Webpack配置</h1><p>Kotlin看不动了，摸鱼学学前端。</p><p>先安装node.js和npm，此处略。</p><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>初始化package描述文件，在项目路径中生成<code>package.json</code>文件。</p><pre class=" language-shell"><code class="language-shell">npm init</code></pre><p>或者使用<code>npm init --yes</code>省去中间配置步骤。</p><h2 id="安装Webpack"><a href="#安装Webpack" class="headerlink" title="安装Webpack"></a>安装Webpack</h2><pre class=" language-shell"><code class="language-shell">npm i webpack webpack-cli -D</code></pre><blockquote><p>–save-dev(-D)参数意思是把模块版本信息保存到devDependencies（开发环境依赖）中，即package.json的devDependencies字段中</p></blockquote><h2 id="配置build启动脚本"><a href="#配置build启动脚本" class="headerlink" title="配置build启动脚本"></a>配置build启动脚本</h2><p>在<code>package.json</code>中，对<code>scripts</code>添加<code>build</code>字段：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"webpack --mode production"</span><span class="token punctuation">,</span>    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>此外在项目目录中新建文件夹<code>src</code>作为源码目录，在<code>src</code>中新建文件<code>index.js</code>作为程序入口，内容随便写点。</p><p>此时可以测试能否build成功：</p><pre class=" language-shell"><code class="language-shell">npm run build</code></pre><p>项目目录中会出现一个<code>dist</code>文件夹，里面有一个<code>main.js</code>，即转换生成的js文件。</p><h2 id="使用webpack-config-js"><a href="#使用webpack-config-js" class="headerlink" title="使用webpack.config.js"></a>使用webpack.config.js</h2><p>可以使用<code>webpack.config.js</code>来自定义<code>build</code>的入口和出口。该文件可以使用<code>node.js</code>的模块。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"dist"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'output.js'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><code>require</code>是<code>node.js</code>引入模块的方法。此处引入的<code>path</code>是用于处理操作系统中文件路径的模块。<code>path.resolve()</code>方法将路径转换为绝对路径。<code>__dirname</code>为当前执行文件所在目录的完整目录名。</p><p>如果需要有多个入口和多个出口，可以如下配置：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>        about<span class="token punctuation">:</span> <span class="token string">'./src/about.js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">"dist"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>output</code>可以省略，生成的文件名使用<code>entry</code>中对应的<code>key</code>值。<code>[name]</code>是由<code>webpack</code>自动填充的字段。还可以使用<code>[hash]</code>、<code>[chunkHash]</code>来生成hash值。</p><p><code>webpack.config.js</code>的位置也是可配置的，需要修改<code>package.json - scripts - build</code>字段</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>   <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"webpack --mode production --config scripts/webpack.config.js"</span><span class="token punctuation">,</span>    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>此时<code>webpack</code>的当前路径变为<code>./scripts/</code>，因此还需要修改<code>webpack.config.js</code>。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>        about<span class="token punctuation">:</span> <span class="token string">'./src/about.js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>或者</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>        about<span class="token punctuation">:</span> <span class="token string">'./src/about.js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dist"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>process.cwd()</code>为获得当前执行node命令时候的文件夹目录名。</p><h2 id="自动生成html"><a href="#自动生成html" class="headerlink" title="自动生成html"></a>自动生成html</h2><p>如果生成js使用了hash值作为文件名，那么对应的html也需要自动生成。安装插件<code>html-webpack-plugin</code>。</p><pre class=" language-shell"><code class="language-shell">npm i -D html-webpack-plugin</code></pre><p>在<code>webpack.config.js</code>中加入插件：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 引入模块</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// 引入插件</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>进行<code>npm run build</code>，在<code>dist</code>中生成了<code>index.html</code>，其中使用的js文件是打包的js文件。</p><h2 id="html模版"><a href="#html模版" class="headerlink" title="html模版"></a>html模版</h2><p>使用html模版则需要在项目目录中建立<code>public</code>文件夹，在其中建立<code>home.html</code>，如下：</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zh<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>自动生成模版<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>修改<code>webpack.config.js</code>，为插件添加配置：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>                template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>可以使用模版语法来定制生成的html。</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zh<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>&lt;%= htmlWebpackPlugin.options.title %><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><p>再次打包则生成的html如下：</p><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>zh<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>模版测试<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>main.299861a9.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre><h2 id="css"><a href="#css" class="headerlink" title="css"></a>css</h2><p>安装<code>style-loader</code>和<code>css-loader</code>。<code>style-loader</code>用于插入css到js里。<code>css-loader</code>用于处理css。</p><pre class=" language-shell"><code class="language-shell">npm i -D style-loader css-loader</code></pre><p>修改<code>webpack.config.js</code>，添加loader：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'style-loader'</span><span class="token punctuation">,</span> <span class="token string">'css-loader'</span> <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>                title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>                template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p><code>loader</code>的执行顺序从后向前。</p><p>在js文件中引入css。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token string">'./main.css'</span><span class="token punctuation">;</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>此时进行打包，css会进入js并在执行的时候生效。</p><p>如果希望提取css到单独文件，则需要安装<code>mini-css-extract-plugin</code>插件。</p><pre class=" language-shell"><code class="language-shell">npm i -D mini-css-extract-plugin</code></pre><p>修改<code>webpack.config.js</code>，加入该插件的配置，修改位置已标出。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// [1]</span><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mini-css-extract-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">// [2]</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span> <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>            template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// [3]</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            filename<span class="token punctuation">:</span> <span class="token string">'[name].css'</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>进行打包时css文件会单独到处，并在html中引入。</p><h2 id="构建导出目录结构"><a href="#构建导出目录结构" class="headerlink" title="构建导出目录结构"></a>构建导出目录结构</h2><p>修改<code>webpack.config.js</code>，直接在导出部分添加路径即可。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mini-css-extract-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// [1]</span>        filename<span class="token punctuation">:</span> <span class="token string">'js/[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span> <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>            template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// [2]</span>            filename<span class="token punctuation">:</span> <span class="token string">'css/[name].[chunkHash:8].css'</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="配置开发服务器"><a href="#配置开发服务器" class="headerlink" title="配置开发服务器"></a>配置开发服务器</h2><p>安装插件<code>webpack-dev-server</code>。</p><pre class=" language-shell"><code class="language-shell">npm i -D webpack-dev-server</code></pre><p>修改<code>package.json</code>，添加<code>dev</code>命令。</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"test-react-2"</span><span class="token punctuation">,</span>  <span class="token property">"version"</span><span class="token operator">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>  <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token property">"main"</span><span class="token operator">:</span> <span class="token string">"index.js"</span><span class="token punctuation">,</span>  <span class="token property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"build"</span><span class="token operator">:</span> <span class="token string">"webpack --mode production --config scripts/webpack.config.js"</span><span class="token punctuation">,</span>    <span class="token property">"dev"</span><span class="token operator">:</span> <span class="token string">"webpack-dev-server --mode development --config scripts/webpack.config.js"</span><span class="token punctuation">,</span>    <span class="token property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>  <span class="token property">"license"</span><span class="token operator">:</span> <span class="token string">"ISC"</span><span class="token punctuation">,</span>  <span class="token property">"devDependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"css-loader"</span><span class="token operator">:</span> <span class="token string">"^3.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"html-webpack-plugin"</span><span class="token operator">:</span> <span class="token string">"^3.2.0"</span><span class="token punctuation">,</span>    <span class="token property">"mini-css-extract-plugin"</span><span class="token operator">:</span> <span class="token string">"^0.8.0"</span><span class="token punctuation">,</span>    <span class="token property">"style-loader"</span><span class="token operator">:</span> <span class="token string">"^1.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"webpack"</span><span class="token operator">:</span> <span class="token string">"^4.41.2"</span><span class="token punctuation">,</span>    <span class="token property">"webpack-cli"</span><span class="token operator">:</span> <span class="token string">"^3.3.9"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>修改<code>webpack.config.js</code>，可以配置端口号等。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mini-css-extract-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'js/[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span> <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>            template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            filename<span class="token punctuation">:</span> <span class="token string">'css/[name].[chunkHash:8].css'</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">// [1]</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>        open<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="配置css预处理器"><a href="#配置css预处理器" class="headerlink" title="配置css预处理器"></a>配置css预处理器</h2><p>安装<code>less</code>和<code>less-loader</code>。</p><pre class=" language-shell"><code class="language-shell">npm i -D less less-loader</code></pre><p>修改<code>webpack.config.js</code>，添加less文件规则。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mini-css-extract-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'js/[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span> <span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// [1]</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span> MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span> <span class="token punctuation">]</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>            template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            filename<span class="token punctuation">:</span> <span class="token string">'css/[name].[chunkHash:8].css'</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>        open<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>添加一个less文件并引入。</p><pre class=" language-less"><code class="language-less"><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> aliceblue<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-js"><code class="language-js"><span class="token keyword">import</span> <span class="token string">'./main.css'</span><span class="token comment" spellcheck="true">// [1]</span><span class="token keyword">import</span> <span class="token string">'./test.less'</span>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"home"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="图片处理"><a href="#图片处理" class="headerlink" title="图片处理"></a>图片处理</h2><p>安装<code>file-loader</code>。</p><pre class=" language-shell"><code class="language-shell">npm i -D file-loader</code></pre><p>在<code>webpack.config.js</code>中配置规则。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mini-css-extract-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'js/[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// [1]</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpe?g|gif|jfif)$/i</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>                    <span class="token punctuation">{</span>                        loader<span class="token punctuation">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>                    <span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">]</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">'[path][name].[ext]'</span><span class="token punctuation">,</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>            template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            filename<span class="token punctuation">:</span> <span class="token string">'css/[name].[chunkHash:8].css'</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>        open<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="字体处理"><a href="#字体处理" class="headerlink" title="字体处理"></a>字体处理</h2><p>同样使用<code>file-loader</code>。在<code>webpack.config.js</code>中添加配置。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mini-css-extract-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'js/[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpe?g|gif|jfif)$/i</span><span class="token punctuation">,</span>                loader<span class="token punctuation">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">'static/images/[name].[ext]'</span><span class="token punctuation">,</span>                    publicPath<span class="token punctuation">:</span> <span class="token string">'/'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// [1]</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.(eot|ttf|woff|woff2)(\?v=\d+\.\d+\.\d+)?$/</span><span class="token punctuation">,</span>                loader<span class="token punctuation">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">'static/fonts/[name].[ext]'</span><span class="token punctuation">,</span>                    publicPath<span class="token punctuation">:</span> <span class="token string">'/'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>            template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            filename<span class="token punctuation">:</span> <span class="token string">'static/css/[name].[chunkHash:8].css'</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>        open<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>修改less。</p><pre class=" language-less"><code class="language-less"><span class="token variable">@mainColor<span class="token punctuation">:</span></span> aliceblue<span class="token punctuation">;</span><span class="token selector">.textHover(<span class="token variable">@origin</span>: aqua, <span class="token variable">@hover</span>: #44cccc)</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@origin</span><span class="token punctuation">;</span>  <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@hover</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// [1]</span><span class="token atrule">@font-face</span> <span class="token punctuation">{</span>  <span class="token property">font-family</span><span class="token punctuation">:</span> FFXIV_Lodestone_SSF<span class="token punctuation">;</span>  <span class="token property">src</span><span class="token punctuation">:</span> <span class="token url">url("assets/fonts/FFXIV_Lodestone_SSF.woff")</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'woff'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">body</span> <span class="token punctuation">{</span>  <span class="token property">color</span><span class="token punctuation">:</span> <span class="token variable">@mainColor</span><span class="token punctuation">;</span>  <span class="token selector">h1</span> <span class="token punctuation">{</span>    <span class="token property">color</span><span class="token punctuation">:</span> coral<span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text1</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token selector">#text2</span> <span class="token punctuation">{</span>    <span class="token mixin-usage function">.textHover</span><span class="token punctuation">(</span>pink<span class="token punctuation">,</span> <span class="token hexcode">#dda0ba</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token comment" spellcheck="true">// [2]</span>  <span class="token selector">#text3</span> <span class="token punctuation">{</span>    <span class="token property">font-family</span><span class="token punctuation">:</span> FFXIV_Lodestone_SSF<span class="token punctuation">,</span> serif<span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="配置babel"><a href="#配置babel" class="headerlink" title="配置babel"></a>配置babel</h2><p>babel可以把ES2015及更新版本的js转换为向前兼容的js，也支持转换jsx。</p><p>安装<code>babel-loader</code>。</p><pre class=" language-shell"><code class="language-shell">npm i -D babel-loader @babel/core @babel/preset-env</code></pre><p>在<code>webpack.config.js</code>中添加规则。</p><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"path"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"html-webpack-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"mini-css-extract-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> dist <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>    entry<span class="token punctuation">:</span> <span class="token punctuation">{</span>        main<span class="token punctuation">:</span> <span class="token string">'./src/home.js'</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    output<span class="token punctuation">:</span> <span class="token punctuation">{</span>        path<span class="token punctuation">:</span> dist<span class="token punctuation">,</span>        filename<span class="token punctuation">:</span> <span class="token string">'js/[name].[chunkHash:8].js'</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    module<span class="token punctuation">:</span> <span class="token punctuation">{</span>        rules<span class="token punctuation">:</span> <span class="token punctuation">[</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.less$/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">[</span>MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token string">'less-loader'</span><span class="token punctuation">]</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.(png|jpe?g|gif|jfif)$/i</span><span class="token punctuation">,</span>                loader<span class="token punctuation">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">'static/images/[name].[ext]'</span><span class="token punctuation">,</span>                    publicPath<span class="token punctuation">:</span> <span class="token string">'/'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.(eot|ttf|woff|woff2)(\?v=\d+\.\d+\.\d+)?$/</span><span class="token punctuation">,</span>                loader<span class="token punctuation">:</span> <span class="token string">'file-loader'</span><span class="token punctuation">,</span>                options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    name<span class="token punctuation">:</span> <span class="token string">'static/fonts/[name].[ext]'</span><span class="token punctuation">,</span>                    publicPath<span class="token punctuation">:</span> <span class="token string">'/'</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// [1]</span>            <span class="token punctuation">{</span>                test<span class="token punctuation">:</span> <span class="token regex">/\.m?js$/</span><span class="token punctuation">,</span>                exclude<span class="token punctuation">:</span> <span class="token regex">/(node_modules|bower_components)/</span><span class="token punctuation">,</span>                use<span class="token punctuation">:</span> <span class="token punctuation">{</span>                    loader<span class="token punctuation">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>                    options<span class="token punctuation">:</span> <span class="token punctuation">{</span>                        presets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">]</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">]</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    plugins<span class="token punctuation">:</span> <span class="token punctuation">[</span>        <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            title<span class="token punctuation">:</span> <span class="token string">"模版测试"</span><span class="token punctuation">,</span>            template<span class="token punctuation">:</span> <span class="token string">"public/home.html"</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>            filename<span class="token punctuation">:</span> <span class="token string">'static/css/[name].[chunkHash:8].css'</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">]</span><span class="token punctuation">,</span>    devServer<span class="token punctuation">:</span> <span class="token punctuation">{</span>        port<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>        open<span class="token punctuation">:</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Webpack </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 前端 </tag>
            
            <tag> Webpack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL基础教程笔记0x01</title>
      <link href="/2019/09/08/SQL%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E7%AC%94%E8%AE%B00x01/"/>
      <url>/2019/09/08/SQL%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E7%AC%94%E8%AE%B00x01/</url>
      
        <content type="html"><![CDATA[<h1 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h1><h2 id="表的加减法"><a href="#表的加减法" class="headerlink" title="表的加减法"></a>表的加减法</h2><h3 id="union"><a href="#union" class="headerlink" title="union"></a>union</h3><ul><li>对表进行并集操作。可以使用<code>union all</code>使结果包含重复行。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> product_id<span class="token punctuation">,</span> product_name<span class="token keyword">from</span> product<span class="token keyword">union</span><span class="token keyword">select</span> product_id<span class="token punctuation">,</span> product_name<span class="token keyword">from</span> product_2<span class="token punctuation">;</span></code></pre><table><thead><tr><th style="text-align:left">product_id</th><th style="text-align:left">product_name</th></tr></thead><tbody><tr><td style="text-align:left">0001</td><td style="text-align:left">T恤</td></tr><tr><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td></tr><tr><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td></tr><tr><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td></tr><tr><td style="text-align:left">0005</td><td style="text-align:left">高压锅</td></tr><tr><td style="text-align:left">0006</td><td style="text-align:left">叉子</td></tr><tr><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td></tr><tr><td style="text-align:left">0008</td><td style="text-align:left">圆珠笔</td></tr><tr><td style="text-align:left">0009</td><td style="text-align:left">手套</td></tr><tr><td style="text-align:left">0010</td><td style="text-align:left">水壶</td></tr></tbody></table><ul><li>注意：作为<code>union</code>的运算对象的记录的列数必须相同，列的类型必须一致；<code>order by</code>只能在最后使用一次。</li></ul><h3 id="intersect"><a href="#intersect" class="headerlink" title="intersect"></a>intersect</h3><ul><li>对表进行交集操作。MySQL不支持该操作。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* postgreSQL */</span><span class="token keyword">select</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product<span class="token punctuation">.</span>product_name<span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product<span class="token keyword">intersect</span><span class="token keyword">select</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product_2<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product_2<span class="token punctuation">.</span>product_name<span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product_2<span class="token punctuation">;</span></code></pre><table><thead><tr><th style="text-align:left">product_id</th><th style="text-align:left">product_name</th></tr></thead><tbody><tr><td style="text-align:left">0001</td><td style="text-align:left">T恤</td></tr><tr><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td></tr><tr><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td></tr></tbody></table><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* MySQL用exists模拟 */</span><span class="token keyword">select</span> product_id<span class="token punctuation">,</span> product_name<span class="token keyword">from</span> product <span class="token keyword">as</span> p<span class="token keyword">where</span> <span class="token keyword">exists</span><span class="token punctuation">(</span>              <span class="token keyword">select</span> product_id              <span class="token keyword">from</span> product_2 <span class="token keyword">as</span> p2              <span class="token keyword">where</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p2<span class="token punctuation">.</span>product_id          <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="except"><a href="#except" class="headerlink" title="except"></a>except</h3><ul><li>对表进行差集操作，注意该操作不满足交换律。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* postgreSQL */</span><span class="token keyword">select</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product<span class="token punctuation">.</span>product_name<span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product<span class="token keyword">except</span><span class="token keyword">select</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product_2<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product_2<span class="token punctuation">.</span>product_name<span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product_2</code></pre><table><thead><tr><th style="text-align:left">product_id</th><th style="text-align:left">product_name</th></tr></thead><tbody><tr><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td></tr><tr><td style="text-align:left">0005</td><td style="text-align:left">高压锅</td></tr><tr><td style="text-align:left">0006</td><td style="text-align:left">叉子</td></tr><tr><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td></tr><tr><td style="text-align:left">0008</td><td style="text-align:left">圆珠笔</td></tr></tbody></table><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* MySQL用not exists模拟 */</span><span class="token keyword">select</span> product_id<span class="token punctuation">,</span> product_name<span class="token keyword">from</span> product <span class="token keyword">as</span> p<span class="token keyword">where</span> <span class="token operator">not</span> <span class="token keyword">exists</span><span class="token punctuation">(</span>              <span class="token keyword">select</span> product_id              <span class="token keyword">from</span> product_2 <span class="token keyword">as</span> p2              <span class="token keyword">where</span> p<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p2<span class="token punctuation">.</span>product_id          <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><table><thead><tr><th style="text-align:left">product_id</th><th style="text-align:left">product_name</th></tr></thead><tbody><tr><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td></tr><tr><td style="text-align:left">0005</td><td style="text-align:left">高压锅</td></tr><tr><td style="text-align:left">0008</td><td style="text-align:left">圆珠笔</td></tr><tr><td style="text-align:left">0006</td><td style="text-align:left">叉子</td></tr><tr><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td></tr></tbody></table><h2 id="联结"><a href="#联结" class="headerlink" title="联结"></a>联结</h2><h3 id="内联结"><a href="#内联结" class="headerlink" title="内联结"></a>内联结</h3><ul><li>以一张表中的列为桥梁，将其他表中满足同样条件的列汇集到同一结果之中。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> sp<span class="token punctuation">.</span>shop_id<span class="token punctuation">,</span> sp<span class="token punctuation">.</span>shop_name<span class="token punctuation">,</span> sp<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>product_name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>sale_price<span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>shop_product <span class="token keyword">as</span> sp <span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product <span class="token keyword">as</span> p<span class="token keyword">on</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id</code></pre><table><thead><tr><th style="text-align:left">shop_id</th><th style="text-align:left">shop_name</th><th style="text-align:left">product_id</th><th style="text-align:left">product_name</th><th style="text-align:left">sale_price</th></tr></thead><tbody><tr><td style="text-align:left">000D</td><td style="text-align:left">福冈</td><td style="text-align:left">0001</td><td style="text-align:left">T恤</td><td style="text-align:left">1000</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0001</td><td style="text-align:left">T恤</td><td style="text-align:left">1000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td><td style="text-align:left">3000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td><td style="text-align:left">3000</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0006</td><td style="text-align:left">叉子</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0006</td><td style="text-align:left">叉子</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td><td style="text-align:left">880</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td><td style="text-align:left">880</td></tr></tbody></table><h3 id="外联结"><a href="#外联结" class="headerlink" title="外联结"></a>外联结</h3><ul><li>和内联结基本相同，但是会选择主表的全部信息（见下面示例）。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> sp<span class="token punctuation">.</span>shop_id<span class="token punctuation">,</span> sp<span class="token punctuation">.</span>shop_name<span class="token punctuation">,</span> sp<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>product_name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>sale_price<span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>shop_product <span class="token keyword">as</span> sp <span class="token keyword">right</span> <span class="token keyword">outer</span> <span class="token keyword">join</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product <span class="token keyword">as</span> p<span class="token keyword">on</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id</code></pre><table><thead><tr><th style="text-align:left">shop_id</th><th style="text-align:left">shop_name</th><th style="text-align:left">product_id</th><th style="text-align:left">product_name</th><th style="text-align:left">sale_price</th></tr></thead><tbody><tr><td style="text-align:left">000D</td><td style="text-align:left">福冈</td><td style="text-align:left">0001</td><td style="text-align:left">T恤</td><td style="text-align:left">1000</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0001</td><td style="text-align:left">T恤</td><td style="text-align:left">1000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td><td style="text-align:left">3000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td><td style="text-align:left">3000</td></tr><tr><td style="text-align:left">NULL</td><td style="text-align:left">NULL</td><td style="text-align:left">NULL</td><td style="text-align:left">高压锅</td><td style="text-align:left">6800</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0006</td><td style="text-align:left">叉子</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0006</td><td style="text-align:left">叉子</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td><td style="text-align:left">880</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td><td style="text-align:left">880</td></tr><tr><td style="text-align:left">NULL</td><td style="text-align:left">NULL</td><td style="text-align:left">NULL</td><td style="text-align:left">圆珠笔</td><td style="text-align:left">100</td></tr></tbody></table><p>有两条记录另一张表上没有。</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> sp<span class="token punctuation">.</span>shop_id<span class="token punctuation">,</span> sp<span class="token punctuation">.</span>shop_name<span class="token punctuation">,</span> sp<span class="token punctuation">.</span>product_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>product_name<span class="token punctuation">,</span> p<span class="token punctuation">.</span>sale_price<span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>shop_product <span class="token keyword">as</span> sp <span class="token keyword">left</span> <span class="token keyword">join</span> <span class="token keyword">public</span><span class="token punctuation">.</span>product <span class="token keyword">as</span> p<span class="token keyword">on</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id</code></pre><table><thead><tr><th style="text-align:left">shop_id</th><th style="text-align:left">shop_name</th><th style="text-align:left">product_id</th><th style="text-align:left">product_name</th><th style="text-align:left">sale_price</th></tr></thead><tbody><tr><td style="text-align:left">000D</td><td style="text-align:left">福冈</td><td style="text-align:left">0001</td><td style="text-align:left">T恤</td><td style="text-align:left">1000</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0001</td><td style="text-align:left">T恤</td><td style="text-align:left">1000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0002</td><td style="text-align:left">打孔器</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000A</td><td style="text-align:left">东京</td><td style="text-align:left">0003</td><td style="text-align:left">运动T恤</td><td style="text-align:left">4000</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td><td style="text-align:left">3000</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0004</td><td style="text-align:left">菜刀</td><td style="text-align:left">3000</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0006</td><td style="text-align:left">叉子</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0006</td><td style="text-align:left">叉子</td><td style="text-align:left">500</td></tr><tr><td style="text-align:left">000C</td><td style="text-align:left">大阪</td><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td><td style="text-align:left">880</td></tr><tr><td style="text-align:left">000B</td><td style="text-align:left">名古屋</td><td style="text-align:left">0007</td><td style="text-align:left">擦菜板</td><td style="text-align:left">880</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SQL基础教程笔记0x00</title>
      <link href="/2019/09/07/SQL%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2019/09/07/SQL%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="查询基础"><a href="#查询基础" class="headerlink" title="查询基础"></a>查询基础</h1><h2 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h2><h3 id="含有NULL时的真值"><a href="#含有NULL时的真值" class="headerlink" title="含有NULL时的真值"></a>含有NULL时的真值</h3><ul><li>SQL中的逻辑运算是三值逻辑，即包括真、假、不确定。</li></ul><h1 id="聚合与排序"><a href="#聚合与排序" class="headerlink" title="聚合与排序"></a>聚合与排序</h1><h2 id="为聚合结果指定条件"><a href="#为聚合结果指定条件" class="headerlink" title="为聚合结果指定条件"></a>为聚合结果指定条件</h2><h3 id="having子句"><a href="#having子句" class="headerlink" title="having子句"></a>having子句</h3><ul><li>having子句用于对集合指定条件过滤。having子句位于group by子句后面。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">from</span> shop<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span><span class="token keyword">having</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span></code></pre><ul><li>having子句中能够使用的要素有：常数、聚合函数、group by子句中指定的列名（即聚合键）。</li></ul><h1 id="复杂查询"><a href="#复杂查询" class="headerlink" title="复杂查询"></a>复杂查询</h1><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><h3 id="视图的创建"><a href="#视图的创建" class="headerlink" title="视图的创建"></a>视图的创建</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">view</span> shop_sum <span class="token punctuation">(</span><span class="token punctuation">`</span>product_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>cnt_product<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token keyword">as</span><span class="token keyword">select</span>  <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">from</span> shop<span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span><span class="token punctuation">;</span></code></pre><h3 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h3><ul><li>定义视图时不能使用<code>order by</code>。</li><li>对视图更新是有条件的：<ol><li><code>select</code>子句中未使用<code>distinct</code>。</li><li><code>from</code>子句中只有一张表。</li><li>未使用<code>group by</code>子句。</li><li>未使用<code>having</code>子句。</li></ol></li></ul><h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><ul><li>子查询就是将用来定义视图的select子句直接用于from子句中。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>cnt_product<span class="token punctuation">`</span><span class="token keyword">from</span> <span class="token punctuation">(</span>         <span class="token keyword">select</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>cnt_product<span class="token punctuation">`</span>         <span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span>         <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span>     <span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>product_sum<span class="token punctuation">`</span><span class="token punctuation">;</span></code></pre><h3 id="标量子查询"><a href="#标量子查询" class="headerlink" title="标量子查询"></a>标量子查询</h3><ul><li>标量子查询必须而且只能返回1行1列的结果。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* where子句中无法使用聚合函数，可以使用标量子查询代替。*/</span><span class="token keyword">select</span> <span class="token punctuation">`</span>product_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>product_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>sale_price<span class="token punctuation">`</span><span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span><span class="token keyword">where</span> sale_price <span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span>    <span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="关联子查询"><a href="#关联子查询" class="headerlink" title="关联子查询"></a>关联子查询</h2><ul><li>在普通子查询中添加where子句，使其变为标量子查询。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">`</span>product_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>product_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>sale_price<span class="token punctuation">`</span><span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>s1<span class="token punctuation">`</span><span class="token keyword">where</span> sale_price <span class="token operator">></span> <span class="token punctuation">(</span>    <span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span>sale_price<span class="token punctuation">)</span>    <span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>s2<span class="token punctuation">`</span>    <span class="token keyword">where</span> <span class="token punctuation">`</span>s1<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>product_type<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>s2<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>product_type<span class="token punctuation">`</span>    <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1 id="函数、谓词、case表达式"><a href="#函数、谓词、case表达式" class="headerlink" title="函数、谓词、case表达式"></a>函数、谓词、case表达式</h1><h2 id="谓词"><a href="#谓词" class="headerlink" title="谓词"></a>谓词</h2><h3 id="like"><a href="#like" class="headerlink" title="like"></a>like</h3><ul><li><code>%</code>代表0字符及以上的任意字符串，<code>_</code>代表任意一个字符。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">/* pg */</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> test<span class="token punctuation">.</span>like_sample<span class="token punctuation">.</span>like_test<span class="token keyword">where</span> strcol <span class="token operator">like</span> <span class="token string">'abc%'</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> test<span class="token punctuation">.</span>like_sample<span class="token punctuation">.</span>like_test<span class="token keyword">where</span> strcol <span class="token operator">like</span> <span class="token string">'abc__'</span><span class="token punctuation">;</span></code></pre><h3 id="between"><a href="#between" class="headerlink" title="between"></a>between</h3><ul><li>范围查询，包括两个边界。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span><span class="token keyword">where</span> sale_price <span class="token operator">between</span> <span class="token number">100</span> <span class="token operator">and</span> <span class="token number">1000</span><span class="token punctuation">;</span></code></pre><h3 id="is-null、is-not-null"><a href="#is-null、is-not-null" class="headerlink" title="is null、is not null"></a>is null、is not null</h3><ul><li>判断是否为<code>null</code>。</li></ul><h3 id="in"><a href="#in" class="headerlink" title="in"></a>in</h3><ul><li><code>or</code>的简便写法。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">`</span>product_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>purchase_price<span class="token punctuation">`</span><span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span><span class="token keyword">where</span> putchase_price <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="使用子查询作为in的参数"><a href="#使用子查询作为in的参数" class="headerlink" title="使用子查询作为in的参数"></a>使用子查询作为in的参数</h3><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">`</span>product_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>sale_price<span class="token punctuation">`</span><span class="token keyword">from</span> <span class="token punctuation">`</span>shop<span class="token punctuation">`</span><span class="token keyword">where</span> <span class="token punctuation">`</span>product_id<span class="token punctuation">`</span> <span class="token operator">in</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span> <span class="token punctuation">`</span>product_id<span class="token punctuation">`</span>    <span class="token keyword">from</span> <span class="token punctuation">`</span>all_shops<span class="token punctuation">`</span>    <span class="token keyword">where</span> <span class="token punctuation">`</span>shop_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'000c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h3><ul><li>判断是否存在满足条件的某种记录，存在则返回真，不存在则返回假。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token punctuation">`</span>product_name<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>sale_price<span class="token punctuation">`</span><span class="token keyword">from</span> <span class="token punctuation">`</span>product<span class="token punctuation">`</span> <span class="token keyword">as</span> p<span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span>    <span class="token keyword">select</span> <span class="token operator">*</span>    <span class="token keyword">from</span> shop_product <span class="token keyword">as</span> sp    <span class="token keyword">where</span> sp<span class="token punctuation">.</span>shop_id <span class="token operator">=</span> <span class="token string">'000c'</span>    <span class="token operator">and</span> sp<span class="token punctuation">.</span>product_id <span class="token operator">=</span> p<span class="token punctuation">.</span>product_id<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="case表达式"><a href="#case表达式" class="headerlink" title="case表达式"></a>case表达式</h2><ul><li>满足<code>when</code>子句就执行对应的<code>then</code>子句，否则到下一个<code>when</code>子句，直到没有<code>when</code>子句后执行<code>else</code>子句。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">sum</span><span class="token punctuation">(</span>    <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'A'</span>    <span class="token keyword">then</span> <span class="token punctuation">`</span>sale_price<span class="token punctuation">`</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>sum_price_clothes<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>    <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'b'</span>    <span class="token keyword">then</span> <span class="token punctuation">`</span>sale_price<span class="token punctuation">`</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>sum_price_kitchen<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>    <span class="token keyword">case</span> <span class="token keyword">when</span> <span class="token punctuation">`</span>product_type<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token string">'C'</span>    <span class="token keyword">then</span> <span class="token punctuation">`</span>sale_price<span class="token punctuation">`</span> <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">`</span>sum_price_office<span class="token punctuation">`</span><span class="token keyword">from</span> <span class="token punctuation">`</span>product<span class="token punctuation">`</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> SQL </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SQL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL技术内幕笔记0x04</title>
      <link href="/2019/09/06/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x04/"/>
      <url>/2019/09/06/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x04/</url>
      
        <content type="html"><![CDATA[<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="事务简介"><a href="#事务简介" class="headerlink" title="事务简介"></a>事务简介</h2><h3 id="特性（ACID）"><a href="#特性（ACID）" class="headerlink" title="特性（ACID）"></a>特性（ACID）</h3><ul><li>原子性（Atomicity）：指整个数据库事务是不可分割的工作单位。只有使事务中所有的数据库操作都执行成功，才算整个事务成功。事务中任何一个SQL语句执行失败，已经执行成功的SQL语句也必须撤销，数据库状态应该退回事务前的状态。</li><li>一致性（Consistency）：指事务将数据库从一种状态转变为下一种一致的状态。在事务开始之前和事务结束之后，数据库的完整性约束没有被破坏。</li><li>隔离性（Isolation）：事务的隔离性要求每个读写事务的对象对其他事务的操作对象能互相分离，即该事务提交前对其他事务都不可见，通常使用锁来实现。</li><li>持久性（Durability）：事务一旦提交，其结果就是永久性的。即使发生宕机等故障，数据库也能将数据恢复。</li></ul><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><h4 id="扁平事务"><a href="#扁平事务" class="headerlink" title="扁平事务"></a>扁平事务</h4><ul><li>是事务中最简单的一种，但在实际生产环境中可能是使用最为频繁的事务。在扁平事务，所有操作都处于同一层次，其由<code>begin work</code>开始，由<code>commit work</code>或<code>rollback work</code>结束，其间的操作是原子的，要么都执行，要么都回滚。</li></ul><h4 id="带保存点的扁平事务"><a href="#带保存点的扁平事务" class="headerlink" title="带保存点的扁平事务"></a>带保存点的扁平事务</h4><ul><li>除了支持扁平事务支持的操作外，允许在事务执行过程中回滚到同一事务中较早的一个状态。这是因为某些事务可能在执行过程中出现错误并不会导致所有的操作都无效，放弃整个事务不合乎要求，开销也太大。</li><li>保存点用来通知系统应该记住事务当前的状态，以便之后发生错误时，事务能够回到保存点当时的状态。</li><li>保存点在事务内部是递增的，不会因为回滚而出现覆盖。</li><li>保存点是易失的，即当发生系统崩溃后进行恢复时，事务需要从开始处重新执行，不能从最近的一个保存点继续。</li></ul><h4 id="链事务"><a href="#链事务" class="headerlink" title="链事务"></a>链事务</h4><ul><li>在提交一个事务时，释放不需要的数据对象，将必要的上下文隐式地传给下一个要开始的事务。提交事务的操作和开始下一个事务的操作将合并为一个原子操作，这意味着下一个事务将看到上一个事务的结果。</li><li>链事务与带保存点的事务不同的是，带保存点的扁平事务能回滚到任意正确的保存点，而链事务中的回滚仅限于当前事务。此外，链事务在执行<code>commit</code>后即释放了当前事务所持有的锁，而带保存点的扁平事务不影响迄今为止所持有的锁。</li></ul><h4 id="嵌套事务"><a href="#嵌套事务" class="headerlink" title="嵌套事务"></a>嵌套事务</h4><ul><li>是一个层次结构框架，由一个顶层事务控制各个层次的事务。顶层事务之下嵌套的事务称为子事务，其控制每一个局部变换。</li></ul><h4 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h4><ul><li>通常是一个在分布式环境下运行的扁平事务，因此需要根据数据所在位置访问网络中的不同节点。</li></ul><h2 id="事务的实现"><a href="#事务的实现" class="headerlink" title="事务的实现"></a>事务的实现</h2><ul><li>redo log用来保证事务的持久性，undo log用来保证事务的一致性。</li><li>redo通常是物理日志，记录的是页的物理修改操作，用于对页进行重做操作。undo是逻辑日志，根据每行记录进行记录，用于对事务进行回滚。</li><li>当事务提交时，必须先将该事务的所有日志写入到redo日志文件进行持久化，待事务的提交成功后才算完成。</li><li>undo存放在数据库内部的一个特殊段中，称为undo段，位于共享表空间内。</li></ul><h2 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h2><blockquote><ul><li>未提交读(Read Uncommitted)：允许脏读，也就是可能读取到其他会话中未提交事务修改的数据。</li><li>提交读(Read Committed)：只能读取到已经提交的数据。Oracle等多数数据库默认都是该级别 (不重复读)。</li><li>可重复读(Repeated Read)：可重复读。在同一个事务内的查询都是事务开始时刻一致的，InnoDB默认级别。在SQL标准中，该隔离级别消除了不可重复读，但是还存在幻象读。</li><li>串行读(Serializable)：完全串行化的读，每次读都需要获得表级共享锁，读写相互都会阻塞。</li></ul><p><a href="https://www.cnblogs.com/zhoujinyi/p/3437475.html" target="_blank" rel="noopener">原文链接</a></p></blockquote><h2 id="分布式事务-1"><a href="#分布式事务-1" class="headerlink" title="分布式事务"></a>分布式事务</h2><ul><li>XA是一种分布式事务的标准，多数数据库都实现了XA接口。</li><li>XA事务由一个或多个资源管理器、一个事务管理器以及一个应用程序组成。</li><li>资源管理器：提供访问事务资源的方法。通常一个数据库就是一个资源管理器。</li><li>事务管理器：协调参与全局事务中的各个事务。需要和参与全局事务的所有资源管理器进行通信。</li><li>应用程序：定义事务的边界，指定全局事务中的操作。</li><li>分布式事务使用两段式提交。在第一阶段，所有参与全局事务的节点都开始准备，告诉事务管理器它们准备好提交了。在第二阶段，事务管理器告诉资源管理器执行<code>rollback</code>还是<code>commit</code>。如果任何一个节点显示不能提交，在所有节点都被告知需要回滚。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> InnoDB </tag>
            
            <tag> 事务 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-正则表达式匹配</title>
      <link href="/2019/09/05/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8C%B9%E9%85%8D/"/>
      <url>/2019/09/05/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8C%B9%E9%85%8D/</url>
      
        <content type="html"><![CDATA[<h1 id="正则表达式匹配"><a href="#正则表达式匹配" class="headerlink" title="正则表达式匹配"></a>正则表达式匹配</h1><p>请实现一个函数用来匹配包括<code>.</code>和<code>*</code>的正则表达式。模式中的字符<code>.</code>表示任意一个字符，而<code>*</code>表示它前面的字符可以出现任意次（包含0次）。 在本题中，匹配是指字符串的所有字符匹配整个模式。例如，字符串<code>aaa</code>与模式<code>a.a</code>和<code>ab*ac*a</code>匹配，但是与<code>aa.a</code>和<code>ab*a</code>均不匹配</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q19</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">match</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> str<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pattern<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern <span class="token operator">==</span> null <span class="token operator">||</span> str <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token function">subMatch</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">subMatch</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> str<span class="token punctuation">,</span> <span class="token keyword">int</span> strIndex<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> pattern<span class="token punctuation">,</span> <span class="token keyword">int</span> patternIndex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// [1]</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>strIndex <span class="token operator">>=</span> str<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> patternIndex <span class="token operator">>=</span> pattern<span class="token punctuation">.</span>length <span class="token operator">||</span>                    <span class="token punctuation">(</span>patternIndex <span class="token operator">==</span> pattern<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> pattern<span class="token punctuation">[</span>patternIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>patternIndex <span class="token operator">>=</span> pattern<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 匹配单个字符</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>patternIndex <span class="token operator">==</span> pattern<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">||</span> pattern<span class="token punctuation">[</span>patternIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'*'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern<span class="token punctuation">[</span>patternIndex<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'.'</span> <span class="token operator">||</span> str<span class="token punctuation">[</span>strIndex<span class="token punctuation">]</span> <span class="token operator">==</span> pattern<span class="token punctuation">[</span>patternIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token function">subMatch</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> strIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> patternIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 匹配带*</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pattern<span class="token punctuation">[</span>patternIndex<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'.'</span> <span class="token operator">&amp;&amp;</span> str<span class="token punctuation">[</span>strIndex<span class="token punctuation">]</span> <span class="token operator">!=</span> pattern<span class="token punctuation">[</span>patternIndex<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">subMatch</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> strIndex<span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> patternIndex <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">//[2]</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">subMatch</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> strIndex<span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> patternIndex <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//[3]</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>strIndex <span class="token operator">&lt;</span> str<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>str<span class="token punctuation">[</span>strIndex<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">!=</span> pattern<span class="token punctuation">[</span>patternIndex<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> pattern<span class="token punctuation">[</span>patternIndex<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">subMatch</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> strIndex<span class="token punctuation">,</span> pattern<span class="token punctuation">,</span> patternIndex <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Q19 s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Q19</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String str <span class="token operator">=</span> <span class="token string">"bcbbabab"</span><span class="token punctuation">;</span>        String pattern <span class="token operator">=</span> <span class="token string">".*a*a"</span><span class="token punctuation">;</span>        s<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>str<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pattern<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：使用递归。首先是退出条件，如果<code>str</code>和<code>pattern</code>都用完退出返回<code>true</code>，如果仅是<code>pattern</code>用完则返回<code>false</code>。注意[1]处有另一种退出返回<code>true</code>的情况，就是<code>str</code>用完，<code>pattern</code>剩余一个字符和<code>*</code>，此时按匹配0个可以返回<code>true</code>。然后是匹配单个字符，比较简单。最后是匹配带<code>*</code>，注意[2]先进行一次匹配0个，[3]进入循环的条件为<code>str</code>没有用完。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 字符串 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL技术内幕笔记0x03</title>
      <link href="/2019/09/05/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x03/"/>
      <url>/2019/09/05/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x03/</url>
      
        <content type="html"><![CDATA[<h1 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h1><h2 id="锁简介"><a href="#锁简介" class="headerlink" title="锁简介"></a>锁简介</h2><ul><li>锁是数据库区别于文件系统的一个关键特性。数据库系统使用锁是为了支持对共享资源进行并发访问，提供数据的完整性和一致性。</li></ul><h2 id="lock与latch"><a href="#lock与latch" class="headerlink" title="lock与latch"></a>lock与latch</h2><ul><li>latch一般成为闩锁（轻量级锁），因为其要求锁定的时间必须非常短。若持续时间长，则应用的性能会非常差。其目的是保证并发线程操作临界资源的正确性，并且通常没有死锁检测机制。在InnoDB中，latch又可以分为mutex（互斥锁）和rwlock（读写锁）。 </li><li>lock的对象是是事务，用来锁定的是数据库中的对象，如表、页、行。一般lock的对象仅在事务commit或rollback后进行释放（不同事务隔离级别释放的时间可能不同）。此外，lock是有死锁机制的。</li></ul><h2 id="InnoDB存储引擎中的锁"><a href="#InnoDB存储引擎中的锁" class="headerlink" title="InnoDB存储引擎中的锁"></a>InnoDB存储引擎中的锁</h2><h3 id="锁的类型"><a href="#锁的类型" class="headerlink" title="锁的类型"></a>锁的类型</h3><ul><li>InnoDB实现了如下两种标准的行级锁：<ul><li>共享锁（S Lock），允许事务读一行数据。</li><li>排他锁（X Lock），允许事务删除或更新一行数据。</li></ul></li><li>InnoDB支持多粒度锁定，这种锁定允许事务在行级锁与表级锁同时存在。为了支持在不同粒度上进行加锁操作，InnoDB支持一种额外的锁方式，称之为意向锁。意向锁是将锁定的对象分为多个层次，意向锁意味着事务希望在更细粒度上进行加锁。InnoDB支持两种意向锁：<ul><li>意向共享锁（IS Lock），事务想要夺得一张表中某几行的共享锁。</li><li>意向排他锁（IX Lock），事务想要获得一张表中某几行的排他锁。</li></ul></li><li>意向锁不会阻塞除全表扫描以外的任何请求。表级意向锁之间互相兼容，IS与S兼容，S与S兼容，其他情况都不兼容。</li></ul><h3 id="一致性非锁定读"><a href="#一致性非锁定读" class="headerlink" title="一致性非锁定读"></a>一致性非锁定读</h3><ul><li>一致性非锁定读是指InnoDB通过行的多版本控制的方式来读取当前数据库中行的数据。如果读取的行正在执行delete或update操作，这时读取操作不会因此去等待行锁释放，而是去读取行的快照数据。该操作实现是通过undo段来完成的，而undo用来在事务中回滚数据，因此快照数据本身是没有额外开销的。此外，读取快照数据是不需要上锁的，因为没有事务需要对历史数据进行修改。由此，非锁定读机制极大地提高了数据库的并发性。</li></ul><h3 id="一致性锁定读"><a href="#一致性锁定读" class="headerlink" title="一致性锁定读"></a>一致性锁定读</h3><ul><li>InnoDB对于select语句支持两种一致性锁定读操作，一种是<code>select ... for update</code>，对读取的行记录加一个X锁，其他事务不能对已锁定的行加上任何锁。另一种是<code>select ... lock in share mode</code>，对读取的行记录加一个S锁，其他事务可以向被锁定的行加S锁，但是如果加X锁则会被阻塞。</li></ul><h2 id="锁的算法"><a href="#锁的算法" class="headerlink" title="锁的算法"></a>锁的算法</h2><h3 id="行锁的3种算法"><a href="#行锁的3种算法" class="headerlink" title="行锁的3种算法"></a>行锁的3种算法</h3><ul><li>Record Lock：单个行记录上锁。总是会去锁住索引记录，如果表在建立时没有设置索引，那么InnoDB会使用隐式的主键来进行锁定。</li><li>Gap Lock：间隙锁，锁定一个范围，但不包含记录本身。</li><li>Next-Key Lock：Gap Lock+Record Lock，锁定一个范围，并且锁定记录本身。InnoDB对于行的查询都是采用这种锁定算法。其设计的目的是为了解决幻象问题。</li><li>当查询的索引含有唯一属性时，InnoDB会对Next-Key Lock进行优化，将其降级为Record Lock，即仅锁住记录，从而提高并发性。</li></ul><h3 id="解决幻象问题"><a href="#解决幻象问题" class="headerlink" title="解决幻象问题"></a>解决幻象问题</h3><ul><li>幻象问题是指，在同一事务下，连续执行两次相同的SQL语句可能得到不同的结果，第二次SQL语句可能会返回之前不存在的的行。</li></ul><h2 id="锁问题"><a href="#锁问题" class="headerlink" title="锁问题"></a>锁问题</h2><h3 id="脏读"><a href="#脏读" class="headerlink" title="脏读"></a>脏读</h3><ul><li>脏数据是指事务对缓冲池中行记录的修改，并且还没有被提交。</li><li>脏读是指在不同事务下，当前事务可以读到其他事务未提交的数据，即脏数据。</li></ul><h3 id="不可重复读"><a href="#不可重复读" class="headerlink" title="不可重复读"></a>不可重复读</h3><ul><li>不可重复读是指，在同一个事务中多次读取同一数据集合，但是存在两次结果不一致的情况。</li><li>不可重复读和脏读的区别是，脏读得到的是未提交的数据，而不可重复读得到的是已经提交的数据，但是其违反了数据库事务一致性的要求。</li><li>不可重复读的问题是可以接受的，因为其读到的是已经提交的数据，本身不会带来很大问题。</li></ul><h3 id="丢失更新"><a href="#丢失更新" class="headerlink" title="丢失更新"></a>丢失更新</h3><ul><li>丢失更新是指有些事务的更新操作被另一个事务的更新操作所覆盖，从而导致数据的不一致，例如：<ol><li>事务t1将行记录r更新为v1，但是t1没有提交</li><li>事务t2将行记录r更新为v2，但是t2没有提交</li><li>t1提交</li><li>t2提交</li></ol></li><li>要避免丢失更新发生，需要让事务在这种情况下的操作变成串行化。在1.和2.中分别加上一个X锁，据此，2.需要等待1.和3.结束才能执行。</li></ul><h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><ul><li>死锁是指两个及以上的事务在执行过程中，因竞争锁资源而造成的一种互相等待的现象。</li><li>解决死锁最简单的方式是不要有等待，让任何等待都转化为回滚，并且事务重新开始。但是这种方式可能导致并发性能下降，而这所带来的问题更为严重，因为很难被发现并且浪费资源。</li><li>解决死锁的一种方法是超时，即当两个事务互相等待时，当一个等待时间超过设置的某一阈值时，其中一个事务进行回滚，另一个等待事务就能继续进行。</li><li>当前数据库普遍采用等待图的方法进行死锁检测，这是一种更为主动的检测方法，主要包括锁的信息链表和事务的等待链表，以及两者构造的图，如果这张图中存在回路，就代表存在死锁。检测算法通常采用深度优先算法实现。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> InnoDB </tag>
            
            <tag> 锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-删除链表节点</title>
      <link href="/2019/09/04/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%88%A0%E9%99%A4%E9%93%BE%E8%A1%A8%E8%8A%82%E7%82%B9/"/>
      <url>/2019/09/04/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%88%A0%E9%99%A4%E9%93%BE%E8%A1%A8%E8%8A%82%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="删除链表节点"><a href="#删除链表节点" class="headerlink" title="删除链表节点"></a>删除链表节点</h1><h2 id="在O-1-时间内删除链表节点"><a href="#在O-1-时间内删除链表节点" class="headerlink" title="在O(1)时间内删除链表节点"></a>在O(1)时间内删除链表节点</h2><p>给定单向链表的头指针和一个节点指针，定义一个函数在O(1)时间内删除该节点。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> value<span class="token punctuation">;</span>    Node next<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Node <span class="token function">solute</span><span class="token punctuation">(</span>Node head<span class="token punctuation">,</span> Node p<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>next <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            p<span class="token punctuation">.</span>value <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">.</span>value<span class="token punctuation">;</span>            p<span class="token punctuation">.</span>next <span class="token operator">=</span> p<span class="token punctuation">.</span>next<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token keyword">return</span> head<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>head <span class="token operator">==</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            Node next <span class="token operator">=</span> head<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>next <span class="token operator">!=</span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>                next <span class="token operator">=</span> next<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            next<span class="token punctuation">.</span>next <span class="token operator">=</span> null<span class="token punctuation">;</span>            <span class="token keyword">return</span> head<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：把要删除的节点的下一个节点的值覆盖到当前节点上，再删除下一个节点。注意需要判断要删除节点是否为尾节点，以及链表中是否只有一个节点。</li></ul><h2 id="删除排序链表中重复的节点"><a href="#删除排序链表中重复的节点" class="headerlink" title="删除排序链表中重复的节点"></a>删除排序链表中重复的节点</h2><p>在一个排序的链表中，存在重复的结点，请删除该链表中重复的结点，重复的结点不保留，返回链表头指针。 例如，链表1-&gt;2-&gt;3-&gt;3-&gt;4-&gt;4-&gt;5 处理后为 1-&gt;2-&gt;5</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> value<span class="token punctuation">;</span>    Node next<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Node <span class="token function">solute</span><span class="token punctuation">(</span>Node head<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>head <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token keyword">boolean</span> deleteHead <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span>next <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> head<span class="token punctuation">.</span>value <span class="token operator">==</span> head<span class="token punctuation">.</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span> deleteHead <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        Node last <span class="token operator">=</span> head<span class="token punctuation">;</span>        Node next <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token keyword">int</span> lastValue <span class="token operator">=</span> head<span class="token punctuation">.</span>value<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>value <span class="token operator">==</span> lastValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>                last<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                lastValue <span class="token operator">=</span> next<span class="token punctuation">.</span>value<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>next<span class="token punctuation">.</span>next <span class="token operator">==</span> null <span class="token operator">||</span> next<span class="token punctuation">.</span>next<span class="token punctuation">.</span>value <span class="token operator">!=</span> lastValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    last <span class="token operator">=</span> last<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    last<span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            next <span class="token operator">=</span> next<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>deleteHead<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span>next <span class="token operator">==</span> null <span class="token operator">||</span> head<span class="token punctuation">.</span>value <span class="token operator">!=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>                head <span class="token operator">=</span> head<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> head<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：如要删除头节点最后处理（头指针向下到第一个值不同的节点），中间节点保存上一个值，如果重复则<code>next</code>直接向下，如果<code>next</code>的值发生变动则进行预判，相同则直接向下并更新上一个值，否则<code>last</code>向下。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 链表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-打印从1到最大的n位数</title>
      <link href="/2019/09/04/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%89%93%E5%8D%B0%E4%BB%8E1%E5%88%B0%E6%9C%80%E5%A4%A7%E7%9A%84n%E4%BD%8D%E6%95%B0/"/>
      <url>/2019/09/04/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%89%93%E5%8D%B0%E4%BB%8E1%E5%88%B0%E6%9C%80%E5%A4%A7%E7%9A%84n%E4%BD%8D%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="打印从1到最大的n位数"><a href="#打印从1到最大的n位数" class="headerlink" title="打印从1到最大的n位数"></a>打印从1到最大的n位数</h1><p>输入数字n，按顺序打印从1到最大的n位数十进制数。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    StringBuilder num <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> lastCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        num<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> c <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'9'</span><span class="token punctuation">)</span> num<span class="token punctuation">.</span><span class="token function">setCharAt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">else</span> <span class="token punctuation">{</span>                    num<span class="token punctuation">.</span><span class="token function">setCharAt</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    c <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> num<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lastCount<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastCount <span class="token operator">>=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            lastCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            num<span class="token punctuation">.</span><span class="token function">setCharAt</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> num<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>num<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">solute</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        Solution solution <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>solution<span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>            solution<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            solution<span class="token punctuation">.</span><span class="token function">increase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：使用书中第一种解法。使用<code>StringBuilder</code>更加方便。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 大数 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-数值的整数次方</title>
      <link href="/2019/09/02/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%95%B0%E5%80%BC%E7%9A%84%E6%95%B4%E6%95%B0%E6%AC%A1%E6%96%B9/"/>
      <url>/2019/09/02/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%95%B0%E5%80%BC%E7%9A%84%E6%95%B4%E6%95%B0%E6%AC%A1%E6%96%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="数值的整数次方"><a href="#数值的整数次方" class="headerlink" title="数值的整数次方"></a>数值的整数次方</h1><p>给定一个double类型的浮点数base和int类型的整数exponent。求base的exponent次方。保证base和exponent不同时为0。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">unsignedPower</span><span class="token punctuation">(</span><span class="token keyword">double</span> base<span class="token punctuation">,</span> <span class="token keyword">int</span> exponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>exponent <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>exponent <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> base<span class="token punctuation">;</span>        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token function">unsignedPower</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> exponent <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        result <span class="token operator">*=</span> result<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>exponent <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> result <span class="token operator">*=</span> base<span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">Power</span><span class="token punctuation">(</span><span class="token keyword">double</span> base<span class="token punctuation">,</span> <span class="token keyword">int</span> exponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>base <span class="token operator">==</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0.0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>exponent <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1.0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> exp <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>exponent<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> result <span class="token operator">=</span> <span class="token function">unsignedPower</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>exponent <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> result <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> result<span class="token punctuation">;</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：求<code>a^n</code>，先求<code>a^(n/2)</code>，然后平方，依次递归。注意指数为负数、0以及底数为0.0的情况。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 数学 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-剪绳子</title>
      <link href="/2019/09/02/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%89%AA%E7%BB%B3%E5%AD%90/"/>
      <url>/2019/09/02/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%89%AA%E7%BB%B3%E5%AD%90/</url>
      
        <content type="html"><![CDATA[<h1 id="剪绳子"><a href="#剪绳子" class="headerlink" title="剪绳子"></a>剪绳子</h1><p>一根长度为<code>n</code>的绳子，请把绳子剪成<code>m</code>段（<code>n &gt; 1</code>且<code>m &gt; 1</code>），每段绳子的长度记为<code>k[0], k[1], ..., k[m]</code>。请问<code>k[0] * k[1] * , ..., * k[m]</code>的可能最大乘积是多少？</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">maxMulti</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">return</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> back <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            max <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> i <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">int</span> temp <span class="token operator">=</span> back<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">*</span> back<span class="token punctuation">[</span>i <span class="token operator">-</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">></span> max<span class="token punctuation">)</span> max<span class="token operator">=</span> temp<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            back<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> max<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> back<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：使用动态规划，记录长度为<code>i</code>时乘积最大值。注意在取<code>[0, 3]</code>时分情况，因为题目要求至少剪一刀，所以在<code>n</code>为<code>[0, 3]</code>时的返回值和记录初始化时的<code>[0, 3]</code>不同。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 动态规划 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-机器人的运动范围</title>
      <link href="/2019/09/02/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%9C%BA%E5%99%A8%E4%BA%BA%E7%9A%84%E8%BF%90%E5%8A%A8%E8%8C%83%E5%9B%B4/"/>
      <url>/2019/09/02/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%9C%BA%E5%99%A8%E4%BA%BA%E7%9A%84%E8%BF%90%E5%8A%A8%E8%8C%83%E5%9B%B4/</url>
      
        <content type="html"><![CDATA[<h1 id="机器人的运动范围"><a href="#机器人的运动范围" class="headerlink" title="机器人的运动范围"></a>机器人的运动范围</h1><p>地上有一个m行和n列的方格。一个机器人从坐标0,0的格子开始移动，每一次只能向左，右，上，下四个方向移动一格，但是不能进入行坐标和列坐标的数位之和大于k的格子。 例如，当k为18时，机器人能够进入方格（35,37），因为3+5+3+7 = 18。但是，它不能进入方格（35,38），因为3+5+3+8 = 19。请问该机器人能够达到多少个格子？</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> x<span class="token punctuation">;</span>    <span class="token keyword">int</span> y<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">addSingle</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            result <span class="token operator">+=</span> n <span class="token operator">%</span> <span class="token number">10</span><span class="token punctuation">;</span>            n <span class="token operator">/=</span> <span class="token number">10</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> k<span class="token punctuation">,</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> visited<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>                x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>                y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>                x <span class="token operator">>=</span> visited<span class="token punctuation">.</span>length <span class="token operator">||</span>                y <span class="token operator">>=</span> visited<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">||</span>                visited<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span>        <span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1]</span>        <span class="token keyword">return</span> <span class="token function">addSingle</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">addSingle</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> k<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">movingCount</span><span class="token punctuation">(</span><span class="token keyword">int</span> threshold<span class="token punctuation">,</span> <span class="token keyword">int</span> rows<span class="token punctuation">,</span> <span class="token keyword">int</span> cols<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>threshold <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> rows<span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> cols <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>threshold <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 初始化访问标记矩阵</span>        <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> visited <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">boolean</span><span class="token punctuation">[</span>rows<span class="token punctuation">]</span><span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> lb<span class="token operator">:</span> visited<span class="token punctuation">)</span> <span class="token punctuation">{</span>            lb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">boolean</span><span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> b<span class="token operator">:</span> lb<span class="token punctuation">)</span> <span class="token punctuation">{</span>                b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// BFS</span>        Queue<span class="token operator">&lt;</span>Point<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Point current<span class="token punctuation">;</span>        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        visited<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            current <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>y<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> visited<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                result<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>y<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> visited<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                result<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> visited<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                result<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">check</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> visited<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                visited<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                result<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：没有使用书上的解法，使用BFS，用队列实现。注意[1]处边界条件。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> BFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL技术内幕笔记0x02</title>
      <link href="/2019/09/02/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x02/"/>
      <url>/2019/09/02/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x02/</url>
      
        <content type="html"><![CDATA[<h1 id="索引和算法"><a href="#索引和算法" class="headerlink" title="索引和算法"></a>索引和算法</h1><h2 id="B-树"><a href="#B-树" class="headerlink" title="B+树"></a>B+树</h2><ul><li>B+树是一种平衡查找树。在B+树中，所有记录节点都是按键值的大小顺序存放在同一层的叶子节点上，由各叶子节点指针进行连接。如果用户从最左边的叶子节点开始遍历，可以得到所有键值的顺序排序。</li></ul><h3 id="插入操作"><a href="#插入操作" class="headerlink" title="插入操作"></a>插入操作</h3><ul><li>Leaf Page未满，Index Page未满：直接插入即可。</li></ul><p><img src="/images/2019-09-03_090547.png" alt="Leaf Page未满，Index Page未满，插入28"></p><ul><li>Leaf Page已满，Index Page未满：需要拆分Leaf Page，将中间节点放入Index Page中，小于中间节点的记录放左边节点，大于或等于中间节点的记录放右边节点。</li></ul><p><img src="/images/2019-09-03_090607.png" alt="Leaf Page已满，Index Page未满，插入70"></p><p><img src="/images/2019-09-03_091127.png" alt="拆分Leaf Page"></p><ul><li>Leaf Page已满，Index Page已满：需要拆分Leaf Page和Index Page。拆分Leaf Page同上；拆分Index Page时，小于中间节点的索引放左边，大于中间节点的索引放右边，中间节点放入上一层Index Page。</li></ul><p><img src="/images/2019-09-03_091534.png" alt="Leaf Page已满，Index Page已满，插入95"></p><p><img src="/images/2019-09-03_091640.png" alt="拆分Leaf Page"></p><p><img src="/images/2019-09-03_091739.png" alt="拆分Index Page"></p><h3 id="删除操作"><a href="#删除操作" class="headerlink" title="删除操作"></a>删除操作</h3><ul><li>B+树使用填充因子来控制树的删除变化，50%是填充因子可设置的最小值。</li><li>叶子节点和中间节点都不小于填充因子：直接删除，如果该节点还是Index Page的节点，用该节点的右节点代替。</li></ul><p><img src="/images/2019-09-03_095134.png" alt="叶子节点和中间节点都不小于填充因子，删除70"></p><p><img src="/images/2019-09-03_095252.png" alt="叶子节点和中间节点都不小于填充因子，删除25"></p><ul><li>叶子节点小于填充因子，中间节点不小于填充因子：合并叶子节点和它的兄弟节点，同时更新Index Page。</li><li>叶子节点和中间节点都小于填充因子：合并叶子节点和它的兄弟节点，更新Index Page，然后合并中间节点和它的父节点、兄弟节点。</li></ul><p><img src="/images/2019-09-03_095831.png" alt="叶子节点和中间节点都小于填充因子，删除60"></p><p><img src="images/2019-09-03_095907.png" alt="合并叶子节点和它的兄弟节点"></p><p><img src="/images/2019-09-03_100010.png" alt="合并中间节点和它的父节点、兄弟节点"></p><h2 id="B-树索引"><a href="#B-树索引" class="headerlink" title="B+树索引"></a>B+树索引</h2><ul><li>B+树索引的本质是B+树在数据库中的实现。但是B+树索引在数据库中具有高扇出性的特点。因此在数据库中，B+树的高度一般都在2~4层。</li></ul><blockquote><p>扇入：指直接调用该模块的上级模块的个数。扇入大表示模块的复用程序高。</p><p>扇出：是指该模块直接调用的下级模块的个数。<em>在此处表示向下查询次数较少。</em></p></blockquote><h3 id="聚集索引"><a href="#聚集索引" class="headerlink" title="聚集索引"></a>聚集索引</h3><ul><li>聚集索引就是按照每张表的主键构造一棵B+树，同时叶子节点中存放的即为整张表的行记录数据，也将聚集索引的叶子节点称为数据页。聚集索引的这个特性决定了索引组织表中数据也是索引的一部分。</li><li>每张表有且只有一个聚集索引。在多数情况下，查询优化器倾向于采用聚集索引，因为聚集索引能够在B+树索引的叶子节点上直接找到数据。此外，由于定义了数据的逻辑顺序，聚集索引能够特别快地访问针对范围值的查询，查询优化器能够快速发现某一段范围的数据页需要扫描。对于主键的排序查找和范围查找速度非常快。</li><li>聚集索引的存储并不是物理上连续的，而是逻辑上连续的。</li></ul><h3 id="辅助索引"><a href="#辅助索引" class="headerlink" title="辅助索引"></a>辅助索引</h3><ul><li>辅助索引中，叶子节点并不包含行记录的全部数据。叶子节点除了包含键值以外，每个叶子节点中的索引行还包含了一个书签，该书签用来告知InnoDB存储引擎与索引相对应行数据的位置。</li></ul><h2 id="Cardinality值"><a href="#Cardinality值" class="headerlink" title="Cardinality值"></a>Cardinality值</h2><ul><li>当某个字段可取值范围很小（例如性别、地区、类型等），称为低选择性，对该字段添加B+树索引是完全没有必要的。相反，如果某个字段的取值范围很广，几乎没有重复，即属于高选择性，则此时选择B+树索引是最合适的。</li><li>Cardinality值非常关键，表示索引中不重复记录数量的预估值。在实际应用中，Cardinality / n_rows_in_table应尽可能地接近1。</li></ul><h2 id="B-树索引的使用"><a href="#B-树索引的使用" class="headerlink" title="B+树索引的使用"></a>B+树索引的使用</h2><h3 id="联合索引"><a href="#联合索引" class="headerlink" title="联合索引"></a>联合索引</h3><ul><li>联合索引是指对表上的多个列进行索引。以(a, b)为例，首先对于单列a来说，联合索引也是可以使用的，但是单独对b的查询不能使用。如果是需要对多个键进行排序，由于联合索引已经对后面的键进行了排序处理，此时使用联合索引可以减少一次排序操作。</li></ul><h3 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h3><ul><li>覆盖索引是指从辅助索引中就可以得到查询记录，而不需要查询聚集索引中的记录。辅助索引不包含整行记录的所有信息，因此其大小要远小于聚集索引，因此可以减少大量的IO操作。例如针对一些统计问题，例如count，如果表中有辅助索引，那么没有必要去查询聚集索引。</li></ul><h2 id="哈希算法"><a href="#哈希算法" class="headerlink" title="哈希算法"></a>哈希算法</h2><h3 id="自适应哈希索引"><a href="#自适应哈希索引" class="headerlink" title="自适应哈希索引"></a>自适应哈希索引</h3><ul><li>InnoDB存储引擎使用哈希算法来对字典进行查找，其冲突机制采用链表方式，哈希函数采用出发散列方式。</li><li>自适应哈希索引采用上述方式实现。自适应哈希索引经哈希函数银蛇到一个哈希表中，因此对于字典类型的查找非常快速。</li></ul><h2 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h2><h3 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h3><ul><li>全文检索通常使用倒排索引来实现。它在辅助表中存储了单词与单词自身在一个或多个文档中所在的位置之间的映射。有两种表现形式：<ul><li>inverted file index，{单词，单词所在的文档ID}</li><li>full inverted index，{单词，(单词所在文档ID，在文档中的具体位置)}</li></ul></li></ul><h3 id="InnoDB全文检索"><a href="#InnoDB全文检索" class="headerlink" title="InnoDB全文检索"></a>InnoDB全文检索</h3><ul><li>InnoDB存储引擎采用full inverted index 的方式实现全文检索。为了提高检索性能，共有6张辅助表，有一个全文检索索引缓存。全文检索索引缓存是一个红黑树结构，在插入数据已经更新到了对应的表时，辅助表的数据可能还没有更新，其更新数据还在全文索引缓存中。当对全文检索进行查询时，首先会将在全文索引缓存中的数据合并到辅助表中，然后在进行查询。</li></ul><h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><ul><li>每张表只能有一个全文索引。</li><li>由多页组合而成的全文索引列必须使用相同的字符集与排序规则。</li><li>不支持没有单词界定符的语言，例如中文、日语等。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> InnoDB </tag>
            
            <tag> 索引 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL技术内幕笔记0x01</title>
      <link href="/2019/09/02/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x01/"/>
      <url>/2019/09/02/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x01/</url>
      
        <content type="html"><![CDATA[<h1 id="表（二）"><a href="#表（二）" class="headerlink" title="表（二）"></a>表（二）</h1><h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><ul><li>在MySQL数据库中，视图是一个命名的虚表，它由一个SQL查询来定义，可以当作表使用。与持久表不同的是，视图中的入局没有实际的物理存储。</li></ul><h3 id="视图的作用"><a href="#视图的作用" class="headerlink" title="视图的作用"></a>视图的作用</h3><ul><li><p>视图的主要用途之一是被用作一个抽象装置，特别是对于一些应用程序，程序本身不需要关心基表的结构，只需要按照视图的定义来取数据或更新数据，因此，视图同时在一定程度上起到一个安全层的作用。</p></li><li><p>用户可以对某些视图进行更新操作，一般称可以进行更新操作的视图为可更新视图。如果加上with check option选项，MySQL数据库会对更新视图插入的数据进行检查，对于不满足视图定义条件的插入会抛出一个异常，不允许视图中数据更新。</p></li></ul><h2 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h2><ul><li>分区的过程是将一个表或索引分解为多个更小、更可管理的部分。就访问数据库而言，从逻辑上讲，只有一个表或一个索引，但是在物理上这个表或索引可能由数十个物理分区组成。每个分区都是独立的对象，可以独自处理，也可以作为一个更大的对象的一部分进行处理。</li><li>水平分区是指将同一表中不同行的记录分配到不同的物理文件中，垂直分区是指将同一表中不同列的记录分配到不同的物理文件中。MySQL数据库支持的分区类型为水平分区，不支持垂直分区。</li><li>局部分区索引是指一个分区中既存放了数据又存放了索引。与之相对的是全局分区，数据存放在各个分区中，但是所有数据的索引放在一个对象中。MySQL的分区是局部分区索引。</li><li>分区主要用于数据库高可用性的管理。</li><li>不论创建何种类型的分区，如果表中存在主键或唯一索引时，分区列必须是唯一索引的一个组成部分。如果建表时没有指定主键，唯一索引，可以指定任何一个列为分区列。</li></ul><h3 id="分区类型"><a href="#分区类型" class="headerlink" title="分区类型"></a>分区类型</h3><h4 id="range分区"><a href="#range分区" class="headerlink" title="range分区"></a>range分区</h4><ul><li>基于属于一个给定连续区间的列值对行数据进行分区。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token keyword">partition</span> <span class="token keyword">by</span> range<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> p0 <span class="token keyword">values</span> less than <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">partition</span> p1 <span class="token keyword">values</span> less than <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="list分区"><a href="#list分区" class="headerlink" title="list分区"></a>list分区</h4><ul><li>同range分区，只是list分区面向的是离散值。如果插入的值不在分区定义中，MySQL数据库会抛出异常。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span><span class="token number">a</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token number">b</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token keyword">partition</span> <span class="token keyword">by</span> list<span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> p0 <span class="token keyword">values</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">partition</span> p1 <span class="token keyword">values</span> <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="hash分区"><a href="#hash分区" class="headerlink" title="hash分区"></a>hash分区</h4><ul><li>根据用户自定义的表达式的返回值来进行分区，返回值不能为负数。此外还需要指定分区数量。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span><span class="token number">a</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token number">b</span> <span class="token keyword">datetime</span><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">hash</span> <span class="token punctuation">(</span>year<span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>partitions <span class="token number">4</span><span class="token punctuation">;</span></code></pre><h4 id="key分区"><a href="#key分区" class="headerlink" title="key分区"></a>key分区</h4><ul><li>使用MySQL数据库提供的函数进行分区。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span><span class="token number">a</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token number">b</span> <span class="token keyword">datetime</span><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token keyword">partition</span> <span class="token keyword">by</span> <span class="token keyword">key</span><span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">)</span>partitions <span class="token number">4</span><span class="token punctuation">;</span></code></pre><h4 id="columns分区"><a href="#columns分区" class="headerlink" title="columns分区"></a>columns分区</h4><ul><li>可以直接使用非整型的数据进行分区，分区根据类型直接比较而得。支持的类型有所有整数类型（int、smallint、tinyint、bigint），日期类型（date、datetime），字符串类型（char、varchar、binary、varbinary）。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t <span class="token punctuation">(</span><span class="token number">a</span> <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token number">b</span> <span class="token keyword">datetime</span><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token keyword">partition</span> <span class="token keyword">by</span> range <span class="token keyword">columns</span><span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">partition</span> p0 <span class="token keyword">values</span> less than<span class="token punctuation">(</span><span class="token string">'2009-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">partition</span> p1 <span class="token keyword">values</span> less than<span class="token punctuation">(</span><span class="token string">'2010-01-01'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="子分区"><a href="#子分区" class="headerlink" title="子分区"></a>子分区</h3><ul><li>子分区是在分区的基础上再进行分区，有时也称这种分区为复合分区。MySQL数据库允许在range和list分区上再进行hash或key分区。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> ts <span class="token punctuation">(</span>    <span class="token number">a</span> <span class="token keyword">int</span><span class="token punctuation">,</span>     <span class="token number">b</span> <span class="token keyword">date</span><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span><span class="token keyword">partition</span> <span class="token keyword">by</span> range<span class="token punctuation">(</span>year<span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>subpartition <span class="token keyword">by</span> <span class="token keyword">hash</span><span class="token punctuation">(</span>to_days<span class="token punctuation">(</span><span class="token number">b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>subpartitions <span class="token number">2</span> <span class="token punctuation">(</span>    <span class="token keyword">partition</span> p0 <span class="token keyword">values</span> less than <span class="token punctuation">(</span><span class="token number">1990</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">partition</span> p1 <span class="token keyword">values</span> less than <span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token keyword">partition</span> p2 <span class="token keyword">values</span> less than maxvalue<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="分区中的null值"><a href="#分区中的null值" class="headerlink" title="分区中的null值"></a>分区中的null值</h3><ul><li>MySQL数据库总是认为null值小于任何一个非null值。</li><li>对于range分区，如果向分区列插入了null值，则MySQL数据库会将该值放入最左边的分区。</li><li>在list分区中使用null值，必须显式指定在哪个分区放入null值，否则会报错。</li><li>hash和key分区的任何分区函数都会将含有null值的记录都返回0。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> InnoDB </tag>
            
            <tag> 表 </tag>
            
            <tag> 视图 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>尝试使用GitHub-Actions自动部署Hexo</title>
      <link href="/2019/08/28/%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8GitHub-Actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo/"/>
      <url>/2019/08/28/%E5%B0%9D%E8%AF%95%E4%BD%BF%E7%94%A8GitHub-Actions%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo/</url>
      
        <content type="html"><![CDATA[<h1 id="尝试使用GitHub-Actions自动部署Hexo"><a href="#尝试使用GitHub-Actions自动部署Hexo" class="headerlink" title="尝试使用GitHub Actions自动部署Hexo"></a>尝试使用GitHub Actions自动部署Hexo</h1><p><a href="https://gythialy.github.io/" target="_blank" rel="noopener">参考链接</a>。</p><ul><li>生成ssh部署公私钥</li></ul><pre class=" language-shell"><code class="language-shell">ssh-keygen</code></pre><ul><li>为Page仓库添加公钥：<ul><li>Github：在<code>仓库/Settings/Deploy keys</code>中添加，授予写权限</li><li>Coding：在<code>仓库/设置/部署公钥</code>中添加，授予写权限</li></ul></li><li>为源码仓库添加私钥：<ul><li>Github：在<code>仓库/Settings/Secrets</code>中添加，注意记录名称。这个功能可以放一些隐私内容，包括私钥、token、密码等等。</li></ul></li><li>编写<code>workflow</code>，文件位置<code>.github/workflows/deploy.yml</code></li></ul><pre class=" language-yml"><code class="language-yml">name: Node CIon: [push]jobs:  build:    runs-on: ubuntu-latest    strategy:      matrix:        node-version: [10.x]    steps:    - uses: actions/checkout@v1    - name: Use Node.js 10.x      uses: actions/setup-node@v1      with:        node-version: '10.x'    - name: env prepare      env:        ACTIONS_PRI: ${{secrets.ACTIONS_PRI}}      run: |        mkdir -p ~/.ssh/        echo "$ACTIONS_PRI" > ~/.ssh/id_rsa        chmod 600 ~/.ssh/id_rsa        ssh-keyscan github.com >> ~/.ssh/known_hosts        ssh-keyscan git.coding.net >> ~/.ssh/known_hosts        git config --global user.name 'SinLapis'        git config --global user.email 'stradust0001@gmail.com'        npm i -g hexo-cli        npm install hexo-renderer-jade hexo-renderer-stylus --save        npm i    - name: gen      run: |        hexo g -d</code></pre><p>多部署注意把域名加入<code>~/.ssh/known_hosts</code>，否则会部署失败。</p>]]></content>
      
      
      <categories>
          
          <category> 博客 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CI/CD </tag>
            
            <tag> GitHub </tag>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MySQL技术内幕笔记0x00</title>
      <link href="/2019/08/28/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2019/08/28/MySQL%E6%8A%80%E6%9C%AF%E5%86%85%E5%B9%95%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="表（一）"><a href="#表（一）" class="headerlink" title="表（一）"></a>表（一）</h1><h2 id="索引组织表"><a href="#索引组织表" class="headerlink" title="索引组织表"></a>索引组织表</h2><ul><li>在InnoDB存储引擎中，表都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表。如果在创建表时没有显式地指定主键，则InnoDB会按以下方式选择或创建主键：<ul><li>首先判断表中是否有非空的唯一索引，如果有则该列为主键。该方式选择的根据是定义索引的顺序，而不是建表时列的顺序。</li><li>否则，InnoDB存储引擎会自动创建一个6字节大小的指针。</li></ul></li></ul><h2 id="InnoDB逻辑存储结构"><a href="#InnoDB逻辑存储结构" class="headerlink" title="InnoDB逻辑存储结构"></a>InnoDB逻辑存储结构</h2><ul><li>从InnoDB存储引擎的逻辑存储结构看，所有数据都被逻辑地存放在一个空间中，称之为表空间。表空间又由段、区、页组成。</li><li>表空间可以看作是InnoDB存储引擎逻辑结构的最高层 ，所有数据都存放在表空间中。</li><li>常见的段有数据段、索引段、回滚段等。数据段即为B+树的叶子节点，索引段为B+树的非叶子节点。</li><li>区是由连续页组成的空间，在任何情况下每个区的大小都为1MB。为了保证区中页的连续性，InnoDB存储引擎一次从磁盘中申请4~5个区。在默认情况下，InnoDB存储引擎页大小为16KB，即一个区中一共有64个连续的页。</li><li>页是InnoDB磁盘管理的最小单位。</li></ul><h2 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h2><h3 id="数据完整性"><a href="#数据完整性" class="headerlink" title="数据完整性"></a>数据完整性</h3><ul><li>关系性数据库和文件系统的一个不同点是，关系数据库本身能保证存储数据的完整性，不需要应用程序的控制，而文件系统一般需要在程序端进行控制。</li><li>一般来说，数据完整性有以下三种形式：<ul><li>实体完整性保证表中有一个主键，可以通过定义Primary Key或Unique Key约束或者定义一个触发器来保证实体的完整性。</li><li>域完整性保证数据每列的值满足特定的条件，可以选择合适的数据类型确保一个入局值满足特定条件，使用外键约束，编写触发器，或者考虑DEFAULT约束。</li><li>参照完整性保证两张表之间的关系。可以使用外键以强制参照完整性，也可以使用触发器。</li></ul></li><li>InnoDB存储引擎提供了以下几种约束：primary key、unique key、foreign key、default、not null</li></ul><h3 id="约束的创建"><a href="#约束的创建" class="headerlink" title="约束的创建"></a>约束的创建</h3><ul><li>约束的创建有两种方式：<ul><li>表建立时就进行约束定义</li><li>利用alter table命令来进行创建约束</li></ul></li><li>对于主键约束而言，其默认约束名为primary。对于unique key约束而言，默认约束名和列名一样，也可以人为指定名字。</li></ul><h3 id="约束和索引的区别"><a href="#约束和索引的区别" class="headerlink" title="约束和索引的区别"></a>约束和索引的区别</h3><ul><li>当用户创建了一个唯一索引就创建了一个唯一的约束。约束偏向于一个逻辑概念，用来保证数据完整性，而索引是一个数据结构，既有逻辑上的概念，在数据库中还代表着物理存储方式。</li></ul><h3 id="对错误数据的约束"><a href="#对错误数据的约束" class="headerlink" title="对错误数据的约束"></a>对错误数据的约束</h3><ul><li>在某些魔神设置下，MySQL数据库允许非法的或者不正确的数据插入或更新，又或者可以在数据库内部将其转化为一个合法的值。</li></ul><h3 id="触发器约束"><a href="#触发器约束" class="headerlink" title="触发器约束"></a>触发器约束</h3><ul><li>触发器的作用是在执行insert、delete、update命令之前或之后自动调用SQL命令或存储过程。最多可以为一个表建立6个触发器，即分别为insert、update、delete的before和after各定义一个。当前MySQL数据库只支持for each row的 触发方式，即按每行记录进行触发。</li><li>通过触发器，用户可以实现MySQL数据库本身并不支持的一些特性。</li></ul><pre class=" language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> user_cash <span class="token punctuation">(</span>    user_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">,</span>    cash <span class="token keyword">int</span> unsigned <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token punctuation">`</span>user_cash<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>cash<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"># 非正常行为</span><span class="token keyword">update</span> <span class="token punctuation">`</span>user_cash<span class="token punctuation">`</span> <span class="token keyword">set</span> <span class="token punctuation">`</span>cash<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>cash<span class="token punctuation">`</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true"># 添加触发器和错误日志</span><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token punctuation">`</span>user_cash_err_log<span class="token punctuation">`</span> <span class="token punctuation">(</span>    user_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">,</span>    old_cash <span class="token keyword">int</span> unsigned <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">,</span>    new_cash <span class="token keyword">int</span> unsigned <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token punctuation">,</span>    <span class="token keyword">user</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    time <span class="token keyword">datetime</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">create</span> <span class="token keyword">trigger</span> tgr_user_cash_update before <span class="token keyword">update</span> <span class="token keyword">on</span> <span class="token punctuation">`</span>user_cash<span class="token punctuation">`</span>    <span class="token keyword">for each row</span>    <span class="token keyword">begin</span>        <span class="token keyword">if</span> new<span class="token punctuation">.</span><span class="token punctuation">`</span>cash<span class="token punctuation">`</span> <span class="token operator">-</span> old<span class="token punctuation">.</span><span class="token punctuation">`</span>cash<span class="token punctuation">`</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token keyword">then</span>            <span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token punctuation">`</span>user_cash_err_log<span class="token punctuation">`</span>            <span class="token keyword">select</span> old<span class="token punctuation">.</span><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span><span class="token punctuation">,</span> old<span class="token punctuation">.</span><span class="token punctuation">`</span>cash<span class="token punctuation">`</span><span class="token punctuation">,</span> new<span class="token punctuation">.</span><span class="token punctuation">`</span>cash<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token keyword">USER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">set</span> new<span class="token punctuation">.</span><span class="token punctuation">`</span>cash<span class="token punctuation">`</span> <span class="token operator">=</span> old<span class="token punctuation">.</span><span class="token punctuation">`</span>cash<span class="token punctuation">`</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>    <span class="token keyword">end</span><span class="token punctuation">;</span></code></pre><pre class=" language-sql"><code class="language-sql"><span class="token comment" spellcheck="true"># 再次尝试非正常行为</span><span class="token keyword">update</span> <span class="token punctuation">`</span>user_cash<span class="token punctuation">`</span> <span class="token keyword">set</span> <span class="token punctuation">`</span>cash<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token punctuation">`</span>cash<span class="token punctuation">`</span> <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token punctuation">`</span>user_id<span class="token punctuation">`</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_cash_err_log<span class="token punctuation">;</span><span class="token comment" spellcheck="true"># 1    1020    1040    root@localhost    2019-08-29 10:06:27</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> user_cash<span class="token punctuation">;</span><span class="token comment" spellcheck="true"># 1    1020</span></code></pre><h3 id="外键约束"><a href="#外键约束" class="headerlink" title="外键约束"></a>外键约束</h3><ul><li>一般称被引用表为父表，引用的表称为子表。外键定义时的on delete和on update表示在对父表进行delete和update操作时，对子表所做的操作。</li><li>可定义的子表操包括cascade、set null、no action、restrict。cascade（级联）表示当父级发生delete或update操作时，对相应的子表中的数据也进行delete或update操作。set null表示父表发生delete或update操作时，相应的子表中的数据被更新为null值，但是子表中相对应的列必须允许为null值。no action和restrict在MySQL中等价，都表示父表发生delete或update操作时抛出错误，不允许这类操作发生。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> InnoDB </tag>
            
            <tag> 表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-矩阵中的路径</title>
      <link href="/2019/08/27/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84/"/>
      <url>/2019/08/27/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84/</url>
      
        <content type="html"><![CDATA[<h1 id="矩阵中的路径"><a href="#矩阵中的路径" class="headerlink" title="矩阵中的路径"></a>矩阵中的路径</h1><p>请设计一个函数，用来判断在一个矩阵中是否存在一条包含某字符串所有字符的路径。路径可以从矩阵中的任意一个格子开始，每一步可以在矩阵中向左，向右，向上，向下移动一个格子。如果一条路径经过了矩阵中的某一个格子，则该路径不能再进入该格子。 例如 a b c e s f c s a d e e 矩阵中包含一条字符串”bccced”的路径，但是矩阵中不包含”abcb”路径，因为字符串的第一个字符b占据了矩阵中的第一行第二个格子之后，路径不能再次进入该格子。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> x<span class="token punctuation">;</span>    <span class="token keyword">int</span> y<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> visited <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>x <span class="token operator">=</span> x<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>y <span class="token operator">=</span> y<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span>Object obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> x <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Point<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> y <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Point<span class="token punctuation">)</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> ce<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetMB</span><span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mb<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bs <span class="token operator">:</span> mb<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> b <span class="token operator">:</span> bs<span class="token punctuation">)</span> <span class="token punctuation">{</span>                b <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasPath</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> matrix<span class="token punctuation">,</span> <span class="token keyword">int</span> rows<span class="token punctuation">,</span> <span class="token keyword">int</span> cols<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> str<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> firstRow <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> firstCol <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">char</span><span class="token punctuation">[</span>rows<span class="token punctuation">]</span><span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">boolean</span><span class="token punctuation">[</span>rows<span class="token punctuation">]</span><span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token function">resetMB</span><span class="token punctuation">(</span>mb<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            mc<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">char</span><span class="token punctuation">[</span>cols<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> cols<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                mc<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> matrix<span class="token punctuation">[</span>i <span class="token operator">*</span> cols <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 先定位第一个字符</span>            outer<span class="token operator">:</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> firstRow <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> firstCol <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> firstRow<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//[1]</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> firstCol <span class="token operator">&lt;</span> cols<span class="token punctuation">;</span> firstCol<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>matrix<span class="token punctuation">[</span>firstRow <span class="token operator">*</span> cols <span class="token operator">+</span> firstCol<span class="token punctuation">]</span> <span class="token operator">==</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">break</span> outer<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstRow <span class="token operator">>=</span> rows<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            Stack<span class="token operator">&lt;</span>Point<span class="token operator">></span> route <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            route<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>firstRow<span class="token punctuation">,</span> firstCol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> strIndex <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>strIndex <span class="token operator">>=</span> str<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//[2]</span>            <span class="token function">resetMB</span><span class="token punctuation">(</span>mb<span class="token punctuation">)</span><span class="token punctuation">;</span>            mb<span class="token punctuation">[</span>firstRow<span class="token punctuation">]</span><span class="token punctuation">[</span>firstCol<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 在定位周围找下一个字符</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>route<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Point current <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> visitOri <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>                        current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>current<span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                mc<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> str<span class="token punctuation">[</span>strIndex<span class="token punctuation">]</span>                <span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//0</span>                    route<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    route<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    visitOri <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    strIndex<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>                        current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> rows <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>current<span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                mc<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">==</span> str<span class="token punctuation">[</span>strIndex<span class="token punctuation">]</span>                <span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//1</span>                    route<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> current<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    route<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    visitOri <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                    mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    strIndex<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>                        current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>current<span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                mc<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> str<span class="token punctuation">[</span>strIndex<span class="token punctuation">]</span>                <span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//2</span>                    route<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    route<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    visitOri <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    strIndex<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>                        current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> cols <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>current<span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                <span class="token operator">!</span>mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>                                mc<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> str<span class="token punctuation">[</span>strIndex<span class="token punctuation">]</span>                <span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">//3</span>                    route<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>current<span class="token punctuation">.</span>x<span class="token punctuation">,</span> current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    route<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visited<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    visitOri <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    mb<span class="token punctuation">[</span>current<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>current<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                    strIndex<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    Point p <span class="token operator">=</span> route<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    mb<span class="token punctuation">[</span>p<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>p<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                    strIndex<span class="token operator">--</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>strIndex <span class="token operator">>=</span> str<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>visitOri <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> current<span class="token punctuation">.</span>visited<span class="token punctuation">[</span>visitOri<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>firstCol <span class="token operator">>=</span> cols <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//[1]</span>                firstCol <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                firstRow<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                firstCol<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：先找开始位置，然后在周围找下一个。要保存两种状态，一是当前已经选择的位置（由<code>boolean</code>二维数组保存），二是回溯失败的状态（由<code>Point</code>对象保存）。注意：如果要找下一个初始位置，[1]处要对初始坐标进行处理，包括移动到下一个坐标和一行循环完成置列号为0（因为要保存之前的状态，所以不能在循环列时置0）；[2]处防止不需要进入循环时要返回<code>true</code>的情况。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 回溯法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HeadFirst设计模式笔记0x00</title>
      <link href="/2019/08/27/HeadFirst%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2019/08/27/HeadFirst%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h1><ul><li>观察者模式定义对象之间的一对多依赖，这样一来，当一个对象改变状态时，它的所有依赖者都会收到通知并自动更新。</li></ul><h2 id="松耦合"><a href="#松耦合" class="headerlink" title="松耦合"></a>松耦合</h2><ul><li>当两个对象之间松耦合，它们依然可以交互，但是互相不关心对方的实现。换句话说，它们各自可以独立复用，在保证交互接口不变的条件下可以修改各自的实现。</li><li>观察者模式实现了主题和观察者之间松耦合的对象设计。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> 观察者模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x0b</title>
      <link href="/2019/08/25/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x0b/"/>
      <url>/2019/08/25/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x0b/</url>
      
        <content type="html"><![CDATA[<h1 id="面向对象和函数式编程的混合：Java-8和Scala的比较"><a href="#面向对象和函数式编程的混合：Java-8和Scala的比较" class="headerlink" title="面向对象和函数式编程的混合：Java 8和Scala的比较"></a>面向对象和函数式编程的混合：Java 8和Scala的比较</h1><h2 id="Java-与-Scala的混合编程"><a href="#Java-与-Scala的混合编程" class="headerlink" title="Java 与 Scala的混合编程"></a><em>Java 与 Scala的混合编程</em></h2><p><a href="https://www.cnblogs.com/yjmyzz/p/4694219.html" target="_blank" rel="noopener">参考</a>。使用Maven生成项目，<code>pom.xml</code>文件如下：</p><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.bigmt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mjns<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">></span></span>11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">></span></span>11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">></span></span>${maven.compiler.source}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.scala-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>scala-library<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.13.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.scala-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>scala-compiler<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.13.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.scala-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>scala-reflect<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.13.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.maven.plugins<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-compiler-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>release</span><span class="token punctuation">></span></span>11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>release</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.scala-tools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>maven-scala-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.15.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>compile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">></span></span>testCompile<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">></span></span>                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">></span></span>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">></span></span>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">></span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">></span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></code></pre><p><img src="/images/2019-08-25_111145.png" alt="项目结构"></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Main.java</span><span class="token keyword">package</span> org<span class="token punctuation">.</span>bigmt<span class="token punctuation">.</span>mjns<span class="token punctuation">;</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ScalaMain scalaMain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ScalaMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        scalaMain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">// ScalaMain.scala</span><span class="token keyword">package</span> org<span class="token punctuation">.</span>bigmt<span class="token punctuation">.</span>mjns<span class="token keyword">class</span> ScalaMain <span class="token punctuation">{</span>  <span class="token keyword">def</span> entry<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> n<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">2</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      println<span class="token punctuation">(</span>s<span class="token string">"Hello ${n} bottles of beer"</span><span class="token punctuation">)</span>      n <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="Scala简介"><a href="#Scala简介" class="headerlink" title="Scala简介"></a>Scala简介</h2><h3 id="你好，啤酒"><a href="#你好，啤酒" class="headerlink" title="你好，啤酒"></a>你好，啤酒</h3><pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">// Scala</span><span class="token number">2</span> to <span class="token number">6</span> foreach <span class="token punctuation">{</span>n <span class="token keyword">=></span> println<span class="token punctuation">(</span>s<span class="token string">"Hello ${n} bottles of beer"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Java</span>IntStream<span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello "</span> <span class="token operator">+</span> n <span class="token operator">+</span> <span class="token string">" bottles of beer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="基础数据结构"><a href="#基础数据结构" class="headerlink" title="基础数据结构"></a>基础数据结构</h3><h4 id="创建集合"><a href="#创建集合" class="headerlink" title="创建集合"></a>创建集合</h4><pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">// Scala</span><span class="token keyword">val</span> authorsToAge <span class="token operator">=</span> Map<span class="token punctuation">(</span><span class="token string">"Raoul"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">"Mario"</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token string">"Alan"</span> <span class="token operator">-</span><span class="token operator">></span><span class="token number">53</span><span class="token punctuation">)</span><span class="token keyword">val</span> authors <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token string">"Raoul"</span><span class="token punctuation">,</span> <span class="token string">"Mario"</span><span class="token punctuation">,</span> <span class="token string">"Alan"</span><span class="token punctuation">)</span><span class="token keyword">val</span> numbers <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span></code></pre><h4 id="不可变"><a href="#不可变" class="headerlink" title="不可变"></a>不可变</h4><ul><li>Scala中不可变的集合是持久化的，更新一个Scala集合会生成一个新的集合，这个新的集合和之前版本的集合共享大部分内容，最终的结果是数据尽可能地实现了持久化。</li></ul><pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">// Scala</span><span class="token keyword">val</span> numbers <span class="token operator">=</span> Set<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">val</span> newNumbers <span class="token operator">=</span> numbers <span class="token operator">+</span> <span class="token number">8</span>println<span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>println<span class="token punctuation">(</span>newNumbers<span class="token punctuation">)</span><span class="token comment" spellcheck="true">/* Output:Set(2, 5, 3)Set(2, 5, 3, 8)*/</span></code></pre><h4 id="使用集合"><a href="#使用集合" class="headerlink" title="使用集合"></a>使用集合</h4><pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">// Scala</span><span class="token keyword">val</span> fileLine <span class="token operator">=</span> List<span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"test for scala"</span><span class="token punctuation">,</span> <span class="token string">"no vac"</span><span class="token punctuation">,</span> <span class="token string">"yeeeeeeees man"</span><span class="token punctuation">)</span><span class="token keyword">val</span> linesLongUpper <span class="token operator">=</span> fileLine<span class="token punctuation">.</span>par<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>_<span class="token punctuation">.</span>length<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map<span class="token punctuation">(</span>_<span class="token punctuation">.</span>toUpperCase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>println<span class="token punctuation">(</span>linesLongUpper<span class="token punctuation">)</span><span class="token comment" spellcheck="true">/* OutputList(TEST FOR SCALA, YEEEEEEEES MAN)*/</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Scala </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
            <tag> Scala </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-旋转数组的最小数字</title>
      <link href="/2019/08/24/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%97%8B%E8%BD%AC%E6%95%B0%E7%BB%84%E7%9A%84%E6%9C%80%E5%B0%8F%E6%95%B0%E5%AD%97/"/>
      <url>/2019/08/24/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%97%8B%E8%BD%AC%E6%95%B0%E7%BB%84%E7%9A%84%E6%9C%80%E5%B0%8F%E6%95%B0%E5%AD%97/</url>
      
        <content type="html"><![CDATA[<h1 id="旋转数组的最小数字"><a href="#旋转数组的最小数字" class="headerlink" title="旋转数组的最小数字"></a>旋转数组的最小数字</h1><h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q11_0</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">quickSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">></span> end<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">,</span> j <span class="token operator">=</span> end<span class="token punctuation">;</span>        <span class="token keyword">int</span> t <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j <span class="token operator">&amp;&amp;</span> t <span class="token operator">&lt;=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> j<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>                arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j <span class="token operator">&amp;&amp;</span> t <span class="token operator">></span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>                arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                j<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> start<span class="token punctuation">,</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">quickSort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="旋转数组的最小数字-1"><a href="#旋转数组的最小数字-1" class="headerlink" title="旋转数组的最小数字"></a>旋转数组的最小数字</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q11</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">minNumberInRotateArray</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> array<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>array <span class="token operator">==</span> null <span class="token operator">||</span> array<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> right <span class="token operator">=</span> array<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> mid<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mid <span class="token operator">=</span> left <span class="token operator">+</span> right <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> array<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">></span> array<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">)</span> left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>mid<span class="token punctuation">]</span> <span class="token operator">&lt;</span> array<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">)</span> right <span class="token operator">=</span> mid<span class="token punctuation">;</span>            <span class="token keyword">else</span> left<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> array<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：和书上略有不同，主要是处理相同数字上。如果<code>arr[left]</code>和<code>arr[mid]</code>相等，那么只移动<code>left</code>即可。此外，要比较<code>arr[left]</code>和<code>arr[right]</code>的大小，否则会越过最小值。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 排序 </tag>
            
            <tag> 查找 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x0a</title>
      <link href="/2019/08/24/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x0a/"/>
      <url>/2019/08/24/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x0a/</url>
      
        <content type="html"><![CDATA[<h1 id="函数式编程的技巧"><a href="#函数式编程的技巧" class="headerlink" title="函数式编程的技巧"></a>函数式编程的技巧</h1><h2 id="无处不在的函数"><a href="#无处不在的函数" class="headerlink" title="无处不在的函数"></a>无处不在的函数</h2><h3 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h3><ul><li>函数满足以下任一要求即可被称为告诫函数：<ul><li>接受至少一个函数作为参数</li><li>返回结果是一个函数</li></ul></li></ul><pre class=" language-java"><code class="language-java">Comparator<span class="token operator">&lt;</span>Apple<span class="token operator">></span> c <span class="token operator">=</span> <span class="token function">comparing</span><span class="token punctuation">(</span>Apple<span class="token operator">:</span><span class="token operator">:</span>getWeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="科里化"><a href="#科里化" class="headerlink" title="科里化"></a>科里化</h3><ul><li>科里化是指一个能将具有<code>n</code>个参数的函数转化为使用<code>n</code>个参数中部分参数的函数，该函数的返回值是另一个函数，参数为转化的函数未使用的参数，例如<code>f(x, y) =  (g(x))(y)</code></li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 摄氏度转华氏度</span><span class="token keyword">static</span> DoubleUnaryOperator <span class="token function">curriedConverter</span><span class="token punctuation">(</span><span class="token keyword">double</span> f<span class="token punctuation">,</span> <span class="token keyword">double</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> x <span class="token operator">*</span> f <span class="token operator">+</span> b<span class="token punctuation">;</span><span class="token punctuation">}</span>DoubleUnaryOperator convertCtoF <span class="token operator">=</span> <span class="token function">curriedConverter</span><span class="token punctuation">(</span><span class="token number">9.0</span><span class="token operator">/</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">double</span> c <span class="token operator">=</span> <span class="token function">convertCotF</span><span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>一个函数使用所有参数仅有部分被传递时，通常称这个函数是部分应用的。</li></ul><h2 id="延迟计算"><a href="#延迟计算" class="headerlink" title="延迟计算"></a>延迟计算</h2><h3 id="自定义延迟列表"><a href="#自定义延迟列表" class="headerlink" title="自定义延迟列表"></a>自定义延迟列表</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">MyList</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T <span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span> <span class="token keyword">boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">default</span> <span class="token keyword">public</span> MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>Predicate<span class="token operator">&lt;</span>T<span class="token operator">></span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span>                p<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span>                        <span class="token keyword">new</span> <span class="token class-name">LazyList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span>                        <span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">MyLinkedList</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">MyList</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> T head<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> tail<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">MyLinkedList</span><span class="token punctuation">(</span>T head<span class="token punctuation">,</span> MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> tail<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> T <span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> head<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> tail<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Empty</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">MyList</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> T <span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">LazyList</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">implements</span> <span class="token class-name">MyList</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> T head<span class="token punctuation">;</span>    <span class="token keyword">final</span> Supplier<span class="token operator">&lt;</span>MyList<span class="token operator">&lt;</span>T<span class="token operator">>></span> tail<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">LazyList</span><span class="token punctuation">(</span>T head<span class="token punctuation">,</span> Supplier<span class="token operator">&lt;</span>MyList<span class="token operator">&lt;</span>T<span class="token operator">>></span> tail<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>head <span class="token operator">=</span> head<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>tail <span class="token operator">=</span> tail<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> T <span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> head<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> tail<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span>Function<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">>></span> findPrices<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>findPrices<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"Fallout New Vegas"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done in "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">" msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> MyList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> <span class="token function">primes</span><span class="token punctuation">(</span>MyList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> numbers<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>                numbers<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">primes</span><span class="token punctuation">(</span>                        numbers<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>n <span class="token operator">-</span><span class="token operator">></span> n <span class="token operator">%</span> numbers<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>                <span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> LazyList<span class="token operator">&lt;</span>Integer<span class="token operator">></span> <span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">from</span><span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">printAll</span><span class="token punctuation">(</span>MyList<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span><span class="token function">head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            list <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">tail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token function">printAll</span><span class="token punctuation">(</span><span class="token function">primes</span><span class="token punctuation">(</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><del>没看懂</del></p><h2 id="模式匹配"><a href="#模式匹配" class="headerlink" title="模式匹配"></a>模式匹配</h2><ul><li>Java没有原生支持模式配配匹配，只能用<code>if</code>进行模拟。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
            <tag> 函数式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-斐波那契数列</title>
      <link href="/2019/08/23/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/"/>
      <url>/2019/08/23/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%96%90%E6%B3%A2%E9%82%A3%E5%A5%91%E6%95%B0%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1 id="斐波那契数列"><a href="#斐波那契数列" class="headerlink" title="斐波那契数列"></a>斐波那契数列</h1><p>要求输入一个整数n，请你输出斐波那契数列的第n项（从0开始，第0项为0）。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q10</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> n<span class="token punctuation">;</span>        <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> b2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>            current <span class="token operator">=</span> b1 <span class="token operator">+</span> b2<span class="token punctuation">;</span>            b2 <span class="token operator">=</span> b1<span class="token punctuation">;</span>            b1 <span class="token operator">=</span> current<span class="token punctuation">;</span>            i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> current<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：动态规划，需要前两个结果。</li></ul><h2 id="跳台阶"><a href="#跳台阶" class="headerlink" title="跳台阶"></a>跳台阶</h2><p>一只青蛙一次可以跳上1级台阶，也可以跳上2级。求该青蛙跳上一个n级的台阶总共有多少种跳法（先后次序不同算不同的结果）。</p><pre class=" language-JAVA"><code class="language-JAVA">public class Q10_2 {    public int JumpFloor(int target) {        if (target < 2) return 1;        if (target == 2) return 2;        int b1 = 2, b2 = 1;        int current = 1, i = 3;        while (i <= target) {            current = b1 + b2;            b2 = b1;            b1 = current;            i++;        }        return current;    }}</code></pre><ul><li>思路：同上。</li></ul><h2 id="变态跳台阶"><a href="#变态跳台阶" class="headerlink" title="变态跳台阶"></a>变态跳台阶</h2><p>一只青蛙一次可以跳上1级台阶，也可以跳上2级……它也可以跳上n级。求该青蛙跳上一个n级的台阶总共有多少种跳法。</p><ul><li>思路：这个是数学题吧？可以把问题转化为青蛙可以以<code>1-n</code>次跳上台阶，求各种次数跳法之和。可以是往<code>n</code>个台阶之间插入挡板，有<code>n-1</code>个空，可插入<code>0~n-1</code>个挡板，则共有<code>C(n-1, 0) + C(n-1, 1) + C(n-1, 2) + ... +C(n-1, n-1) = 2^(n-1)</code>种方法。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 动态规划 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-用两个栈实现队列</title>
      <link href="/2019/08/23/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E7%94%A8%E4%B8%A4%E4%B8%AA%E6%A0%88%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/"/>
      <url>/2019/08/23/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E7%94%A8%E4%B8%A4%E4%B8%AA%E6%A0%88%E5%AE%9E%E7%8E%B0%E9%98%9F%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1 id="用两个栈实现队列"><a href="#用两个栈实现队列" class="headerlink" title="用两个栈实现队列"></a>用两个栈实现队列</h1><p>用两个栈来实现一个队列，完成队列的<code>Push</code>和<code>Pop</code>操作。 队列中的元素为<code>int</code>类型。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q9</span> <span class="token punctuation">{</span>    Stack<span class="token operator">&lt;</span>Integer<span class="token operator">></span> stack1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Stack<span class="token operator">&lt;</span>Integer<span class="token operator">></span> stack2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">int</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>        stack1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fillStack2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack1<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>stack1<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>stack2<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">fillStack2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> stack2<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：一个栈用来入队，另一个栈用来出队。如果出队的栈为空，需要把入队的栈的值导入出队的栈。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 栈 </tag>
            
            <tag> 队列 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-二叉树的下一个结点</title>
      <link href="/2019/08/23/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E4%B8%8B%E4%B8%80%E4%B8%AA%E7%BB%93%E7%82%B9/"/>
      <url>/2019/08/23/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E4%BA%8C%E5%8F%89%E6%A0%91%E7%9A%84%E4%B8%8B%E4%B8%80%E4%B8%AA%E7%BB%93%E7%82%B9/</url>
      
        <content type="html"><![CDATA[<h1 id="二叉树的下一个结点"><a href="#二叉树的下一个结点" class="headerlink" title="二叉树的下一个结点"></a>二叉树的下一个结点</h1><p>给定一个二叉树和其中的一个结点，请找出中序遍历顺序的下一个结点并且返回。注意，树中的结点不仅包含左右子结点，同时包含指向父结点的指针。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TreeLinkNode</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> val<span class="token punctuation">;</span>    TreeLinkNode left <span class="token operator">=</span> null<span class="token punctuation">;</span>    TreeLinkNode right <span class="token operator">=</span> null<span class="token punctuation">;</span>    TreeLinkNode next <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token function">TreeLinkNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q8</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> TreeLinkNode <span class="token function">GetNext</span><span class="token punctuation">(</span>TreeLinkNode pNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pNode <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pNode<span class="token punctuation">.</span>right <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            TreeLinkNode l <span class="token operator">=</span> pNode<span class="token punctuation">.</span>right<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>l<span class="token punctuation">.</span>left <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                l <span class="token operator">=</span> l<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> l<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        TreeLinkNode t <span class="token operator">=</span> pNode<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>next <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>next<span class="token punctuation">.</span>left <span class="token operator">==</span> t<span class="token punctuation">)</span> <span class="token keyword">return</span> t<span class="token punctuation">.</span>next<span class="token punctuation">;</span>            t <span class="token operator">=</span> t<span class="token punctuation">.</span>next<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：分类讨论。如果给出节点有右孩子，从右孩子开始一直访问其左孩子，直到当前节点没有左孩子，返回当前节点。如果给出节点没有右孩子，那么如果它是其父节点的左孩子，则返回其父节点。如果不是其父节点的左孩子，则继续找父节点的父节点，直到当前节点是父节点的左孩子，返回当前节点的父节点。如果找到根节点，那么给出节点没有下一个节点。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-重建二叉树</title>
      <link href="/2019/08/22/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E9%87%8D%E5%BB%BA%E4%BA%8C%E5%8F%89%E6%A0%91/"/>
      <url>/2019/08/22/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E9%87%8D%E5%BB%BA%E4%BA%8C%E5%8F%89%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h1 id="重建二叉树"><a href="#重建二叉树" class="headerlink" title="重建二叉树"></a>重建二叉树</h1><p>输入某二叉树的前序遍历和中序遍历的结果，重建该二叉树，返回二叉树的根节点。假设输入的前序遍历和中序遍历的结果中都不含重复的数字。二叉树节点定义：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TreeNode</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>    <span class="token keyword">public</span> TreeNode left<span class="token punctuation">;</span>    <span class="token keyword">public</span> TreeNode right<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">buildTree</span><span class="token punctuation">(</span>            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preOrder<span class="token punctuation">,</span> <span class="token keyword">int</span> preStart<span class="token punctuation">,</span>            <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inOrder<span class="token punctuation">,</span> <span class="token keyword">int</span> inStart<span class="token punctuation">,</span> <span class="token keyword">int</span> inEnd<span class="token punctuation">,</span>            TreeNode current    <span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> index<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>index <span class="token operator">=</span> inStart<span class="token punctuation">;</span> index <span class="token operator">&lt;=</span> inEnd<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>inOrder<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> current<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> leftLength <span class="token operator">=</span> index <span class="token operator">-</span> inStart<span class="token punctuation">;</span>        <span class="token keyword">int</span> rightLength <span class="token operator">=</span> inEnd <span class="token operator">-</span> index<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leftLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            TreeNode left <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preOrder<span class="token punctuation">[</span>preStart <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            current<span class="token punctuation">.</span>left <span class="token operator">=</span> left<span class="token punctuation">;</span>            <span class="token function">buildTree</span><span class="token punctuation">(</span>                    preOrder<span class="token punctuation">,</span> preStart <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>                    inOrder<span class="token punctuation">,</span> index <span class="token operator">-</span> leftLength<span class="token punctuation">,</span> index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>                    left            <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>rightLength <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            TreeNode right <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preOrder<span class="token punctuation">[</span>preStart <span class="token operator">+</span> leftLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            current<span class="token punctuation">.</span>right <span class="token operator">=</span> right<span class="token punctuation">;</span>            <span class="token function">buildTree</span><span class="token punctuation">(</span>                    preOrder<span class="token punctuation">,</span> preStart <span class="token operator">+</span> leftLength <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>                    inOrder<span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> index <span class="token operator">+</span> rightLength<span class="token punctuation">,</span>                    right            <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> TreeNode <span class="token function">reConstructBinaryTree</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> preOrder<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> inOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>preOrder <span class="token operator">==</span> null <span class="token operator">||</span> preOrder<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> null<span class="token punctuation">;</span>        TreeNode root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeNode</span><span class="token punctuation">(</span>preOrder<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">buildTree</span><span class="token punctuation">(</span>                preOrder<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>                inOrder<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> inOrder<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span>                root        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> root<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：前序遍历的第一个元素就是当前树的根节点，在中序遍历中找到当前节点的位置就能算出左右序列长度，从而进行递归。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 树 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-从尾到头打印链表</title>
      <link href="/2019/08/22/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E4%BB%8E%E5%B0%BE%E5%88%B0%E5%A4%B4%E6%89%93%E5%8D%B0%E9%93%BE%E8%A1%A8/"/>
      <url>/2019/08/22/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E4%BB%8E%E5%B0%BE%E5%88%B0%E5%A4%B4%E6%89%93%E5%8D%B0%E9%93%BE%E8%A1%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="从尾到头打印链表"><a href="#从尾到头打印链表" class="headerlink" title="从尾到头打印链表"></a>从尾到头打印链表</h1><p>输入一个链表的头节点，从尾到头反过来打印出每个节点的值。链表定义如下：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>    <span class="token keyword">public</span> Node next<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>    <span class="token keyword">public</span> Node next<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token keyword">int</span> value<span class="token punctuation">,</span> Node next<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q6</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">solution</span><span class="token punctuation">(</span>Node head<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>head <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>head<span class="token punctuation">.</span>next <span class="token operator">!=</span> null<span class="token punctuation">)</span>                <span class="token function">solution</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>next<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>head<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Test</span><span class="token keyword">class</span> <span class="token class-name">Q6Test</span><span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ByteArrayOutputStream outContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ByteArrayOutputStream errContent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> PrintStream originalOut <span class="token operator">=</span> System<span class="token punctuation">.</span>out<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> PrintStream originalErr <span class="token operator">=</span> System<span class="token punctuation">.</span>err<span class="token punctuation">;</span>    <span class="token annotation punctuation">@BeforeAll</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setUpStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span><span class="token function">setOut</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span>outContent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span>errContent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@AfterAll</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">restoreStreams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span><span class="token function">setOut</span><span class="token punctuation">(</span>originalOut<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span>originalErr<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Node n1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>        Node n2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> n1<span class="token punctuation">)</span><span class="token punctuation">;</span>        Node n3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">;</span>        Node n4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> n3<span class="token punctuation">)</span><span class="token punctuation">;</span>        Node n5 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> n4<span class="token punctuation">)</span><span class="token punctuation">;</span>        Q6<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>n5<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"1 2 3 4 5 "</span><span class="token punctuation">,</span> outContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        outContent<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Q6<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">"1 "</span><span class="token punctuation">,</span> outContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        outContent<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Q6<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> outContent<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：使用栈达到先入后出的效果，同样可以使用递归。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 数据结构 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 链表 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x09</title>
      <link href="/2019/08/22/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x09/"/>
      <url>/2019/08/22/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x09/</url>
      
        <content type="html"><![CDATA[<h1 id="函数式思考"><a href="#函数式思考" class="headerlink" title="函数式思考"></a>函数式思考</h1><h2 id="实现和维护系统"><a href="#实现和维护系统" class="headerlink" title="实现和维护系统"></a>实现和维护系统</h2><h3 id="共享可变数据"><a href="#共享可变数据" class="headerlink" title="共享可变数据"></a>共享可变数据</h3><ul><li>如果一个方法既不修改它的内嵌类的状态，也不修改其他对象的状态，使用<code>return</code>返回所有的计算结果，那么称其为纯粹的或无副作用的。</li><li>副作用：是指函数效果已经超出了函数自身范畴，包括：<ul><li>除了构造器内的初始化操作，对类中数据结构的任何修改，包括字段的赋值操作</li><li>抛出一个异常</li><li>进行输入/输出操作，比如向一个文件写数据</li></ul></li></ul><h3 id="声明式编程"><a href="#声明式编程" class="headerlink" title="声明式编程"></a>声明式编程</h3><ul><li>命令式编程：描述如何做的编程风格，适合经典的面向对象编程，因为它的特点是它的指令和计算机底层的词汇非常接近，比如赋值、条件分支以及循环。</li><li>声明式编程：描述要做什么的编程风格，由程序员来制定规则，给出希望实现的目标，让系统来决定如何实现这个目标。它带来的好处非常明显，用这种方式编写的代码更加接近问题陈述。</li></ul><h2 id="什么是函数式编程"><a href="#什么是函数式编程" class="headerlink" title="什么是函数式编程"></a>什么是函数式编程</h2><h3 id="函数式Java编程"><a href="#函数式Java编程" class="headerlink" title="函数式Java编程"></a>函数式Java编程</h3><ul><li>函数式的函数或方法都只能修改本地变量。除此之外，它引用的对象都应该是不可修改的对象。</li><li>函数式的函数或方法不应该抛出任何异常。取而代之，可以使用<code>Optional&lt;T&gt;</code>。</li><li>如果函数或方法调用的库函数如果有副作用，那么必须设法隐藏这些非函数式的行为，否则就不能调用这些方法。</li></ul><h3 id="引用透明性"><a href="#引用透明性" class="headerlink" title="引用透明性"></a>引用透明性</h3><ul><li>引用透明性是指，如果一个函数只要传递同样的参数值，总是返回同样的结果，那么这个函数就是引用透明的。<code>Random#nextInt</code>就不是此类函数。在函数式编程中应该选择使用引用透明的函数。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
            <tag> 函数式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x08</title>
      <link href="/2019/08/21/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x08/"/>
      <url>/2019/08/21/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x08/</url>
      
        <content type="html"><![CDATA[<h1 id="CompletableFuture：组合异步编程（二）"><a href="#CompletableFuture：组合异步编程（二）" class="headerlink" title="CompletableFuture：组合异步编程（二）"></a>CompletableFuture：组合异步编程（二）</h1><h2 id="对多个异步任务进行流水线操作"><a href="#对多个异步任务进行流水线操作" class="headerlink" title="对多个异步任务进行流水线操作"></a>对多个异步任务进行流水线操作</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Shop</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Shop</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>1000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">calculatePrice</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> product<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 同步方法</span>    <span class="token keyword">public</span> String <span class="token function">getPrice</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">double</span> price <span class="token operator">=</span> <span class="token function">calculatePrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>       Discount<span class="token punctuation">.</span>Code code <span class="token operator">=</span> Discount<span class="token punctuation">.</span>Code<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>Discount<span class="token punctuation">.</span>Code<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s:%.2f:%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> price<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Discount</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">enum</span> Code <span class="token punctuation">{</span>        <span class="token function">NONE</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SILVER</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GOLD</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">PLATINUM</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">DIAMOND</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> percentage<span class="token punctuation">;</span>        <span class="token function">Code</span><span class="token punctuation">(</span><span class="token keyword">int</span> percentage<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>percentage <span class="token operator">=</span> percentage<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">applyDiscount</span><span class="token punctuation">(</span>Quote quote<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> quote<span class="token punctuation">.</span><span class="token function">getShopName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" price is "</span> <span class="token operator">+</span> Discount<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>quote<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quote<span class="token punctuation">.</span><span class="token function">getDiscountCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">double</span> price<span class="token punctuation">,</span> Code code<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Shop<span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> price <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> code<span class="token punctuation">.</span>percentage<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Quote</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> String shopName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">double</span> price<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Discount<span class="token punctuation">.</span>Code discountCode<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Quote</span><span class="token punctuation">(</span>String shopName<span class="token punctuation">,</span> <span class="token keyword">double</span> price<span class="token punctuation">,</span> Discount<span class="token punctuation">.</span>Code discountCode<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>shopName <span class="token operator">=</span> shopName<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>price <span class="token operator">=</span> price<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>discountCode <span class="token operator">=</span> discountCode<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Quote <span class="token function">parse</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> split <span class="token operator">=</span> s<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String shopName <span class="token operator">=</span> split<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> price <span class="token operator">=</span> Double<span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Discount<span class="token punctuation">.</span>Code discountCode <span class="token operator">=</span> Discount<span class="token punctuation">.</span>Code<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>split<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Quote</span><span class="token punctuation">(</span>shopName<span class="token punctuation">,</span> price<span class="token punctuation">,</span> discountCode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getShopName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> shopName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getPrice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> price<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Discount<span class="token punctuation">.</span>Code <span class="token function">getDiscountCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> discountCode<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BestPrice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"LetsSaveBig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"MyFavoriteShop"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BuyItAll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Steam"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Epic"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"GOG"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Taptap"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"W"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"V"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Z"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"X"</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Executor executor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>            Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>shops<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            r <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>                t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> t<span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">findPrices</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">return</span> shops<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>shop <span class="token operator">-</span><span class="token operator">></span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Quote<span class="token operator">:</span><span class="token operator">:</span>parse<span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Discount<span class="token operator">:</span><span class="token operator">:</span>applyDiscount<span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>   <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">findPricesByFuture</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>       List<span class="token operator">&lt;</span>CompletableFuture<span class="token operator">&lt;</span>String<span class="token operator">>></span> priceFuture <span class="token operator">=</span> shops<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>shop <span class="token operator">-</span><span class="token operator">></span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>future <span class="token operator">-</span><span class="token operator">></span> future<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>Quote<span class="token operator">:</span><span class="token operator">:</span>parse<span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>future <span class="token operator">-</span><span class="token operator">></span> future<span class="token punctuation">.</span><span class="token function">thenCompose</span><span class="token punctuation">(</span>quote <span class="token operator">-</span><span class="token operator">></span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span>                       <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> Discount<span class="token punctuation">.</span><span class="token function">applyDiscount</span><span class="token punctuation">(</span>quote<span class="token punctuation">)</span><span class="token punctuation">,</span> executor               <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token keyword">return</span> priceFuture<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>CompletableFuture<span class="token operator">:</span><span class="token operator">:</span>join<span class="token punctuation">)</span>               <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span>Function<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">>></span> findPrices<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>findPrices<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"Fallout New Vegas"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done in "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">" msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token function">test</span><span class="token punctuation">(</span>Main<span class="token operator">:</span><span class="token operator">:</span>findPrices<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">test</span><span class="token punctuation">(</span>Main<span class="token operator">:</span><span class="token operator">:</span>findPricesByFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output[BestPrice price is 130.6535, LetsSaveBig price is 77.87200000000001, MyFavoriteShop price is 113.27, BuyItAll price is 152.532, Steam price is 113.49600000000001, Epic price is 115.32, GOG price is 106.46, Taptap price is 142.44299999999998, W price is 104.76, V price is 132.297, Z price is 136.6575, Y price is 99.2085, X price is 95.60700000000001]Done in 26058 msecs[BestPrice price is 126.36, LetsSaveBig price is 94.728, MyFavoriteShop price is 149.43, BuyItAll price is 107.01, Steam price is 83.936, Epic price is 153.5485, GOG price is 142.53300000000002, Taptap price is 99.2275, W price is 97.064, V price is 104.976, Z price is 87.40549999999999, Y price is 138.051, X price is 140.409]Done in 2007 msecs*/</span></code></pre><ul><li><code>thenApply</code>：支持可以采用同步操作的过程，不会带来太多延迟。在上面代码中，<code>thenApply</code>方法将<code>Stream</code>中的每个<code>CompletableFuture&lt;String&gt;</code>对象转换为对应的<code>CompletableFuture&lt;Quote&gt;</code>对象。</li><li><code>thenCompose</code>：支持异步执行过程，允许对两个异步操作进行流水线，第一个操作完成时，将其结果作为参数传递给第二个操作。</li></ul><h3 id="将两个CompletableFuture对象整合起来，无论它们是否存在依赖"><a href="#将两个CompletableFuture对象整合起来，无论它们是否存在依赖" class="headerlink" title="将两个CompletableFuture对象整合起来，无论它们是否存在依赖"></a>将两个CompletableFuture对象整合起来，无论它们是否存在依赖</h3><ul><li><code>thenCombine</code>：可以将两个完全不相干的<code>CompletableFuture</code>对象的结果整合起来。它接受名为<code>BiFunction</code>的第二参数，这个参数定义了当两个<code>CompletableFuture</code>对象完成计算后，结果如何合并。</li></ul><pre class=" language-java"><code class="language-java">Future<span class="token operator">&lt;</span>Double<span class="token operator">></span> futurePriceInUSD <span class="token operator">=</span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">thenCombine</span><span class="token punctuation">(</span>CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span>    <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> exchangeService<span class="token punctuation">.</span><span class="token function">getRate</span><span class="token punctuation">(</span>Money<span class="token punctuation">.</span>EUR<span class="token punctuation">,</span> Money<span class="token punctuation">.</span>USD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>price<span class="token punctuation">,</span> rate<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> price <span class="token operator">*</span> rate<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="相应CompletableFuture的completion事件"><a href="#相应CompletableFuture的completion事件" class="headerlink" title="相应CompletableFuture的completion事件"></a>相应CompletableFuture的completion事件</h2><ul><li><code>thenAccept</code>：将<code>CompletableFuture</code>返回的结果作为参数，并定义如何处理该结果。一旦<code>CompletableFuture</code>计算得到结果，它就返回一个<code>CompletableFuture&lt;Void&gt;</code>。</li><li><code>CompletableFuture.allOf</code>：是一个工厂方法，接收一个<code>CompletableFuture</code>构成的数组，数组中的所有<code>CompletableFuture</code>对象执行完成后，它返回一个<code>CompletableFuture&lt;Void&gt;</code>对象。</li><li><code>CompletableFuture.anyOf</code>：是一个工厂方法，接收一个<code>CompletableFuture</code>构成的数组，返回第一个执行完毕的<code>CompletableFuture</code>对象的返回值构成的<code>CompletableFuture&lt;Object&gt;</code>。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
            <tag> 并发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-二维数组中的查找</title>
      <link href="/2019/08/20/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E6%9F%A5%E6%89%BE/"/>
      <url>/2019/08/20/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E4%BA%8C%E7%BB%B4%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E6%9F%A5%E6%89%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="二维数组中的查找"><a href="#二维数组中的查找" class="headerlink" title="二维数组中的查找"></a>二维数组中的查找</h1><p>在一个二维数组中（每个一维数组的长度相同），每一行都按照从左到右递增的顺序排序，每一列都按照从上到下递增的顺序排序。请完成一个函数，输入这样的一个二维数组和一个整数，判断数组中是否含有该整数。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q4</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr <span class="token operator">==</span> null <span class="token operator">||</span> arr<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> null <span class="token operator">||</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span> length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">></span> target <span class="token operator">||</span> arr<span class="token punctuation">[</span>arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> target<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> column <span class="token operator">=</span> arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>column <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> row <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">==</span> target<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>column<span class="token punctuation">]</span> <span class="token operator">></span> target<span class="token punctuation">)</span> column<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token keyword">else</span> row<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Test</span><span class="token keyword">class</span> <span class="token class-name">Q4Test</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span>                <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">,</span>                <span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token function">assertTrue</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertTrue</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertTrue</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertTrue</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertTrue</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertFalse</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertFalse</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertFalse</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertFalse</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertFalse</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertFalse</span><span class="token punctuation">(</span>Q4<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="/images/2019-08-22_154547.png" alt="在二维数组中查找"></p><ul><li>思路：从右上角开始，如图，由于<code>9</code>大于<code>7</code>，那么第四列所有的数都大于<code>7</code>，因此可以排除第四列。以此类推。如果当前值小于目标值，例如第二列的<code>2</code>小于<code>7</code>，那么<code>2</code>右面的所有数都小于<code>7</code>，因此可以排除第二行。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 数组 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-数组中的重复数字</title>
      <link href="/2019/08/19/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97/"/>
      <url>/2019/08/19/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%87%8D%E5%A4%8D%E6%95%B0%E5%AD%97/</url>
      
        <content type="html"><![CDATA[<h1 id="数组中的重复数字"><a href="#数组中的重复数字" class="headerlink" title="数组中的重复数字"></a>数组中的重复数字</h1><h2 id="找出数组中重复的数字"><a href="#找出数组中重复的数字" class="headerlink" title="找出数组中重复的数字"></a>找出数组中重复的数字</h2><p>在一个长度为<code>n</code>的数组里的所有数字都在<code>0</code>到<code>n-1</code>的范围内。 数组中某些数字是重复的，但不知道有几个数字是重复的。也不知道每个数字重复几次。请找出数组中任意一个重复的数字。 例如，如果输入长度为<code>7</code>的数组<code>{2, 3, 1, 0, 2, 5, 3}</code>，那么对应的输出是第一个重复的数字<code>2</code>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q3</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> value <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> value <span class="token operator">></span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> arr<span class="token punctuation">[</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                <span class="token keyword">int</span> t <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>                arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                arr<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                i<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Test</span><span class="token keyword">class</span> <span class="token class-name">Q3Test</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> Q3<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Q3<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Q3<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Q3<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> Q3<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：从<code>0</code>号位开始，将值和下标对应起来，例如<code>arr[0] == 2</code>，那么就看<code>arr[2]</code>是不是<code>2</code>，是则<code>2</code>是其中一个重复数字，否则交换。如果当前位置下标和当前值相等就向后移动。</li><li>时间复杂度<code>O(n)</code>，空间复杂度<code>O(1)</code>。</li></ul><h2 id="不修改数组找出重复的数字"><a href="#不修改数组找出重复的数字" class="headerlink" title="不修改数组找出重复的数字"></a>不修改数组找出重复的数字</h2><p>在一个长度为<code>n + 1</code>的数组里的所有数字都在<code>1</code>到<code>n</code>的范围内。 数组中至少有一个数字是重复的，。请找出数组中任意一个重复的数字，但不修改数组。 例如，如果输入长度为<code>8</code>的数组<code>{2, 3, 5, 4, 3, 2, 6, 7}</code>，那么对应的输出是重复的数字<code>2</code>或<code>3</code>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Q3_2</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> right <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> big <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> eq <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> small <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> mid<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>            mid <span class="token operator">=</span> left <span class="token operator">+</span> <span class="token punctuation">(</span>right <span class="token operator">-</span> left <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> value <span class="token operator">:</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">>=</span> left <span class="token operator">&amp;&amp;</span> value <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> mid<span class="token punctuation">)</span> eq<span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> mid<span class="token punctuation">)</span> small<span class="token operator">++</span><span class="token punctuation">;</span>                    <span class="token keyword">else</span> big<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>eq <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> mid<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>small <span class="token operator">></span> big<span class="token punctuation">)</span> right <span class="token operator">=</span> mid<span class="token punctuation">;</span>            <span class="token keyword">else</span> left <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Test</span><span class="token keyword">class</span> <span class="token class-name">Q3_2Test</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Test</span>    <span class="token keyword">void</span> <span class="token function">solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token function">assertThat</span><span class="token punctuation">(</span>Q3_2<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">anyOf</span><span class="token punctuation">(</span><span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">equalTo</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">assertArrayEquals</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">,</span> arr<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 无重复</span>        arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span>Q3_2<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// null</span>        <span class="token function">assertEquals</span><span class="token punctuation">(</span>Q3_2<span class="token punctuation">.</span><span class="token function">solution</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>思路：针对值范围进行二分查找。例如<code>1-n</code>，中间值为<code>mid</code>，先遍历数组，分别找出小于<code>mid</code>的个数<code>small</code>、等于<code>mid</code>的个数<code>eq</code>、大于<code>mid</code>的个数<code>big</code>。如果<code>eq</code>大于<code>1</code>，那说明为<code>mid</code>的元素有两个，即找到结果。否则，看<code>small</code>和<code>big</code>哪一个更大，则重复值在哪边。</li><li>时间复杂度<code>O(nlogn)</code>，空间复杂度<code>O(1)</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> 算法 </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 数组 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x07</title>
      <link href="/2019/08/19/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x07/"/>
      <url>/2019/08/19/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x07/</url>
      
        <content type="html"><![CDATA[<h1 id="CompletableFuture：组合异步编程（一）"><a href="#CompletableFuture：组合异步编程（一）" class="headerlink" title="CompletableFuture：组合异步编程（一）"></a>CompletableFuture：组合异步编程（一）</h1><h2 id="Future接口"><a href="#Future接口" class="headerlink" title="Future接口"></a>Future接口</h2><ul><li><code>Future</code>接口是对将来某个时刻会发生的结果进行建模。它建模了一种异步计算，返回一个执行运算结果的引用，当运算结束后，这个引用被返回公文袋调用方。在<code>Future</code>中触发那些潜在耗时的操作把调用线程解放出来，让它能继续执行其他有价值的工作。</li></ul><pre class=" language-java"><code class="language-java">ExecutorService executor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Future<span class="token operator">&lt;</span>Double<span class="token operator">></span> future <span class="token operator">=</span> executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Double <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">doSomeLongComputation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">doSomethingElse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">try</span> <span class="token punctuation">{</span>    Double result <span class="token operator">=</span> future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> ee<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ee<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ie<span class="token punctuation">)</span> <span class="token punctuation">{</span>    ie<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TimeoutException</span> te<span class="token punctuation">)</span> <span class="token punctuation">{</span>    te<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="Future接口的局限性"><a href="#Future接口的局限性" class="headerlink" title="Future接口的局限性"></a>Future接口的局限性</h3><ul><li><code>Future</code>表达能力有限，某些异步计算用<code>Future</code>难以表达。</li></ul><h2 id="使用CompletableFuture构建异步应用"><a href="#使用CompletableFuture构建异步应用" class="headerlink" title="使用CompletableFuture构建异步应用"></a>使用CompletableFuture构建异步应用</h2><h3 id="将同步方法转换为异步方法"><a href="#将同步方法转换为异步方法" class="headerlink" title="将同步方法转换为异步方法"></a>将同步方法转换为异步方法</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Shop</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>1000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">calculatePrice</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> product<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 同步方法</span>    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getPrice</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">calculatePrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 异步方法</span>    <span class="token keyword">public</span> Future<span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token function">getPriceAsync</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        CompletableFuture<span class="token operator">&lt;</span>Double<span class="token operator">></span> futurePrice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> futurePrice<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">calculatePrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> futurePrice<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Shop shop <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Future<span class="token operator">&lt;</span>Double<span class="token operator">></span> futurePrice <span class="token operator">=</span> shop<span class="token punctuation">.</span><span class="token function">getPriceAsync</span><span class="token punctuation">(</span><span class="token string">"my favorite product"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> invocationTime <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Invocation returned after "</span> <span class="token operator">+</span> invocationTime <span class="token operator">+</span> <span class="token string">" msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 执行其它操作</span>        Shop<span class="token punctuation">.</span><span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>           <span class="token keyword">double</span> price <span class="token operator">=</span> futurePrice<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Price is %.2f%n"</span><span class="token punctuation">,</span> price<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">long</span> retrievalTime <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Price returned after "</span> <span class="token operator">+</span> retrievalTime <span class="token operator">+</span> <span class="token string">"msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><ul><li>如果异步方法发生错误，其异常会被限制在当前线程中，并且该线程最终会被杀死，而这会导致<code>get</code>方法永远阻塞。可以使用重载后的<code>get</code>方法，支持超时参数来防止永久阻塞，程序会得到<code>TimeoutException</code>。但是还是无法得知异步方法线程的错误原因，此时应该使用<code>CompletableFuture</code>的<code>completeExceptionally</code>方法将导致<code>CompletableFuture</code>内发生的问题抛出。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Future<span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token function">getPriceAsync</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>    CompletableFuture<span class="token operator">&lt;</span>Double<span class="token operator">></span> futurePrice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            futurePrice<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">calculatePrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            futurePrice<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> futurePrice<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="使用工厂方法创建CompletableFuture"><a href="#使用工厂方法创建CompletableFuture" class="headerlink" title="使用工厂方法创建CompletableFuture"></a>使用工厂方法创建CompletableFuture</h3><ul><li><code>CompletableFuture.supplyAsync()</code>是一个工厂方法，接受一个<code>Supplier&lt;T&gt;</code>参数，返回一个<code>CompletableFuture</code>对象。使用该方法创建的<code>CompletableFuture</code>与上面带有异常处理的代码是等价的。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Future<span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token function">geetPriceAsync</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token function">calculatePrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="免受阻塞"><a href="#免受阻塞" class="headerlink" title="免受阻塞"></a>免受阻塞</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Shop</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Shop</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>1000L<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">calculatePrice</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> random<span class="token punctuation">.</span><span class="token function">nextDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> product<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> product<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 同步方法</span>    <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getPrice</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">calculatePrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 异步方法</span>    <span class="token keyword">public</span> Future<span class="token operator">&lt;</span>Double<span class="token operator">></span> <span class="token function">getPriceAsync</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        CompletableFuture<span class="token operator">&lt;</span>Double<span class="token operator">></span> futurePrice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFuture</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                futurePrice<span class="token punctuation">.</span><span class="token function">complete</span><span class="token punctuation">(</span><span class="token function">calculatePrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                futurePrice<span class="token punctuation">.</span><span class="token function">completeExceptionally</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> futurePrice<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">findPrices</span><span class="token punctuation">(</span>String product<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> shops<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>shop <span class="token operator">-</span><span class="token operator">></span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s price is %.2f"</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BestPrice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"LetsSaveBig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"MyFavoriteShop"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BuyItAll"</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">findPrices</span><span class="token punctuation">(</span><span class="token string">"Fallout New Vegas"</span><span class="token punctuation">,</span> shops<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done in "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">" msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:[BestPrice price is 97.75, LetsSaveBig price is 118.44, MyFavoriteShop price is 98.66, BuyItAll price is 149.10]Done in 4013 msecs*/</span></code></pre><h3 id="使用并行流对请求进行并行操作"><a href="#使用并行流对请求进行并行操作" class="headerlink" title="使用并行流对请求进行并行操作"></a>使用并行流对请求进行并行操作</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">findPrices</span><span class="token punctuation">(</span>String product<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> shops<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>shop <span class="token operator">-</span><span class="token operator">></span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%s price is %.2f"</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BestPrice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"LetsSaveBig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"MyFavoriteShop"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BuyItAll"</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">findPrices</span><span class="token punctuation">(</span><span class="token string">"Fallout New Vegas"</span><span class="token punctuation">,</span> shops<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done in "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">" msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:[BestPrice price is 163.63, LetsSaveBig price is 125.60, MyFavoriteShop price is 148.02, BuyItAll price is 118.71]Done in 1022 msecs*/</span></code></pre><h3 id="使用CompletableFuture发起异步请求"><a href="#使用CompletableFuture发起异步请求" class="headerlink" title="使用CompletableFuture发起异步请求"></a>使用CompletableFuture发起异步请求</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">findPrices</span><span class="token punctuation">(</span>String product<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops<span class="token punctuation">)</span> <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>CompletableFuture<span class="token operator">&lt;</span>String<span class="token operator">>></span> priceFuture <span class="token operator">=</span> shops<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>shop <span class="token operator">-</span><span class="token operator">></span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span>                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> shop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" price is "</span> <span class="token operator">+</span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>                <span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> priceFuture<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>CompletableFuture<span class="token operator">:</span><span class="token operator">:</span>join<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BestPrice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"LetsSaveBig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"MyFavoriteShop"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BuyItAll"</span><span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">findPrices</span><span class="token punctuation">(</span><span class="token string">"Fallout New Vegas"</span><span class="token punctuation">,</span> shops<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done in "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">" msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:[BestPrice price is 116.10675116625683, LetsSaveBig price is 159.1609417232611, MyFavoriteShop price is 166.64834055365026, BuyItAll price is 121.8279536327426]Done in 1044 msecs*/</span></code></pre><ul><li><em><del>此处执行时间远低于书中所述（2005 ms），比较接近并行流的性能。有待查证。</del>和CPU逻辑处理器数量有关，运行环境是12核，因此当把商店数量改为13后，执行时间为2063 ms。</em></li></ul><h3 id="使用定制的执行器"><a href="#使用定制的执行器" class="headerlink" title="使用定制的执行器"></a>使用定制的执行器</h3><ul><li>可以使用线程池。线程池大小估算：<code>T = N * U * (1 + W / C)</code>，其中，<code>T</code>为线程池大小，<code>N</code>为CPU核数，<code>U</code>为期望的CPU利用率，<code>W / C</code>为等待时间与计算时间比率。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Shop<span class="token operator">></span> shops <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BestPrice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"LetsSaveBig"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"MyFavoriteShop"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"BuyItAll"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Steam"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Epic"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"GOG"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Taptap"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"W"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"V"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Z"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"Y"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token keyword">new</span> <span class="token class-name">Shop</span><span class="token punctuation">(</span><span class="token string">"X"</span><span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Executor executor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>            Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>shops<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            r <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>                Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>                t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> t<span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">findPricesByFuture</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>CompletableFuture<span class="token operator">&lt;</span>String<span class="token operator">>></span> priceFuture <span class="token operator">=</span> shops<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>shop <span class="token operator">-</span><span class="token operator">></span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span>                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> shop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" price is "</span> <span class="token operator">+</span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span>                <span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> priceFuture<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>CompletableFuture<span class="token operator">:</span><span class="token operator">:</span>join<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">findPricesByFutureWithExec</span><span class="token punctuation">(</span>String product<span class="token punctuation">)</span> <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>CompletableFuture<span class="token operator">&lt;</span>String<span class="token operator">>></span> priceFuture <span class="token operator">=</span> shops<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>shop <span class="token operator">-</span><span class="token operator">></span> CompletableFuture<span class="token punctuation">.</span><span class="token function">supplyAsync</span><span class="token punctuation">(</span>                        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> shop<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" price is "</span> <span class="token operator">+</span> shop<span class="token punctuation">.</span><span class="token function">getPrice</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">,</span>                        executor                <span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> priceFuture<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>CompletableFuture<span class="token operator">:</span><span class="token operator">:</span>join<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span>Function<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">>></span> findPrices<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> start <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>findPrices<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"Fallout New Vegas"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">long</span> duration <span class="token operator">=</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> 1_000_000<span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Done in "</span> <span class="token operator">+</span> duration <span class="token operator">+</span> <span class="token string">" msecs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token function">test</span><span class="token punctuation">(</span>Main<span class="token operator">:</span><span class="token operator">:</span>findPricesByFuture<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">test</span><span class="token punctuation">(</span>Main<span class="token operator">:</span><span class="token operator">:</span>findPricesByFutureWithExec<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:[BestPrice price is 123.81188673960165, LetsSaveBig price is 134.2037700185142, MyFavoriteShop price is 108.25237001214239, BuyItAll price is 115.00922099155312, Steam price is 111.23106850193753, Epic price is 99.22328167208421, GOG price is 164.50758310616402, Taptap price is 121.17345205244206, W price is 123.06486848925549, V price is 138.86613263159464, Z price is 160.93733921008214, Y price is 150.61296275286742, X price is 151.1427293015105]Done in 2063 msecs[BestPrice price is 147.8957557234686, LetsSaveBig price is 115.91180890944013, MyFavoriteShop price is 145.9127196738407, BuyItAll price is 153.58049341481873, Steam price is 127.4807398778012, Epic price is 143.5858168683404, GOG price is 151.72178968386282, Taptap price is 140.27525423457325, W price is 142.2637869480202, V price is 115.3615656625179, Z price is 151.1027261194255, Y price is 121.78157514886323, X price is 150.22069837374056]Done in 1003 msecs*/</span></code></pre><h3 id="并行的方案选择"><a href="#并行的方案选择" class="headerlink" title="并行的方案选择"></a>并行的方案选择</h3><ul><li>如果进行计算密集的操作，并且没有I/O，那么推荐使用<code>Stream</code>接口。反之，如果并行单元需要等待I/O操作，那么使用<code>CompletableFuture</code>灵活性更好，还可以根据需要设置线程数。而且，如果此时使用流，那么流的延迟特性会导致难以判断什么时候触发了等待。</li><li><em>流的延迟特性：<code>Stream</code>的操作由零个或多个中间操作和一个结束操作两部分组成。只有执行了结束操作，<code>Stream</code>定义的中间操作才会依次执行。</em></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
            <tag> 并发 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>剑指Offer面试题-实现单例模式</title>
      <link href="/2019/08/17/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"/>
      <url>/2019/08/17/%E5%89%91%E6%8C%87Offer%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%9E%E7%8E%B0%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="实现单例模式"><a href="#实现单例模式" class="headerlink" title="实现单例模式"></a>实现单例模式</h1><h2 id="懒汉式单例"><a href="#懒汉式单例" class="headerlink" title="懒汉式单例"></a>懒汉式单例</h2><ul><li>懒汉式单例指第一次调用时才进行实例化。</li></ul><h3 id="双重检验锁"><a href="#双重检验锁" class="headerlink" title="双重检验锁"></a>双重检验锁</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> Singleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><p>构造函数应当设为<code>private</code>，获取单例函数应设为<code>public static</code>。</p></li><li><p>单例变量应当声明为<code>volatile</code>，禁止指令重排序。由于初始化实例<code>singleton = new Singleton();</code>不是原子操作，而是分为4个步骤：</p><ol><li>申请内存空间</li><li>初始化默认值</li><li>执行构造器方法</li><li>连接引用和实例</li></ol><p>其中3和4是可以重排序的。如果线程a执行顺序为1243，执行4后切换到线程b，此时单例变量不为空，线程b将获得一个没有初始化完成的对象。</p></li><li><p><code>synchronized</code>上锁对象是<code>Singleton.class</code>。</p></li><li><p><code>synchronized</code>代码块中还应该进行一次对实例的判空，因为如果线程a通过了第一个判空后，切换到线程b一直执行，直到创建单例再切回线程a，此时线程a已经不需要再创建单例了。</p></li><li><p>可见性由<code>synchronized</code>保证。</p></li></ul><h3 id="静态内部类"><a href="#静态内部类" class="headerlink" title="静态内部类"></a>静态内部类</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StaticSingleton</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton SINGLETON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> StaticSingleton<span class="token punctuation">.</span>SINGLETON<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>该方式是线程安全的，因为JVM在执行类的初始化阶段，会获得一个可以同步多个线程对同一个类的初始化的锁。假设线程a先进行了初始化，那么线程b一直等待初始化锁。线程a执行类初始化，即使发生了重排序，也不会影响线程a的初始化。线程a初始化完后，释放锁。线程b获得初始化锁，发现<code>Singleton</code>对象已经初始化完毕，释放锁，不进行初始化，获得<code>Singleton</code>对象。</li><li><em>上面的静态内部类式单例是<strong>不能</strong>防止反射攻击的，网上有些博客说是可以，我认为是错误的。攻击代码也是一般思路，也可能有优化空间。详见下面代码。</em></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">StaticSingleton</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Singleton SINGLETON <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> StaticSingleton<span class="token punctuation">.</span>SINGLETON<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IllegalAccessException<span class="token punctuation">,</span> InvocationTargetException<span class="token punctuation">,</span> InstantiationException<span class="token punctuation">,</span> NoSuchFieldException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 保存初始单例</span>        Singleton s <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 获取Singleton构造器，并创建一个新的实例</span>        Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> c <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        c<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Singleton s2 <span class="token operator">=</span> <span class="token punctuation">(</span>Singleton<span class="token punctuation">)</span>c<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 获取内部类的构造器，并创建一个实例（可能不需要此步骤，没有测试）</span>        Constructor<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> in <span class="token operator">=</span> Singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getDeclaredConstructors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        in<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object ins <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 获取单例成员变量</span>        Field f <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 去除final修饰符（修改final成员通用方法）</span>        Field modifiersField <span class="token operator">=</span> Field<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"modifiers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        modifiersField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        modifiersField<span class="token punctuation">.</span><span class="token function">setInt</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token punctuation">.</span><span class="token function">getModifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token operator">~</span>Modifier<span class="token punctuation">.</span>FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 修改单例成员的值为新实例</span>        f<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        f<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>ins<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 比较</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Singleton<span class="token punctuation">.</span><span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:WARNING: An illegal reflective access operation has occurredWARNING: Illegal reflective access by Main (file:./testJava/out/production/testJava/) to field java.lang.reflect.Field.modifiersWARNING: Please consider reporting this to the maintainers of MainWARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operationsWARNING: All illegal access operations will be denied in a future releasefalse*/</span></code></pre><h3 id="线程不安全"><a href="#线程不安全" class="headerlink" title="线程不安全"></a>线程不安全</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>仅适用于单线程。</li></ul><h3 id="对象锁"><a href="#对象锁" class="headerlink" title="对象锁"></a>对象锁</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton singleton <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>线程安全，但是每次调用<code>getInstance()</code>时都会锁住对象，引起线程阻塞，效率较低。</li></ul><h2 id="饿汉式单例"><a href="#饿汉式单例" class="headerlink" title="饿汉式单例"></a>饿汉式单例</h2><ul><li>指在类初始化时就已经实例化。</li></ul><h3 id="使用类实现"><a href="#使用类实现" class="headerlink" title="使用类实现"></a>使用类实现</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Singleton singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Singleton <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>线程安全，JVM会保证类只加载一次。</li></ul><h3 id="使用枚举实现"><a href="#使用枚举实现" class="headerlink" title="使用枚举实现"></a>使用枚举实现</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> Singleton <span class="token punctuation">{</span>    INSTANCE<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>枚举实例只会初始化一次，因此可以保证是单例。</li><li>线程安全，同样JVM会保证枚举只加载一次。</li><li>枚举实现单例可以防止反射调用构造函数，枚举在反编译后是<code>abstact class</code>，无法实例化。并且在反射调用构造函数时会检查所调用的构造函数是否属于枚举类型的，若是则抛出异常。</li><li>枚举实现单例可以防止反序列化生成新的实例，因为枚举反序列化时则是通过<code>java.lang.Enum</code>的<code>valueOf</code>方法来根据名字查找枚举对象。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 设计模式 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 设计模式 </tag>
            
            <tag> Java </tag>
            
            <tag> 剑指Offer </tag>
            
            <tag> 单例模式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x06</title>
      <link href="/2019/08/17/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x06/"/>
      <url>/2019/08/17/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x06/</url>
      
        <content type="html"><![CDATA[<h1 id="用Optional取代null"><a href="#用Optional取代null" class="headerlink" title="用Optional取代null"></a>用Optional取代null</h1><h2 id="如何为缺失值建模"><a href="#如何为缺失值建模" class="headerlink" title="如何为缺失值建模"></a>如何为缺失值建模</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Car car<span class="token punctuation">;</span>    <span class="token keyword">public</span> Car <span class="token function">getCar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> car<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Insurance insurance<span class="token punctuation">;</span>    <span class="token keyword">public</span> Insurance <span class="token function">getInsurance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> insurance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Insurance</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getCarInsuranceName</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> person<span class="token punctuation">.</span><span class="token function">getCar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInsurance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>一般情况下，如果<code>Person</code>没有<code>Car</code>，那么<code>getCar()</code>会设置为返回<code>null</code>，表示该值缺失。因此需要判断返回值是否为<code>null</code>来防止出现<code>NullPointerException</code></li></ul><h3 id="采用防御式检查减少NullPointerException"><a href="#采用防御式检查减少NullPointerException" class="headerlink" title="采用防御式检查减少NullPointerException"></a>采用防御式检查减少NullPointerException</h3><ul><li>深层质疑：会增加代码缩进层数，不具备扩展性，代码维护困难。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getCarInsuranceName</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>person <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            Car car <span class="token operator">=</span> person<span class="token punctuation">.</span><span class="token function">getCar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>car <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                Insurance insurance <span class="token operator">=</span> car<span class="token punctuation">.</span><span class="token function">getInsurance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>insurance <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> insurance<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token string">"Unknown"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><ul><li>过多的退出语句：退出点数量多，难以维护。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getCarInsuranceName</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>person <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Unknown"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Car car <span class="token operator">=</span> person<span class="token punctuation">.</span><span class="token function">getCar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>car <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Unknown"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        Insurance insurance <span class="token operator">=</span> car<span class="token punctuation">.</span><span class="token function">getInsurance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>insurance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"Unknown"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> insurance<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="null带来的问题"><a href="#null带来的问题" class="headerlink" title="null带来的问题"></a>null带来的问题</h3><ul><li>错误之源：<code>NullPointerException</code>是目前Java程序开发中最典型的异常。</li><li>代码膨胀：需要深度嵌套<code>null</code>检查，可读性极差。</li><li>毫无意义：<code>null</code>自身没有任何语义，是以一种错误的方式对缺失值建模。</li><li>违反哲学：Java一直试图避免让程序员意识到指针的存在，但<code>null</code>指针例外。</li><li>类型缺失：<code>null</code>不属于任何类型，这意味着它可以被赋值给任何变量，而当这个变量传递给系统的其它部分时，将无法确定<code>null</code>变量最初是什么类型。</li></ul><h3 id="其他语言中null的替代品"><a href="#其他语言中null的替代品" class="headerlink" title="其他语言中null的替代品"></a>其他语言中null的替代品</h3><ul><li>Groovy：引入安全导航操作符，可以安全的访问可能为<code>null</code>的变量，避免抛出<code>NullPointerException</code>。</li></ul><pre class=" language-groovy"><code class="language-groovy"><span class="token keyword">def</span> carInsuranceName <span class="token operator">=</span> person<span class="token operator">?.</span>car<span class="token operator">?.</span>insurance<span class="token operator">?.</span>name</code></pre><ul><li>Haskell：<code>Maybe</code>类型，本质上是<code>optional</code>值的封装。</li><li>Scala：<code>Option[T]</code>，要显式调用<code>avaliable</code>操作检查该变量是否有值，其实是变相的<code>null</code>检查。</li></ul><h2 id="Optional类简介"><a href="#Optional类简介" class="headerlink" title="Optional类简介"></a>Optional类简介</h2><ul><li>变量存在时，<code>Optional</code>类型只是对对象的简单封装。变量不存在时，缺失的值会被建模成一个“空”的<code>Optional</code>对象，由方法<code>Optional.empty()</code>返回。<code>Optional.empty()</code>方法是一个静态工厂方法，它返回<code>Optional</code>类的特定单一实例。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Car car<span class="token punctuation">;</span>    <span class="token keyword">public</span> Optional<span class="token operator">&lt;</span>Car<span class="token operator">></span> <span class="token function">getCar</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Insurance insurance<span class="token punctuation">;</span>    <span class="token keyword">public</span> Optional<span class="token operator">&lt;</span>Insurance<span class="token operator">></span> <span class="token function">getInsurance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>insurance<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Insurance</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">public</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><del><code>Optional</code>和<code>null</code>的重要语义区别是，<code>Optional</code>类清楚地表明允许发生变量缺失，<code>null</code>则不允许。</del>在代码中，如果变量不能为<code>null</code>，那么也不需要为其添加<code>null</code>检查，因为<code>null</code>的检查只会掩盖问题，并未真正修复问题。</li><li><em>书中对应上面代码部分在声明成员变量时形如<code>private Optional&lt;Car&gt; car</code>，但此时IDEA报出警告<code>&#39;Optional&#39; used as field or parameter type</code>，参考<a href="https://stackoverflow.com/questions/31922866/why-should-java-8s-optional-not-be-used-in-arguments" target="_blank" rel="noopener">StackOverFlow</a>，<code>Optional</code>作为成员变量或者函数参数类型会导致不必要的包装和额外的解包逻辑，且无法序列化，因此只需在返回值处使用<code>Optional</code>。</em></li></ul><h2 id="应用Optional的几种模式"><a href="#应用Optional的几种模式" class="headerlink" title="应用Optional的几种模式"></a>应用Optional的几种模式</h2><h3 id="创建Optional对象"><a href="#创建Optional对象" class="headerlink" title="创建Optional对象"></a>创建Optional对象</h3><ul><li>声明一个空的<code>Optional</code></li></ul><pre class=" language-java"><code class="language-java">Optional<span class="token operator">&lt;</span>Car<span class="token operator">></span> optCar <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>依据一个非空值创建Optional</li></ul><pre class=" language-java"><code class="language-java">Optional<span class="token operator">&lt;</span>Car<span class="token operator">></span> optCar <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>可接受<code>null</code>的<code>Optional</code>，如果传入<code>null</code>则获得空对象</li></ul><pre class=" language-java"><code class="language-java">Optional<span class="token operator">&lt;</span>Car<span class="token operator">></span> optCar <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="使用map从Optional对象中提取和转换值"><a href="#使用map从Optional对象中提取和转换值" class="headerlink" title="使用map从Optional对象中提取和转换值"></a>使用map从Optional对象中提取和转换值</h3><pre class=" language-java"><code class="language-java">Optional<span class="token operator">&lt;</span>Insurance<span class="token operator">></span> optInsurance <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>insurance<span class="token punctuation">)</span><span class="token punctuation">;</span>Optional<span class="token operator">&lt;</span>String<span class="token operator">></span> name <span class="token operator">=</span> optInsurance<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Insurance<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>如果<code>Optional</code>包含一个值，那函数就将该值作为参数传递给<code>map</code>，对该值进行转换。如果<code>Optional</code>为空，就什么也不做。</li></ul><h3 id="使用flatMap链接Optional对象"><a href="#使用flatMap链接Optional对象" class="headerlink" title="使用flatMap链接Optional对象"></a>使用flatMap链接Optional对象</h3><pre class=" language-java"><code class="language-java">Optional<span class="token operator">&lt;</span>Person<span class="token operator">></span> optPerson <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//！Optional&lt;String> name = optPerson.map(Person::getCar)</span><span class="token comment" spellcheck="true">//！    .map(Car::getInsurance)</span><span class="token comment" spellcheck="true">//！    .map(Insurance::getName);</span></code></pre><ul><li>上面代码注释处无法通过编译。第一个<code>map</code>返回值类型是<code>Optional&lt;Optional&lt;Car&gt;&gt;</code>，而不是需要的<code>Optional&lt;Car&gt;</code>。</li><li>解决上述问题应该使用<code>flatMap</code>，<code>flatMap</code>方法接受一个函数作为参数，这个函数的返回值是另一个流。这个方法会应用到流的每一个元素，最终形成一个新的流。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 与书中略有不同，详情见上</span><span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">getCarInsuranceName</span><span class="token punctuation">(</span>Person person<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>Person<span class="token operator">:</span><span class="token operator">:</span>getCar<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>Car<span class="token operator">:</span><span class="token operator">:</span>getInsurance<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Insurance<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">"Unknown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><h3 id="默认行为及解引用Optional对象"><a href="#默认行为及解引用Optional对象" class="headerlink" title="默认行为及解引用Optional对象"></a>默认行为及解引用Optional对象</h3><ul><li><code>get()</code>：如果变量存在则返回封装的变量值，否则抛出<code>NoSuchElementException</code>异常。不推荐使用。</li><li><code>orElse(T other)</code>：如果变量存在则返回，否则返回传入的默认值。</li><li><code>orElseGet(Supplier&lt;? extends X&gt; other)</code>：是<code>orElse()</code>的延迟调用版。传入的<code>Supplier</code>只有在变量不存在时调用。如果创建对象是耗时操作应该使用该方法。</li><li><code>orElseThrow(Supplier&lt;? extends x&gt; exceptionSupplier)</code>：类似于<code>get()</code>，不过抛出的错误由传入的<code>Supplier</code>创建。</li><li><code>ifPresent(Consumer&lt;? extends T&gt; consumer)</code>：在变量存在时执行传入的<code>Consumer</code>，否则就不进行任何操作。</li></ul><h3 id="两个Optional对象组合"><a href="#两个Optional对象组合" class="headerlink" title="两个Optional对象组合"></a>两个Optional对象组合</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Optional<span class="token operator">&lt;</span>Insurance<span class="token operator">></span> <span class="token function">safeFind</span><span class="token punctuation">(</span>Person person<span class="token punctuation">,</span> Car car<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span>            <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>                   p <span class="token operator">-</span><span class="token operator">></span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>c <span class="token operator">-</span><span class="token operator">></span> <span class="token function">find</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>首先，<code>c -&gt; find(p, c)</code>返回<code>Insurance</code>，而流的类型为<code>Optional</code>，因此不需要<code>flatMap</code>。之后<code>p -&gt; Optional.ofNullable(car).map(c -&gt; find(p, c))</code>得到的就是<code>Optional&lt;Insurance&gt;</code>，<code>Optional.ofNullable(person)</code>的流类型是<code>Optional&lt;Person&gt;</code>，因此需要<code>flatMap</code>。</li></ul><h3 id="使用filter剔除特定的值"><a href="#使用filter剔除特定的值" class="headerlink" title="使用filter剔除特定的值"></a>使用filter剔除特定的值</h3><ul><li><code>filter</code>方法接受一个谓词作为参数。如果<code>Optional</code>对象的值存在，并且它符合谓词条件，<code>filter</code>方法就返回其值；否则它就返回一个空的<code>Optional</code>对象。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> String <span class="token function">getCarInsuranceName</span><span class="token punctuation">(</span>Optional<span class="token operator">&lt;</span>Person<span class="token operator">></span> person<span class="token punctuation">,</span> <span class="token keyword">int</span> minAge<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> person<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>p <span class="token operator">-</span><span class="token operator">></span> p<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> minAge<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>Person<span class="token operator">:</span><span class="token operator">:</span>getCar<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">flatMap</span><span class="token punctuation">(</span>Car<span class="token operator">:</span><span class="token operator">:</span>getInsurance<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Insurance<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token string">"Unknown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="使用Optional的实战示例"><a href="#使用Optional的实战示例" class="headerlink" title="使用Optional的实战示例"></a>使用Optional的实战示例</h2><h3 id="用Optional封装可能为null的值"><a href="#用Optional封装可能为null的值" class="headerlink" title="用Optional封装可能为null的值"></a>用Optional封装可能为null的值</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 原始代码</span>Object value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// if value != null ...</span><span class="token comment" spellcheck="true">// 使用Optional</span>Optional<span class="token operator">&lt;</span>Object<span class="token operator">></span> value <span class="token operator">=</span> Optional<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"key"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="异常与Optional对比"><a href="#异常与Optional对比" class="headerlink" title="异常与Optional对比"></a>异常与Optional对比</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 将String转为Integer</span><span class="token keyword">public</span> <span class="token keyword">static</span> Optional<span class="token operator">&lt;</span>Integer<span class="token operator">></span> <span class="token function">stringToInt</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NumberFormatExcption</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Java 9中添加了Stream.ofNullable，如果对象为null，则返回OptionalInt</span><span class="token keyword">public</span> OptionalInt <span class="token function">stringToInt</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Stream<span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>str <span class="token operator">-</span><span class="token operator">></span> str<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"\\d+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">mapToInt</span><span class="token punctuation">(</span>Integer<span class="token operator">:</span><span class="token operator">:</span>parseInt<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x05</title>
      <link href="/2019/08/15/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x05/"/>
      <url>/2019/08/15/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x05/</url>
      
        <content type="html"><![CDATA[<h1 id="默认方法"><a href="#默认方法" class="headerlink" title="默认方法"></a>默认方法</h1><ul><li>一旦类库设计者需要更新接口，向其中加入新的方法，继承该接口的代码就需要做出相应的修改。Java 8引入了新的解决方法，一是允许在接口中声明静态方法，二是引入默认方法，通过默认方法可以指定接口方法的默认实现，默认方法使用<code>default</code>修饰。</li></ul><h2 id="不断演进的API"><a href="#不断演进的API" class="headerlink" title="不断演进的API"></a>不断演进的API</h2><h3 id="不同类型的兼容性"><a href="#不同类型的兼容性" class="headerlink" title="不同类型的兼容性"></a>不同类型的兼容性</h3><ul><li>变更对Java程序的影响大体可以分成三种类型的兼容性：<ul><li>二进制级的兼容性，表示现有的二进制执行文件能无缝持续链接（包括验证、准备和解析）和运行。例如向接口添加一个方法就是二进制级的兼容，如果添加方法不被调用，那么现有程序就不会出现错误。</li><li>源代码级的兼容性，表示引入变化之后，现有的程序依然能成功编译通过。例如向接口添加新的方法就不是源代码级的兼容，因为遗留代码没有实现新引入的方法，所以无法顺利通过编译。</li><li>函数行为的兼容性，表示变更发生之后，程序接受同样的输入能得到同样的结果。还是例如向接口添加新的方法，是函数行为兼容的，因为新的方法没有调用，或者被实现覆盖而没有影响其表现。</li></ul></li></ul><h2 id="默认方法的使用模式"><a href="#默认方法的使用模式" class="headerlink" title="默认方法的使用模式"></a>默认方法的使用模式</h2><h3 id="可选方法"><a href="#可选方法" class="headerlink" title="可选方法"></a>可选方法</h3><ul><li>使用默认方法，可以为那些用户不会经常使用的，但是接口中包含的方法提供一个默认实现，这样实体类就无需在自己的实现中显示地提供一个空方法。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Iterator</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> <span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    T <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="行为的多继承"><a href="#行为的多继承" class="headerlink" title="行为的多继承"></a>行为的多继承</h3><ul><li>类型的多继承：允许实现多个接口，而接口可以有默认实现，实质上实现了多继承。</li><li>用正交方法精简接口：分解实体类的不同功能点并设计接口，降低接口的重合度。</li><li>注意，继承不应该成为代码复用的万金油，例如继承一个100个方法的类就不是一个好选择，因为这会引入不必要的复杂性。可以使用代理模式有效的规避这类问题。</li></ul><h2 id="解决冲突的规则"><a href="#解决冲突的规则" class="headerlink" title="解决冲突的规则"></a>解决冲突的规则</h2><h3 id="解决为题的三条规则"><a href="#解决为题的三条规则" class="headerlink" title="解决为题的三条规则"></a>解决为题的三条规则</h3><ol><li><strong>类中方法的优先级最高</strong>。类或父类中声明的方法的优先级高于任何声明为默认方法的优先级。</li><li><strong>如果1.无法判断</strong>，那么<strong>子接口的优先级最高</strong>。函数签名相同时，优先选择拥有最具体实现的默认方法的接口，如果<code>B</code>继承了<code>A</code>，那么<code>B</code>比<code>A</code>更具体。</li><li><strong>如果2.也无法判断</strong>，继承了多个接口的类必须通过<strong>显式覆盖和调用期望的方法</strong>。</li></ol><p><img src="/images/2019-08-17_101549.png" alt="继承一个类，实现两个接口的情况"></p><ul><li>注意，上图中<code>D</code>未覆盖<code>hello()</code>方法，但它实现了接口<code>A</code>，那么它拥有<code>A</code>的默认方法；此外，<code>C</code>实现了接口<code>B</code>，因此编译器会在接口<code>A</code>和接口<code>B</code>的<code>hello()</code>之间选择（而不是类<code>D</code>和接口<code>B</code>之间）。由于<code>B</code> 更加具体，所以会选择接口<code>B</code>的<code>hello()</code>方法。</li></ul><h3 id="冲突及如何显式地消除歧义"><a href="#冲突及如何显式地消除歧义" class="headerlink" title="冲突及如何显式地消除歧义"></a>冲突及如何显式地消除歧义</h3><p><img src="/images/2019-08-17_103001.png" alt="同时实现具有相同函数声明的两个接口"></p><ul><li>上图中，编译器将无法判断哪一个接口的实现更加具体，此时应该使用显式地声明来确定使用哪一个方法，或者覆盖它。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">C</span> <span class="token keyword">implements</span> <span class="token class-name">B</span><span class="token punctuation">,</span> A <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        B<span class="token punctuation">.</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="菱形继承问题"><a href="#菱形继承问题" class="headerlink" title="菱形继承问题"></a>菱形继承问题</h3><p><img src="/images/2019-08-17_103749.png" alt="菱形问题 - 1"></p><ul><li>上图中实际上只有一个方法可选，即接口<code>A</code>的默认方法。</li></ul><p><img src="/images/2019-08-17_104018.png" alt="菱形问题 - 2"></p><ul><li>此时接口<code>B</code>比接口<code>A</code>更加具体，因此使用接口<code>B</code>的<code>hello()</code>方法。</li></ul><p><img src="/images/2019-08-17_104325.png" alt="菱形问题 - 3"></p><ul><li>上面这种情况会出现冲突，需要显式指定方法。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>jOOQ逆向生成Java代码</title>
      <link href="/2019/08/15/jOOQ%E9%80%86%E5%90%91%E7%94%9F%E6%88%90Java%E4%BB%A3%E7%A0%81/"/>
      <url>/2019/08/15/jOOQ%E9%80%86%E5%90%91%E7%94%9F%E6%88%90Java%E4%BB%A3%E7%A0%81/</url>
      
        <content type="html"><![CDATA[<h1 id="jOOQ逆向生成Java代码"><a href="#jOOQ逆向生成Java代码" class="headerlink" title="jOOQ逆向生成Java代码"></a>jOOQ逆向生成Java代码</h1><h2 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h2><p>要操作一下GeoIP库，打算接触一下ORM。又因为最近在看Stream，想找一种类似流水线的Java处理数据库相关的框架。jOOQ符合了我的需求。</p><p><a href="https://www.jooq.org/doc/3.11/manual-single-page/#jooq-in-7-steps-step3" target="_blank" rel="noopener">官网文档连接</a></p><h2 id="关于xml"><a href="#关于xml" class="headerlink" title="关于xml"></a>关于xml</h2><pre class=" language-xml"><code class="language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://www.jooq.org/xsd/jooq-codegen-3.11.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>  <span class="token comment" spellcheck="true">&lt;!-- Configure the database connection here --></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>jdbc</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>driver</span><span class="token punctuation">></span></span>com.mysql.jdbc.Driver<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>driver</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">></span></span>jdbc:mysql://localhost:3306/library<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>user</span><span class="token punctuation">></span></span>root<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>user</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>password</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>password</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>jdbc</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>generator</span><span class="token punctuation">></span></span>    <span class="token comment" spellcheck="true">&lt;!-- The default code generator. You can override this one, to generate your own code style.         Supported generators:         - org.jooq.codegen.JavaGenerator         - org.jooq.codegen.ScalaGenerator         Defaults to org.jooq.codegen.JavaGenerator --></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>org.jooq.codegen.JavaGenerator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>database</span><span class="token punctuation">></span></span>      <span class="token comment" spellcheck="true">&lt;!-- The database type. The format here is:           org.jooq.meta.[database].[database]Database --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">></span></span>org.jooq.meta.mysql.MySQLDatabase<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">></span></span>      <span class="token comment" spellcheck="true">&lt;!-- The database schema (or in the absence of schema support, in your RDBMS this           can be the owner, user, database name) to be generated --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>inputSchema</span><span class="token punctuation">></span></span>library<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>inputSchema</span><span class="token punctuation">></span></span>      <span class="token comment" spellcheck="true">&lt;!-- All elements that are generated from your schema           (A Java regular expression. Use the pipe to separate several expressions)           Watch out for case-sensitivity. Depending on your database, this might be important! --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>includes</span><span class="token punctuation">></span></span>.*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>includes</span><span class="token punctuation">></span></span>      <span class="token comment" spellcheck="true">&lt;!-- All elements that are excluded from your schema           (A Java regular expression. Use the pipe to separate several expressions).           Excludes match before includes, i.e. excludes have a higher priority --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>excludes</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>excludes</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>database</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>target</span><span class="token punctuation">></span></span>      <span class="token comment" spellcheck="true">&lt;!-- The destination package of your generated classes (within the destination directory) --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packageName</span><span class="token punctuation">></span></span>test.generated<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packageName</span><span class="token punctuation">></span></span>      <span class="token comment" spellcheck="true">&lt;!-- The destination directory of your generated classes. Using Maven directory layout here --></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>directory</span><span class="token punctuation">></span></span>C:/workspace/MySQLTest/src/main/java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>directory</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>target</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>generator</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span></code></pre><p>上面直接贴了官网样例。可能需要修改的有：</p><ul><li>数据库连接<code>jdbc</code></li><li>要生成Java代码对应的数据库名<code>inputSchema</code></li><li>目标路径<code>directory</code>和目标包名<code>packageName</code></li></ul><h2 id="生成步骤"><a href="#生成步骤" class="headerlink" title="生成步骤"></a>生成步骤</h2><p>首先按官网文档所说，下载<code>jooq-3.11.11.jar</code>、<code>jooq-codegen-3.11.11.jar</code>、<code>jooq-meta-3.11.11.jar</code>以及<code>mysql-connector-java-5.1.36.jar</code>四个jar包到某个临时目录（例如<code>D:\temp</code>），将上面的xml文件也放进该目录（命名为<code>x.xml</code>）。</p><pre><code>java -classpath jooq-3.11.11.jar;jooq-meta-3.11.11.jar;jooq-codegen-3.11.11.jar;mysql-connector-java-5.1.36.jar;. org.jooq.codegen.GenerationTool x.xml</code></pre><p>如果参考了官网的命令，注意去掉谜之换行以及MySQL驱动jar包名称后面的<code>-bin</code>。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> jOOQ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x04</title>
      <link href="/2019/08/12/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x04/"/>
      <url>/2019/08/12/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x04/</url>
      
        <content type="html"><![CDATA[<h1 id="重构、测试和调试"><a href="#重构、测试和调试" class="headerlink" title="重构、测试和调试"></a>重构、测试和调试</h1><h2 id="为改善可读性和灵活性重构代码"><a href="#为改善可读性和灵活性重构代码" class="headerlink" title="为改善可读性和灵活性重构代码"></a>为改善可读性和灵活性重构代码</h2><h3 id="从匿名类到Lambda表达式的转换"><a href="#从匿名类到Lambda表达式的转换" class="headerlink" title="从匿名类到Lambda表达式的转换"></a>从匿名类到Lambda表达式的转换</h3><ul><li>将实现单一抽象方法的匿名类转换为Lambda表达式。</li></ul><pre class=" language-java"><code class="language-java">Runnable r1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Runnable r2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>转换时应当注意：</p><ul><li>匿名类和Lambda表达式中的<code>this</code>和<code>super</code>的含义是不同的。在匿名类中，<code>this</code>代表的类是自身，但在Lambda中代表的是包含类（<em>外部类</em>）。</li><li>匿名类可以屏蔽包含类的变量，而Lambda表达式不能。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>Runnable r1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//! int a = 2;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>Runnable r2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//正确</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><ul><li>在涉及重载的上下文里，Lambda表达式将无法确定其类型，而匿名类则在初始化时确定了其类型。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Task</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span>Runnable runnable<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"in runnable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        runnable<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span>Task task<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"in task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        task<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">//! Main.test(() -> System.out.println("error"));</span>        <span class="token comment" spellcheck="true">// 无法通过编译</span>        <span class="token comment" spellcheck="true">// Error:(22, 13) java: 对test的引用不明确</span>        <span class="token comment" spellcheck="true">//     Main 中的方法 test(java.lang.Runnable) 和 Main 中的方法 test(Task) 都匹配</span>        Main<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Task<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"right"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 使用强制转换，正确</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="从Lambda表达式到方法引用的转换"><a href="#从Lambda表达式到方法引用的转换" class="headerlink" title="从Lambda表达式到方法引用的转换"></a>从Lambda表达式到方法引用的转换</h3><ul><li>为了改善代码的可读性，尽量使用方法引用，因为方法名往往能更直观地表达代码的意图。另外，还应该考虑使用静态辅助方法，比如<code>comparing</code>、<code>maxBy</code>。</li></ul><h3 id="从命令式的数据处理切换到Stream"><a href="#从命令式的数据处理切换到Stream" class="headerlink" title="从命令式的数据处理切换到Stream"></a>从命令式的数据处理切换到Stream</h3><ul><li>Stream API能更清晰地表达数据处理管道的意图。另外，通过短路和延迟载入以及利用多核，可以对Stream进行优化。但是这是一个困难的任务，因为要选择适当的流操作来还原控制流语句，例如<code>break</code>、<code>continue</code>以及<code>return</code>。</li></ul><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> dishName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>Dish dish<span class="token operator">:</span> menu<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">300</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        dishNames<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span>menu<span class="token punctuation">.</span><span class="token function">parallelStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>d <span class="token operator">-</span><span class="token operator">></span> d<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">300</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="使用Lambda重构面向对象的设计模式"><a href="#使用Lambda重构面向对象的设计模式" class="headerlink" title="使用Lambda重构面向对象的设计模式"></a>使用Lambda重构面向对象的设计模式</h2><h3 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h3><ul><li>策略模式代表了解决一类算法的通用解决方案，可以在运行时选择使用哪种方案。策略模式包含三部分内容：<ul><li>一个代表某个算法的接口。</li><li>一个或多个该接口的具体实现，它们代表了算法的多种实现。</li><li>一个或多个使用策略对象的客户。</li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">ValidationStrategy</span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">IsAllLowerCase</span> <span class="token keyword">implements</span> <span class="token class-name">ValidationStrategy</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"[a-z]+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">IsNumberic</span> <span class="token keyword">implements</span> <span class="token class-name">ValidationStrategy</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">execute</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"\\d+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Validator</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> ValidationStrategy strategy<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Validator</span><span class="token punctuation">(</span>ValidationStrategy strategy<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>strategy <span class="token operator">=</span> strategy<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validate</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> strategy<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Validator nv1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsNumberic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> b1 <span class="token operator">=</span> nv1<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Validator lv1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IsAllLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">boolean</span> b2 <span class="token operator">=</span> lv1<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string">"bbbb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Validator nv2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> s<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"[a-z]+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b1 <span class="token operator">=</span> nv2<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Validator lv2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Validator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String s<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> s<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"\\d+"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b2 <span class="token operator">=</span> lv2<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token string">"bbb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="模版方法"><a href="#模版方法" class="headerlink" title="模版方法"></a>模版方法</h3><ul><li>如果需要采用某个算法的框架，同时又希望有一定的灵活度，能对它的某些部分进行改进，那么采用模版方法设计模式是比较通用的方案。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">OnlineBanking</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processCustomer</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Custormer c <span class="token operator">=</span> Database<span class="token punctuation">.</span><span class="token function">getCustormerWithId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">makeCustomerHappy</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">makeCustomerHappy</span><span class="token punctuation">(</span>Customer c<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码搭建的在线银行算法框架，不同的支行可以通过继承<code>OnlineBanking</code>来提供不同的服务。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">OnlineBanking</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processCustomer</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> Consumer<span class="token operator">&lt;</span>Customer<span class="token operator">></span> makeCustomerHappy<span class="token punctuation">)</span> <span class="token punctuation">{</span>        makeCustomerHappy<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//...</span><span class="token keyword">new</span> <span class="token class-name">OnlineBanking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">processCustomer</span><span class="token punctuation">(</span><span class="token number">1337</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Customer c<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hello!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h3><ul><li>观察者模式是，某些事件发生时（比如状态转变），如果一个对象（主题）需要自动地通知其他多个对象（观察者）。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 观察者接口</span><span class="token keyword">interface</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span>String tweet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 不同的观察者</span><span class="token keyword">class</span> <span class="token class-name">NYTimes</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span>String tweet<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tweet <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tweet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"money"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Breaking news in NY! "</span> <span class="token operator">+</span> tweet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Guardian</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span>String tweet<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tweet <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tweet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"queen"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Yet another news in London... "</span> <span class="token operator">+</span> tweet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">LeMonde</span> <span class="token keyword">implements</span> <span class="token class-name">Observer</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span>String tweet<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tweet <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tweet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"wine"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Today cheese, wine and news! "</span> <span class="token operator">+</span> tweet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 主题接口</span><span class="token keyword">interface</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">registerObserver</span><span class="token punctuation">(</span>Observer o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">notifyObservers</span><span class="token punctuation">(</span>String tweet<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Feed</span> <span class="token keyword">implements</span> <span class="token class-name">Subject</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> List<span class="token operator">&lt;</span>Observer<span class="token operator">></span> observers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">registerObserver</span><span class="token punctuation">(</span>Observer o<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>observers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notifyObservers</span><span class="token punctuation">(</span>String tweet<span class="token punctuation">)</span> <span class="token punctuation">{</span>       observers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>o <span class="token operator">-</span><span class="token operator">></span> o<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span>tweet<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//...</span><span class="token comment" spellcheck="true">// 使用</span>Feed f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Feed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token punctuation">.</span><span class="token function">registerObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">NYTimes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token punctuation">.</span><span class="token function">registerObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Guardian</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token punctuation">.</span><span class="token function">registerObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LeMonde</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>f<span class="token punctuation">.</span><span class="token function">notifyObservers</span><span class="token punctuation">(</span><span class="token string">"The queen said her favourite book is Java 8 in Action!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 优化观察者声明和注册</span>f<span class="token punctuation">.</span><span class="token function">registerObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span>String tweet<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tweet <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> tweet<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"money"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Breaking news in NY! "</span> <span class="token operator">+</span> tweet<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//...</span></code></pre><ul><li>上面示例仅限简单的观察者模式。如果观察者的逻辑十分复杂，或者持有状态、定义了多个方法等等，此时应该继续使用类的方式。</li></ul><h3 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h3><ul><li>责任链模式是一种创建处理对象序列的通用方案。一个处理对象可能需要在完成一些工作之后，将结果传递给另一个对象，这个对象接着做一些工作，再转交给下一个处理对象，以此类推。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 处理抽象类</span><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ProcessingObject</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> ProcessingObject<span class="token operator">&lt;</span>T<span class="token operator">></span> successor<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSuccessor</span><span class="token punctuation">(</span>ProcessingObject<span class="token operator">&lt;</span>T<span class="token operator">></span> successor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>successor <span class="token operator">=</span> successor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> T <span class="token function">handle</span><span class="token punctuation">(</span>T input<span class="token punctuation">)</span> <span class="token punctuation">{</span>        T r <span class="token operator">=</span> <span class="token function">handleWork</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>successor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> successor<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>         <span class="token keyword">return</span> r<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">abstract</span> <span class="token keyword">protected</span> T <span class="token function">handleWork</span><span class="token punctuation">(</span>T input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 处理类</span><span class="token keyword">class</span> <span class="token class-name">HeaderTextProcessing</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessingObject</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> String <span class="token function">handleWord</span><span class="token punctuation">(</span>String text<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"From Raoul, Mario and Alan: "</span> <span class="token operator">+</span> text<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">SpellCheckerProcessing</span> <span class="token keyword">extends</span> <span class="token class-name">ProcessingObject</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> String <span class="token function">handleWord</span><span class="token punctuation">(</span>String text<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> text<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"labda"</span><span class="token punctuation">,</span> <span class="token string">"lambda"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 使用</span>ProcessingObject<span class="token operator">&lt;</span>String<span class="token operator">></span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeaderTextProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ProcessingObjct<span class="token operator">&lt;</span>String<span class="token operator">></span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpellCheckerProcessing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p1<span class="token punctuation">.</span><span class="token function">setSuccessor</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>String result <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token string">"Aren't labdas really sexy?!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用Lambda优化处理对象实现和连接</span>UnaryOperator<span class="token operator">&lt;</span>String<span class="token operator">></span> headerProcessing <span class="token operator">=</span> <span class="token punctuation">(</span>String text<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"From Raoul, Mario and Alan: "</span> <span class="token operator">+</span> text<span class="token punctuation">;</span>UnaryOperator<span class="token operator">&lt;</span>String<span class="token operator">></span> spellCheckerProcessing <span class="token operator">=</span> <span class="token punctuation">(</span>String text<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> text<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"labda"</span><span class="token punctuation">,</span> <span class="token string">"lambda"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Function<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> pipeline <span class="token operator">=</span> headerProcessing<span class="token punctuation">.</span><span class="token function">andThen</span><span class="token punctuation">(</span>spellCheckerProcessing<span class="token punctuation">)</span><span class="token punctuation">;</span>String result <span class="token operator">=</span> pipeline<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token string">"Aren't labdas really sexy?!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h3><ul><li>使用工厂模式，无需向客户端暴露实例化的逻辑就能完成对象的创建。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProdectFactory</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Product <span class="token function">createProduct</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> <span class="token string">"loan"</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Loan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"stock"</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token keyword">new</span>  <span class="token class-name">Stock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token string">"bond"</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Bond</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No such product "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// 使传统的工厂模式</span>Product p <span class="token operator">=</span> ProductFactory<span class="token punctuation">.</span><span class="token function">createProduct</span><span class="token punctuation">(</span><span class="token string">"loan"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用Lambda表达式优化工厂模式</span><span class="token keyword">final</span> <span class="token keyword">static</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> Supplier<span class="token operator">&lt;</span>Product<span class="token operator">>></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token punctuation">{</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"load"</span><span class="token punctuation">,</span> Loan<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">,</span> Stock<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bond"</span><span class="token punctuation">,</span> Bond<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> Product <span class="token function">createProduct</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Supplier<span class="token operator">&lt;</span>Product<span class="token operator">></span> p <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentExcetption</span><span class="token punctuation">(</span><span class="token string">"No such product "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ul><li>没有必要对Lambda表达式进行测试，更应该关注外围方法的的行为。</li></ul><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><ul><li>方法引用的错误可以体现在栈跟踪中，而Lambda表达式由于没有名字，栈跟踪显示的错误会比较难以理解。此时应该使用日志调试，即在流水线中插入<code>peek</code>方法查看中间值。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x03</title>
      <link href="/2019/08/08/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x03/"/>
      <url>/2019/08/08/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x03/</url>
      
        <content type="html"><![CDATA[<h1 id="并行数据处理与性能"><a href="#并行数据处理与性能" class="headerlink" title="并行数据处理与性能"></a>并行数据处理与性能</h1><h2 id="并行流"><a href="#并行流" class="headerlink" title="并行流"></a>并行流</h2><h3 id="将顺序流转换为并行流"><a href="#将顺序流转换为并行流" class="headerlink" title="将顺序流转换为并行流"></a>将顺序流转换为并行流</h3><ul><li>可以把流转换成并行流，从而让前面的函数归约过程并行运行。对顺序流调用<code>parallel()</code>方法。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">parallelSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Stream<span class="token punctuation">.</span><span class="token function">iterate</span><span class="token punctuation">(</span>1L<span class="token punctuation">,</span> i <span class="token operator">-</span><span class="token operator">></span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>        <span class="token punctuation">.</span><span class="token function">parallel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token function">reduce</span><span class="token punctuation">(</span>0L<span class="token punctuation">,</span> Long<span class="token operator">:</span><span class="token operator">:</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>对顺序流调用<code>parallel()</code>方法不意味着流本身有任何实际的变化。它内部实际上就是设了一个<code>boolean</code>标志，表示让调用<code>parallel()</code>方法之后进行的所有操作都并行执行。类似的，对并行流调用<code>sequential()</code>方法就可以把它变成顺序流。不过在一个流水线中，只有最后一个<code>parallel()</code>或者<code>squential()</code>方法生效，影响整个流水线。</li></ul><h3 id="高效使用并行流"><a href="#高效使用并行流" class="headerlink" title="高效使用并行流"></a>高效使用并行流</h3><ul><li>首先应该进行<strong>测量</strong>。并行流并不总是比顺序流快。</li><li>留意<strong>装箱</strong>。自动装箱合拆箱操作会大大降低性能。可以使用原始类型流（<code>IntStream</code>、<code>LongStream</code>、<code>DoubleStream</code>）来避免这种操作。</li><li>有些操作<strong>本身在并行流上的性能就比顺序流差</strong>，特别是<code>limit</code>和<code>findFirst</code>等依赖于元素顺序的操作，它们在并行流上执行的代价非常大。</li><li>要考虑流的操作流水线的<strong>总计算成本</strong>。设<code>N</code>是要处理的元素总数，<code>Q</code>是一个元素通过流水线的大致处理成本，则<code>N*Q</code>就是这个对成本的一个粗略估计。Q值较高就意味着使用并行流时性能好的可能性比较大。</li><li>对于较小的数据量，选择并行流几乎不是一个好的决定。并行处理少数几个元素的好处还抵不上<strong>并行化造成的额外开销</strong>。</li><li>要考虑<strong>流背后的数据结构是否容易分解</strong>。例如<code>ArrayList</code>的拆分效率比<code>LinkedList</code>高得多，因为前者不用遍历就可以平均拆分，后者则必须遍历。</li><li>流自身的特点，以及流水线中的中间操作修改流的方式，都可能会<strong>改变分解过程的性能</strong>。例如一个流可以分成大小相同的两部分，这样每个部分都可以比较高效地并行处理，但筛选操作可能会丢弃的元素个数却无法预测，导致流的大小未知。</li><li>要考虑终端操作中合并步骤的代价。如果代价很大，那么组合每个子流产生的部分结果所付出的代价就可能会超过通过并行流得到的性能提升。</li></ul><h2 id="分支-合并框架"><a href="#分支-合并框架" class="headerlink" title="分支/合并框架"></a>分支/合并框架</h2><ul><li>分支/合并框架的目的是以递归的方式将可以并行的任务拆分成更小的任务，然后将每个子任务的结果合并起来生成整体结果。它是<code>ExecutorService</code>接口的一个实现，它把子任务分配给线程池（称为<code>ForkJoinPool</code>）中的工作线程。</li></ul><h3 id="使用RecursiveTask"><a href="#使用RecursiveTask" class="headerlink" title="使用RecursiveTask"></a>使用RecursiveTask</h3><ul><li>要把任务提交到线程池，必须创建<code>RecursiveTask&lt;R&gt;</code>的一个子类，其中<code>R</code>时并行化任务（以及所有子任务）产生的结果类型，或者如果任务不返回结果，则是<code>RecursiveAction</code>类型。要定义<code>RecursiveTask</code>只需要实现它唯一的抽象方法<code>compute</code>。这个方法同时定义了将任务拆分成子任务的逻辑，以及无法再久拆分或不方便再拆分时，生成单个子任务结果的逻辑。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ForkJoinSumCalculator</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token operator">&lt;</span>Long<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> start<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> end<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> THRESHOLD <span class="token operator">=</span> 10_000<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ForkJoinSumCalculator</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>numbers <span class="token operator">=</span> numbers<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> start<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>end <span class="token operator">=</span> end<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">ForkJoinSumCalculator</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numbers<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">computeSequentially</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            sum <span class="token operator">+=</span> numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> sum<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">protected</span> Long <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> length <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> THRESHOLD<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">computeSequentially</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ForkJoinSumCalculator leftTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> start<span class="token punctuation">,</span> start <span class="token operator">+</span> <span class="token punctuation">(</span>length <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        leftTask<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ForkJoinSumCalculator rightTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> start <span class="token operator">+</span> <span class="token punctuation">(</span>length <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>        Long rightResult <span class="token operator">=</span> rightTask<span class="token punctuation">.</span><span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Long leftResult <span class="token operator">=</span> leftTask<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> leftResult <span class="token operator">+</span> rightResult<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">forkJoinSum</span><span class="token punctuation">(</span><span class="token keyword">long</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers <span class="token operator">=</span> LongStream<span class="token punctuation">.</span><span class="token function">rangeClosed</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ForkJoinTask<span class="token operator">&lt;</span>Long<span class="token operator">></span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinSumCalculator</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="使用分支-合并框架的最佳做法"><a href="#使用分支-合并框架的最佳做法" class="headerlink" title="使用分支/合并框架的最佳做法"></a>使用分支/合并框架的最佳做法</h3><ul><li>对一个任务调用<code>join</code>方法会阻塞调用方，直到该任务做出结果。因此，有必要在两个子任务的计算都开始之后再调用它。否则会比原始的顺序算法更慢更复杂，因为每个子任务都必须等待另一个子任务完成才能启动。</li><li>不应该在<code>RecursiveTask</code>内部使用<code>ForkJoinPool</code>的<code>invoke</code>方法。相反，应该直接调用<code>compute</code>或<code>fork</code>方法，只有顺序代码才应该用<code>invoke</code>来启动并行计算。</li><li>对子任务调用<code>fork</code>方法可以把它排进<code>ForkJoinPool</code>。同时对左右两边的子任务调用<code>fork</code>的效率要比直接对其中一个调用<code>compute</code>低。直接调用<code>compute</code>可以为其中一个子任务重用同一线程，从而避免在线程池中多分配一个任务造成的开销。</li><li>调试使用分支/合并框架的并行计算可能有点棘手，特别是查看栈跟踪无法起作用，因为调用<code>compute</code>的线程并不是概念上的调用方。</li><li>和并行流一样，在多核处理器上使用分支/合并框架不一定比顺序执行快。分支/合并框架需要“预热”或者说要执行几遍才会被JIT编译器优化。</li></ul><h3 id="工作窃取"><a href="#工作窃取" class="headerlink" title="工作窃取"></a>工作窃取</h3><ul><li>在理想情况下，划分并行任务时，应该让每个任务都用完全相同的时间完成，让所有的CPU内核都同样繁忙。但是实际上，每个子任务所花的时间可能天差地别，要么是因为划分策略效率低，要么是有不可预知的原因，例如磁盘访问慢，或是需要和外部服务进行协调执行。</li><li>分支/合并框架使用工作窃取来解决工作量不平衡的问题。在实际使用中，任务会被差不多地分配到<code>ForkJoinPool</code>中的所有线程上。每个线程都为分配给它的任务保存一个双向链式队列，每完成一个任务，就会从队列头上取出下一个任务开始执行。如果某个线程早早完成了分配给它的所有任务，也就是它的任务队列已经空了，而其它的线程还很忙。这时，该线程会随机选择一个别的线程，从其队尾“偷走”一个任务。这个过程一直继续下去，直到所有的任务都执行完毕，所有的队列都清空。这就是为什么要划成许多小任务而不是少数几个大任务，这有助于更好地在工作线程之间平衡负载。</li></ul><h2 id="Spliterator"><a href="#Spliterator" class="headerlink" title="Spliterator"></a>Spliterator</h2><ul><li><code>Spliterator</code>，和<code>Iterator</code>一样用于遍历数据源中的元素，但它是为了并行执行而设计的。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Spliterator接口定义</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Spliterator</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span>Consumer<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">></span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>    Spliterator<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">trySplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">long</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="拆分过程"><a href="#拆分过程" class="headerlink" title="拆分过程"></a>拆分过程</h3><p><img src="/images/2019-08-12_202534.png" alt="拆分过程状态转换"></p><ul><li>将<code>Stream</code>拆分成多个部分的算法是一个递归过程，不断地对<code>Spliterator</code>调用<code>trySplit</code>直到它返回<code>null</code>。当所有的<code>Spliterator</code>都返回<code>null</code>则拆分终止。</li><li><code>Spliterator</code>接口声明的最后一个抽象方法是<code>characteristics</code>，它将返回一个<code>int</code>，代表<code>Spliterator</code>本身特性集的编码。</li></ul><table><thead><tr><th>特性</th><th>含义</th></tr></thead><tbody><tr><td><code>ORDERED</code></td><td>元素有既定顺序（例如<code>List</code>），因此<code>Spliterator</code>在遍历和划分时也会遵守这一顺序</td></tr><tr><td><code>DISTINCT</code></td><td>对于任意一对遍历过的元素<code>x</code>和<code>y</code>，<code>x.equals(y)</code>返回<code>false</code></td></tr><tr><td><code>SORTED</code></td><td>遍历的元素按照一个预定义的顺序排序</td></tr><tr><td><code>SIZED</code></td><td>该<code>Spliterator</code>由一个已知大小的源建立（例如<code>Set</code>），因此<code>estimatedSize()</code>返回的是准确值</td></tr><tr><td><code>NONNULL</code></td><td>保证遍历的元素不会为<code>null</code></td></tr><tr><td><code>IMMUTABLE</code></td><td><code>Spliterator</code>的数据源不能被修改。这意味着在遍历时不能添加、删除或修改任何元素</td></tr><tr><td><code>CONCURRENT</code></td><td>该<code>Spliterator</code>的数据源可以被其他线程同时修改而无需同步</td></tr><tr><td><code>SUBSIZED</code></td><td>该<code>Spliterator</code>和所有从它拆分出来的<code>Spliterator</code>都是<code>SIZED</code></td></tr></tbody></table><h3 id="实现自定义Spliterator"><a href="#实现自定义Spliterator" class="headerlink" title="实现自定义Spliterator"></a>实现自定义Spliterator</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">WordCounterSpliterator</span> <span class="token keyword">implements</span> <span class="token class-name">Spliterator</span><span class="token operator">&lt;</span>Character<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> String string<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> currentChar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">WordCounterSpliterator</span><span class="token punctuation">(</span>String string<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>string <span class="token operator">=</span> string<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryAdvance</span><span class="token punctuation">(</span>Consumer<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> Character<span class="token operator">></span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>        action<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>currentChar<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> currentChar <span class="token operator">&lt;</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Spliterator<span class="token operator">&lt;</span>Character<span class="token operator">></span> <span class="token function">trySplit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> currentSize <span class="token operator">=</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentChar<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentSize <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 从中间开始，找下一个空白字符，然后拆分，以避免从单词中间拆开</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> splitPos <span class="token operator">=</span> <span class="token punctuation">(</span>currentSize <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> currentChar<span class="token punctuation">;</span> splitPos <span class="token operator">&lt;</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> splitPos<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>Character<span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>splitPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Spliterator<span class="token operator">&lt;</span>Character<span class="token operator">></span> spliterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WordCounterSpliterator</span><span class="token punctuation">(</span>string<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>currentChar<span class="token punctuation">,</span> splitPos<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                currentChar <span class="token operator">=</span> splitPos<span class="token punctuation">;</span>                <span class="token keyword">return</span> spliterator<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">estimateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> string<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> currentChar<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> ORDERED <span class="token operator">+</span> SIZED <span class="token operator">+</span> SUBSIZED <span class="token operator">+</span> NONNULL <span class="token operator">+</span> IMMUTABLE<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">WordCounter</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> counter<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> lastSpace<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">WordCounter</span><span class="token punctuation">(</span><span class="token keyword">int</span> counter<span class="token punctuation">,</span> <span class="token keyword">boolean</span> lastSpace<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>counter <span class="token operator">=</span> counter<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>lastSpace <span class="token operator">=</span> lastSpace<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 遍历，见状态转换图</span>    <span class="token keyword">public</span> WordCounter <span class="token function">accumulate</span><span class="token punctuation">(</span>Character c<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Character<span class="token punctuation">.</span><span class="token function">isWhitespace</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> lastSpace <span class="token operator">?</span> <span class="token keyword">this</span> <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span>counter<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> lastSpace <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 归约方法，将两个WordCounter合并为一个</span>    <span class="token keyword">public</span> WordCounter <span class="token function">combine</span><span class="token punctuation">(</span>WordCounter wordCounter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span>counter <span class="token operator">+</span> wordCounter<span class="token punctuation">.</span>counter<span class="token punctuation">,</span> wordCounter<span class="token punctuation">.</span>lastSpace<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> counter<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">countWords</span><span class="token punctuation">(</span>Stream<span class="token operator">&lt;</span>Character<span class="token operator">></span> stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 使用流归约</span>        WordCounter wordCounter <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>                <span class="token keyword">new</span> <span class="token class-name">WordCounter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                WordCounter<span class="token operator">:</span><span class="token operator">:</span>accumulate<span class="token punctuation">,</span>                WordCounter<span class="token operator">:</span><span class="token operator">:</span>combine        <span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> wordCounter<span class="token punctuation">.</span><span class="token function">getCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">final</span> String SENTENCE <span class="token operator">=</span> <span class="token string">" Nel mezzo del cammin di nostra vita mi ritrovai in una selva oscura"</span> <span class="token operator">+</span>                <span class="token string">" che la dritta via era smarrita "</span><span class="token punctuation">;</span>        Spliterator<span class="token operator">&lt;</span>Character<span class="token operator">></span> spliterator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WordCounterSpliterator</span><span class="token punctuation">(</span>SENTENCE<span class="token punctuation">)</span><span class="token punctuation">;</span>        Stream<span class="token operator">&lt;</span>Character<span class="token operator">></span> stream <span class="token operator">=</span> StreamSupport<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>spliterator<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Found "</span> <span class="token operator">+</span> Main<span class="token punctuation">.</span><span class="token function">countWords</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" words"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><code>tryAdvance</code>方法的行为类似于普通的<code>Iterator</code>，因为它会按顺序一个一个使用<code>Spliterator</code>中的元素，并且还有其他元素要遍历就返回<code>true</code>。在上面代码中，<code>tryAdvance</code>将当前位置的<code>Character</code>传给了<code>Consumer</code>，并让位置加一。作为参数传递的<code>Consumer</code>是一个Java内部类，在遍历流时将要处理的<code>Character</code>传给了一系列要对其执行的函数。这里传递给了<code>accumulate()</code>。</li><li><code>trySplit</code>方法定义了拆分要遍历的数据结构的逻辑。首先要设定不再进一步拆分的下限，以避免生成太多的任务。拆分时，一旦找到合适的位置，就可以创建一个新的<code>Spliterator</code>来遍历从当前位置到拆分位置的子串。</li><li><code>estimatedSize</code>是这个<code>Spliterator</code>解析的<code>String</code>的总长度和当前遍历位置的差。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x02</title>
      <link href="/2019/08/05/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x02/"/>
      <url>/2019/08/05/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x02/</url>
      
        <content type="html"><![CDATA[<h1 id="用流收集数据"><a href="#用流收集数据" class="headerlink" title="用流收集数据"></a>用流收集数据</h1><h2 id="归约和汇总"><a href="#归约和汇总" class="headerlink" title="归约和汇总"></a>归约和汇总</h2><h3 id="查找流中的最大值和最小值"><a href="#查找流中的最大值和最小值" class="headerlink" title="查找流中的最大值和最小值"></a>查找流中的最大值和最小值</h3><ul><li><code>Collectors.maxBy</code>和<code>Collectors.minBy</code>可以计算流中的最大或最小值。这两个收集器接收一个<code>Comparator</code>参数来比较流中的元素。</li></ul><pre class=" language-java"><code class="language-java">Comparator<span class="token operator">&lt;</span>Dish<span class="token operator">></span> dishCaloriesComparator <span class="token operator">=</span> Comparator<span class="token punctuation">.</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getCalories<span class="token punctuation">)</span><span class="token punctuation">;</span>Optional<span class="token operator">&lt;</span>Dish<span class="token operator">></span> mostCalorieDish <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">maxBy</span><span class="token punctuation">(</span>DishCaloriesComparator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h3><ul><li><code>Collectors</code>类专门为汇总提供了一个工厂方法<code>Collectors.summingInt</code>。它可接受一个把对象映射为求和所需<code>int</code>的函数，并返回一个收集器；该收集器在传递普通的<code>collect</code>方法后即执行所需要的汇总操作。类似的还有<code>Collectors.summingLong</code>和<code>Collectors.summingDouble</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> totalCalories <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">summingInt</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span>getCalories<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><code>Collectors.averagingInt</code>，以及对应的<code>Collectors.averagingLong</code>和<code>Collectors.averagingDouble</code>可以计算数值的平均数。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">double</span> avgCalories <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">averagingInt</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getCalories<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><code>summarizingInt</code>工厂方法返回的收集器可以一次操作就得到流中元素的个数、所选值的总和、平均值、最大值、最小值。</li></ul><pre class=" language-java"><code class="language-java">IntSummaryStatistics menuStatistics <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">summarizingInt</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getCalories<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="连接字符串"><a href="#连接字符串" class="headerlink" title="连接字符串"></a>连接字符串</h3><ul><li><code>joining</code>工厂方法返回的收集器会把对流中每一个对象应用<code>toString</code>方法得到的所有字符串连接成一个字符串。</li></ul><pre class=" language-java"><code class="language-java">String shortMenu <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><ul><li><code>joining</code>在内部使用了<code>StringBuilder</code>来把生成的字符串逐个追加起来。此外，如果对象有<code>toString()</code>方法，那么可以省略<code>map</code>映射。</li></ul><pre class=" language-java"><code class="language-java">String shortMenu <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><code>joining()</code>还接受一个字符串作为分界符。</li></ul><pre class=" language-java"><code class="language-java">String shortMenu <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="广义的归约汇总"><a href="#广义的归约汇总" class="headerlink" title="广义的归约汇总"></a>广义的归约汇总</h3><ul><li><code>reduce</code>工厂方法则是所有归约情况的一般化，它需要三个参数：初始值、转换函数、累积函数（将两个项目累积成一个同类型的值）。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> totalCalories <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">reducing</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Dish<span class="token operator">:</span><span class="token operator">:</span>getCalories<span class="token punctuation">,</span> Integer<span class="token operator">:</span><span class="token operator">:</span>sum<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h2><ul><li>可以使用<code>Collectors.groupingBy</code>工厂方法返回的收集器来实现元素分组。</li></ul><pre class=" language-java"><code class="language-java">Map<span class="token operator">&lt;</span>Dish<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Dish<span class="token operator">>></span> dishesByType <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getType<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>在上面代码中，<code>groupingBy</code>方法接受一个分类函数，用于提取元素的类别从而对元素进行分组。分组的操作结果是一个<code>Map</code>，分组函数返回的值作为映射的键，流中所有具有这个分类值的项目的列表作为对应的映射值。如果没有现成的获取元素类别的函数，可以传入Lambda。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> ColaricLevel <span class="token punctuation">{</span> DIET<span class="token punctuation">,</span> NORMAL<span class="token punctuation">,</span> FAT <span class="token punctuation">}</span>Map<span class="token operator">&lt;</span>CaloricLevel<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Dish<span class="token operator">>></span> dishesByCaloricLevel <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>    <span class="token function">groupingBy</span><span class="token punctuation">(</span>dish <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token keyword">return</span> CaloricLevel<span class="token punctuation">.</span>DIET<span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">700</span><span class="token punctuation">)</span> <span class="token keyword">return</span> CaloricLevel<span class="token punctuation">.</span>NORMAL<span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">return</span> CaloricLevel<span class="token punctuation">.</span>FAT<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="多级分组"><a href="#多级分组" class="headerlink" title="多级分组"></a>多级分组</h3><ul><li><code>Collectors.groupingBy</code>有双参数版本，第二个参数为<code>collector</code>类型。进行二级分组时，可以把一个内层<code>groupingBy</code>传递给外层<code>groupingBy</code>，并定义一个为流中项目分类的二级标准。</li></ul><pre class=" language-java"><code class="language-java">Map<span class="token operator">&lt;</span>Dish<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>CaloricLevel<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Dish<span class="token operator">>>></span> dishesByTypeCaloricLevel <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>    <span class="token function">groupingBy</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getType<span class="token punctuation">,</span> <span class="token function">groupingBy</span><span class="token punctuation">(</span>dish <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token keyword">return</span> CaloricLevel<span class="token punctuation">.</span>DIET<span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>dish<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">700</span><span class="token punctuation">)</span> <span class="token keyword">return</span> CaloricLevel<span class="token punctuation">.</span>NORMAL<span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token keyword">return</span> CaloricLevel<span class="token punctuation">.</span>FAT<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="按子组收集数据"><a href="#按子组收集数据" class="headerlink" title="按子组收集数据"></a>按子组收集数据</h3><ul><li><code>groupingBy</code>的第二个参数也可以是其它<code>collect</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 分组求和</span>Map<span class="token operator">&lt;</span>Dish<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> Long<span class="token operator">></span> typesCount <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getType<span class="token punctuation">,</span> <span class="token function">counting</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 找出分组最大值</span>Map<span class="token operator">&lt;</span>Dish<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> Optional<span class="token operator">&lt;</span>Dish<span class="token operator">>></span> mostCaloricByType <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>    Dish<span class="token operator">:</span><span class="token operator">:</span>getType<span class="token punctuation">,</span>    <span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getCalories<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li><code>Collectors.collectingAndThen</code>可以把收集器返回的结果转换为另一种类型。</li></ul><pre class=" language-java"><code class="language-java">Map<span class="token operator">&lt;</span>Dish<span class="token punctuation">.</span>Type<span class="token punctuation">,</span> Dish<span class="token operator">></span> mostCaloricByType <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>    Dish<span class="token operator">:</span><span class="token operator">:</span>getType<span class="token punctuation">,</span>    <span class="token function">collectingAndThen</span><span class="token punctuation">(</span><span class="token function">maxBy</span><span class="token punctuation">(</span><span class="token function">comparingInt</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getCalories<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Optional<span class="token operator">:</span><span class="token operator">:</span>get<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="分区"><a href="#分区" class="headerlink" title="分区"></a>分区</h2><ul><li>分区是分组的特殊情况：由一个谓词作为分类函数，它成为分区函数。分区函数返回一个布尔值，这意味着得到的分组<code>Map</code>的键类型是<code>Boolean</code>，于是它最多可以分为两组，<code>true</code>一组<code>false</code>一组。类似<code>groupingBy</code>可以进行多级分区。</li></ul><pre class=" language-java"><code class="language-java">Map<span class="token operator">&lt;</span>Boolean<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>Dish<span class="token operator">>></span> partitionedMenu <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">partitioningBy</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>isVegetarian<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="收集器接口"><a href="#收集器接口" class="headerlink" title="收集器接口"></a>收集器接口</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// Collector接口定义</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Collector</span><span class="token operator">&lt;</span>T<span class="token punctuation">,</span> A<span class="token punctuation">,</span> R<span class="token operator">></span> <span class="token punctuation">{</span>    Supplier<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token function">supplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    BiConsumer<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Function<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> R<span class="token operator">></span> <span class="token function">finisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    BinaryOperator<span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token function">combiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Set<span class="token operator">&lt;</span>Characteristics<span class="token operator">></span> <span class="token function">characteristics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="接口解析"><a href="#接口解析" class="headerlink" title="接口解析"></a>接口解析</h3><h4 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h4><ul><li><code>T</code>是流中要收集的项目的泛型；<code>A</code>是累加器的类型，累加器是在收集过程中用于累积部分结果的对象；<code>R</code>是收集操作得到的对象（一般情况下是集合，但也有可能不是）。</li></ul><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><ul><li><code>supplier</code>方法：用于创建一个空的累加器实例，供数据收集过程使用</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Supplier<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token function">suplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 或者传递构造函数引用</span><span class="token keyword">public</span> Supplier<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token function">suplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> ArrayList<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li><code>accumulator</code>方法：返回执行归约操作的函数。当遍历到流中第n个元素时，这个函数执行时会有两个参数，保存归约结果的累加器（已收集了流中的n - 1个项目），以及第n个元素本身。该函数将返回<code>void</code>，因为是累加器的原位更新，即函数的执行改变了它的内部状态以体现遍历的元素的效果。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> BiConsumer<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>list<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 或者传递构造函数引用</span><span class="token keyword">public</span> BiConsumer<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> T<span class="token operator">></span> <span class="token function">accumulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> List<span class="token operator">:</span><span class="token operator">:</span>add<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li><code>finisher</code>方法：在遍历完流后，<code>finisher</code>方法必须返回累积过程的最后要调用的一个函数，以便将累加器对象转换为整个集合操作的最终结果。如果不需要进行转换，可以返回<code>Function.identity()</code>，该函数直接返回对象本身，即<code>return t -&gt; t;</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> Function<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">,</span> List<span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token function">finisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> Function<span class="token punctuation">.</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li><code>combiner</code>方法：返回一个供归约操作使用的函数，它定义了对流的各个子部分进行并行处理时，各个子部分归约所得到的累加器要如何合并。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> BinaryOperator<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token function">combiner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>list1<span class="token punctuation">,</span> list2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>        list1<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>list2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> list1<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>并行归约流程</li></ul><ol><li>原始流会以递归方式拆分为子流，直到定义流是否需要进一步拆分的一个条件为非。</li><li>对所有的子流并行处理，即对每个子流应用归约算法。</li><li>使用收集器<code>combiner</code>方法返回的函数，将所有的部分结果两两合并。</li></ol><ul><li><code>characteristics</code>方法：返回一个不可变的<code>Characteristics</code>集合，它定义了收集器的行为，尤其是关于流是否可以并行归约，以及可以使用哪些优化的提示。<code>Characteristics</code>是一个包含三个项目的枚举：<ol><li><code>UNORDERED</code>：归约结果不受流中项目的遍历和累积顺序的影响</li><li><code>CONCURRENT</code>：<code>accumulator</code>函数可以从多个线程同时调用，且该收集器可以并行归约流。如果收集器没有标为<code>UNORDERED</code>，那它仅在用于无序数据源才可以并行归约。</li><li><code>IDENTITY_FINISH</code>：这表明完成器方法返回的函数是一个恒等函数，可以跳过。这种情况下，类累加器对象将会直接用作归约过程的最终结果。这也就意味着，将累加器<code>A</code>不加检查地转换为结果<code>R</code>是安全的。</li></ol></li></ul><h3 id="进行自定义收集而不实现接口"><a href="#进行自定义收集而不实现接口" class="headerlink" title="进行自定义收集而不实现接口"></a>进行自定义收集而不实现接口</h3><ul><li><code>collector</code>的一个重载版本可以接受三个参数，<code>supplier</code>、<code>accumulator</code>、<code>combiner</code>。</li></ul><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>Dish<span class="token operator">></span> dishes <span class="token operator">=</span> menuStream<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>    ArrayList<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">,</span>    List<span class="token operator">:</span><span class="token operator">:</span>add<span class="token punctuation">,</span>    List<span class="token operator">:</span><span class="token operator">:</span>addAll<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x17</title>
      <link href="/2019/08/02/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x17/"/>
      <url>/2019/08/02/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x17/</url>
      
        <content type="html"><![CDATA[<h1 id="并发（四）"><a href="#并发（四）" class="headerlink" title="并发（四）"></a>并发（四）</h1><h2 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h2><ul><li>任务之间相互等待的连续循环，没有哪个线程能够继续执行，即死锁。</li><li>死锁发生的条件：<ol><li><strong>互斥条件</strong>。任务使用的资源中至少有一个是不能共享的。</li><li><strong>允许持有资源等待</strong>。至少有一个任务必须持有一个资源并且正在等待获取一个当前被别的任务持有的资源。</li><li><strong>资源不能被抢占</strong>，任务必须把资源释放当作普通事件。</li><li><strong>循环等待</strong>。一个任务等待其他任务所持有的资源，后者又在等待另一个任务所持有的资源，这样一直下去，直到有一个任务在等待第一个任务所持有的资源，使得所有任务都被锁住。</li></ol></li></ul><h2 id="部分类库的构件"><a href="#部分类库的构件" class="headerlink" title="部分类库的构件"></a>部分类库的构件</h2><h3 id="CountDownLatch"><a href="#CountDownLatch" class="headerlink" title="CountDownLatch"></a>CountDownLatch</h3><ul><li><code>CountDownLatch</code>用来同步一个或多个任务，强制它们等待由其他任务执行的一组操作完成。</li><li>可以向<code>CountDownLatch</code>对象设置一个初始计数值，任何在这个对象上调用<code>wait()</code>的方法都将阻塞，直至这个计数值到达0。其他任务结束其工作时，可以在该对象上调用<code>countDown()</code>来减小这个计数值。<code>CountDownLatch</code>设计为只触发一次，计数值不能被重置。</li><li>调用<code>countDown()</code>的任务在产生这个调用时并没有被阻塞，只有对<code>await()</code>的调用会被阻塞，直至计数值到达0。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">TaskPortion</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> id <span class="token operator">=</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> CountDownLatch latch<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">TaskPortion</span><span class="token punctuation">(</span>CountDownLatch latch<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> latch<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">"completed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%1$-3d "</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">WaitingTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> id <span class="token operator">=</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> CountDownLatch latch<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">WaitingTask</span><span class="token punctuation">(</span>CountDownLatch latch<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>latch <span class="token operator">=</span> latch<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Latch barrier passed for "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"WaitingTask %1$-3d"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIZE <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        CountDownLatch latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaitingTask</span><span class="token punctuation">(</span>latch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskPortion</span><span class="token punctuation">(</span>latch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Launched all tasks"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h3><ul><li>一组任务并行执行工作，然后在进行下一个步骤之前等待，直至所有任务都完成。它使得所有的并行任务都将在栅栏处列队，因此可以一致地向前移动，非常像<code>CountDownLatch</code>，只是<code>CountDownLatch</code>是只触发一次的事件，而<code>CyclicBarrier</code>可以多次重用。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Horse</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> id <span class="token operator">=</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> strides <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> CyclicBarrier cyclicBarrier<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Horse</span><span class="token punctuation">(</span>CyclicBarrier cyclicBarrier<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Horse<span class="token punctuation">.</span>cyclicBarrier <span class="token operator">=</span> cyclicBarrier<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">getStrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> strides<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    strides <span class="token operator">+=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Horse "</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">tracks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"*"</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">getStrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> FINISH_LINE <span class="token operator">=</span> <span class="token number">75</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>Horse<span class="token operator">></span> horseList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">int</span> nHorses<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> pause<span class="token punctuation">)</span> <span class="token punctuation">{</span>        CyclicBarrier cyclicBarrie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span>nHorses<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">.</span><span class="token function">repeat</span><span class="token punctuation">(</span>FINISH_LINE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>Horse horse <span class="token operator">:</span> horseList<span class="token punctuation">)</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>horse<span class="token punctuation">.</span><span class="token function">tracks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>Horse horse <span class="token operator">:</span> horseList<span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>horse<span class="token punctuation">.</span><span class="token function">getStrides</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> FINISH_LINE<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>horse <span class="token operator">+</span> <span class="token string">"won!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>pause<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"barrier action sleep"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nHorses<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>            Horse horse <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Horse</span><span class="token punctuation">(</span>cyclicBarrie<span class="token punctuation">)</span><span class="token punctuation">;</span>            horseList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>horse<span class="token punctuation">)</span><span class="token punctuation">;</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>horse<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">int</span> nHorses <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> pause <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Main</span><span class="token punctuation">(</span>nHorses<span class="token punctuation">,</span> pause<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>可以向<code>CyclicBarrier</code>提供一个“栅栏动作”，一个<code>Runnable</code>，当计数值到达0时自动执行。这是与<code>CountDownLatch</code>的另一个区别。</li></ul><h3 id="DelayQueue"><a href="#DelayQueue" class="headerlink" title="DelayQueue"></a>DelayQueue</h3><ul><li>一个无界的<code>BlockingQueue</code>，用于放置实现了<code>Delayed</code>接口的对象，其中的对象只能在其到期时才能从队列中取走。这种队列是有序的，即队头对象的<del>延迟</del>到期的时间最长。如果没有任何延迟到期，那么就不会有任何头元素，并且<code>poll()</code>将返回<code>null</code>。</li><li><em>延迟到期时间略带误导，指设定的到期时间减去当前时间，因此<code>DelayQueue</code>中元素排列是按设定时间从小到大排列。</em></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DelayedTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> Delayed <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> id <span class="token operator">=</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> delta<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> trigger<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>DelayedTask<span class="token operator">></span> sequence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">DelayedTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>delta <span class="token operator">=</span> delta<span class="token punctuation">;</span>        trigger <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> TimeUnit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>delta<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>        sequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getDelay</span><span class="token punctuation">(</span>TimeUnit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> unit<span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>trigger <span class="token operator">-</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>Delayed arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        DelayedTask that <span class="token operator">=</span> <span class="token punctuation">(</span>DelayedTask<span class="token punctuation">)</span> arg<span class="token punctuation">;</span>        <span class="token keyword">return</span> Long<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>trigger<span class="token punctuation">,</span> that<span class="token punctuation">.</span>trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%1$-4d]"</span><span class="token punctuation">,</span> delta<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" Task "</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">summary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"("</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> delta <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EndSentinel</span> <span class="token keyword">extends</span> <span class="token class-name">DelayedTask</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> ExecutorService exec<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">EndSentinel</span><span class="token punctuation">(</span><span class="token keyword">int</span> delay<span class="token punctuation">,</span> ExecutorService e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">super</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>            exec <span class="token operator">=</span> e<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>DelayedTask pt<span class="token operator">:</span> sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span><span class="token function">summary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" Calling shutdownNow()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">DelayedTaskConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> DelayQueue<span class="token operator">&lt;</span>DelayedTask<span class="token operator">></span> q<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">DelayedTaskConsumer</span><span class="token punctuation">(</span>DelayQueue<span class="token operator">&lt;</span>DelayedTask<span class="token operator">></span> q<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>q <span class="token operator">=</span> q<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                q<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Finished DelayedTaskConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DelayQueue<span class="token operator">&lt;</span>DelayedTask<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DelayQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            queue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DelayedTask</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DelayedTask<span class="token punctuation">.</span>EndSentinel</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">,</span> exec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DelayedTaskConsumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><code>Delayed</code>接口有一个方法名为<code>getDelay()</code>，它可以用来告知延迟到期有多长时间，或者到场时间之前已经到期。<em>比起<code>BlockingQueue</code>，<code>DelayQueue#take()</code>会在没有元素或者没有元素到期时阻塞。</em></li></ul><h3 id="PriorityBlockingQueue"><a href="#PriorityBlockingQueue" class="headerlink" title="PriorityBlockingQueue"></a>PriorityBlockingQueue</h3><ul><li><em>与上面<code>DelayQueue</code>类似，只不过优先级是人为指定。</em></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">PriorizedTask</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">,</span> Comparable<span class="token operator">&lt;</span>PriorizedTask<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> id  <span class="token operator">=</span> counter<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> priority<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>PriorizedTask<span class="token operator">></span> sequence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">PriorizedTask</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>priority <span class="token operator">=</span> priority<span class="token punctuation">;</span>        sequence<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">compareTo</span><span class="token punctuation">(</span>PriorizedTask o<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Integer<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>priority<span class="token punctuation">,</span> o<span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"[%1$-3d]"</span><span class="token punctuation">,</span> priority<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" Task "</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">summary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"("</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> priority <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EndSentinel</span> <span class="token keyword">extends</span> <span class="token class-name">PriorizedTask</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> ExecutorService exec<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token function">EndSentinel</span><span class="token punctuation">(</span>ExecutorService exec<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>exec <span class="token operator">=</span> exec<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>PriorizedTask pt<span class="token operator">:</span> sequence<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span><span class="token function">summary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">%</span> <span class="token number">5</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">+</span> <span class="token string">" Calling shutdownNow()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">PrioritizedTaskProducer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Queue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> queue<span class="token punctuation">;</span>    <span class="token keyword">private</span> ExecutorService exec<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">PrioritizedTaskProducer</span><span class="token punctuation">(</span>Queue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> queue<span class="token punctuation">,</span> ExecutorService exec<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> queue<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>exec <span class="token operator">=</span> exec<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PriorizedTask</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PriorizedTask</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PriorizedTask</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PriorizedTask<span class="token punctuation">.</span>EndSentinel</span><span class="token punctuation">(</span>exec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Finished PrioritizedTaskProducer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">PrioritizedTaskConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> PriorityBlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> q<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">PrioritizedTaskConsumer</span><span class="token punctuation">(</span>PriorityBlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> q<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>q <span class="token operator">=</span> q<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                q<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Finished PrioritizedTaskConsumer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        PriorityBlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PriorityBlockingQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrioritizedTaskProducer</span><span class="token punctuation">(</span>queue<span class="token punctuation">,</span> exec<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrioritizedTaskConsumer</span><span class="token punctuation">(</span>queue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="ScheduledExecutorService"><a href="#ScheduledExecutorService" class="headerlink" title="ScheduledExecutorService"></a>ScheduledExecutorService</h3><ul><li><code>ScheduledThreadPoolExecutor</code>提供<code>schedule()</code>（运行一次任务）和<code>scheduleAtFixedRate()</code>（可以设定初次延迟和再次运行间隔时间）来自动调度<code>Runnable</code>对象。</li></ul><h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> COUNT <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Executor executor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Semaphore semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Main<span class="token punctuation">.</span>Task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Task</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 使用资源</span>                semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="Exchanger"><a href="#Exchanger" class="headerlink" title="Exchanger"></a>Exchanger</h3><ul><li>可以让两个线程（只能是两个）交换一个对象。先调用<code>exchange()</code>的线程阻塞，直到另一个线程也调用<code>exchange()</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Producer</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>T<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Exchanger<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">>></span> exchanger<span class="token punctuation">;</span>    <span class="token keyword">private</span> Supplier<span class="token operator">&lt;</span>T<span class="token operator">></span> supplier<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Producer</span><span class="token punctuation">(</span>Exchanger<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">>></span> exchanger<span class="token punctuation">,</span> Supplier<span class="token operator">&lt;</span>T<span class="token operator">></span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>exchanger <span class="token operator">=</span> exchanger<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>supplier <span class="token operator">=</span> supplier<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        list<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            list <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Consumer</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> List<span class="token operator">&lt;</span>T<span class="token operator">></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Exchanger<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">>></span> exchanger<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>Exchanger<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>T<span class="token operator">>></span> exchanger<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>exchanger <span class="token operator">=</span> exchanger<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            list <span class="token operator">=</span> exchanger<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"From Producer: "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Exchanger<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Integer<span class="token operator">>></span> exchanger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Exchanger</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>exchanger<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>exchanger<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x16</title>
      <link href="/2019/07/30/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x16/"/>
      <url>/2019/07/30/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x16/</url>
      
        <content type="html"><![CDATA[<h1 id="并发（三）"><a href="#并发（三）" class="headerlink" title="并发（三）"></a>并发（三）</h1><h2 id="线程之间的协作"><a href="#线程之间的协作" class="headerlink" title="线程之间的协作"></a>线程之间的协作</h2><h3 id="wait-与notifyAll"><a href="#wait-与notifyAll" class="headerlink" title="wait()与notifyAll()"></a>wait()与notifyAll()</h3><ul><li><code>wait()</code>会将任务挂起，并且只有<code>notify()</code>和<code>notifyAll()</code>发生时，即表示发生了某些感兴趣的食物，这个任务才会被唤醒并去检查所产生的变化。因此，<code>wait()</code>提供了一种在任务之间对活动同步对方式。</li><li>与<code>sleep()</code>的区别：<ol><li>在<code>wait()</code>期间对象锁时释放的</li><li>可以通过<code>notify()</code>、<code>notifyAll()</code>，或者令时间到期，从<code>wait()</code>中恢复执行</li></ol></li><li>调用<code>sleep()</code>、<code>yield()</code>时锁并不会释放。</li><li><code>wait()</code>、<code>notify()</code>、<code>notifyAll()</code>是基类<code>Object</code>的一部分，而不是<code>Thread</code>的一部分。</li><li><code>wait()</code>、<code>notify()</code>、<code>notifyAll()</code>可以并且只能同步控制方法或者同步控制块中调用，如果在非同步部分调用会得到<code>IllegalMonitorStateException</code>异常，即调用这些方法必须拥有（或者）对象的锁。</li></ul><h3 id="错失信号"><a href="#错失信号" class="headerlink" title="错失信号"></a>错失信号</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// T1</span><span class="token keyword">synchronized</span><span class="token punctuation">(</span>sharedMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    shareMonitor<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// T2</span><span class="token keyword">while</span> <span class="token punctuation">(</span>trye<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span><span class="token punctuation">(</span>shareMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        sharedMonitor<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>在上面代码中，如果先执行了T1中的<code>notify()</code>后执行T2中的<code>wait()</code>，此时T2已经错失了T1发来的信号，从而产生了死锁。T2的改进方法见下面代码。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sharedMonitor<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>someCondition<span class="token punctuation">)</span> sharedMonitor<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>此时如果T1先执行，由于条件改变，T2就不会进入<code>wait()</code>。此外，这种方式还能防止被错误唤醒，如果被错误唤醒但还满足等待条件时会继续进入<code>wait()</code>。</li><li><code>notifyAll()</code>因某个特定锁而被调用时，只有等待这个锁的任务才会被唤醒。</li></ul><h3 id="使用wait-和notifyAll-进行线程协作"><a href="#使用wait-和notifyAll-进行线程协作" class="headerlink" title="使用wait()和notifyAll()进行线程协作"></a>使用wait()和notifyAll()进行线程协作</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Meal</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> orderNum<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Meal</span><span class="token punctuation">(</span><span class="token keyword">int</span> orderNum<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>orderNum <span class="token operator">=</span> orderNum<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Meal "</span> <span class="token operator">+</span> orderNum<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">WaitPerson</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Restaurant restaurant<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">WaitPerson</span><span class="token punctuation">(</span>Restaurant restaurant<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>restaurant <span class="token operator">=</span> restaurant<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>restaurant<span class="token punctuation">.</span>meal <span class="token operator">==</span> null<span class="token punctuation">)</span>                        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token punctuation">}</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Waitperson got "</span> <span class="token operator">+</span> restaurant<span class="token punctuation">.</span>meal<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>restaurant<span class="token punctuation">.</span>chef<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    restaurant<span class="token punctuation">.</span>meal <span class="token operator">=</span> null<span class="token punctuation">;</span>                    restaurant<span class="token punctuation">.</span>chef<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"WaitPerson interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Chef</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Restaurant restaurant<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Chef</span><span class="token punctuation">(</span>Restaurant restaurant<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>restaurant <span class="token operator">=</span> restaurant<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">while</span> <span class="token punctuation">(</span>restaurant<span class="token punctuation">.</span>meal <span class="token operator">!=</span> null<span class="token punctuation">)</span>                        <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Out of food, closing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    restaurant<span class="token punctuation">.</span>exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Order up!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>restaurant<span class="token punctuation">.</span>waitPerson<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    restaurant<span class="token punctuation">.</span>meal <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Meal</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>                    restaurant<span class="token punctuation">.</span>waitPerson<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Chef interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Restaurant</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Meal meal<span class="token punctuation">;</span>    ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    WaitPerson waitPerson <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WaitPerson</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    Chef chef <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Chef</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>chef<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>waitPerson<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Restaurant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><em>上面代码使用<code>wait()</code>和<code>notifyAll()</code>的主要原因是减少资源竞争，从而降低CPU资源使用。实际上单生产者单消费者在不考虑资源使用的情况下，是没有必要加锁的。</em></li><li>上面代码中只有一个任务，理论上可以调用<code>notify()</code>而不是<code>notifyAll()</code>。但是，在更复杂的情况下，可能会有多个任务在某个特定的对象锁上等待，因此无法知道哪个任务应该被唤醒。因此，调用<code>notifyAll()</code>要更安全一些，这样可以唤醒等待这个锁的所有任务，而每个任务都必须决定这个通知是否与自己相关。（<em>因为获取对象锁之后，线程的行为并不确定，因此应当使用<code>notifyAll()</code>来唤醒所有线程，每个线程来检查自己是否应当被唤醒。</em>）</li></ul><h3 id="使用显式的Lock对象和Condition对象"><a href="#使用显式的Lock对象和Condition对象" class="headerlink" title="使用显式的Lock对象和Condition对象"></a>使用显式的Lock对象和Condition对象</h3><ul><li>可以使用显式的操作来进行同步与协作。使用互斥并允许任务挂起的基本类时<code>Condition</code>，可以通过在<code>Condition</code>上调用<code>await()</code>来挂起一个任务。当外部条件发生变化，意味着某个任务应该继续执行时，可以通过调用<code>signal()</code>来通知这个任务，从而唤醒一个任务，或者调用<code>signalAll()</code>来唤醒所有在这个<code>Condition</code>上被其自身挂起的任务。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Car</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Lock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Condition condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> waxOn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            waxOn <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">buffed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            waxOn <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waitForWaxing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>waxOn<span class="token punctuation">)</span>                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">waitForBuffing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>waxOn<span class="token punctuation">)</span>                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">WaxOn</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Car car<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">WaxOn</span><span class="token punctuation">(</span>Car car<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>car <span class="token operator">=</span> car<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Wax on"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                car<span class="token punctuation">.</span><span class="token function">waxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                car<span class="token punctuation">.</span><span class="token function">waitForBuffing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Exiting via interrupt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Exiting Wax On task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">WaxOff</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Car car<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">WaxOff</span><span class="token punctuation">(</span>Car car<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>car <span class="token operator">=</span> car<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                car<span class="token punctuation">.</span><span class="token function">waitForWaxing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Wax Off!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                car<span class="token punctuation">.</span><span class="token function">buffed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Exiting via interrupt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Exiting Wax Off task"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        Car car <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaxOff</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WaxOn</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>单个<code>Lock</code>将产生一个<code>Condition</code>对象，这个对象用可以管理任务之间的通信。但是，<code>Condition</code>对象不含任何有关处理状态的信息，因此需要额外的变量来负责表示处理状态的信息，如上面代码中的<code>waxOn</code>。</li></ul><h3 id="生产者-消费者队列"><a href="#生产者-消费者队列" class="headerlink" title="生产者-消费者队列"></a>生产者-消费者队列</h3><ul><li>同步队列时更高级别的抽象，同样可以解决任务协作问题，同步队列在任何时刻都只允许一个任务插入或移除元素。在<code>java.util.concurrent.BlockingQueue</code>接口中提供了这种队列。其实现<code>LinkedBlockingQueue</code>是一个无界队列，<code>ArrayBlockingQueue</code>则有固定尺寸。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Toast</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">enum</span> Status <span class="token punctuation">{</span>DRY<span class="token punctuation">,</span> BUTTERED<span class="token punctuation">,</span> JAMMED<span class="token punctuation">}</span>    <span class="token keyword">private</span> Status status <span class="token operator">=</span> Status<span class="token punctuation">.</span>DRY<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Toast</span><span class="token punctuation">(</span><span class="token keyword">int</span> idn<span class="token punctuation">)</span> <span class="token punctuation">{</span>        id <span class="token operator">=</span> idn<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">butter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        status <span class="token operator">=</span> Status<span class="token punctuation">.</span>BUTTERED<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">jam</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        status <span class="token operator">=</span> Status<span class="token punctuation">.</span>JAMMED<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Status <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> status<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"Toast "</span> <span class="token operator">+</span> id <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> status<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">ToastQueue</span> <span class="token keyword">extends</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Toast<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Toaster</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> ToastQueue toasts<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Toaster</span><span class="token punctuation">(</span>ToastQueue toasts<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>toasts <span class="token operator">=</span> toasts<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">+</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                Toast t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Toast</span><span class="token punctuation">(</span>count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>                toasts<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Toaster interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Toaster off "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Butterer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> ToastQueue dryQueue<span class="token punctuation">,</span> butteredQueue<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Butterer</span><span class="token punctuation">(</span>ToastQueue dryQueue<span class="token punctuation">,</span> ToastQueue butteredQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>dryQueue <span class="token operator">=</span> dryQueue<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>butteredQueue <span class="token operator">=</span> butteredQueue<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Toast t <span class="token operator">=</span> dryQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                t<span class="token punctuation">.</span><span class="token function">butter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>                butteredQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Butterer interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Butterer off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Jammer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> ToastQueue butterQueue<span class="token punctuation">,</span> finishedQueue<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Jammer</span><span class="token punctuation">(</span>ToastQueue butterQueue<span class="token punctuation">,</span> ToastQueue finishedQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>butterQueue <span class="token operator">=</span> butterQueue<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>finishedQueue <span class="token operator">=</span> finishedQueue<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Toast t <span class="token operator">=</span> butterQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                t<span class="token punctuation">.</span><span class="token function">jam</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>                finishedQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Jammer interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Jammer off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Eater</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> ToastQueue finishedQueue<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Eater</span><span class="token punctuation">(</span>ToastQueue finishedQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>finishedQueue <span class="token operator">=</span> finishedQueue<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>Thread<span class="token punctuation">.</span><span class="token function">interrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                Toast t <span class="token operator">=</span> finishedQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> count<span class="token operator">++</span> <span class="token operator">||</span> t<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Toast<span class="token punctuation">.</span>Status<span class="token punctuation">.</span>JAMMED<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">">>>>>Error: "</span> <span class="token operator">+</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>                    System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Chomp! "</span> <span class="token operator">+</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Eater interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Eater off"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        ToastQueue dryQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToastQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                butteredQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToastQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                finishedQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ToastQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Toaster</span><span class="token punctuation">(</span>dryQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Butterer</span><span class="token punctuation">(</span>dryQueue<span class="token punctuation">,</span> butteredQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Jammer</span><span class="token punctuation">(</span>butteredQueue<span class="token punctuation">,</span> finishedQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Eater</span><span class="token punctuation">(</span>finishedQueue<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="任务间使用管道进行输入输出"><a href="#任务间使用管道进行输入输出" class="headerlink" title="任务间使用管道进行输入输出"></a>任务间使用管道进行输入输出</h3><ul><li>以管道的形式在线程间进行输入输出也很有用，在Java中对应为<code>PipedWriter</code>类（允许任务向管道写）和<code>PipedReader</code>类（允许不同任务从同一个管道中读）。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Sender</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Random random <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> PipedWriter out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PipedWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> PipedWriter <span class="token function">getOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> out<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> c <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span> c <span class="token operator">&lt;=</span> <span class="token string">'z'</span><span class="token punctuation">;</span> c<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>                    TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token string">" Sender write exception"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token string">" Sender sleep interrupted"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Receiver</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> PipedReader in<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Receiver</span><span class="token punctuation">(</span>Sender sender<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PipedReader</span><span class="token punctuation">(</span>sender<span class="token punctuation">.</span><span class="token function">getOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Read: "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token string">" Receiver read exception"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>        Sender sender <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Receiver receiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Receiver</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>        TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020-tplink提前批面经</title>
      <link href="/2019/07/30/2020-tplink%E6%8F%90%E5%89%8D%E6%89%B9%E9%9D%A2%E7%BB%8F/"/>
      <url>/2019/07/30/2020-tplink%E6%8F%90%E5%89%8D%E6%89%B9%E9%9D%A2%E7%BB%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="2020-tplink提前批面经"><a href="#2020-tplink提前批面经" class="headerlink" title="2020 tplink提前批面经"></a>2020 tplink提前批面经</h1><ul><li>应聘岗位：IT软件工程师</li><li>状态：一面过，二面没去</li></ul><h2 id="一面"><a href="#一面" class="headerlink" title="一面"></a>一面</h2><ul><li>自我介绍</li><li>介绍项目（Docker、DNS相关）<ul><li>项目简介</li><li>介绍Docker</li><li>Docker和虚拟机的区别，相比虚拟机的优点</li><li>Docker和lxc的区别</li><li>DNS解析流程</li></ul></li><li>Java<ul><li>String和StringBuffer的区别，什么时候用哪个</li><li>Java如何避免内存溢出（没明白）-&gt; 讲下gc</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> 面经 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面经 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2020中兴提前批面经</title>
      <link href="/2019/07/30/2020%E4%B8%AD%E5%85%B4%E6%8F%90%E5%89%8D%E6%89%B9%E9%9D%A2%E7%BB%8F/"/>
      <url>/2019/07/30/2020%E4%B8%AD%E5%85%B4%E6%8F%90%E5%89%8D%E6%89%B9%E9%9D%A2%E7%BB%8F/</url>
      
        <content type="html"><![CDATA[<h1 id="2020中兴提前批面经"><a href="#2020中兴提前批面经" class="headerlink" title="2020中兴提前批面经"></a>2020中兴提前批面经</h1><ul><li>应聘岗位：软件开发工程师</li><li>状态：等待通知</li></ul><h2 id="专业面"><a href="#专业面" class="headerlink" title="专业面"></a>专业面</h2><ul><li>自我介绍</li><li>介绍项目（Docker、DNS相关）<ul><li>项目简介（目的、实现技术）</li><li>系统架构</li><li>Docker和虚拟机的区别</li><li>如何监控Docker容器状态</li><li>Docker容器内进程和普通进程的区别</li><li>Docker的优缺点</li><li>DNS解析流程</li></ul></li><li>Java和Go的区别</li><li>数据库相关<ul><li>关系型和非关系型的区别</li><li>解释事务</li></ul></li><li>解释递归（手撕递归的代码）</li><li><del>没问Java，佛了</del></li><li>关于Go（<del>以后再也不说我会Go了，再也不！</del>）<ul><li>Go的引用类型有哪些</li><li>Go的指针运算有哪些</li><li>数组和切片的区别</li></ul></li></ul><h2 id="HR面"><a href="#HR面" class="headerlink" title="HR面"></a>HR面</h2><ul><li>自我介绍</li><li>应聘时选择企业考虑的因素</li><li>希望在哪个城市工作，为什么</li><li>讲一个在做项目时印象深刻的事</li><li>自己的优缺点</li><li>额外问题</li></ul><h2 id="部门leader-电话面"><a href="#部门leader-电话面" class="headerlink" title="部门leader(?)电话面"></a>部门leader(?)电话面</h2><ul><li>介绍项目</li><li>职业规划，三年后的目标</li><li>期望薪资和原因</li><li>期望工作城市</li><li>是否接触过手机软件开发，介绍项目内容和项目去向</li><li>假设你是项目负责人，如何着手完全没有接触过相关领域的项目</li><li>接上，给定该项目的功能点，设想其服务段和客户端架构</li><li>如果当前的项目毫无进展或者遇到重大问题，而第二天是项目的重要节点该怎么办</li><li>空闲时间做什么</li></ul>]]></content>
      
      
      <categories>
          
          <category> 面经 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 面经 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x01</title>
      <link href="/2019/07/30/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x01/"/>
      <url>/2019/07/30/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x01/</url>
      
        <content type="html"><![CDATA[<h1 id="流"><a href="#流" class="headerlink" title="流"></a>流</h1><h2 id="流简介"><a href="#流简介" class="headerlink" title="流简介"></a>流简介</h2><ul><li>流是从支持数据处理操作的源生成的元素序列。</li><li>集合的核心是数据，而流的目的在于表达计算。</li><li>和迭代器类似，流只能遍历一次。</li><li>使用<code>Collection</code>接口需要用户做迭代，称为外部迭代。而使用<code>Stream</code>则代替用户做了迭代，称为内部迭代。</li></ul><h2 id="流操作"><a href="#流操作" class="headerlink" title="流操作"></a>流操作</h2><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> names <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment" spellcheck="true">// 中间操作</span>                         <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>d <span class="token operator">-</span><span class="token operator">></span> d<span class="token punctuation">.</span><span class="token function">getCalories</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                         <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Dist<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span>                         <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>                         <span class="token comment" spellcheck="true">// 终端操作</span>                         <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>诸如<code>filter</code>或<code>sorted</code>等中间操作会返回另一个流，这让多个操作可以连接起来形成一个查询。除非流水线上触发一个终端操作，否则中间操作不会执行任何处理，因为中间操作一般都可以合并起来，在终端操作时一次性全部处理，这种技术称作循环合并。</li><li>终端操作会从流的流水线生成结果。其结果是任何不是流的值，比如<code>List</code>、<code>Integer</code>，甚至是<code>void</code>。</li></ul><h1 id="使用流"><a href="#使用流" class="headerlink" title="使用流"></a>使用流</h1><h2 id="筛选和切片"><a href="#筛选和切片" class="headerlink" title="筛选和切片"></a>筛选和切片</h2><h3 id="用谓词筛选"><a href="#用谓词筛选" class="headerlink" title="用谓词筛选"></a>用谓词筛选</h3><ul><li><code>filter</code>方法：接受一个谓词（返回<code>boolean</code>的函数）作为参数，并返回一个包括所有符合谓词的元素的流。</li></ul><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>Dish<span class="token operator">></span> vegetarianMenu <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>isVegetarian<span class="token punctuation">)</span>                                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="提取不同元素"><a href="#提取不同元素" class="headerlink" title="提取不同元素"></a>提取不同元素</h3><ul><li><code>distinct</code>方法：无参数，返回一个元素各异的流（根据流所生成元素的<code>hashCode()</code>和<code>equals()</code>方法实现）。</li></ul><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> numbers <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>numbers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>i <span class="token operator">-</span><span class="token operator">></span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>       <span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>out<span class="token operator">:</span><span class="token operator">:</span>println<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/* Output:24*/</span></code></pre><h3 id="截短流"><a href="#截短流" class="headerlink" title="截短流"></a>截短流</h3><ul><li><code>limit(n)</code>方法：返回一个不超过给定长度<code>n</code>的流。如果流是有序的，则最多返回钱<code>n</code>个元素；如果流是无序的（例如<code>Set</code>），则返回结果不会以任何顺序排列。</li></ul><h3 id="跳过元素"><a href="#跳过元素" class="headerlink" title="跳过元素"></a>跳过元素</h3><ul><li><code>skip(n)</code>方法：返回一个去掉前<code>n</code>个元素的流。如果流中的元素不足<code>n</code>个，则返回一个空流。与<code>limit(n)</code>是互补操作。</li></ul><h2 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h2><h3 id="对流中的每个元素应用函数"><a href="#对流中的每个元素应用函数" class="headerlink" title="对流中的每个元素应用函数"></a>对流中的每个元素应用函数</h3><ul><li><code>map</code>方法：接受一个函数作为参数，这个函数会被应用到每个元素上，并将其映射成一个新的元素（与转换的区别是，该步骤是创建一个新的版本而不是修改）。</li></ul><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>String<span class="token operator">></span> dishName <span class="token operator">=</span> menu<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Dish<span class="token operator">:</span><span class="token operator">:</span>getName<span class="token punctuation">)</span>                            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="流的扁平化"><a href="#流的扁平化" class="headerlink" title="流的扁平化"></a>流的扁平化</h3><ul><li><code>flatMap</code>方法：传入的方法生成的流不会各自独立，而是会被合并，扁平化称为一个流。</li></ul><h2 id="查找和匹配"><a href="#查找和匹配" class="headerlink" title="查找和匹配"></a>查找和匹配</h2><ul><li><code>anyMatch</code>检查谓词是否至少匹配一个元素；<code>allMatch</code>会检查谓词是否匹配所有元素，相对的<code>noneMatch</code>则会确保流中没有任何元素与给定的谓词匹配。这三种方法都用到了短路。</li><li><code>findAny</code>可以返回流中的任意元素，而<code>findFirst</code>则返回有出现顺序的流中的第一个元素。使用时配合<code>Optional&lt;T&gt;</code>使用。此外<code>findAny</code>在使用并行流时限制较少，如果不关心返回哪个元素，那么应该使用<code>findAny</code>。</li></ul><h2 id="归约"><a href="#归约" class="headerlink" title="归约"></a>归约</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> sum <span class="token operator">=</span> numbers<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> a <span class="token operator">+</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><ul><li>上面代码展示了用<code>reduce</code>求一组整数的和，<code>reduce</code>接受一个初始值和一个函数，它将使用函数反复结合每个元素，直到流被归约成一个值。</li><li>使用<code>reduce</code>可以让内部实现得以选择并行执行操作。但是，传递给<code>reduce</code>的Lambda不能更改状态（如实例变量），而且操作必须满足结合律才可以按任意顺序执行。</li></ul><h2 id="数值流"><a href="#数值流" class="headerlink" title="数值流"></a>数值流</h2><ul><li><code>IntStream</code>、<code>DoubleStream</code>和<code>LongStream</code>分别将流中的元素特化为<code>int</code>、<code>double</code>和<code>long</code>，从而避免的暗含的装箱成本。数值流包含进行常用归约的方法，如求和<code>sum</code>，找到最大元素<code>max</code>等。</li><li>映射到数值流可以用<code>mapToInt</code>、<code>mapToDouble</code>和<code>mapToLong</code>，而使用<code>boxed</code>方法可以将数值流转回对象流（各个基本类型对应的包装类型）。</li><li><code>range</code>和<code>rangeClosed</code>是可以用于<code>IntStream</code>和<code>LongStream</code>的静态方法，作用是生成范围内的数，区别是<code>range</code>不包含结束值而<code>rangeClosed</code>包含。</li></ul><h2 id="构建流"><a href="#构建流" class="headerlink" title="构建流"></a>构建流</h2><h3 id="由值创建流"><a href="#由值创建流" class="headerlink" title="由值创建流"></a>由值创建流</h3><ul><li>使用<code>Stream.of</code>可以通过显式值创建一个流，可以接受任意数量的参数。而<code>Stream.empty</code>可以得到一个空流。</li></ul><pre class=" language-java"><code class="language-java">Stream<span class="token operator">&lt;</span>String<span class="token operator">></span> stream <span class="token operator">=</span> Stream<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Java 8"</span><span class="token punctuation">,</span> <span class="token string">"Lambdas"</span><span class="token punctuation">,</span> <span class="token string">"In"</span><span class="token punctuation">,</span> <span class="token string">"Action"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>Stream<span class="token operator">&lt;</span>String<span class="token operator">></span> emptyStream <span class="token operator">=</span> Stream<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="由数组创建流"><a href="#由数组创建流" class="headerlink" title="由数组创建流"></a>由数组创建流</h3><ul><li>静态方法<code>Arrays.stream</code>可以从数组创建一个流，接受一个数组作为参数。</li></ul><h3 id="由文件生成流"><a href="#由文件生成流" class="headerlink" title="由文件生成流"></a>由文件生成流</h3><ul><li><code>java.nio.file.Files</code>中的很多静态方法都会返回一个流，例如<code>Files.lines</code>，它会返回一个由指定文件中的各行构成的字符串流。</li></ul><h3 id="由函数生成流——创建无限流"><a href="#由函数生成流——创建无限流" class="headerlink" title="由函数生成流——创建无限流"></a>由函数生成流——创建无限流</h3><h4 id="迭代"><a href="#迭代" class="headerlink" title="迭代"></a>迭代</h4><ul><li><code>iterate</code>方法接受一个初始值，以及一个一次应用在每个产生的新值上的Lambda。<code>iterate</code>操作基本上是顺序的，因为结果取决于前一次应用。该操作将生成一个无限流，没有结尾，因为值是按需计算的，可以永远计算下去。因此流和集合的一个关键的区别在于流是无界的。</li></ul><h4 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h4><ul><li><code>generate</code>方法也可以生成无限流，它接受一个<code>Supplier&lt;T&gt;</code>类型的Lambda提供新的值。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
            <tag> 流 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java8实战笔记0x00</title>
      <link href="/2019/07/29/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2019/07/29/Java8%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="通过行为参数化传递代码"><a href="#通过行为参数化传递代码" class="headerlink" title="通过行为参数化传递代码"></a>通过行为参数化传递代码</h1><h2 id="行为参数化"><a href="#行为参数化" class="headerlink" title="行为参数化"></a>行为参数化</h2><ul><li>谓词：根据对象的某些属性来返回<code>boolean</code>值的函数。</li></ul><h2 id="代码进化节选"><a href="#代码进化节选" class="headerlink" title="代码进化节选"></a>代码进化节选</h2><h3 id="使用接口实现策略设计模式"><a href="#使用接口实现策略设计模式" class="headerlink" title="使用接口实现策略设计模式"></a>使用接口实现策略设计模式</h3><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 顶层接口</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ApplePredicate</span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span>Apple apple<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 各种具体实现，可以不断增加</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppleHeavyWeightPredicate</span> <span class="token keyword">implements</span> <span class="token class-name">ApplePredicate</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span>Apple apple<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> apple<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">150</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppleGreenColorPredicate</span> <span class="token keyword">implements</span> <span class="token class-name">ApplePredicate</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span>Apple apple<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"green"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>apple<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 使用部分，无需变动</span><span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> <span class="token function">filterApples</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> inventory<span class="token punctuation">,</span> ApplePredicate p<span class="token punctuation">)</span> <span class="token punctuation">{</span>    List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>Apple apple<span class="token operator">:</span> inventory<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>apple<span class="token punctuation">)</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>apple<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="使用匿名内部类"><a href="#使用匿名内部类" class="headerlink" title="使用匿名内部类"></a>使用匿名内部类</h3><ul><li>在上面代码中，所定义的类可能仅实例化一次， 而使用匿名内部类可以弥补这点。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 仍然需要上面代码的顶层接口，但无需实际定义类</span>List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> redApples <span class="token operator">=</span> <span class="token function">filterApples</span><span class="token punctuation">(</span>inventory<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ApplePredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span>Apple a<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"red"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="使用Lambda表达式"><a href="#使用Lambda表达式" class="headerlink" title="使用Lambda表达式"></a>使用Lambda表达式</h3><pre class=" language-java"><code class="language-java">List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> result <span class="token operator">=</span> <span class="token function">filterApples</span><span class="token punctuation">(</span>inventory<span class="token punctuation">,</span> <span class="token punctuation">(</span>Apple apple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"red"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>apple<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="使用泛型"><a href="#使用泛型" class="headerlink" title="使用泛型"></a>使用泛型</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Predicate</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">boolean</span> <span class="token function">test</span><span class="token punctuation">(</span>T t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> List<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">filter</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">,</span> Predicate<span class="token operator">&lt;</span>T<span class="token operator">></span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>    List<span class="token operator">&lt;</span>T<span class="token operator">></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>T e<span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//...</span>List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> redApples <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>inventory<span class="token punctuation">,</span> <span class="token punctuation">(</span>Apple apple<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"red"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>apple<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> evenNumbers <span class="token operator">=</span> <span class="token function">filter</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> <span class="token punctuation">(</span>Integer i<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h1 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h1><h2 id="使用Lambda表达式-1"><a href="#使用Lambda表达式-1" class="headerlink" title="使用Lambda表达式"></a>使用Lambda表达式</h2><ul><li>函数式接口：是指只定义一个抽象方法的接口。例如Java API中的<code>Comparetor</code>、<code>Runnable</code>、<code>Callable</code>等。</li><li><code>@FunctionalInterface</code>：用于标注接口为函数式接口，如果该接口没有定义抽象方法或者包含多个抽象方法，编译时会出现错误。其作用类似于<code>@Override</code>。</li></ul><h2 id="使用函数式接口"><a href="#使用函数式接口" class="headerlink" title="使用函数式接口"></a>使用函数式接口</h2><ul><li><code>java.util.function.Predicate&lt;T&gt;</code>提供一个<code>test()</code>方法，接受一个泛型<code>T</code>对象，返回一个<code>boolean</code>。</li><li><code>java.util.function.Consumer&lt;T&gt;</code>提供一个<code>accept()</code>方法，接受一个泛型<code>T</code>对象，返回为<code>void</code>。</li><li><code>java.util.function.Function&lt;T, R&gt;</code>提供一个<code>apply()</code>方法，接受一个泛型<code>T</code>对象，返回一个泛型<code>R</code>对象。</li></ul><h3 id="原始类型特化"><a href="#原始类型特化" class="headerlink" title="原始类型特化"></a>原始类型特化</h3><ul><li>虽然Java可以进行自动装箱和拆箱，但是这一操作还是有性能代价的。为避免自动装箱和拆箱，Java为其提供的函数式接口提供了原始类型特有版本，例如功能类似<code>Predicate&lt;T&gt;</code>的<code>IntPredicate</code>，其参数为<code>int</code>而不是<code>Integer</code>可以避免装箱。</li></ul><h3 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h3><ul><li>任何函数式接口都不允许抛出受检异常。如果希望Lambda表达式可以抛出异常，可以定义一个自己的函数式接口，并声明受检异常，或者把Lambda主体用<code>try/catch</code>块包裹。下面代码为示例。</li></ul><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@FunctionalInterface</span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">BufferredReaderProcessor</span> <span class="token punctuation">{</span>    String <span class="token function">process</span><span class="token punctuation">(</span>BufferedReader b<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">//...</span>BufferedReaderProcessor p <span class="token operator">=</span> <span class="token punctuation">(</span>BufferedReader br<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><pre class=" language-java"><code class="language-java">Function<span class="token operator">&lt;</span>BufferedReader<span class="token punctuation">,</span> String<span class="token operator">></span> f <span class="token operator">=</span> <span class="token punctuation">(</span>BufferedReader b<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> b<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><h2 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h2><ul><li>编译器会自动推断Lambda表达式的参数类型，而无需显式声明。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 没有类型推断</span>Comparator<span class="token operator">&lt;</span>Apple<span class="token operator">></span> c <span class="token operator">=</span> <span class="token punctuation">(</span>Apple a1<span class="token punctuation">,</span> Apple a2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> a1<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a2<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 有类型推断</span>Comparator<span class="token operator">&lt;</span>Apple<span class="token operator">></span> c <span class="token operator">=</span> <span class="token punctuation">(</span>a1<span class="token punctuation">,</span> a2<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> a1<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>a2<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h2 id="使用局部变量"><a href="#使用局部变量" class="headerlink" title="使用局部变量"></a>使用局部变量</h2><ul><li>Lambda表达式允许使用自由变量（在外层作用域中定义的变量），类似于匿名类。</li><li>Lambda可以没有限制的捕获实例变量和静态变量，但是局部变量必须声明为<code>final</code>或者事实上是<code>final</code>。关于事实上是<code>final</code>的变量，见下面代码。不符合事实上是<code>final</code>的变量出现时，编译器将会发出错误信息。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">1337</span><span class="token punctuation">;</span>Runnable r <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Error: java: 从lambda 表达式引用的本地变量必须是最终变量或实际上的最终变量</span>n <span class="token operator">=</span> <span class="token number">31337</span><span class="token punctuation">;</span> </code></pre><h2 id="方法引用"><a href="#方法引用" class="headerlink" title="方法引用"></a>方法引用</h2><ul><li>方法引用可以被看作仅仅调用特定方法的Lambda的一种快捷写法。如果一个Lambda代表的只是直接调用这个方法，那最好还是用名称调用而不是尝试去描述过程。事实上，方法引用就是根据已有的方法实现来创建Lambda表达式。</li></ul><pre class=" language-java"><code class="language-java"><span class="token punctuation">(</span>Apple a<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> a<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 等价于</span>Apple<span class="token operator">:</span><span class="token operator">:</span>getWeight</code></pre><h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><ul><li><p>方法引用主要有三类：</p><ol><li>指向静态方法的方法引用（例如<code>Integer</code>的<code>parseInt()</code>，写作<code>Integer::parseInt</code>）</li><li>指向任意类型实例方法的方法引用（例如<code>String</code>对象的<code>length()</code>，写作<code>String::length</code>）</li><li>指向现有对象的实例方法的方法引用（例如局部变量<code>x</code>，其拥有实例方法<code>getValue()</code>，则可写<code>x::getValue</code>）</li></ol><p>注意，第二种实例是Lambda本身的参数，而第三种实例来自外部。</p></li></ul><h3 id="构造函数引用"><a href="#构造函数引用" class="headerlink" title="构造函数引用"></a>构造函数引用</h3><ul><li>可以使用<code>ClassName::new</code>来对构造函数进行引用。注意选择正确的接口接收构造函数引用，见下面代码示例。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> w<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        w <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Apple</span><span class="token punctuation">(</span><span class="token keyword">int</span> w<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>w <span class="token operator">=</span> w<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Supplier<span class="token operator">&lt;</span>Apple<span class="token operator">></span> c <span class="token operator">=</span> Apple<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">;</span>        Apple a1 <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Function<span class="token operator">&lt;</span>Integer<span class="token punctuation">,</span> Apple<span class="token operator">></span> c2 <span class="token operator">=</span> Apple<span class="token operator">:</span><span class="token operator">:</span><span class="token keyword">new</span><span class="token punctuation">;</span>        Apple a2 <span class="token operator">=</span> c2<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><code>ClassName::new</code>会选择匹配函数式接口对应方法参数列表的构造函数，而无需指定参数列表。</p><h2 id="复合Lambda表达式"><a href="#复合Lambda表达式" class="headerlink" title="复合Lambda表达式"></a>复合Lambda表达式</h2><ul><li>Java 8的一些函数式借口都有为方便而设计的方法，可以把多个简单的Lambda复合成复杂的表达式（例如使用<code>or</code>连接两个Lambda）。这些方法的实现使用了接口的默认方法。</li></ul><h3 id="比较器复合"><a href="#比较器复合" class="headerlink" title="比较器复合"></a>比较器复合</h3><p>以一个<code>Comparator</code>为例：</p><pre class=" language-java"><code class="language-java">Comparator<span class="token operator">&lt;</span>Apple<span class="token operator">></span> c <span class="token operator">=</span> Comparator<span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>Apple<span class="token operator">:</span><span class="token operator">:</span>getWeight<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="逆序"><a href="#逆序" class="headerlink" title="逆序"></a>逆序</h4><ul><li>如果希望将结果逆序输出，可以使用默认方法<code>reversed()</code>将比较器结果逆序：</li></ul><pre class=" language-java"><code class="language-java">inventory<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token function">comparing</span><span class="token punctuation">(</span>Apple<span class="token operator">:</span><span class="token operator">:</span>getWeight<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h4 id="比较器链"><a href="#比较器链" class="headerlink" title="比较器链"></a>比较器链</h4><ul><li>如果使用比较器得到两个应该处于相同位置的对象时，可以使用<code>thenComparing()</code>来进一步比较：</li></ul><pre class=" language-java"><code class="language-java">inventory<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token function">comparing</span><span class="token punctuation">(</span>Apple<span class="token operator">:</span><span class="token operator">:</span>getWeight<span class="token punctuation">)</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">reversed</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token punctuation">.</span><span class="token function">thenComparing</span><span class="token punctuation">(</span>Apple<span class="token operator">:</span><span class="token operator">:</span>getCountry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="谓词复合"><a href="#谓词复合" class="headerlink" title="谓词复合"></a>谓词复合</h3><ul><li>谓词借口包括三个方法：<code>negate</code>、<code>and</code>和<code>or</code>，其优先级是从左往右。</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 从现有的Predicate创建结果的非</span>Predicate<span class="token operator">&lt;</span>Apple<span class="token operator">></span> notRedApple <span class="token operator">=</span> redApple<span class="token punctuation">.</span><span class="token function">negate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 使用and和or创建复杂的Predicate对象</span>Predicate<span class="token operator">&lt;</span>Apple<span class="token operator">></span> p <span class="token operator">=</span> redApple<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span>a <span class="token operator">-</span><span class="token operator">></span> a<span class="token punctuation">.</span><span class="token function">getWeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">150</span><span class="token punctuation">)</span>                             <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>a <span class="token operator">-</span><span class="token operator">></span> <span class="token string">"green"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><h3 id="函数复合"><a href="#函数复合" class="headerlink" title="函数复合"></a>函数复合</h3><ul><li>可以使用<code>Function</code>接口将Lambda表达式复合起来。其中提供<code>andThen()</code>和<code>compose()</code>两个方法，它们都会返回一个<code>Function</code>实例。<code>andThen()</code>会先对输入应用调用该方法的<code>Function</code>，后对输入应用该方法的<code>Function</code>参数；<code>compose()</code>则是先对输入应用该方法的<code>Function</code>参数，后对输入应用调用该方法的<code>Function</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x15</title>
      <link href="/2019/07/28/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x15/"/>
      <url>/2019/07/28/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x15/</url>
      
        <content type="html"><![CDATA[<h1 id="并发（二）"><a href="#并发（二）" class="headerlink" title="并发（二）"></a>并发（二）</h1><h2 id="共享受限资源"><a href="#共享受限资源" class="headerlink" title="共享受限资源"></a>共享受限资源</h2><h3 id="不正确地访问资源"><a href="#不正确地访问资源" class="headerlink" title="不正确地访问资源"></a>不正确地访问资源</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Even</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token operator">++</span>i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1]</span>        <span class="token operator">++</span>i<span class="token punctuation">;</span>        <span class="token keyword">return</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码中，如果正确执行，那么<code>next()</code>方法返回的一定是偶数。但是在并发的条件下，[1]处如果线程被挂起，被另外一个线程调用该对象的<code>next()</code>方法时则会返回奇数。</li></ul><h3 id="使用synchronize进行同步控制"><a href="#使用synchronize进行同步控制" class="headerlink" title="使用synchronize进行同步控制"></a>使用synchronize进行同步控制</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Even</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token operator">++</span>i<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1]</span>        <span class="token operator">++</span>i<span class="token punctuation">;</span>        <span class="token keyword">return</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>使用<code>synchronized</code>关键字进行同步控制，应将涉及竞争的数据成员都声明为<code>private</code>，仅允许通过方法来访问这些成员。然后将相关的方法声明为<code>synchronized</code>。</li><li>所有对象都自动含有单一的锁（也成为监视器）。当在对象上调用其任意的<code>synchronized</code>方法的时候，此对象都被加锁，此时该对象上的其他<code>synchronized</code>方法只有等前一个方法调用完毕并释放了锁之后才能被调用。</li><li>一个任务可以多次获得对象的锁。JVM会跟踪加锁的次数，每当这个相同的任务在这个对象上获得锁时，相应的计数器会递增；每当任务离开一个<code>synchronized</code>方法，计数会递减；当计数为0时，锁被完全释放，此时其他任务可以使用此资源。</li><li>针对每个类，也有一个锁（作为类的<code>Class</code>对象的一部分），所以<code>synchronized static</code>方法可以在类的范围内防止对<code>static</code>数据的并发访问。</li></ul><h3 id="使用显式的Lock对象"><a href="#使用显式的Lock对象" class="headerlink" title="使用显式的Lock对象"></a>使用显式的Lock对象</h3><ul><li><code>Lock</code>对象必须被显式地创建、锁定和释放。相比起<code>synchronized</code>，代码缺乏优雅性，但是更加灵活；并且，如果使用<code>synchronized</code>时某些事物失败的将会抛出异常，没有机会进行清理工作，而使用<code>Lock</code>对象可以在<code>finally</code>子句中进行清理工作。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Even</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Lock lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token operator">++</span>i<span class="token punctuation">;</span>            <span class="token operator">++</span>i<span class="token punctuation">;</span>            <span class="token keyword">return</span> i<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="原子性和可视性"><a href="#原子性和可视性" class="headerlink" title="原子性和可视性"></a>原子性和可视性</h3><ul><li>原子操作是不能被线程调度机制中断的操作，一旦操作开始，那么它一定在可能发生的上下文切换之前执行完毕。</li></ul><blockquote><p>当变量声明为<code>volatile</code>时，变量将具备以下两个特性：</p><ol><li><p>保证此变量对所有线程的可见性，即一个线程修改了volatile变量后，其余线程可以立即获得修改后的值。</p></li><li><p>禁止指令重排序优化，即设置内存屏障，保证volatile变量修改更新到所有CPU上。</p></li></ol></blockquote><ul><li>在非<code>volatile</code>上的原子操作不必刷新到主存中去，因此其他读取该域的任务也不必看到这个新值。</li><li>如果多个任务在同时访问某个域，那么这个域就应该是<code>volatile</code>的，否则，这个域就应该只能经由同步来访问。同步也会导致向主存中刷新，因此如果一个域完全由<code>synchronized</code>方法或语句块来防护，那就不必将其设置为是<code>volatile</code>的。</li><li>当一个域的值依赖于它之前的值，或者受到其他域的值的限制时，<code>volatile</code>将无法工作。</li></ul><h3 id="原子类"><a href="#原子类" class="headerlink" title="原子类"></a>原子类</h3><ul><li>Java SE5引入了诸如<code>AtomicInteger</code>、<code>AtomicLong</code>、<code>AtomicReference</code>等特殊的原子性变量类，提供原子性条件更新操作<code>compareAndSet(expectedValue, updateValue)</code>，这是由硬件（CPU指令）支持的。</li></ul><h3 id="临界区"><a href="#临界区" class="headerlink" title="临界区"></a>临界区</h3><ul><li>如果只是希望防止多个线程同时访问方法内部的部分代码而不是防止访问整个代码，可以使用<code>synchronized</code>指定某个对象，此对象的锁将用于对指定代码段进行同步控制。这段代码被称为临界区，或者同步控制块。</li><li>一般情况下，使用<code>synchronized</code>同步临界区时指定的同步对象为当前对象，即<code>synchronized (this)</code>。当然也可以指定其它对象，但注意确保所有任务都是在同一个对象上同步的。</li></ul><h2 id="终结任务"><a href="#终结任务" class="headerlink" title="终结任务"></a>终结任务</h2><h3 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h3><ul><li>一个线程可以处于一下四种状态之一：<ol><li>新建：当线程被创建时，它只会短暂地处于该状态。此时它已经得到了必需的系统资源，并进行了初始化，可以获得CPU时间了。之后调度器将把这个线程转变为可运行状态或者阻塞状态。</li><li>就绪：在这种状态下，只要调度器把时间片分配给线程，线程就可以运行，也就是说，线程可以运行也可以不运行。</li><li>阻塞：线程能够运行，但有某个条件阻止它运行。当线程处于阻塞状态时，调度器将会忽略线程，不会分配给线程任何CPU时间。直到线程重新进入了就绪状态，它才有可能执行操作。</li><li>死亡：处于死亡或终止状态的线程不再是可调度的，并且再也不会得到CPU时间，它的任务已经结束，或者不再是可运行的。任务死亡的通常方式是从<code>run()</code>方法返回，但是任务的线程还可以被中断。</li></ol></li></ul><h3 id="进入阻塞状态"><a href="#进入阻塞状态" class="headerlink" title="进入阻塞状态"></a>进入阻塞状态</h3><ul><li>一个任务进入阻塞状态，可能有如下原因：<ol><li>通过调用<code>sleep()</code>使任务进入休眠状态，在这种情况下，任务在指定的时间内不会运行。</li><li>调用<code>wait()</code>使线程挂起，直到线程得到了<code>notify()</code>或者<code>notifyAll()</code>消息（或者在Java中等价的<code>signal()</code>或<code>signalAll()</code>消息），线程才会进入就绪状态。</li><li>任务在等待某个输入/输出完成。</li><li>任务试图在某个对象上调用其同步控制方法，但对象锁不可用，因为另一个任务已经获取了这个锁。</li></ol></li></ul><h3 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h3><ul><li><code>Thread</code>类包含<code>interrupt()</code>方法，可以终止被阻塞任务，这个方法将设置线程的中断状态。如果一个线程已经被阻塞，或者试图执行一个阻塞操作，那么设置这个线程的中断状态将跑出<code>InterruptedException</code>。当抛出该异常或者该任务调用<code>Thread#interrupted()</code>时，中断状态将被复位。</li><li>如果在<code>Executor</code>上调用<code>shutdownNow()</code>，那么它将发送一个<code>interrrupt()</code>调用给它启动的所有线程。如果希望只中断某个任务，那么需要通过调用<code>submit()</code>而不是<code>executor()</code>启动任务，这样可以持有线程的上下文。<code>submit()</code>将放回一个泛型<code>Future&lt;?&gt;</code>，可以在其上调用<code>cancel()</code>，由此中断某个任务。如果将<code>true</code>传递给<code>cancel()</code>，那么它就会有在该线程上调用<code>interrupt()</code>以停止这个线程的权限。</li><li><code>interrupt()</code>不能中断正在试图获取<code>synchronized</code>锁或者试图执行I/O操作的线程，<em>因为操作系统并未提供该功能</em>。</li><li>可以通过调用<code>Thread.interrupted()</code>来检查中断状态，不仅仅可以得知<code>interrupt()</code>是否被调用过，还可以清除中断状态。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x14</title>
      <link href="/2019/07/24/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x14/"/>
      <url>/2019/07/24/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x14/</url>
      
        <content type="html"><![CDATA[<h1 id="并发（一）"><a href="#并发（一）" class="headerlink" title="并发（一）"></a>并发（一）</h1><h2 id="基本的线程机制"><a href="#基本的线程机制" class="headerlink" title="基本的线程机制"></a>基本的线程机制</h2><h3 id="定义任务"><a href="#定义任务" class="headerlink" title="定义任务"></a>定义任务</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">LiftOff</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">protected</span> <span class="token keyword">int</span> countDown <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> taskCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> id <span class="token operator">=</span> taskCount<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">LiftOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">LiftOff</span><span class="token punctuation">(</span><span class="token keyword">int</span> countDown<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>countDown <span class="token operator">=</span> countDown<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"#%d(%s)"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> countDown <span class="token operator">></span> <span class="token number">0</span><span class="token operator">?</span> countDown<span class="token operator">:</span><span class="token string">"LiftOff"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>countDown<span class="token operator">--</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>实现<code>Runnable</code>接口并实现<code>run()</code>方法，即可执行自定义任务。</li><li>静态方法<code>Thread.yield()</code>是对线程调度器的一种建议，告知其可以让出CPU转移给其它线程。</li></ul><h3 id="Thread类"><a href="#Thread类" class="headerlink" title="Thread类"></a>Thread类</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LiftOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>可以直接继承<code>Thread</code>类，或者向<code>Thread</code>构造器中传入<code>Runnable</code>对象，来构建由不同线程执行任务的对象。</li><li>上面代码一次执行的结果可能和另外一次不同，因为线程调度机制是非确定的。</li></ul><h3 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h3><ul><li><code>Executor</code>能够管理异步任务的执行，无须显式地管理线程的生命周期。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LiftOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>在上面代码中，<code>ExecutorService</code>对象使用静态方法<code>Executors.newCachedThreadPool()</code>创建，<code>ExecutorService#execute()</code>为每一个任务都创建了一个线程。</li><li><code>ExecutorService#shutdown()</code>方法可以防止新任务提交给该<code>Executor</code>，而当前线程将继续运行在<code>shutdown()</code>被调用之前提交的所有任务，待所有任务均执行完毕后，当前线程将会尽快退出。</li><li><code>ChchedThreadPool</code>在程序执行过程中通常会创建与所需数量相同的线程，然后在它回收旧线程时停止创建新线程。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LiftOff</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><code>FixedThreadPool</code>可以一次性预先执行代价高昂的线程分配，因而也可以限制线程的数量。由于不需要为每个任务都固定付出创建线程的开销，因此可以节省时间。在事件驱动的系统中，需要线程的事件处理器，通过直接从池中获取线程以尽快得到服务。在这个过程中，由于线程总数是有限的，因此不会出现资源滥用。</li><li>在任何线程池中，现有线程在可能的情况下都会被自动复用。</li><li><code>SingleThreadExecutor</code>类似于线程数量为1的<code>FixedThreadPool</code>，可以用于在另一个线程中连续运行任何事物（长期服务），例如监听进入的套接字连接的任务。如果向<code>SingleThreadExecutor</code>提交了多个任务，那么这些任务将会排队执行，所有的任务将使用相同的线程。这能够保证在任意时刻在任意线程中都只有唯一的任务在运行，不需要在共享资源上处理同步并有限制的使用这些资源。</li></ul><h3 id="从任务中产生返回值"><a href="#从任务中产生返回值" class="headerlink" title="从任务中产生返回值"></a>从任务中产生返回值</h3><ul><li>如果需要任务在完成时能够返回一个值，可以实现<code>Callable</code>接口。<code>Callable</code>是一种具有类型参数的泛型，它的类型参数表示的是从方法<code>call()</code>中返回值的类型。向<code>Executor</code>提交任务时使用<code>ExecutorService#submit()</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> String <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"result: "</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>Future<span class="token operator">&lt;</span>String<span class="token operator">>></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>exec<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Future<span class="token operator">&lt;</span>String<span class="token operator">></span> r<span class="token operator">:</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ExecutionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        exec<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><code>ExecutorService#submit()</code>方法会产生<code>Future</code>对象，它用<code>Callable</code>返回的结果的特定类型进行参数化。可以调用<code>Future#isDone()</code>来查询<code>Future</code>是否已经完成，如果完成可以调用<code>Future#get()</code>获取对应结果。也可以直接调用<code>Future#get()</code>，此时会发生阻塞，直到结果准备就绪。</li></ul><h3 id="休眠"><a href="#休眠" class="headerlink" title="休眠"></a>休眠</h3><ul><li>可以调用<code>TimeUnit.MILLSECONDS.sleep()</code>来中止任务执行给定的时间，同时会抛出<code>InterruptedException</code>异常。由于异常不能跨线程传播回主线程，因此必须在本地处理所有在任务内部产生的异常。</li></ul><h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><ul><li>线程的优先级将该线程的重要性传递给了调度器，调度器将倾向度让优先级最高的线程先执行。然而，这并不意味着优先级较低的线程得不到执行，仅仅是执行的频率较低。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> countDown <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">double</span> d<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> priority<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Test</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>priority <span class="token operator">=</span> priority<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> countDown<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                d <span class="token operator">+=</span> <span class="token punctuation">(</span>Math<span class="token punctuation">.</span>PI <span class="token operator">+</span> Math<span class="token punctuation">.</span>E<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span>i<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> Thread<span class="token punctuation">.</span><span class="token function">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>countDown <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>MAX_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span>MIN_PRIORITY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>可以使用<code>getPriority()</code>来读取现有线程的优先级，并且可以在任何时候通过调用<code>setPriority()</code>来修改优先级。</li><li>尽管JDK有10个优先级，但是和多数的操作系统都不能映射得很好。唯一可移植的方法是只使用<code>MAX_PRIORITY</code>、<code>NORM_PRIORITY</code>和<code>MIN_PRIORITY</code>。</li></ul><h3 id="后台线程"><a href="#后台线程" class="headerlink" title="后台线程"></a>后台线程</h3><ul><li>后台线程，是指在程序运行的时候在后台提供一种通用服务的线程，并且这种线程并不属于程序中不可或缺的部分。因此，当所有的非后台线程结束时，程序也就终止了，同时会杀死进程中所有的后台线程。</li><li>可以使用<code>Thread#setDaemon()</code>来设置线程为后台线程，但必须在线程启动之前设置。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DaemonThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Thread <span class="token function">newThread</span><span class="token punctuation">(</span>Runnable r<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Daemon</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DaemonThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Daemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"all start."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>每个静态的<code>ExecutorService</code>创建方法可以被重载为接收一个<code>ThreadFactory</code>对象，而这个工厂对象将用于创建新的线程。在上面代码中，自定义的工厂将新的线程均设置成为后台线程。</li><li>可以通过调用<code>Thread#isDaemon()</code>方法来确定线程是否为一个后台线程。后台线程创建的线程都将自动设置成为后台线程。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Daemon</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"starting daemon"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// [1]</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"run?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Daemon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>当最后一个非后台线程终止时，JVM就会立即关闭所有后台进程（例如上面代码，尽管执行到[1]处会被强制停止，但不会执行<code>finally</code>子句）。这不是关闭后台进程优雅的方式，相应的，非后台的<code>Executor</code>控制的所有任务可以同时被关闭，这是一种更好的解决方式。</li></ul><h3 id="加入一个线程"><a href="#加入一个线程" class="headerlink" title="加入一个线程"></a>加入一个线程</h3><ul><li>一个线程可以在其他线程之上调用<code>join()</code>方法，此时调用<code>join()</code>的线程将被挂起，直到目标线程结束才回复（即<code>t.isAlive</code>为假）。也可以在调用<code>join()</code>时带上一个超时参数，如果发生超时目标线程还没有结束，<code>join()</code>方法也会返回。</li></ul><h3 id="捕获线程异常"><a href="#捕获线程异常" class="headerlink" title="捕获线程异常"></a>捕获线程异常</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ThrowException</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码中的<code>try</code>语句无法捕获线程中的异常。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ThrowException</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">CatchException</span> <span class="token keyword">implements</span> <span class="token class-name">Thread<span class="token punctuation">.</span>UncaughtExceptionHandler</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">uncaughtException</span><span class="token punctuation">(</span>Thread t<span class="token punctuation">,</span> Throwable e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"caught: "</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">ExceptionThreadFactory</span> <span class="token keyword">implements</span> <span class="token class-name">ThreadFactory</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Thread <span class="token function">newThread</span><span class="token punctuation">(</span>Runnable r<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Thread t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>        t<span class="token punctuation">.</span><span class="token function">setUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CatchException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>        ExecutorService exec <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExceptionThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        exec<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThrowException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:caught: java.lang.RuntimeException*/</span></code></pre><ul><li><code>Thread.UncaughtException</code>接口可以为每个<code>Thread</code>对象都附着一个异常处理器。其中<code>uncaughtException()</code>方法会在线程因未捕获异常而退出前被调用。上面代码中创建了一个<code>ThreadFactory</code>子类来为线程添加异常处理器。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x13</title>
      <link href="/2019/07/24/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x13/"/>
      <url>/2019/07/24/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x13/</url>
      
        <content type="html"><![CDATA[<h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><ul><li>注解也被称为元数据，为在代码中添加信息提供了一种形式化的方法，以便在后面使用这些数据。</li><li>有三种内置的注解，分别是：<ol><li><code>@Override</code>，表示当前的方法定义将覆盖超类中的方法。如果注解的方法没有对应到超类中的方法，编译器会发出错误提示。</li><li><code>@Deprecated</code>，如果在其它代码中使用了注解为<code>@Deprecated</code>的元素，那么编译器会发出警告信息。</li><li><code>@SuppressWarnings</code>，关闭不当的编译器警告信息。</li></ol></li></ul><h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><h3 id="定义注解"><a href="#定义注解" class="headerlink" title="定义注解"></a>定义注解</h3><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>ElementType<span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>@<span class="token keyword">interface</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre><ul><li>除了<code>@</code>以外，<code>@Test</code>的定义很像一个空的接口。</li><li>没有元素的注解称为标记注解。</li></ul><h3 id="元注解"><a href="#元注解" class="headerlink" title="元注解"></a>元注解</h3><table><thead><tr><th>元注解</th><th>说明</th></tr></thead><tbody><tr><td><code>@Target</code></td><td>表示该注解可以用于什么地方，可能的参数包括：<code>CONSTRUCTOR</code>（构造器声明），<code>FIELD</code>（域声明），<code>LOCAL_VARIABLE</code>（局部变量声明），<code>METHOD</code>（方法声明），<code>PACKAGE</code>（包声明），<code>PARAMETER</code>（参数声明），<code>TYPE</code>（类、接口、注解、枚举）</td></tr><tr><td><code>@Retention</code></td><td>表示需要再什么级别保存该注解信息。可选的参数包括：<code>SOURCE</code>（注解将被编译器丢弃），<code>CLASS</code>（注解在class文件中可用，但会被VM丢弃），<code>RUNTIME</code>（VM在运行期也会保留注解，可以通过反射读取注解信息）</td></tr><tr><td><code>@Documented</code></td><td>将此注解包含在Javadoc中</td></tr><tr><td><code>@Inherited</code></td><td>允许子类继承父类中的注解</td></tr></tbody></table><h2 id="编写注解处理器"><a href="#编写注解处理器" class="headerlink" title="编写注解处理器"></a>编写注解处理器</h2><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>ElementType<span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span><span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>RetentionPolicy<span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>@<span class="token keyword">interface</span> <span class="token class-name">UseCase</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> String <span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"No description"</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">PasswordUtils</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@UseCase</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token number">47</span><span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">"Need one or more numeric"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">validatePassword</span><span class="token punctuation">(</span>String password<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>password<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token string">"\\w*\\d\\w*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@UseCase</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token number">48</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> String <span class="token function">encryptPassword</span><span class="token punctuation">(</span>String password<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@UseCase</span><span class="token punctuation">(</span>id <span class="token operator">=</span> <span class="token number">49</span><span class="token punctuation">,</span> desc <span class="token operator">=</span> <span class="token string">"Same with the previous"</span><span class="token punctuation">)</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">chekcForNewPassword</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>String<span class="token operator">></span> prevPasswords<span class="token punctuation">,</span> String password<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token operator">!</span>prevPasswords<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">trackUseCases</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> useCases<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> cl<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Method m<span class="token operator">:</span> cl<span class="token punctuation">.</span><span class="token function">getDeclaredMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            UseCase uc <span class="token operator">=</span> m<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span>UseCase<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>uc <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uc<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> uc<span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                useCases<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>uc<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">:</span> useCases<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token string">"Not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Integer<span class="token operator">></span> useCases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Collections<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>useCases<span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">trackUseCases</span><span class="token punctuation">(</span>useCases<span class="token punctuation">,</span> PasswordUtils<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码使用了反射来取得注解信息。其中，<code>getAnnoation()</code>方法返回指定类型的注解对象。如果被注解方法上没有该类型的注解，则返回<code>null</code>值。如果注解中没有指定注解字段值，则返回定义注解字段时的默认值。</li></ul><h3 id="注解元素"><a href="#注解元素" class="headerlink" title="注解元素"></a>注解元素</h3><ul><li><p>注解元素可用的类型：</p><ul><li>所有基本类型</li><li><code>Class</code></li><li><code>enum</code></li><li><code>String</code></li><li><code>Annotation</code></li></ul><p>如果使用了其它类型则会报错。另外，注解可以作为元素的类型，这意味着注解可以嵌套。</p></li></ul><h3 id="默认值限制"><a href="#默认值限制" class="headerlink" title="默认值限制"></a>默认值限制</h3><ul><li>元素必须有默认值，或者在使用注解时提供元素的值。</li><li>对于非基本类型的元素，无论是在源代码中，还是在注解接口中定义默认值，都不能以<code>null</code>作为其值。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>全排列</title>
      <link href="/2019/07/22/%E5%85%A8%E6%8E%92%E5%88%97/"/>
      <url>/2019/07/22/%E5%85%A8%E6%8E%92%E5%88%97/</url>
      
        <content type="html"><![CDATA[<h1 id="全排列"><a href="#全排列" class="headerlink" title="全排列"></a>全排列</h1><h2 id="递归方法"><a href="#递归方法" class="headerlink" title="递归方法"></a>递归方法</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> t <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>        arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">full</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 将当前最左边和后面的值依次交换</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> start<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 递归解决子数组全排列</span>                <span class="token function">full</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 复原数组</span>                <span class="token function">swap</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> start<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token function">full</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="字典排序"><a href="#字典排序" class="headerlink" title="字典排序"></a>字典排序</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dict</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 从最右起，找出为升序的相邻两个数，记录小的位置i</span>            <span class="token keyword">int</span> i<span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 如果没有则表示完成字典排序</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 从最右起，找出比arr[i]大的第一个数，记录位置j</span>            <span class="token keyword">int</span> j<span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> arr<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">></span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// 交换i和j</span>            <span class="token keyword">int</span> t <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>            arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> t<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 对i + 1到最后进行排序</span>            Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token function">dict</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 算法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x12</title>
      <link href="/2019/07/21/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x12/"/>
      <url>/2019/07/21/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x12/</url>
      
        <content type="html"><![CDATA[<h1 id="枚举类型（二）"><a href="#枚举类型（二）" class="headerlink" title="枚举类型（二）"></a>枚举类型（二）</h1><h2 id="使用EnumSet替代标志"><a href="#使用EnumSet替代标志" class="headerlink" title="使用EnumSet替代标志"></a>使用EnumSet替代标志</h2><ul><li>是一种面向<code>enum</code>的标志，可以用来表示某种“开/关”信息。其内部实现是将一个<code>long</code>值作为位向量，因此<code>EnumSet</code>非常高效。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> AlarmPoints <span class="token punctuation">{</span>    STAIR1<span class="token punctuation">,</span> STAIR2<span class="token punctuation">,</span> LOBBY<span class="token punctuation">,</span> OFFICE1<span class="token punctuation">,</span> OFFICE2<span class="token punctuation">,</span> OFFICE3<span class="token punctuation">,</span>    OFFICE4<span class="token punctuation">,</span> BATHROOM<span class="token punctuation">,</span> UTILITY<span class="token punctuation">,</span> KITCHEN<span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        EnumSet<span class="token operator">&lt;</span>AlarmPoints<span class="token operator">></span> points <span class="token operator">=</span> EnumSet<span class="token punctuation">.</span><span class="token function">noneOf</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span>BATHROOM<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>        points<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>EnumSet<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span>STAIR1<span class="token punctuation">,</span> AlarmPoints<span class="token punctuation">.</span>STAIR2<span class="token punctuation">,</span> AlarmPoints<span class="token punctuation">.</span>KITCHEN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>        points <span class="token operator">=</span> EnumSet<span class="token punctuation">.</span><span class="token function">allOf</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        points<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>EnumSet<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span>STAIR1<span class="token punctuation">,</span> AlarmPoints<span class="token punctuation">.</span>STAIR2<span class="token punctuation">,</span> AlarmPoints<span class="token punctuation">.</span>KITCHEN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>        points<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>EnumSet<span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span>OFFICE1<span class="token punctuation">,</span> AlarmPoints<span class="token punctuation">.</span>OFFICE4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>        points <span class="token operator">=</span> EnumSet<span class="token punctuation">.</span><span class="token function">complementOf</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>points<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><del><code>EnumSet.of()</code>方法被重载了很多次，不仅为可变数量参数进行类重载，还为接收1到5个显式的参数的情况进行类重载。即当使用2到5个参数时，会调用对应的重载方法，而使用1个或者多于5个参数时，会调用可变参数的<code>of()</code>方法。注意，1个参数不会导致编译器构造可变参数数组。</del></li><li><p><em>在JDK 11中，<code>EnumSet.of()</code>不同的重载方法有：1至5个显式声明参数的方法，和一个参数列表为<code>(E first, E... rest)</code>的方法。</em></p></li><li><p><em>在创建<code>EnumSet</code>对象时，如果枚举实例小于等于64个，则使用一个<code>long</code>值，否则使用一个<code>long</code>数组。</em></p></li></ul><h2 id="使用EnumMap"><a href="#使用EnumMap" class="headerlink" title="使用EnumMap"></a>使用EnumMap</h2><ul><li><code>EnumMap</code>要求其中的键必须来自一个<code>enum</code>。由于枚举实例总数量是确定的，<code>EnumMap</code>内部使用了数组实现。调用<code>put()</code>方法时键只能是枚举实例，其它操作和普通的<code>Map</code>基本一致。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> AlarmPoints <span class="token punctuation">{</span>    STAIR1<span class="token punctuation">,</span> STAIR2<span class="token punctuation">,</span> LOBBY<span class="token punctuation">,</span> OFFICE1<span class="token punctuation">,</span> OFFICE2<span class="token punctuation">,</span> OFFICE3<span class="token punctuation">,</span>    OFFICE4<span class="token punctuation">,</span> BATHROOM<span class="token punctuation">,</span> UTILITY<span class="token punctuation">,</span> KITCHEN<span class="token punctuation">}</span><span class="token keyword">interface</span> <span class="token class-name">Command</span> <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        EnumMap<span class="token operator">&lt;</span>AlarmPoints<span class="token punctuation">,</span> Command<span class="token operator">></span> em <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnumMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        em<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span>KITCHEN<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Command</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Kichen fire!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        em<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span>BATHROOM<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Command</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Bathroom alart!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>AlarmPoints<span class="token punctuation">,</span> Command<span class="token operator">></span> e<span class="token operator">:</span> em<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">": "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            e<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            em<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>AlarmPoints<span class="token punctuation">.</span>UTILITY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:BATHROOM: Bathroom alart!KITCHEN: Kichen fire!java.lang.NullPointerException*/</span></code></pre><ul><li>上面代码是一种命令模式的用法，即首先需要一个只有单一方法的接口，然后从该接口实现具有各自不同的行为的多个子类。之后可以根据需要构造命令对象并使用。</li><li>如果<code>EnumMap</code>没有为某个键调用<code>put()</code>方法来存入相应的值的话，那么其对应的值就为<code>null</code>。</li><li><em>注意<code>foreach</code>中元素的泛型声明不可省略</em></li></ul><h2 id="常量相关方法"><a href="#常量相关方法" class="headerlink" title="常量相关方法"></a>常量相关方法</h2><ul><li>可以为<code>enum</code>实例编写方法，从而为每个枚举实例赋予各自不同的行为。首先需要为<code>enum</code>定义一个或多个方法（或者抽象方法），然后为选择枚举实例进行覆盖方法（如果是抽象方法则每个枚举实例都要实现该方法）。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> Test <span class="token punctuation">{</span>    DATE_TIME <span class="token punctuation">{</span>        String <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> DateFormat<span class="token punctuation">.</span><span class="token function">getDateInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>     CLASSPATH <span class="token punctuation">{</span>        String <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> System<span class="token punctuation">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"CLASSPATH"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>     VERSION <span class="token punctuation">{</span>        String <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.version"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    TEST <span class="token punctuation">{</span>        String <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"test info"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token number">222222</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> String <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">111111</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Test t<span class="token operator">:</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> t<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:2019年7月21日 111111.;C:\Program Files\Java\jdk-11.0.3\lib\dt.jar;C:\Program Files\Java\jdk-11.0.3\lib\tools.jar; 11111111.0.3 111111test info 222222*/</span></code></pre><ul><li>通过相应的枚举实例，可以调用其上的方法，这通常也称为表驱动的代码（tabledriven code）。在上面代码中，枚举实例似乎被当做其“超类”来使用，在调用覆盖（实现）的方法（抽象方法）时体现多态的行为。</li></ul><h3 id="使用enum职责链"><a href="#使用enum职责链" class="headerlink" title="使用enum职责链"></a>使用enum职责链</h3><ul><li>在职责链设计模式中，可以用多种不同的方法来解决一个问题，然后将它们链接在一起。当一个请求到来时，遍历这个链，直到链中的某个解决方案能够处理该请求。</li><li>通过常量相关的方法，可以很容易地实现一个简单的职责链。其中每一次尝试可以看做一个策略（设计模式），完整的处理方式列表就是一个职责链。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> Handle <span class="token punctuation">{</span>    PLUS <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token keyword">int</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>target <span class="token operator">-</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>                     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"plus"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    MINUS <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token keyword">int</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>target <span class="token operator">-</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span>                     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"minus"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    ABS <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token keyword">int</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>target <span class="token operator">+</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>                     System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"abs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token keyword">int</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">modify</span><span class="token punctuation">(</span><span class="token keyword">int</span> src<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>src <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>Handle h<span class="token operator">:</span> Handle<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>h<span class="token punctuation">.</span><span class="token function">modify</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"can't modify"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Random r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> target <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> src <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">;</span>            <span class="token function">modify</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:30 can't modify-2 can't modify-4 can't modify-4 can't modify4 minus3 can't modify-5 can't modify-3 abs2 plus3 can't modify*/</span></code></pre><h3 id="使用enum的状态机"><a href="#使用enum的状态机" class="headerlink" title="使用enum的状态机"></a>使用enum的状态机</h3><ul><li>枚举类型非常适合用来创建状态机。一个状态机有有限的特定状态，它通常根据输入，从一个状态转移到下一个状态。每个状态都具有某些可接受的输入，不同的输入回事状态机从当前状态转移到不同的新状态。由于<code>enum</code>对其实例有严格的限制，非常适合用来表现不同的状态和输入。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> Check <span class="token punctuation">{</span>    EVEN <span class="token punctuation">{</span>        <span class="token keyword">void</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">char</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token string">'0'</span><span class="token operator">:</span>                    c <span class="token operator">=</span> ODD<span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token string">'1'</span><span class="token operator">:</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token operator">:</span>                    c <span class="token operator">=</span> ERROR<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    ODD <span class="token punctuation">{</span>        <span class="token keyword">void</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">char</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> <span class="token string">'0'</span><span class="token operator">:</span>                    c <span class="token operator">=</span> EVEN<span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> <span class="token string">'1'</span><span class="token operator">:</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token operator">:</span>                    c <span class="token operator">=</span> ERROR<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    ERROR<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Check c<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">char</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"no such method."</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>String num<span class="token punctuation">)</span> <span class="token punctuation">{</span>        c <span class="token operator">=</span> EVEN<span class="token punctuation">;</span>        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ns <span class="token operator">=</span> num<span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">char</span> n<span class="token operator">:</span> ns<span class="token punctuation">)</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">==</span> ERROR<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> ODD<span class="token operator">:</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"odd 0s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> EVEN<span class="token operator">:</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"even 0s"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> ERROR<span class="token operator">:</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"incorrect input"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Check<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token string">"01001100001"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Check<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token string">"000011110000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Check<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token string">"00110020"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:odd 0seven 0sincorrect input*/</span></code></pre><ul><li><em>上面代码中实现了判断一串字符串的二进制数中有奇数还是偶数个0。有三种状态，<code>EVEN</code>、<code>ODD</code>、<code>ERROR</code>，前两种状态根据输入的不同决定将要转移的下一个状态，而<code>ERROR</code>则表示输入有误，仅作为最终状态。</em></li></ul><h2 id="多路分发"><a href="#多路分发" class="headerlink" title="多路分发"></a>多路分发</h2><ul><li><em>如果存在一种多元运算，其变量类型范围确定但是不能知道某个变量的具体类型，并且该运算结果与变量类型相关，即该运算的实现需要判断各个参数的类型，那么此时可以使用多路分发。</em></li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> Outcome <span class="token punctuation">{</span> WIN<span class="token punctuation">,</span> DRAW<span class="token punctuation">,</span> LOSE<span class="token punctuation">}</span><span class="token keyword">interface</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>    Outcome <span class="token function">compete</span><span class="token punctuation">(</span>Item it<span class="token punctuation">)</span><span class="token punctuation">;</span>    Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Paper p<span class="token punctuation">)</span><span class="token punctuation">;</span>    Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Scissors s<span class="token punctuation">)</span><span class="token punctuation">;</span>    Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Rock r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Paper</span> <span class="token keyword">implements</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Outcome <span class="token function">compete</span><span class="token punctuation">(</span>Item it<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Paper p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Scissors s<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Rock r<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">"Paper"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Scissors</span> <span class="token keyword">implements</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Outcome <span class="token function">compete</span><span class="token punctuation">(</span>Item it<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Paper p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Scissors s<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Rock r<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">"Scissors"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Rock</span> <span class="token keyword">implements</span> <span class="token class-name">Item</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Outcome <span class="token function">compete</span><span class="token punctuation">(</span>Item it<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> it<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Paper p<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Scissors s<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">eval</span><span class="token punctuation">(</span>Rock r<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token string">"Rock"</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> SIZE <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Random r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Item <span class="token function">newItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Scissors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Rock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Paper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">match</span><span class="token punctuation">(</span>Item a<span class="token punctuation">,</span> Item b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token string">" vs. "</span> <span class="token operator">+</span> b <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> a<span class="token punctuation">.</span><span class="token function">compete</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">match</span><span class="token punctuation">(</span><span class="token function">newItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">newItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码实现了“石头、剪刀、布”游戏，采用了接口的方式进行多路分发（两路分发），避免了需要判断类型的代码。</li></ul><h3 id="使用enum分发"><a href="#使用enum分发" class="headerlink" title="使用enum分发"></a>使用enum分发</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> Outcome <span class="token punctuation">{</span> WIN<span class="token punctuation">,</span> DRAW<span class="token punctuation">,</span> LOSE<span class="token punctuation">}</span><span class="token keyword">enum</span> RoShamBo2 <span class="token punctuation">{</span>    <span class="token function">PAPER</span><span class="token punctuation">(</span>Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">SCISSORS</span><span class="token punctuation">(</span>Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">ROCK</span><span class="token punctuation">(</span>Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> Outcome vPaper<span class="token punctuation">,</span> vScissors<span class="token punctuation">,</span> vRock<span class="token punctuation">;</span>    <span class="token function">RoShamBo2</span><span class="token punctuation">(</span>Outcome paper<span class="token punctuation">,</span> Outcome scissors<span class="token punctuation">,</span> Outcome rock<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>vPaper <span class="token operator">=</span> paper<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>vScissorc <span class="token operator">=</span> scissors<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>vRock <span class="token operator">=</span> rock<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">compete</span><span class="token punctuation">(</span>RoShamBo2 it<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">case</span> Outcome<span class="token punctuation">.</span>PAPER<span class="token operator">:</span> <span class="token keyword">return</span> vPaper<span class="token punctuation">;</span>            <span class="token keyword">case</span> Outcome<span class="token punctuation">.</span>SCISSORS<span class="token operator">:</span> <span class="token keyword">return</span> vScissors<span class="token punctuation">;</span>            <span class="token keyword">case</span> Outcome<span class="token punctuation">.</span>ROCK<span class="token operator">:</span> <span class="token keyword">return</span> vRock<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 调用略</span></code></pre><ul><li>上面代码使用构造器来初始化每个枚举实例，并以一组结果作为参数，形成类类似查询表的结构。</li></ul><h3 id="使用常量相关的方法"><a href="#使用常量相关的方法" class="headerlink" title="使用常量相关的方法"></a>使用常量相关的方法</h3><ul><li>为每个枚举实例提供方法的不同实现同样可以完成多路分发，但是在需要添加类型时代码的改动量要多于使用<code>enum</code>分发。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> Outcome <span class="token punctuation">{</span> WIN<span class="token punctuation">,</span> DRAW<span class="token punctuation">,</span> LOSE<span class="token punctuation">}</span><span class="token keyword">enum</span> RoShamBo3 <span class="token punctuation">{</span>    PAPER <span class="token punctuation">{</span>        <span class="token keyword">public</span> Outcome <span class="token function">compete</span><span class="token punctuation">(</span>RoShamBo3 it<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">default</span><span class="token operator">:</span>                 <span class="token keyword">case</span> PAPER<span class="token operator">:</span> <span class="token keyword">return</span> DRAW<span class="token punctuation">;</span>                <span class="token keyword">case</span> SCISSORS<span class="token operator">:</span> <span class="token keyword">return</span> LOSE<span class="token punctuation">;</span>                <span class="token keyword">case</span> ROCK<span class="token operator">:</span> <span class="token keyword">return</span> WIN<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// SCISSORS, ROCK略 </span><span class="token punctuation">}</span></code></pre><h3 id="使用EnumMap分发"><a href="#使用EnumMap分发" class="headerlink" title="使用EnumMap分发"></a>使用EnumMap分发</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> Outcome <span class="token punctuation">{</span> WIN<span class="token punctuation">,</span> DRAW<span class="token punctuation">,</span> LOSE<span class="token punctuation">}</span><span class="token keyword">enum</span> RoShamBo5 <span class="token punctuation">{</span>    PAPER<span class="token punctuation">,</span> SCISSORS<span class="token punctuation">,</span> ROCK<span class="token punctuation">;</span>    <span class="token keyword">static</span> EnumMap<span class="token operator">&lt;</span>RoShamBo5<span class="token punctuation">,</span> EnumMap<span class="token operator">&lt;</span>RoShamBo5<span class="token punctuation">,</span> Outcome<span class="token operator">>></span> table <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnumMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>RoShamBo5<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>RoShamBo5 it<span class="token operator">:</span> RoShamBo5<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            table<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EnumMap</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>RoShamBo5<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">initRow</span><span class="token punctuation">(</span>PAPER<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initRow</span><span class="token punctuation">(</span>SCISSORS<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">initRow</span><span class="token punctuation">(</span>ROCK<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>LOSE<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>WIN<span class="token punctuation">,</span> Outcome<span class="token punctuation">.</span>DRAW<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">initRow</span><span class="token punctuation">(</span>RoShamBo5 it<span class="token punctuation">,</span> Outcome vPAPER<span class="token punctuation">,</span> Outcome vSCISSORS<span class="token punctuation">,</span> Outcome vROCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>        EnumMap<span class="token operator">&lt;</span>RoShamBo5<span class="token punctuation">,</span> Outcome<span class="token operator">></span> row <span class="token operator">=</span> RoShamBo5<span class="token punctuation">.</span>table<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>        row<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>RoShamBo5<span class="token punctuation">.</span>PAPER<span class="token punctuation">,</span> vPAPER<span class="token punctuation">)</span><span class="token punctuation">;</span>        row<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>RoShamBo5<span class="token punctuation">.</span>SCISSORS<span class="token punctuation">,</span> vSCISSORS<span class="token punctuation">)</span><span class="token punctuation">;</span>        row<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>RoShamBo5<span class="token punctuation">.</span>ROCK<span class="token punctuation">,</span> vROCK<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> Outcome <span class="token function">compete</span><span class="token punctuation">(</span>RoShamBo5 it<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> table<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>使用<code>EnumMap</code>实现类似于表格的方法，从而达到了分发的目的。当然也可以使用二维数组来实现。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x11</title>
      <link href="/2019/07/18/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x11/"/>
      <url>/2019/07/18/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x11/</url>
      
        <content type="html"><![CDATA[<h1 id="枚举类型（一）"><a href="#枚举类型（一）" class="headerlink" title="枚举类型（一）"></a>枚举类型（一）</h1><h2 id="基本enum特性"><a href="#基本enum特性" class="headerlink" title="基本enum特性"></a>基本enum特性</h2><ul><li>调用<code>enum</code>的<code>values()</code>方法，可以遍历<code>enum</code>实例，返回一个<code>enum</code>实例的数组，并且数组中实例的顺序和声明时的顺序保持一致。</li><li>创建<code>enum</code>时，编译器会为你生成一个相关的类，这个类继承自<code>java.lang.Enum</code>。</li><li><code>ordinal()</code>方法返回一个<code>int</code>值，表示每个<code>enum</code>实例在声明中的次序，从<code>0</code>开始计算。</li><li>可以使用<code>==</code>来比较<code>enum</code>实例，编译器会自动提供<code>equals()</code>和<code>hashCode()</code>方法。</li><li><code>Enum</code>实现了<code>Comparable</code>接口，拥有<code>compareTo()</code>方法。</li><li><code>name()</code>方法返回<code>enum</code>实例声明时的名字，和<code>toString()</code>方法相同。</li><li><code>valueOf()</code>根据参数给出的实例名称返回相应的<code>enum</code>实例，如果不存在该名称的实例将会抛出异常。</li></ul><blockquote><p><code>enum</code>是java中的语法糖，实际反编译后是继承自<code>Enum</code>类。</p></blockquote><h2 id="向enum中添加新方法"><a href="#向enum中添加新方法" class="headerlink" title="向enum中添加新方法"></a>向enum中添加新方法</h2><ul><li><code>enum</code>除了不能被继承，和普通的类基本相同。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">enum</span> Main <span class="token punctuation">{</span>    <span class="token function">WEST</span><span class="token punctuation">(</span><span class="token string">"west"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">NORTH</span><span class="token punctuation">(</span><span class="token string">"north"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">EAST</span><span class="token punctuation">(</span><span class="token string">"east"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token function">SOUTH</span><span class="token punctuation">(</span><span class="token string">"south"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> String desc<span class="token punctuation">;</span>    <span class="token function">Main</span><span class="token punctuation">(</span>String desc<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>desc <span class="token operator">=</span> desc<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">getDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> desc<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Main m<span class="token operator">:</span> Main<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>m <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> m<span class="token punctuation">.</span><span class="token function">getDesc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:WEST westNORTH northEAST eastSOUTH south*/</span></code></pre><ul><li>如果希望为<code>enum</code>添加方法，必须先定义<code>enum</code>实例，并且在实例序列最后添加一个分号。否则在编译时会得到错误消息。</li><li>可以为<code>enum</code>添加构造方法，注意声明<code>enum</code>实例时就是在使用<code>enum</code>的构造方法。此外，<code>enum</code>的构造方法无所谓是否<code>private</code>，因为就算不声明<code>private</code>其构造方法也只能在<code>enum</code>内部使用。</li><li>可以覆盖原来的<code>toString()</code>方法，以提供定制化效果。</li></ul><blockquote><p><code>enum</code>的构造方法不能被反射调用，当反射调用构造方法时会检查对应类是否为枚举类。</p></blockquote><h2 id="switch语句中的enum"><a href="#switch语句中的enum" class="headerlink" title="switch语句中的enum"></a>switch语句中的enum</h2><ul><li>在<code>case</code>语句中不需要<code>enum</code>类来修饰<code>enum</code>实例。</li></ul><h2 id="values-方法"><a href="#values-方法" class="headerlink" title="values()方法"></a>values()方法</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 反编译enum代码</span><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token keyword">extends</span> <span class="token class-name">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>Enum</span><span class="token operator">&lt;</span>Apple<span class="token operator">></span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Apple A<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Apple B<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> Apple C<span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> Apple<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">public</span> <span class="token keyword">static</span> Apple <span class="token function">valueOf</span><span class="token punctuation">(</span>java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>String<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">static</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li><code>values()</code>方法和<code>valueOf(String)</code>方法是编译器向<code>enum</code>中加入的静态方法。</li><li>编译器将<code>enum</code>标记为<code>final</code>类，因此无法继承<code>enum</code>。</li></ul><h2 id="随机选取"><a href="#随机选取" class="headerlink" title="随机选取"></a>随机选取</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Enums</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Random rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">Enum</span><span class="token operator">&lt;</span>T<span class="token operator">>></span> T <span class="token function">random</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> ec<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">random</span><span class="token punctuation">(</span>ec<span class="token punctuation">.</span><span class="token function">getEnumConstants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">random</span><span class="token punctuation">(</span>T<span class="token punctuation">[</span><span class="token punctuation">]</span> values<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> values<span class="token punctuation">[</span>rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>values<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><code>&lt;T extends Enum&lt;T&gt;&gt;</code>限制泛型必须为<code>enum</code>，使用<code>Class&lt;T&gt;</code>可以获取枚举的实例数组。</li></ul><h2 id="使用接口组织枚举"><a href="#使用接口组织枚举" class="headerlink" title="使用接口组织枚举"></a>使用接口组织枚举</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">Food</span> <span class="token punctuation">{</span>    <span class="token keyword">enum</span> Appetizer <span class="token keyword">implements</span> <span class="token class-name">Food</span> <span class="token punctuation">{</span>        SALAD<span class="token punctuation">,</span> SOUP<span class="token punctuation">,</span> SPRING_ROLLS    <span class="token punctuation">}</span>    <span class="token keyword">enum</span> MainCourse <span class="token keyword">implements</span> <span class="token class-name">Food</span> <span class="token punctuation">{</span>        LASAGNE<span class="token punctuation">,</span> BURRITO<span class="token punctuation">,</span> PAD_THAI<span class="token punctuation">,</span> LENTILS    <span class="token punctuation">}</span>    <span class="token keyword">enum</span> Dessert <span class="token keyword">implements</span> <span class="token class-name">Food</span> <span class="token punctuation">{</span>        TIRAMISU<span class="token punctuation">,</span> GELATO<span class="token punctuation">,</span> BLACK_FOREST_CAKE    <span class="token punctuation">}</span>    <span class="token keyword">enum</span> Coffee <span class="token keyword">implements</span> <span class="token class-name">Food</span> <span class="token punctuation">{</span>        BLACK_COFFEE<span class="token punctuation">,</span> DECAF_COFFEE<span class="token punctuation">,</span> ESPRESSO    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Food f <span class="token operator">=</span> Food<span class="token punctuation">.</span>Appetizer<span class="token punctuation">.</span>SALAD<span class="token punctuation">;</span>        f <span class="token operator">=</span> Food<span class="token punctuation">.</span>Coffee<span class="token punctuation">.</span>BLACK_COFFEE<span class="token punctuation">;</span>        f <span class="token operator">=</span> Food<span class="token punctuation">.</span>Dessert<span class="token punctuation">.</span>BLACK_FOREST_CAKE<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><p>在一个接口的内部，创建实现该接口的枚举，以此将元素进行分组，可以达到将枚举元素分类组织的目的。</p></li><li></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x10</title>
      <link href="/2019/07/15/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x10/"/>
      <url>/2019/07/15/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x10/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-I-O-系统（六）"><a href="#Java-I-O-系统（六）" class="headerlink" title="Java I/O 系统（六）"></a>Java I/O 系统（六）</h1><h2 id="对象序列化"><a href="#对象序列化" class="headerlink" title="对象序列化"></a>对象序列化</h2><ul><li>Java的对象序列化将那些实现了<code>Serializable</code>接口的对象转换成一个字节序列，并能够在以后将这个字节序列完全恢复为原来的对象。这一过程甚至可通过网络进行；这意味着序列化机制能自动弥补不同操作系统之间的差异。</li><li>对象序列化可以实现轻量级持久性。持久性值为准一个对象的生存周期并不取决于程序是否在执行，而是可以生存与程序调用之间。之所以称其为轻量级，是因为不能用某种持久的关键字来简单地定义一个对象，并让系统自动维护其它细节问题，相反，对象必须在程序中显示地序列化和反序列化。</li><li>对象序列化可以用于Java的远程方法调用和Java Beans对象序列化。</li></ul><blockquote><p>实现RMI的主要步骤：</p><ol><li>定义一个远程接口，此接口需要继承Remote</li><li>开发远程接口的实现类</li><li>创建一个server并把远程对象注册到端口</li><li>创建一个client查找远程对象，调用远程方法、</li></ol></blockquote><blockquote><p>Java Bean类是指Java中遵循关于命名、构造器、方法的特定规范的一种类型，以提供通用性。</p></blockquote><ul><li>只要对象实现了<code>Serializable</code>接口就可以进行对象序列化。<code>Serializable</code>是一个标记接口，其中没有任何方法。</li><li>序列化一个对象，首先要创建某些<code>OutputStream</code>对象，然后将其封装在一个<code>ObjectOutputStream</code>对象内，然后调用<code>writeObject()</code>即可将对象序列化，并将其发送给<code>OutputStream</code>；反序列化一个对象，需要将一个<code>InputStream</code>对象封装在<code>ObjectInputStream</code>中，然后调用<code>readObject()</code>，此时获得一个引用，指向一个向上转型的<code>Object</code>，需要进行合适的向下转型才能使用。</li><li>对象序列化不仅保存了对象本身的信息，而且能最终对象内所包含的所有引用，并保存那些对象；接着对这些对象继续追踪它们包含的引用并保存，以此类推。</li></ul><h3 id="寻找类"><a href="#寻找类" class="headerlink" title="寻找类"></a>寻找类</h3><ul><li>必须保证Java虚拟机能够找到序列化对象对应类的.class文件，否则会出现<code>ClassNotFoundException</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Alien</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        ObjectOutput out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"x.file"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Alien a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Alien</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>此时再编写反序列化部分，和<code>Alien</code>不在同一目录下。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        ObjectInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"x.file"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Object a <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:Exception in thread "main" java.lang.ClassNotFoundException: Alien...*/</span></code></pre><p><em>如果前后序列化的类名字相同，但是成员有变化会出现异常。</em></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 序列化时定义</span><span class="token keyword">class</span> <span class="token class-name">Alien</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 反序列化时定义</span><span class="token keyword">class</span> <span class="token class-name">Alien</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    String i <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><em>此时进行反序列化会出现：</em></p><pre><code>Exception in thread &quot;main&quot; java.io.InvalidClassException: Alien; local class incompatible: stream classdesc serialVersionUID = 185057998004728250, local class serialVersionUID = 6323316111603380755</code></pre><p><em>但是如果成员名称和权限相同，成员变量仅赋值不同，成员方法的返回值和参数列表均相同但方法内部实现不同则不会出现异常，例如：</em></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 序列化时定义</span><span class="token keyword">class</span> <span class="token class-name">Alien</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        i<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 反序列化时定义</span><span class="token keyword">class</span> <span class="token class-name">Alien</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">566</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><em>此时进行反序列化不会出现异常。</em></p><h3 id="序列化控制"><a href="#序列化控制" class="headerlink" title="序列化控制"></a>序列化控制</h3><ul><li>如果希望对序列化过程进行控制，可以通过实现<code>Externalizable</code>接口代替<code>Serializable</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Constructing objects..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Blip1 b1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blip1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Blip2 b2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blip2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectOutputStream o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"blips.out"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Saving objects..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        o<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span>        o<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>        o<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"blips.out"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Recovering b1..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b1 <span class="token operator">=</span> <span class="token punctuation">(</span>Blip1<span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Recovering b2..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b2 <span class="token operator">=</span> <span class="token punctuation">(</span>Blip2<span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Blip1</span> <span class="token keyword">implements</span> <span class="token class-name">Externalizable</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token function">Blip1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip1 Constructor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeExternal</span><span class="token punctuation">(</span>ObjectOutput out<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip1#writeExternal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readExternal</span><span class="token punctuation">(</span>ObjectInput in<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip1#reeadExternal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Blip2</span> <span class="token keyword">implements</span> <span class="token class-name">Externalizable</span> <span class="token punctuation">{</span>    <span class="token function">Blip2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip2  Constructor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeExternal</span><span class="token punctuation">(</span>ObjectOutput out<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip2#writeExternal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readExternal</span><span class="token punctuation">(</span>ObjectInput in<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip2#reeadExternal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:Constructing objects...Blip1 ConstructorBlip2  ConstructorSaving objects...Blip1#writeExternalBlip2#writeExternalRecovering b1...Blip1 ConstructorBlip1#reeadExternalRecovering b2...Exception in thread "main" java.io.InvalidClassException: Blip2; no valid constructor*/</span></code></pre><ul><li><code>Externalizable</code>和<code>Serializable</code>不同，后者完全以对象存储的二进制位来构造，而不需要构造器，前者则会调用类所有默认的构造器（包括字段定义的初始化），然后调用<code>readExternal()</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Blip3</span> <span class="token keyword">implements</span> <span class="token class-name">Externalizable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>    <span class="token keyword">private</span> String s<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Blip3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip3 Constructor"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Blip3</span><span class="token punctuation">(</span>String x<span class="token punctuation">,</span> <span class="token keyword">int</span> a<span class="token punctuation">)</span> <span class="token punctuation">{</span>        s <span class="token operator">=</span> x<span class="token punctuation">;</span>        i <span class="token operator">=</span> a<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> s <span class="token operator">+</span> i<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeExternal</span><span class="token punctuation">(</span>ObjectOutput out<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Blip3#writeExternal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 可以控制序列化成员</span>        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">readExternal</span><span class="token punctuation">(</span>ObjectInput in<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> ClassNotFoundException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 按照writeExternal中写入顺序读出</span>        s <span class="token operator">=</span> <span class="token punctuation">(</span>String<span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        i <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Constructing objects..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Blip3 b3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blip3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b3<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectOutputStream o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"b3.out"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Saving object..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        o<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>b3<span class="token punctuation">)</span><span class="token punctuation">;</span>        o<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"b3.out"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Recovering object..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        b3 <span class="token operator">=</span> <span class="token punctuation">(</span>Blips3<span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>在上面代码中，如果在<code>writeExternal()</code>和<code>readExternal()</code>不保存和恢复成员变量，那么反序列化对象后，其成员变量值均为初始值（<code>i</code>为<code>0</code>，<code>s</code>为<code>null</code>）。</li><li>如果不希望对象中某个变量被序列化，除了实现<code>Externalizable</code>接口以外，可以使用<code>Serializable</code>配合关键字<code>transient</code>，该关键字修饰的成员变量在序列化时会被忽略。例如：</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">transient</span> String password<span class="token punctuation">;</span></code></pre><p>无论在使用中对<code>password</code>赋任何值，在序列化和反序列化后，其值一定为<code>null</code>。</p><ul><li>尽管<code>Serializable</code>中没有定义方法，但是如果在实现该接口的类中添加<code>writeObject(ObjectOutputStream out)</code>和<code>readObject(ObjectInputStream in)</code>，那么对该类的对象进行序列化和反序列化时就会调用这两个方法，无论其权限如何（即使是<code>private</code>也会被调用）。此处使用的是反射搜索方法，而不是检查接口。</li></ul><h3 id="使用持久性"><a href="#使用持久性" class="headerlink" title="使用持久性"></a>使用持久性</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">House</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> String name<span class="token punctuation">;</span>    <span class="token keyword">private</span> House preferredHouse<span class="token punctuation">;</span>    <span class="token function">Animal</span><span class="token punctuation">(</span>String nm<span class="token punctuation">,</span> House h<span class="token punctuation">)</span> <span class="token punctuation">{</span>        name <span class="token operator">=</span> nm<span class="token punctuation">;</span>        preferredHouse <span class="token operator">=</span> h<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> name <span class="token operator">+</span> <span class="token string">"["</span> <span class="token operator">+</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"], "</span> <span class="token operator">+</span> preferredHouse <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        House house <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">House</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>Animal<span class="token operator">></span> animals <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        animals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">"dog"</span><span class="token punctuation">,</span> house<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        animals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">"hamster"</span><span class="token punctuation">,</span> house<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        animals<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Animal</span><span class="token punctuation">(</span><span class="token string">"cat"</span><span class="token punctuation">,</span> house<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>animals<span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteArrayOutputStream buf1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectOutputStream o1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>buf1<span class="token punctuation">)</span><span class="token punctuation">;</span>        o1<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>animals<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 写第2次</span>        o1<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>animals<span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteArrayOutputStream buf2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectOutputStream o2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>buf2<span class="token punctuation">)</span><span class="token punctuation">;</span>        o2<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>animals<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream in1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>buf1<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectInputStream in2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>buf2<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List a1 <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token punctuation">)</span>in1<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List a2 <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token punctuation">)</span>in1<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List a3 <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token punctuation">)</span>in2<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a1<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a2<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:[dog[Animal@5b464ce8], House@2d3fcdbd, hamster[Animal@617c74e5], House@2d3fcdbd, cat[Animal@6537cf78], House@2d3fcdbd][dog[Animal@4501b7af], House@523884b2, hamster[Animal@5b275dab], House@523884b2, cat[Animal@61832929], House@523884b2][dog[Animal@4501b7af], House@523884b2, hamster[Animal@5b275dab], House@523884b2, cat[Animal@61832929], House@523884b2][dog[Animal@29774679], House@3ffc5af1, hamster[Animal@5e5792a0], House@3ffc5af1, cat[Animal@26653222], House@3ffc5af1]*/</span></code></pre><ul><li>可以发现，首先对象序列化实现了对象的深拷贝。此外，在<code>o1</code>中写入两次的对象地址是相同的，这意味着在同一个对象序列化流中，系统能够识别出相同的引用。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Shape</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> RED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> BLUE <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> GREEN <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> xPos<span class="token punctuation">,</span> yPos<span class="token punctuation">,</span> dimension<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Random rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token number">47</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">setColor</span><span class="token punctuation">(</span><span class="token keyword">int</span> newColor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">int</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Shape</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> dim<span class="token punctuation">)</span> <span class="token punctuation">{</span>        xPos <span class="token operator">=</span> x<span class="token punctuation">;</span>        yPos <span class="token operator">=</span> y<span class="token punctuation">;</span>        dimension <span class="token operator">=</span> dim<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"color["</span> <span class="token operator">+</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"] xPos["</span> <span class="token operator">+</span> xPos <span class="token operator">+</span> <span class="token string">"] yPos"</span> <span class="token operator">+</span> yPos <span class="token operator">+</span> <span class="token string">"] dim["</span> <span class="token operator">+</span> dimension <span class="token operator">+</span> <span class="token string">"]\n"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Shape <span class="token function">randomFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> x <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> y <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> dim <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span> <span class="token punctuation">(</span>counter<span class="token operator">++</span> <span class="token operator">%</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Circle</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Square</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Line</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Circle</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> color <span class="token operator">=</span> RED<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setColor</span><span class="token punctuation">(</span><span class="token keyword">int</span> newColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        color <span class="token operator">=</span> newColor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> color<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">Circle</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> dim<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Square</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> color<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Square</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> dim<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">;</span>        color <span class="token operator">=</span> RED<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setColor</span><span class="token punctuation">(</span><span class="token keyword">int</span> newColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        color <span class="token operator">=</span> newColor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> color<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Line</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> color <span class="token operator">=</span> RED<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Line</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> dim<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serializeStaticState</span><span class="token punctuation">(</span>ObjectOutputStream os<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        os<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>color<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">deserializeStaticState</span><span class="token punctuation">(</span>ObjectInputStream os<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        color <span class="token operator">=</span> os<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setColor</span><span class="token punctuation">(</span><span class="token keyword">int</span> newColor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        color <span class="token operator">=</span> newColor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> color<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        List<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span><span class="token operator">>></span> shapeTypes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shapeTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Circle<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shapeTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Square<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        shapeTypes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Line<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>Shape<span class="token operator">></span> shapes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            shapes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>Shape<span class="token punctuation">.</span><span class="token function">randomFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            <span class="token punctuation">(</span><span class="token punctuation">(</span>Shape<span class="token punctuation">)</span>shapes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span>Shape<span class="token punctuation">.</span>GREEN<span class="token punctuation">)</span><span class="token punctuation">;</span>        ObjectOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"cad.out"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>shapeTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>        Line<span class="token punctuation">.</span><span class="token function">serializeStaticState</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>shapes<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>shapes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 类定义略</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 恢复</span>        ObjectInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"cad.out"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span><span class="token operator">>></span> shapeTypes2 <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Shape</span><span class="token operator">>></span><span class="token punctuation">)</span>in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Line<span class="token punctuation">.</span><span class="token function">deserializeStaticState</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        List<span class="token operator">&lt;</span>Shape<span class="token operator">></span> shapes2 <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token operator">&lt;</span>Shape<span class="token operator">></span><span class="token punctuation">)</span> in<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>shapes2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>注意，在上面代码中，除了<code>Line</code>对象以外的其它对象的<code>static</code>字段<code>color</code>在反序列化后没有设置正确的值，这也是<code>Line</code>类中两个静态方法<code>serializeStaticState()</code>和<code>deserializeStaticState()</code>的作用，手动实现<code>static</code>字段的序列化。</li></ul><h2 id="Perferences"><a href="#Perferences" class="headerlink" title="Perferences"></a>Perferences</h2><ul><li>Perferences提供存储小的、受限的数据集合（基本类型和字符串），存储位置和方法与操作系统相关（Windows存储在注册表中）。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x0f</title>
      <link href="/2019/07/14/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0f/"/>
      <url>/2019/07/14/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0f/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-I-O-系统（五）"><a href="#Java-I-O-系统（五）" class="headerlink" title="Java I/O 系统（五）"></a>Java I/O 系统（五）</h1><h2 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h2><ul><li>Java I/O类库中的类支持读写压缩格式的数据流。压缩类库是按字节方式处理的，因此属于<code>InputStream</code>和<code>OutputStream</code>继承层次结构的一部分。</li><li>可以使用<code>InputStreamReader</code>和<code>OutputStreamWriter</code>在两种类型之间进行转换。</li></ul><h3 id="GZIP"><a href="#GZIP" class="headerlink" title="GZIP"></a>GZIP</h3><ul><li>使用GZIP压缩，直接将输出流封装成<code>GZIPOutputStream</code>或<code>ZipOutputStream</code>，解压就将输入流封装成<code>GZIPInputStream</code>或<code>ZipInputStream</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GZIPcompress</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 检查参数</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"no file."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 压缩</span>        BufferedReader in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        BufferedOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GZIPOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"test.gz"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Writing file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> c<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>             out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 解压</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Reading file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        BufferedReader in2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GZIPInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"test.gz"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String s<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> in2<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="用Zip进行多文件压缩、解压"><a href="#用Zip进行多文件压缩、解压" class="headerlink" title="用Zip进行多文件压缩、解压"></a>用Zip进行多文件压缩、解压</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 压缩</span>        FileOutputStream f <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"test.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        CheckedOutputStream csum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckedOutputStream</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Adler32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ZipOutputStream zos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipOutputStream</span><span class="token punctuation">(</span>csum<span class="token punctuation">)</span><span class="token punctuation">;</span>        BufferedOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span>zos<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>String arg<span class="token operator">:</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Writing file "</span> <span class="token operator">+</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>            BufferedReader in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            zos<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ZipEntry</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> c<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>            in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            out<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 校验和</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Checksum: "</span> <span class="token operator">+</span> csum<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 解压</span>        FileInputStream fi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"test.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        CheckedInputStream csumi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CheckedInputStream</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Adler32</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ZipInputStream in2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipInputStream</span><span class="token punctuation">(</span>csumi<span class="token punctuation">)</span><span class="token punctuation">;</span>        BufferedInputStream bis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>in2<span class="token punctuation">)</span><span class="token punctuation">;</span>        ZipEntry ze<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ze <span class="token operator">=</span> in2<span class="token punctuation">.</span><span class="token function">getNextEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Reading file: "</span> <span class="token operator">+</span> ze<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> x<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">=</span> bis<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Checksum: "</span> <span class="token operator">+</span> csumi<span class="token punctuation">.</span><span class="token function">getChecksum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 另一种解压方式</span>        ZipFile zf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipFile</span><span class="token punctuation">(</span><span class="token string">"test.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Enumeration e <span class="token operator">=</span> zf<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            ZipEntry ze2 <span class="token operator">=</span> <span class="token punctuation">(</span>ZipEntry<span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"File: "</span> <span class="token operator">+</span> ze2<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// ...</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>对于每一个要加入压缩档案的文件，都必须调用<code>putNextEntry()</code>，并将其传递给一个<code>ZipEntry</code>对象。<code>ZipEntry</code>对象包含了一个功能很广泛的接口，可以获取和设置Zip文件内特定想上所有可利用的数据，例如名字、压缩和未压缩的文件大小、日期、校验和等等。</li><li>为了能够解压文件，<code>ZipInputStream</code>提供了一个<code>getNextEntry()</code>方法返回下一个<code>ZipEntry</code>（如果存在）。</li><li>为了读取校验和，必须拥有相关联的<code>Checksum</code>对象的访问权限。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x0e</title>
      <link href="/2019/07/14/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0e/"/>
      <url>/2019/07/14/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0e/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-I-O-系统（四）"><a href="#Java-I-O-系统（四）" class="headerlink" title="Java I/O 系统（四）"></a>Java I/O 系统（四）</h1><h2 id="新I-O"><a href="#新I-O" class="headerlink" title="新I/O"></a>新I/O</h2><ul><li><code>java.nio.*</code>包中引入了新的Java I/O类库，其目的在于提高速度。而速度的提高来自于所使用的结构更接近于操作系统执行I/O的方式：通道和缓冲器。在交互过程中只需要和缓冲器交互，把缓冲器派送到通道。通道要么从缓冲器获得数据，要么向缓冲器发送数据。</li><li>唯一直接与通道交互的缓冲器是<code>ByteBuffer</code>，可以存储未加工字节的缓冲器。</li><li>引入NIO后，<code>FileInputStream</code>、<code>OutputStream</code>、<code>RandomAccessFile</code>被修改，可以产生<code>FileChannel</code>，用于操纵字节流。<code>java.nio.channels.Channels</code>类提供了可以在通道中产生<code>Reader</code>和<code>Writer</code>等字符模式类的方法。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// FileChannel fc = new FileOutputStream("test.out").getChannel();</span>        FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"test.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileChannel fc <span class="token operator">=</span> fos<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">"Some text"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// fc = new RandomAccessFile("test.out", "rw").getChannel();</span>        RandomAccessFile raf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token string">"test.out"</span><span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc <span class="token operator">=</span> raf<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>fc<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">"Some more"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        raf<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// fc = new FileInputStream("test.out").getChannel();</span>        FileInputStream fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"test.out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteBuffer buff <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">;</span>        buff<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>buff<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>buff<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><code>getChannel()</code>会产生一个<code>FileChannel</code>，可以向它传送用于读写的<code>ByteBuffer</code>，并且可以锁定文件的某些区域用于独占式访问。</li><li>对于只读访问，必须显式地使用静态<code>allocate()</code>方法来分配<code>ByteBuffer</code>。<code>ByteBuffer</code>的大小关乎I/O的速度。使用<code>allocateDirect()</code>可以产生与操作系统有更高耦合性的直接缓冲器，以获得更高的速度。但是这种分配的开支会更大，并且具体实现与操作系统相关。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChannelCopy</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> BSIZE <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throw</span> Exception <span class="token punctuation">{</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">!=</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"arguments: sourcefile destfile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        FileInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileChannel fi <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fo <span class="token operator">=</span> out<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteBuffer buffer <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>BSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            buffer<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            fo<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>            buffer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>一旦调用<code>read()</code>来告知<code>FileChannel</code>向<code>ByteBuffer</code>存储字节，就必须调用缓冲器上的<code>flip()</code>，准备好让其它对象来读取其内容。如果打算继续使用缓冲器执行<code>read()</code>，则必须使用<code>clear()</code>。</li><li><code>FileChannel#read()</code>返回<code>-1</code>时即达到了输入的末尾。</li><li><code>transferTo()</code>和<code>transferFrom()</code>可以将一个通道和另一个通道相连。</li></ul><h3 id="转换数据"><a href="#转换数据" class="headerlink" title="转换数据"></a>转换数据</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 直接输入输出</span>        FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"data2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileChannel fc <span class="token operator">=</span> fos<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">"Some text"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileInputStream fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"data2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ByteBuffer bb <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>        bb<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bb<span class="token punctuation">.</span><span class="token function">asCharBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bb<span class="token punctuation">.</span><span class="token function">rewind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输出时解码</span>        String encoding <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"file.encoding"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"encoding: "</span> <span class="token operator">+</span> encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Charset<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>encoding<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 输入时编码</span>        fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"data2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc <span class="token operator">=</span> fos<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token string">"Some text"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-16BE"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"data2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bb<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>        bb<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bb<span class="token punctuation">.</span><span class="token function">asCharBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 使用CharBuffer输出</span>        fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"data2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc <span class="token operator">=</span> fos<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bb <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bb<span class="token punctuation">.</span><span class="token function">asCharBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"Some text"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 使用CharBuffer输入</span>        fis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"data2.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc <span class="token operator">=</span> fis<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bb<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bb<span class="token punctuation">)</span><span class="token punctuation">;</span>        bb<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>bb<span class="token punctuation">.</span><span class="token function">asCharBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:卯浥⁴數-----encoding: UTF-8Some text-----Some textSome text*/</span></code></pre><ul><li><code>java.nio.CharBuffer</code>有一个<code>toString()</code>方法，可以返回一个包含缓冲器所有字符的字符串。但是缓冲器中容纳的是普通的字节，要将其转为字符，要么在输入时对其进行编码，要么在将其从缓冲器输出时对其进行解码。</li></ul><h3 id="获取基本类型"><a href="#获取基本类型" class="headerlink" title="获取基本类型"></a>获取基本类型</h3><ul><li>向<code>ByteBuffer</code>插入基本类型数据，可以利用<code>asCharBuffer()</code>、<code>asShortBuffer()</code>等获得该缓冲器上的视图，然后使用视图的<code>put()</code>方法。注意使用<code>ShortBuffer</code>的<code>put()</code>方法时需要进行强制类型转换，而其它所有的数据缓冲器在使用<code>put()</code>方法时，不要进行转换。</li></ul><h3 id="视图缓冲器"><a href="#视图缓冲器" class="headerlink" title="视图缓冲器"></a>视图缓冲器</h3><ul><li>视图缓冲器可以通过某个特定的基本数据类型的试穿查看其底层的<code>ByteBuffer</code>。此外还可以从<code>ByteBuffer</code>一次一个或者成批（数组）读取基本类型值。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IntBufferDemo</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ByteBuffer bb <span class="token operator">=</span> ByteBuffer<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        IntBuffer ib <span class="token operator">=</span> bb<span class="token punctuation">.</span><span class="token function">asIntBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ib<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">143</span><span class="token punctuation">,</span> <span class="token number">811</span><span class="token punctuation">,</span> <span class="token number">1016</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"-----"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ib<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1811</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// [11, 42, 47, 1811, 143, 811, 1016]</span>        ib<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>ib<span class="token punctuation">.</span><span class="token function">hasRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> i <span class="token operator">=</span> ib<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码中，先用重载后的<code>put()</code>方法存储一个整数数组。<code>get()</code>和<code>put()</code>方法调用直接访问底层<code>ByteBuffer</code>中的某个整数位置。</li></ul><blockquote><p>小端：低位字节排放在内存的低地址端，高位字节排放在内存的高地址端。<br>大端：高位字节排放在内存的低地址端，低位字节排放在内存的高地址端。</p></blockquote><ul><li><code>ByteBuffer</code>默认是大端形式存储数据，并且数据在网络中传送时也常常使用大端模式。可以使用带有参数<code>ByteOrder.BIG_ENDIAN</code>或<code>ByteOrder.LITTLE_ENDIAN</code>的<code>order()</code>方法改变<code>ByteBuffer</code>的字节排序方式。</li></ul><h3 id="缓冲器的细节"><a href="#缓冲器的细节" class="headerlink" title="缓冲器的细节"></a>缓冲器的细节</h3><ul><li><code>Buffer</code>由数据和四个索引组成。四个索引<code>mark</code>、<code>position</code>、<code>limit</code>、<code>capacity</code>可以高效地访问及操纵<code>Buffer</code>中的数据。</li></ul><table><thead><tr><th>方法</th><th>功能</th></tr></thead><tbody><tr><td><code>capacity()</code></td><td>返回缓冲区的容量<code>capacity</code></td></tr><tr><td><code>clear()</code></td><td>清空缓冲区，将<code>position</code>设置为0，<code>limit</code>设置为容量<code>capacity</code>，可以用于覆写缓冲区</td></tr><tr><td><code>flip()</code></td><td>将<code>limit</code>设为<code>position</code>，<code>position</code>设为0，用于准备从缓冲区读取已经写入的数据</td></tr><tr><td><code>limit()</code></td><td>返回<code>limit</code>值</td></tr><tr><td><code>limit(int lim)</code></td><td>设置<code>limit</code>值</td></tr><tr><td><code>mark()</code></td><td>将<code>mark</code>设为<code>position</code></td></tr><tr><td><code>position()</code></td><td>返回<code>position</code>值</td></tr><tr><td><code>position(int pos)</code></td><td>设置<code>position</code>值</td></tr><tr><td><code>remaining()</code></td><td>返回<code>limit - position</code></td></tr><tr><td><code>hasRemaining()</code></td><td>若有介于<code>position</code>和<code>limit</code>之间的元素，则返回<code>true</code></td></tr></tbody></table><h3 id="内存映射文件"><a href="#内存映射文件" class="headerlink" title="内存映射文件"></a>内存映射文件</h3><ul><li>内存映射文件可以创建和修改因为过大而不能放入内存的文件。对应类为<code>MappedByteBuffer</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LarggeMappedFiles</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">0x8FFFFFFF</span><span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        RandomAccessFile raf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RandomAccessFile</span><span class="token punctuation">(</span><span class="token string">"test.dat"</span><span class="token punctuation">,</span> <span class="token string">"rw"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        MappedByteBuffer mbb <span class="token operator">=</span> raf<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>FileChannel<span class="token punctuation">.</span>MapMode<span class="token punctuation">.</span>READ_WRITE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            mbb<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Finished writing"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>mbb<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><blockquote><p><code>MappedByteBuffer</code>主要是通过<code>FileChannel#map</code>方法，把文件映射到虚拟内存，并返回逻辑地址<code>address</code>，后续文件的读写操作都使用维护的虚拟内存地址和偏移进行操作。</p></blockquote><h3 id="文件加锁"><a href="#文件加锁" class="headerlink" title="文件加锁"></a>文件加锁</h3><ul><li>文件加锁机制允许同步访问某个作为共享资源的文件，并且文件锁对其它的操作系统进程是可见的，因为Java的文件加锁直接映射到了本地操作系统的加锁工具。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileLocking</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        FileOutputStream fos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"file.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        FileLock fl <span class="token operator">=</span> fos<span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Locked File"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            fl<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Released Lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        fos<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>通过对<code>FileChannel</code>调用<code>tryLock()</code>或<code>lock</code>，就可以获得整个文件的<code>FileLock</code>。<code>tryLock()</code>是非阻塞式的，会尝试一次获得锁，如果失败则直接返回。<code>lock()</code>是阻塞式的，会阻塞进程直到获得锁，或调用<code>lock()</code>的线程中断，或调用<code>lock()</code>的通道关闭。Java虚拟机会自动释放锁或者关闭加锁的通道，也可以显式使用<code>FileLock#release()</code>释放锁。</li><li>可以对文件的一部分上锁，使用重载的<code>tryLock(long position, long size, boolean shared)</code>或<code>lock(long position, long size, boolean shared)</code>，其中加锁区域由<code>size - position</code>决定，第三个参数指明是否为共享锁。</li><li>对独占所或者共享锁的支持必须由底层的操作系统提供，如果操作系统不支持共享锁并为每一个请求都创建一个锁，那么就会使用独占锁。</li><li><code>SocketChannel</code>、<code>DatagramChannel</code>、<code>ServerSocketChannel</code>不需要加锁，因为这些通道是从单进程实体继承而来，通常不在两个进程之间共享网络socket。</li><li>对于映射文件，同样可以进行部分加锁，以便其它进程可以修改文件中未被加锁的部分，例如数据库。其方法和上述过程相同。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x0d</title>
      <link href="/2019/07/12/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0d/"/>
      <url>/2019/07/12/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0d/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-I-O-系统（三）"><a href="#Java-I-O-系统（三）" class="headerlink" title="Java I/O 系统（三）"></a>Java I/O 系统（三）</h1><h2 id="标准I-O"><a href="#标准I-O" class="headerlink" title="标准I/O"></a>标准I/O</h2><ul><li>标准I/O是Unix中的概念，指程序所使用的单一信息流。程序的所有输入都可以来自标准输入，所有输出也都可以发送到标准输出，以及所有的错误信息都可以发送到标准错误。其意义在于，可以容易的吧程序传亮起来，一个程序的标准输出可以成为另一个程序的标准输入。</li></ul><h3 id="从标准输入中读取"><a href="#从标准输入中读取" class="headerlink" title="从标准输入中读取"></a>从标准输入中读取</h3><ul><li>Java提供了<code>System.in</code>、<code>System.out</code>和<code>System.err</code>。<code>System.out</code>和<code>System.err</code>已经事先被包装成了<code>PrintStream</code>对象，<code>System.in</code>是没有被包装过的<code>InputStream</code>。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        BufferedReader stdin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String s<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> stdin<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="标准I-O重定向"><a href="#标准I-O重定向" class="headerlink" title="标准I/O重定向"></a>标准I/O重定向</h3><ul><li>Java的<code>System</code>类提供一些简单的静态方法调用，以允许我们队标准输入、输出和错误I/O流进行重定向。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        PrintStream console <span class="token operator">=</span> System<span class="token punctuation">.</span>out<span class="token punctuation">;</span>        BufferedInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"Test.java"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        PrintStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"test.out"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span><span class="token function">setIn</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span><span class="token function">setOut</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span><span class="token function">setErr</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span><span class="token punctuation">;</span>        BufferedReader br <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String s<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span><span class="token function">setOut</span><span class="token punctuation">(</span>console<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码中将标准输入接在了文件上，而标准输出和标准错误重定向至另一个文件。此外，在开始部分保存了最初<code>System.out</code>的引用，在最后部分进行了还原。</li><li>I/O重定向操作的是字节流，而不是字符流，因此重定向时注意使用<code>InputStream</code>和<code>OutputStream</code>。</li></ul><h2 id="进程控制"><a href="#进程控制" class="headerlink" title="进程控制"></a>进程控制</h2><ul><li>可以使用Java执行控制台命令，并获取其标准输出、错误。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        OSExecute<span class="token punctuation">.</span><span class="token function">command</span><span class="token punctuation">(</span><span class="token string">"ping 114.114.114.114"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">OSExecute</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">command</span><span class="token punctuation">(</span>String command<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> err <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Process process <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProcessBuilder</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            BufferedReader results <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            String s<span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>                System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>            BufferedReader errors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">getErrorStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>                err <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>command<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"CMD /C"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                 <span class="token function">command</span><span class="token punctuation">(</span><span class="token string">"CMD /C"</span> <span class="token operator">+</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">else</span>                 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Error executing "</span> <span class="token operator">+</span> command<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x0c</title>
      <link href="/2019/07/11/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0c/"/>
      <url>/2019/07/11/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0c/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-I-O-系统（二）"><a href="#Java-I-O-系统（二）" class="headerlink" title="Java I/O 系统（二）"></a>Java I/O 系统（二）</h1><h2 id="I-O流典型的使用方式"><a href="#I-O流典型的使用方式" class="headerlink" title="I/O流典型的使用方式"></a>I/O流典型的使用方式</h2><h3 id="缓冲输入文件"><a href="#缓冲输入文件" class="headerlink" title="缓冲输入文件"></a>缓冲输入文件</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">BufferedInputFile</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> String <span class="token function">read</span><span class="token punctuation">(</span>String filename<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        BufferedReader in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String s<span class="token punctuation">;</span>        StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>s <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>如果想要打开一个文件用于字符输入，可以使用以<code>String</code>或<code>File</code>对象作为文件名的<code>FileInputReader</code>。为了提高速度，需要对文件进行缓冲，可以将所产生的引用传给一个<code>BufferedReader</code>构造器。<code>BufferedReader</code>也提供<code>readLine()</code>方法，可以进行内容读取。当<code>readLine()</code>返回<code>null</code>时即达到文件末尾。最后调用<code>close()</code>关闭文件。</li></ul><h3 id="从内存输入"><a href="#从内存输入" class="headerlink" title="从内存输入"></a>从内存输入</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        StringReader in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringReader</span><span class="token punctuation">(</span><span class="token string">"aaa bbb ccc ddd\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> c<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>使用<code>StringReader</code>读取内存中的<code>String</code>，<code>read()</code>每次会读取一个字节（是<code>int</code>形式，注意使用类型转换）。</li></ul><h3 id="格式化的内存输入"><a href="#格式化的内存输入" class="headerlink" title="格式化的内存输入"></a>格式化的内存输入</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        DataInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"Main.java"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>in<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">/* 一次读多个字节        byte[] b = new byte[10];        while (in.available() != 0) {            in.read(b);            System.out.println(Arrays.toString(b));        }        */</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>读取格式化的数据，需要使用<code>DataInputStream</code>，这是一个面向字节的I/O类。因为任何字节的值都是合法结果，所以需要<code>available()</code>方法检查还有多少可供存取的字符。</li></ul><h3 id="基本的文件输出"><a href="#基本的文件输出" class="headerlink" title="基本的文件输出"></a>基本的文件输出</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        BufferedReader in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileReader</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        PrintWriter out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrintWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileWriter</span><span class="token punctuation">(</span><span class="token string">"b.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> lineCount <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        String s<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">=</span> in<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>            out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>lineCount<span class="token operator">++</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>        in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li><code>FileWriter</code>对象可以向文件写入数据。首先，创建一个与指定文件连接的<code>FileWriter</code>。此外，通常会用<code>BufferedWriter</code>将其包装来缓冲输出，因为缓冲往往能够显著地提高I/O性能。为了提供格式化机制，使用了<code>PrintWriter</code>装饰。最后，应该显式调用<code>Writer#close()</code>，否则缓冲区内容不会刷新清空，内容也不会写入文件。</li><li>在Java SE5中，<code>PrintWriter</code>添加了一个辅助构造器，可以省略其它装饰器，直接填入文件名<code>String</code>即可。</li></ul><h3 id="存储和恢复数据"><a href="#存储和恢复数据" class="headerlink" title="存储和恢复数据"></a>存储和恢复数据</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>        DataOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeDouble</span><span class="token punctuation">(</span><span class="token number">3.14159</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span><span class="token string">"That was pi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeDouble</span><span class="token punctuation">(</span><span class="token number">1.41413</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">writeUTF</span><span class="token punctuation">(</span><span class="token string">"Square root of 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        DataInputStream in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span><span class="token string">"a.txt"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readDouble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">readUTF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>可以用<code>DataOutputStream</code>、<code>DataInputStream</code>以与机器无关方式从底层流中读写基本 Java 数据类型。</li><li>当使用<code>DataOutputStream</code>写字符串并让<code>DataInputStream</code>能够恢复它的唯一可靠做法就是使用UTF-8编码，在上面代码中就是使用<code>writeUTF()</code>和<code>readUTF()</code>。</li><li>ASCII字符只占7位，为了避免空间浪费，UTF-8将ASCII字符编码成单一字节形式，而非ASCII字符则编码成两到三个字节的形式。另外，字符串的长度存储在UTF-8字符串的前两个字节。<code>writeUTF()</code>和<code>readUTF()</code>使用的是UTF-8变体。</li><li>为了保证所有的读方法能够正常工作，必须知道流中数据项所在的确切位置，要么为文件中的数据采用固定的割舍，标准要么将额外的信息保存在文件中以便能够对其解析来确定数据的存放位置。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x0b</title>
      <link href="/2019/07/09/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0b/"/>
      <url>/2019/07/09/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0b/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-I-O-系统（一）"><a href="#Java-I-O-系统（一）" class="headerlink" title="Java I/O 系统（一）"></a>Java I/O 系统（一）</h1><h2 id="File"><a href="#File" class="headerlink" title="File"></a>File</h2><ul><li><p><code>File</code>类既代表一个特定文件的名称，又能代表一个目录下的一组文件的名称。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        File path <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String<span class="token punctuation">[</span><span class="token punctuation">]</span> list<span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>            list <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">else</span>             list <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DirFilter</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Arrays<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> String<span class="token punctuation">.</span>CASE_INSENSITIVE_ORDER<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span>String dirItem<span class="token operator">:</span> list<span class="token punctuation">)</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>dirItem<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">DirFilter</span> <span class="token keyword">implements</span> <span class="token class-name">FilenameFilter</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> Pattern pattern<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">DirFilter</span><span class="token punctuation">(</span>String regex<span class="token punctuation">)</span> <span class="token punctuation">{</span>        pattern <span class="token operator">=</span> Pattern<span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span>regex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">accept</span><span class="token punctuation">(</span>File dir<span class="token punctuation">,</span> String name<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码中，<code>File#list()</code>可以接受一个<code>FilenameFilter</code>对象，用于过滤文件。此处使用了回调，重载了<code>accept()</code>方法并让<code>list()</code>调用。</li></ul><h2 id="输入和输出"><a href="#输入和输出" class="headerlink" title="输入和输出"></a>输入和输出</h2><h3 id="InputStream类型"><a href="#InputStream类型" class="headerlink" title="InputStream类型"></a>InputStream类型</h3><ul><li><code>InputStream</code>的作用是用来表示那些从不同数据源产生的输入的类，包括：字节数组、<code>String</code>对象、文件、管道、由其他种类的流组成的序列等，每一种数据源都有相应的<code>InputStream</code>子类。</li></ul></li></ul><table><thead><tr><th>类</th><th>功能</th><th>构造器参数</th><th>如何使用</th></tr></thead><tbody><tr><td><code>ByteArrayInputStream</code></td><td>允许将内存的缓冲区当做<code>InputStream</code>使用</td><td>缓冲区，字节将从中取出</td><td>作为一种数据源：将其与<code>FilterInputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>StringBufferInputStream</code></td><td>将<code>String</code>转换成<code>InputStream</code>使用</td><td>字符串，底层是实现使用<code>StringBuffer</code></td><td>作为一种数据源：将其与<code>FilterInputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>FileInputStream</code></td><td>用于从文件中读取信息</td><td>字符串，表示文件名、文件或<code>FileDescriptor</code>对象</td><td>作为一种数据源：将其与<code>FilterInputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>PipedInputStream</code></td><td>产生用于写入相关<code>PipedOutputStream</code>的数据，实现管道化的概念</td><td><code>PipedOutputStream</code></td><td>作为一种数据源：将其与<code>FilterInputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>SequenceInputStream</code></td><td>将两个或多个<code>InputStream</code>对象转换成单一<code>InputStream</code></td><td>两个<code>InputSteam</code>对象或者一个容纳<code>InputStream</code>对象的容器<code>Enumeration</code></td><td>作为多线程中数据源：将其与<code>FilterInputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>FilterInputStream</code></td><td>抽象类，作为装饰器的接口。其中，装饰器为其它的<code>InputStream</code>类提供有用的功能</td><td>-</td><td>-</td></tr></tbody></table><h3 id="OutputStream类型"><a href="#OutputStream类型" class="headerlink" title="OutputStream类型"></a>OutputStream类型</h3><ul><li><code>OutputStream</code>类的类别决定了输出所要去往的目标：字节数组、文件或管道。</li></ul><table><thead><tr><th>类</th><th>功能</th><th>构造器参数</th><th>如何使用</th></tr></thead><tbody><tr><td><code>ByteArrayOutputStream</code></td><td>在内存中创建缓冲区，所有送往流的数据都要放置在此缓冲区。</td><td>缓冲区初始化尺寸（可选）</td><td>用于指定数据的目的地：将其与<code>FilterOutputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>FileOutputStream</code></td><td>用于将信息写至文件</td><td>字符串，表示文件名、文件或<code>FileDescriptor</code>对象</td><td>用于指定数据的目的地：将其与<code>FilterOutputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>PipedOutputStream</code></td><td>任何写入其中的信息都会自动作为相关<code>PipedInputStream</code>的输出。实现管道化的概念</td><td><code>PipedInputStream</code></td><td>用于指定多线程的数据的目的地：将其与<code>FilterOutputStream</code>对象相连以提供有用接口</td></tr><tr><td><code>FilterOutputStream</code></td><td>抽象类，作为装饰器的皆苦。其中，装饰器为其它<code>OutputStream</code>提供有用功能</td><td>-</td><td>-</td></tr></tbody></table><h2 id="添加属性和有用的接口"><a href="#添加属性和有用的接口" class="headerlink" title="添加属性和有用的接口"></a>添加属性和有用的接口</h2><h3 id="FilterInputStream"><a href="#FilterInputStream" class="headerlink" title="FilterInputStream"></a>FilterInputStream</h3><table><thead><tr><th>类</th><th>功能</th><th>构造器参数</th><th>如何使用</th></tr></thead><tbody><tr><td><code>DataInputStream</code></td><td>与<code>DataOutputStream</code>搭配使用，可以按照可移植方式从流读取基本数据类型（<code>int</code>、<code>char</code>、<code>long</code>等）</td><td><code>InputStream</code></td><td>包含用于读取基本类型数据的全部接口</td></tr><tr><td><code>BufferedInputStream</code></td><td>可以防止每次读取时都得进行实际写操作，代表使用缓冲区。</td><td><code>InputStream</code>，可选指定缓冲区大小</td><td>本质上不提供接口，只不过是向进程中添加缓冲区所必须的</td></tr><tr><td><code>LineNumberInputStream</code></td><td>跟踪输入流中的行号，可调用<code>getLineNumber()</code>和<code>setLineNumber(int)</code></td><td><code>InputStream</code></td><td>仅增加了行号，因此可能要与接口对象搭配使用</td></tr><tr><td><code>PushbackInputStream</code></td><td>能弹出一个字节的缓冲区，因此可以将读到的最后一个字符回退。</td><td><code>InputStream</code></td><td>通常作为编译器的扫描器</td></tr></tbody></table><h3 id="FilterOutputStream"><a href="#FilterOutputStream" class="headerlink" title="FilterOutputStream"></a>FilterOutputStream</h3><table><thead><tr><th>类</th><th>功能</th><th>构造器参数</th><th>如何使用</th></tr></thead><tbody><tr><td><code>DataOutputStream</code></td><td>与<code>DataInputStream</code>搭配使用，可以按照可移植方式从流读取基本数据类型（<code>int</code>、<code>char</code>、<code>long</code>等）</td><td><code>OutputStream</code></td><td>包含用于写入基本类型数据的全部接口</td></tr><tr><td><code>PrintStream</code></td><td>用于产生格式化输出。其中<code>DataOutputStream</code>处理数据的存储，<code>PrintStream</code>处理显示</td><td><code>OutputStream</code>，可选是否每次换行时清空缓冲区</td><td>-</td></tr><tr><td><code>BufferedOutputStream</code></td><td>可以防止每次读取时都得进行实际写操作，代表使用缓冲区。</td><td><code>OutputStream</code>，可选指定缓冲区大小</td><td>本质上不提供接口，只不过是向进程中添加缓冲区所必须的</td></tr></tbody></table><h2 id="Reader和Writer"><a href="#Reader和Writer" class="headerlink" title="Reader和Writer"></a>Reader和Writer</h2><ul><li><code>InputStream</code>和<code>OutputStream</code>是面向字节形式的I/O，而<code>Reader</code>和<code>Writer</code>则提供兼容Unicode与面向字符的I/O功能。</li></ul><h3 id="数据的来源与去处"><a href="#数据的来源与去处" class="headerlink" title="数据的来源与去处"></a>数据的来源与去处</h3><table><thead><tr><th><code>InputStream</code>和<code>OutputStream</code></th><th><code>Reader</code>和<code>Writer</code></th></tr></thead><tbody><tr><td><code>InputStream</code></td><td><code>Reader</code>，适配器<code>InputStreamReader</code></td></tr><tr><td><code>OutputStream</code></td><td><code>Writer</code>， 适配器<code>OutputStreamWriter</code></td></tr><tr><td><code>FileInputStream</code></td><td><code>FileReader</code></td></tr><tr><td><code>FileOutputStream</code></td><td><code>FileWriter</code></td></tr><tr><td>-</td><td><code>StringReader</code></td></tr><tr><td>-</td><td><code>StringWriter</code></td></tr><tr><td><code>ByteArrayInputStream</code></td><td><code>CharArrayReader</code></td></tr><tr><td><code>ByteArrayOutputStream</code></td><td><code>CharArrayWriter</code></td></tr><tr><td><code>PipedInputStream</code></td><td><code>PipedReader</code></td></tr><tr><td><code>PipedOutputStream</code></td><td><code>PipedWriter</code></td></tr></tbody></table><h3 id="更改流的行为"><a href="#更改流的行为" class="headerlink" title="更改流的行为"></a>更改流的行为</h3><table><thead><tr><th><code>FilterInputStream</code>和<code>FilterOutputStream</code></th><th><code>FilterReader</code>和<code>FilterWriter</code></th></tr></thead><tbody><tr><td><code>FilterInputStream</code></td><td><code>FilterReader</code></td></tr><tr><td><code>FilterOutputStream</code></td><td><code>FilterWriter</code></td></tr><tr><td><code>BufferedInputStream</code></td><td><code>BufferedReader</code></td></tr><tr><td><code>BufferedOutputStream</code></td><td><code>BufferedWriter</code></td></tr><tr><td><code>PrintStream</code></td><td><code>PrintWriter</code></td></tr></tbody></table><ul><li>如果需要使用<code>readLine()</code>方法，就不应该使用<code>DataInputStream</code>，而用<code>BufferedReader</code>代替。</li></ul><blockquote><p><code>DataInputStream#readLine()</code>方法已被废弃，因为它无法正确地将字节转换为字符。</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DNS与BIND笔记0x00</title>
      <link href="/2019/07/08/DNS%E4%B8%8EBIND%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2019/07/08/DNS%E4%B8%8EBIND%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="DNS的运行机制"><a href="#DNS的运行机制" class="headerlink" title="DNS的运行机制"></a>DNS的运行机制</h1><h2 id="域命名空间"><a href="#域命名空间" class="headerlink" title="域命名空间"></a>域命名空间</h2><ul><li>DNS的本质是分布式数据库，通过域名来进行索引。每个域名本质上是一颗大型逆向树的一条路径，这棵逆向树就是域命名空间。</li></ul><h3 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h3><ul><li>如果根节点（以”.”和一个空标签结束）出现在一个域名的结尾时，称之为完全限定域名（fully qualified domain name, FQDN），它能准确地标识出一个节点在层次结构中的位置。</li></ul><h3 id="域"><a href="#域" class="headerlink" title="域"></a>域</h3><ul><li>一个域就是域命名空间的一颗子树。</li></ul><h3 id="资源记录"><a href="#资源记录" class="headerlink" title="资源记录"></a>资源记录</h3><ul><li>与域名相关的数据都被包含在资源记录（resource record, RR）中。记录按照所关联的网络或软件的类型被分成不同的类。</li></ul><h2 id="名称服务器和区域"><a href="#名称服务器和区域" class="headerlink" title="名称服务器和区域"></a>名称服务器和区域</h2><ul><li>存储域命名空间信息的程序称作名称服务器（nameserver）。名称服务器通常只拥有域命名空间某一部分的完整信息，这一部分称作区域（zone）。加载区域后，名称服务器可宣称对此区域具有权威（authority）。</li><li>区域和域的区别：所有的顶级域以及许多二级域和更低级别的域通过授权被划分成了更小更好管理的单元，这些单元就是区域。</li></ul><h3 id="名称服务器的类型"><a href="#名称服务器的类型" class="headerlink" title="名称服务器的类型"></a>名称服务器的类型</h3><ul><li>primary master：其区域数据来源于主机上的文件</li><li>slave(secondary master)：其区域数据来源于primary master或者另外一台slave。</li></ul><h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><h3 id="解析器"><a href="#解析器" class="headerlink" title="解析器"></a>解析器</h3><ul><li>解析器是访问名称服务器，从域命名空间获取信息的客户端程序。</li></ul><h3 id="递归查询"><a href="#递归查询" class="headerlink" title="递归查询"></a>递归查询</h3><ul><li>当名称服务器接收到递归查询请求时，如果它能够回答，就直接返回查询结果。如果它不能回答，那么它递归检查自己是否知道域名的权威名称服务器，如果知道，就给该权威名称服务器发送查询请求，如果不知道，则再检索上一级域名的权威名称服务器，直到检索根域名，此时将直接向根服务器发起查询请求。</li></ul><h3 id="迭代查询"><a href="#迭代查询" class="headerlink" title="迭代查询"></a>迭代查询</h3><ul><li>在迭代查询请求中，收到请求的名称服务器只会返回它认为的“最佳答案”，即返回解析结果或者它所知道的和域名最相近的权威名称服务器。</li></ul><h3 id="往返时间"><a href="#往返时间" class="headerlink" title="往返时间"></a>往返时间</h3><ul><li>往返时间（roundtrip time，RTT）是同一区域的不同名称服务器的选择依据。</li></ul><h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><ul><li>名称服务器在处理递归查询时，会遇到许多与域命名空间有关的信息，它会记录下每次遇到的名称服务器、地址和对应的区域。这样既能加快处理查询请求的速度，也能减少向根服务器查询的次数。</li></ul><h3 id="生存时间"><a href="#生存时间" class="headerlink" title="生存时间"></a>生存时间</h3><ul><li>生存时间（time to live，TTL）是名称服务器允许数据在缓存中存放的时间，如果到期，名称服务器就会丢弃过期数据，并从权威名称服务器获取新的数据。</li></ul>]]></content>
      
      
      <categories>
          
          <category> 网络 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 网络 </tag>
            
            <tag> 笔记 </tag>
            
            <tag> DNS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x0a</title>
      <link href="/2019/07/07/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0a/"/>
      <url>/2019/07/07/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x0a/</url>
      
        <content type="html"><![CDATA[<h1 id="容器深入研究"><a href="#容器深入研究" class="headerlink" title="容器深入研究"></a>容器深入研究</h1><h2 id="Collection的功能方法"><a href="#Collection的功能方法" class="headerlink" title="Collection的功能方法"></a>Collection的功能方法</h2><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>boolean add(T)</code></td><td>添加元素，如果类型不为<code>T</code>则返回<code>false</code>。可选</td></tr><tr><td><code>boolean addAll(Collection&lt;? extends T&gt;)</code></td><td>添加所有元素，只要添加了元素就返回<code>true</code>。可选</td></tr><tr><td><code>void clear()</code></td><td>移除所有元素。可选</td></tr><tr><td><code>boolean contains(T)</code></td><td>如果容器包含该元素，则返回<code>true</code></td></tr><tr><td><code>boolean containsAll(Collection&lt;?&gt;)</code></td><td>如果容器中包含所有元素，则返回<code>true</code></td></tr><tr><td><code>boolean isEmpty()</code></td><td>容器中没有元素返回<code>true</code></td></tr><tr><td><code>Iterator&lt;T&gt; iterator()</code></td><td>返回一个可以遍历容器所有元素的<code>Iterator&lt;T&gt;</code></td></tr><tr><td><code>boolean remove(Object)</code></td><td>如果元素在容器中，则移除一个该元素的实例。如果发生了移除则返回<code>true</code>。可选</td></tr><tr><td><code>boolean removeAll(Collection&lt;?&gt;)</code></td><td>移除参数中所有的元素，如果发生了移除就返回<code>true</code>。可选</td></tr><tr><td><code>boolean retainAll(Collection&lt;?&gt;)</code></td><td>只保存参数中的元素，只要<code>Collection</code>发生了改变就返回<code>true</code></td></tr><tr><td><code>int size()</code></td><td>返回容器中元素的数目</td></tr><tr><td><code>Object[] toArray()</code></td><td>返回包含容器中所有元素的数组</td></tr><tr><td><code>&lt;T&gt; T[] toArray(T[] a)</code></td><td>返回包含容器中所有元素的数组，数组类型与参数类型一致</td></tr></tbody></table><h2 id="可选操作"><a href="#可选操作" class="headerlink" title="可选操作"></a>可选操作</h2><ul><li><p>在<code>Collection</code>方法中，一些方法是可选的，这意味着继承<code>Collection</code>时这些方法可以不进行覆盖。此时导出类对象调用该方法时会出现<code>UnsupportedOperationException</code>。<code>Collection</code>的可选方法实现如下:</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span>E e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>可见，如果导出类不实现可选方法，那么该方法会调用<code>Collection</code>中的实现，即抛出一个<code>UnsupportedOperationException</code>异常。</p></li></ul><h2 id="Set与存储顺序"><a href="#Set与存储顺序" class="headerlink" title="Set与存储顺序"></a>Set与存储顺序</h2><h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><ul><li>存入<code>Set</code>的每个元素都必须是唯一的，因为<code>Set</code>不保存重复元素。加入<code>Set</code>的元素必须定义<code>equals()</code>方法一确保对象的唯一性。<code>Set</code>和<code>Collection</code>有完全一样的接口。<code>Set</code>不保证维护元素的次序。</li></ul><h3 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h3><ul><li>为快速查找而设计的<code>Set</code>，存入<code>HashSet</code>的元素必须定义<code>hashCode()</code>。<code>HashSet</code>存储元素的顺序是按照底层哈希桶号从小到大排序，如果桶号相同就按照放入桶的先后顺序。</li></ul><h3 id="TreeSet"><a href="#TreeSet" class="headerlink" title="TreeSet"></a>TreeSet</h3><ul><li>保持次序的<code>Set</code>，底层为树结构。使用它可以从<code>Set</code>中提取有序的序列。元素必须实现<code>Comparable</code>接口</li></ul><h3 id="LinkedHashSet"><a href="#LinkedHashSet" class="headerlink" title="LinkedHashSet"></a>LinkedHashSet</h3><ul><li>具有<code>HashSet</code>的查询速度，且内部使用链表维护元素的顺序（插入的顺序）。</li></ul><h3 id="SortedSet"><a href="#SortedSet" class="headerlink" title="SortedSet"></a>SortedSet</h3><ul><li>可以保证其中的元素处于排序状态，并提供一些附加功能</li></ul><h2 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h2><h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><ul><li>队列的基本实现。</li></ul><h3 id="优先级队列"><a href="#优先级队列" class="headerlink" title="优先级队列"></a>优先级队列</h3><ul><li><code>PriorityQueue</code>：按照元素从小到大排列。</li></ul><h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><h3 id="Map的各种实现"><a href="#Map的各种实现" class="headerlink" title="Map的各种实现"></a>Map的各种实现</h3><ul><li><code>HashMap</code>：<code>Map</code>基于散列表的实现。插入和查询键值对的开销是固定的，可以通过构造器设置容量和负载因子，以调整容器性能</li></ul><blockquote><p>负载因子：如果容器持有元素超过一定比例会进行扩容，此时作为底层实现的旧数组会被更大容量的新数组取代。这个比例就是负载因子。</p></blockquote><ul><li><code>LinkedHashMap</code>：类似于<code>HashMap</code>，但是迭代遍历时，取得键值对的顺序是插入顺序，或者是最近最少使用（LRU）次序。仅比<code>HashMap</code>慢一点，而在迭代访问时反而更快，因为其使用链表维护内部次序。</li><li><code>TreeMap</code>：基于红黑树的实现。查看键或者键值对时，它们会被排序。<code>TreeMap</code>的特点在于，所得到的结果是经过排序的（按元素大小排序）。<code>TreeMap</code>是唯一带有<code>subMap()</code>方法的<code>Map</code>，它可以返回一棵子树。</li><li><code>WeakHashMap</code>：弱键映射，允许释放映射所指向的对象，这是为解决某类特殊问题而设计的。如果映射之外没有引用指向某个键，则此键可以被垃圾回收。</li><li><code>ConcurrentHashMap</code>：一种线程安全的<code>Map</code>，它不涉及同步加锁。</li><li><code>IdentityHashMap</code>：使用<code>==</code>代替<code>equals()</code>对键进行比较的散列映射，专为解决特殊问题而设计的。</li></ul><h3 id="散列"><a href="#散列" class="headerlink" title="散列"></a>散列</h3><ul><li><code>HashMap</code>使用了散列码作为键的搜索。在Java中，<code>hashCode()</code>是根类<code>Object</code>的方法，因此所有Java对象都能产生散列码。使用<code>hashCode()</code>进行查询能够显著地提高性能。</li><li>默认的<code>Object#equals()</code>只是比较对象地址，如果需要某个自定义的类作为键使用，需要重载<code>hashCode()</code>和<code>equals()</code>。</li></ul><h2 id="容器的选择"><a href="#容器的选择" class="headerlink" title="容器的选择"></a>容器的选择</h2><h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><ul><li><code>ArrayList</code>应该作为默认选择，只有当程序的性能因为经常从表中间进行插入和删除而变差的时候，才去选择<code>LinkedList</code>。如果使用的是固定数量的元素，也可以直接使用数组。</li></ul><h3 id="Set-1"><a href="#Set-1" class="headerlink" title="Set"></a>Set</h3><ul><li><code>HashSet</code>的性能基本上总是比<code>TreeSet</code>好，特别是在添加和查询元素时。当需要对元素进行排序，或者需要对元素进行迭代时才会需要<code>TreeSet</code>。</li></ul><h3 id="Map-1"><a href="#Map-1" class="headerlink" title="Map"></a>Map</h3><ul><li>类似于<code>Set</code>的结果，<code>TreeMap</code>比<code>HashMap</code>要慢。</li></ul><h2 id="实用方法"><a href="#实用方法" class="headerlink" title="实用方法"></a>实用方法</h2><table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>max(Collection)</code>, <code>min(Collection)</code></td><td>返回参数<code>Collection</code>中最大或者最小的元素，采用<code>Collection</code>中内置的自然比较法</td></tr><tr><td><code>max(Collection, Comparator)</code>, <code>min(Collection, Comparator)</code></td><td>返回参数<code>Collection</code>中最大或最小的元素，采用参数中的<code>Comparator</code>进行比较</td></tr><tr><td><code>indexOfSubList(List source, List target)</code></td><td>返回<code>target</code>在<code>source</code>中第一次出现的位置，或者在找不到时返回<code>-1</code></td></tr><tr><td><code>lastIndexOfSubList(List source, List target)</code></td><td>返回<code>target</code>在<code>source</code>中最后一次出现的位置，或者在找不到时返回<code>-1</code></td></tr><tr><td><code>replaceAll(List&lt;T&gt;, T oldVal, T newVal)</code></td><td>使用<code>newVal</code>替换所有<code>oldVal</code></td></tr><tr><td><code>reverse(List)</code></td><td>逆转所有元素的次序</td></tr><tr><td><code>reverseOrder()</code>, <code>reverseOrder(Comparator&lt;T&gt;)</code></td><td>返回一个<code>Comparator</code>，它可以以逆转实现了<code>Comparator&lt;T&gt;</code>的对象集合的自然顺序。第二个版本可以逆转所提供的<code>Comparator</code>的顺序</td></tr><tr><td><code>rotate(List, int distance)</code></td><td>所有元素向后移动<code>distance</code>个位置，将末尾的元素循环到前面来</td></tr><tr><td><code>shuffle(List)</code>, <code>shuffle(List, Random)</code></td><td>随机改变指定列表顺序。第一种形式提供其自己的随机机制，第二种则来源于参数<code>Random</code>对象</td></tr><tr><td><code>sort(List&lt;T&gt;)</code>, <code>sort(List&lt;T&gt;, Comparator&lt;? super T&gt; c)</code></td><td>使用<code>List&lt;T&gt;</code>中的自然顺序排序。第二种形式允许提供用于排序的<code>Comparator</code></td></tr><tr><td><code>copy(List&lt;? super T&gt; dest, List&lt;? extends T&gt; src)</code></td><td>将<code>src</code>中的元素复制到<code>dest</code></td></tr><tr><td><code>swap(List, int i, int j)</code></td><td>交换<code>list</code>中位置<code>i</code>与位置<code>j</code>的元素，通常比手动实现要快</td></tr><tr><td><code>fill(LIst&lt;? super T&gt;, T x)</code></td><td>用对象<code>x</code>替换<code>list</code>中的所有元素</td></tr><tr><td><code>disjoint(Collection, Collection)</code></td><td>当两个集合没有重复元素时返回<code>true</code></td></tr><tr><td><code>frequency(Collection, Object x)</code></td><td>返回<code>Collection</code>中<code>x</code>出现的次数</td></tr><tr><td><code>emptyList()</code>, <code>emptyMap()</code>, <code>emptySet()</code></td><td>返回不可变且为泛型的<code>List</code>、<code>Map</code>、<code>Set</code></td></tr><tr><td><code>singleton(T x)</code>, <code>singletonList(T x)</code>, <code>singletonMap(K key, V value)</code></td><td>产生不可变的<code>Set&lt;T&gt;</code>、<code>List&lt;T&gt;</code>、<code>Map&lt;K, V&gt;</code>。</td></tr></tbody></table><ul><li>在比较字符串而使用<code>max()</code>、<code>min()</code>、<code>sort()</code>等方法时，使用参数<code>String.CASE_INSENSITIVE_ORDER</code>可以忽略大小写。</li></ul><h3 id="同步控制"><a href="#同步控制" class="headerlink" title="同步控制"></a>同步控制</h3><ul><li><code>Collections.synchonizedCollection()</code>可以传入一个新生成的容器，返回的是有同步功能的版本。类似的还有<code>Collections.synchonizedList()</code>、<code>Collections.synchonizedSet()</code>、<code>Collections.synchonizedMap()</code>等。</li><li>快速报错：Java容器的一种保护机制，能够防止多个进程同时修改同一个容器的内容。它会探查容器上的任何除了当前进程进行的操作以外的所有变化，一旦发现其它进行修改了容器，就立刻抛出<code>ConcurrentModificationException</code>异常。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x09</title>
      <link href="/2019/07/07/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x09/"/>
      <url>/2019/07/07/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x09/</url>
      
        <content type="html"><![CDATA[<h1 id="泛型（四）"><a href="#泛型（四）" class="headerlink" title="泛型（四）"></a>泛型（四）</h1><h2 id="动态类型安全"><a href="#动态类型安全" class="headerlink" title="动态类型安全"></a>动态类型安全</h2><ul><li><p>因为可以向旧版本的Java代码中传递容器，而如果旧版本的代码没有使用泛型则需要动态类型检查。<code>java.uitl.Collections</code>中有一系列方法可以完成这项工作：<code>checkedCollection()</code>、<code>checkedList()</code>、<code>checkedMap()</code>、<code>checkedSet()</code>、<code>checkedSortedMap()</code>、<code>checkedSortedSet()</code>。其参数为希望获得检查的容器和强制要求的类型。受检查的容器在插入不正确的类型时会抛出<code>ClassCastException</code>。例如：</p><p><code>List&lt;Cat&gt; cats = Collections.checkedList(new ArrayList&lt;&gt;(), Cat.class);</code></p><p>此时插入<code>Cat</code>对象是正确的，而插入<code>Dog</code>对象则会出现异常。</p></li></ul><h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><ul><li>由于擦除的原因，将泛型应用于异常是非常受限的。<code>catch</code>语句不能捕获泛型类型异常，因为在编译期和运行时都必须知道异常的确切类型。泛型类也不能直接或间接继承<code>Throwable</code>。</li><li>在方法的<code>throw</code>子句可以使用类型参数，使得随检查异常的类型发生变化而变化的代码</li></ul><h2 id="混型"><a href="#混型" class="headerlink" title="混型"></a>混型</h2><ul><li>混型是指回合多个类的能力，以产生一个可以表示混型中所有类型的类。</li><li>混型的价值之一是可以将特性和行为一致地应用于多个类型，如果在混型类中修改，那么这些修改将会应用于混型所应用的所有类型之上。混型有一点面向切面编程的意思。</li></ul><h3 id="与接口混合"><a href="#与接口混合" class="headerlink" title="与接口混合"></a>与接口混合</h3><ul><li>一种常见的混型方法就是使用接口产生混型效果，即使用代理，每个混入类型都有一个相应的域，调用方法时要转发给对应的域。</li></ul><h3 id="使用装饰器模式"><a href="#使用装饰器模式" class="headerlink" title="使用装饰器模式"></a>使用装饰器模式</h3><ul><li>装饰器是通过使用组合和形式化结构（可装饰物/装饰器层器结构）类实现的，而混型是基于继承的。因此可以将基于参数化类型的混型当做一种泛型装饰器机制，这种机制不需要装饰器设计模式的继承结构。（<em>即声明一个混型，其泛型类型参数为混型基于的所有类型，以达到混型的目的</em>）</li></ul><h3 id="与动态代理混合"><a href="#与动态代理混合" class="headerlink" title="与动态代理混合"></a>与动态代理混合</h3><ul><li>可以使用动态代理实现更为接近混合模型的机制。通过使用动态代理，所产生的类的动态类型将会是已经混入的组合类型。</li><li>由于动态代理的限制，每个被混入的类都必须是某个接口的实现。</li><li>在调用混入类型的方法之前，需对混型对象进行向下转型到合适的类型。</li></ul><h2 id="潜在类型机制"><a href="#潜在类型机制" class="headerlink" title="潜在类型机制"></a>潜在类型机制</h2><ul><li>潜在类型机制，又称鸭子类型机制，具有这种机制的语言只要求实现某个方法的自己，而不是某个特定类型或者接口，从而放松了限制。潜在类型机制可以横跨类型继承结构，调用某个不是公共接口的方法。</li><li>在Java中是没有原生实现的潜在类型机制，会被强制要求继承某个类或者实现某个接口。</li></ul><h2 id="对缺乏潜在类型机制的补救"><a href="#对缺乏潜在类型机制的补救" class="headerlink" title="对缺乏潜在类型机制的补救"></a>对缺乏潜在类型机制的补救</h2><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">CommunicateReflectively</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">perform</span><span class="token punctuation">(</span>Object speaker<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> spkr <span class="token operator">=</span> speaker<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            Method speak <span class="token operator">=</span> spkr<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token string">"speak"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            speak<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>speaker<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>NoSuchMethodException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>speaker <span class="token operator">+</span> <span class="token string">"cannot speak"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上面的代码使用了反射获取了指定名称的方法，但是类型检查转移到了运行时。</p><h3 id="将一个方法应用于序列"><a href="#将一个方法应用于序列" class="headerlink" title="将一个方法应用于序列"></a>将一个方法应用于序列</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Apply</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token punctuation">,</span> S <span class="token keyword">extends</span> <span class="token class-name">Iterable</span><span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token operator">>></span>         <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>S seq<span class="token punctuation">,</span> Method f<span class="token punctuation">,</span> Object<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span>T t<span class="token operator">:</span> seq<span class="token punctuation">)</span> <span class="token punctuation">{</span>                f<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><ul><li>上面代码的目的是实现对任意的序列<code>S&lt;T&gt;</code>调用某种方法，然而恰好序列都是实现了<code>Iterable</code>接口的。但是这种方法并不适用于没有实现内建接口或者继承内建类的类型。</li></ul><h3 id="用适配器模式仿真潜在类型机制"><a href="#用适配器模式仿真潜在类型机制" class="headerlink" title="用适配器模式仿真潜在类型机制"></a>用适配器模式仿真潜在类型机制</h3><ul><li>可以使用适配器模式来适配已有的接口，来产生需要的接口。</li></ul><h1 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h1><h2 id="数组的特点"><a href="#数组的特点" class="headerlink" title="数组的特点"></a>数组的特点</h2><ul><li>效率：数组是一种效率最高的存储和随机访问对象引用序列的方式，代价是数组对象的大小被固定，并且在其生命周期中不能改变。</li><li>类型：相比缺少泛型的容器，数组可以持有某种类型的对象，可以通过编译期检查来防止不当的操作。</li><li>持有基本类型：数组可以持有基本类型，但是容器不能直接持有基本类型。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x08</title>
      <link href="/2019/07/05/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x08/"/>
      <url>/2019/07/05/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x08/</url>
      
        <content type="html"><![CDATA[<h1 id="泛型（三）"><a href="#泛型（三）" class="headerlink" title="泛型（三）"></a>泛型（三）</h1><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="任何基本类型都不能作为类型参数"><a href="#任何基本类型都不能作为类型参数" class="headerlink" title="任何基本类型都不能作为类型参数"></a>任何基本类型都不能作为类型参数</h3><ul><li>Java泛型中不能使用基本类型用作类型参数，取而代之可以使用基本类型的包装器以及自动包装机制。</li></ul><h3 id="实现参数化接口"><a href="#实现参数化接口" class="headerlink" title="实现参数化接口"></a>实现参数化接口</h3><ul><li>一个类不能实现同一个泛型接口的两种变体，由于擦除的原因，这两个变体会成为相同的接口。</li></ul><h3 id="转型和警告"><a href="#转型和警告" class="headerlink" title="转型和警告"></a>转型和警告</h3><ul><li>使用带有泛型类型参数的转型或<code>instanceof</code>不会有任何效果。因为类型参数<code>T</code>会被擦除到第一个边界，默认为<code>Object</code>，使用转型或<code>instanceof</code>也只使用了<code>Object</code>。</li><li>在必须进行转型到某种泛型类时，需要使用泛型类对象转型，例如<code>List.class.cast(x)</code>，但是无法转换到具体类型，即不能使用<code>List&lt;RealClass&gt;.class.cast(x)</code>。</li></ul><h3 id="重载"><a href="#重载" class="headerlink" title="重载"></a>重载</h3><ul><li>由于擦除的原因，相同泛型类、不同类型参数的重载方法将产生相同的类型签名。</li></ul><h3 id="基类劫持接口"><a href="#基类劫持接口" class="headerlink" title="基类劫持接口"></a>基类劫持接口</h3><ul><li>当父类实现泛型接口时，实现了接口中的某个带有相应泛型参数的方法，此时子类将不能修改该方法的参数类型。</li></ul><h2 id="自限定的类型"><a href="#自限定的类型" class="headerlink" title="自限定的类型"></a>自限定的类型</h2><h3 id="古怪的循环泛型"><a href="#古怪的循环泛型" class="headerlink" title="古怪的循环泛型"></a>古怪的循环泛型</h3><ul><li>诸如<code>class Sub extends Basic&lt;Sub&gt;</code>的定义就是古怪的循环泛型，子类类型出现在了基类中。</li><li>其本质是基类用导出类替代其参数，意味着泛型基类变成了一种其所有导出类的公共功能的模板，但是这些功能对于其所有的参数和返回值，将使用导出类型。</li></ul><h3 id="自限定"><a href="#自限定" class="headerlink" title="自限定"></a>自限定</h3><ul><li>下面代码中<code>SelfBounded</code>即自限定的泛型基类。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SelfBounded</span><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">SelfBounded</span><span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token punctuation">{</span>    T element<span class="token punctuation">;</span>    SelfBounded<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">set</span><span class="token punctuation">(</span>T arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        element <span class="token operator">=</span> arg<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    T <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> element<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>继承<code>SelfBounded</code>必须类似与<code>class A extends SelfBounded&lt;A&gt;</code>来定义子类，这保证了类型参数必定与正在被定义的类相同。</p><p>同样的，自限定还可以用于泛型方法，防止该方法用于自限定参数之外的任何事物上：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SelfBoundingMethods</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">SelfBoundingMethods</span><span class="token operator">&lt;</span>T<span class="token operator">>></span> T <span class="token function">f</span> <span class="token punctuation">(</span>T arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> arg<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        A a <span class="token operator">=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="参数协变"><a href="#参数协变" class="headerlink" title="参数协变"></a>参数协变</h3><ul><li>自限定类型的意义在于能够产生协变参数类型，即方法参数类型会随着子类变化而变化，不会出现重载。</li></ul><p><em>但实际上如果仅为了实现参数协变，自限定并不是必要的，使用循环泛型就能解决，例如：</em></p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        A a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        B b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">SelfBounded</span><span class="token operator">&lt;</span>T <span class="token keyword">extends</span> <span class="token class-name">SelfBounded</span><span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token punctuation">{</span>    T element<span class="token punctuation">;</span>    SelfBounded<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">set</span><span class="token punctuation">(</span>T arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        element <span class="token operator">=</span> arg<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    T <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> element<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Cyclic</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T element<span class="token punctuation">;</span>    Cyclic<span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">set</span><span class="token punctuation">(</span>T arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>        element <span class="token operator">=</span> arg<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    T <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> element<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token keyword">extends</span> <span class="token class-name">SelfBounded</span><span class="token operator">&lt;</span>A<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token keyword">extends</span> <span class="token class-name">Cyclic</span><span class="token operator">&lt;</span>B<span class="token operator">></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">/* Output:A@2c13da15A@2c13da15A@2c13da15B@9e89d68B@9e89d68B@9e89d68*/</span></code></pre><p><em>上面代码中，<code>SelfBounded</code>是自限定的，而<code>Cyclic</code>仅是普通的泛型类，其子类<code>B</code>使用了循环泛型就实现了参数协变。两者唯一的不同仅在于自限定中类型参数必须是自限定的，而循环泛型并无此限制</em></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x07</title>
      <link href="/2019/07/04/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x07/"/>
      <url>/2019/07/04/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x07/</url>
      
        <content type="html"><![CDATA[<h1 id="泛型（二）"><a href="#泛型（二）" class="headerlink" title="泛型（二）"></a>泛型（二）</h1><h2 id="边界"><a href="#边界" class="headerlink" title="边界"></a>边界</h2><ul><li>泛型边界不但可以强制规定泛型可以应用的类型，还允许泛型按照其边界类型调用方法。</li></ul><h2 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h2><blockquote><p>逆变与协变用来描述类型转换后的继承关系，其定义为：如果A、B表示类型，f(⋅)表示类型转换，≤表示继承关系（比如，A≤B表示A是由B派生出来的子类）<br>f(⋅)是逆变（contravariant）的，当A≤B时有f(B)≤f(A)成立；<br>f(⋅)是协变（covariant）的，当A≤B时有f(A)≤f(B)成立；<br>f(⋅)是不变（invariant）的，当A≤B时上述两个式子均不成立，即f(A)与f(B)相互之间没有继承关系。</p></blockquote><ul><li>在Java中，数组是协变的</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token keyword">extends</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Jonathan</span> <span class="token keyword">extends</span> <span class="token class-name">Apple</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Orange</span> <span class="token keyword">extends</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Fruit<span class="token punctuation">[</span><span class="token punctuation">]</span> fruits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        fruits<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        fruits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jonathan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            fruits<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Runtime Error</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            fruits<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Orange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// Runtime Error</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上述代码可以通过编译，但是在运行时会报错。</p><p><em>由于早期Java不支持泛型，对数组的通用操作都是使用<code>Object[]</code>实现的，因此上述代码可以通过编译。但是为了避免因为声明类型和实际类型不一致而引发的问题，Java把类型检查放在了运行时</em></p><p>然而使用泛型时，由于擦除的存在，所有检查都必须在编译期完成，因此诸如<code>List&lt;Fruit&gt; flist = new ArrayList&lt;Apple&gt;;</code>的代码是无法通过编译的。与数组不同，泛型没有内建的协变类型。</p><p>但是这一限制可以使用通配符解除，例如<code>List&lt;? extends Fruit&gt; flist = new ArrayList&lt;Apple&gt;;</code>，这不意味着<code>flist</code>可以持有任意<code>Fruit</code>及其子类的对象，仍然需要指明其持有类型，并向上转型。</p><p>此时问题又出现了，向上转型后将无法传入任何类型对象给<code>flist</code>，因为编译器不知道<code>&lt;? extends Fruit&gt;</code>指向哪个类型（此时编译器会将其标记为某种未知类型），例如它可以指向<code>Orange</code>，那么向其中放入<code>Apple</code>、<code>Fruit</code>、<code>Object</code>对象都是非法的。不过此时从<code>flist</code>中取出<code>Apple</code>对象是允许的（前提是容器中有对象）。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Gen</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T t<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">Test</span><span class="token punctuation">(</span>T t<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// this.t = t;</span>        <span class="token function">setT</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    T <span class="token function">getT</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">void</span> <span class="token function">setT</span><span class="token punctuation">(</span>T t<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>t <span class="token operator">=</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Apple</span> <span class="token keyword">extends</span> <span class="token class-name">Fruit</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>        Gen<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span><span class="token operator">></span> g <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Gen</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        g<span class="token punctuation">.</span><span class="token function">setT</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// error</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Cannot infer type arguments for Test1&lt;></span><span class="token comment" spellcheck="true">// The method setT(capture#2-of ? extends Number) in the type Test1&lt;capture#2-of ? extends Number> is not applicable for the arguments (Apple)</span></code></pre><p><em>在上面代码中，在构造方法中却是正确的。个人推测，<code>new Gen&lt;&gt;(new Apple())</code>这部分实际上泛型是<code>Apple</code>，并且也不能是包含通配符的泛型，因此构造方法顺利通过编译，但是变量<code>g</code>的泛型是包含通配符的，即其泛型是不确定的类型，因此后续调用<code>setT()</code>方法出现问题。</em></p><h3 id="逆变"><a href="#逆变" class="headerlink" title="逆变"></a>逆变</h3><ul><li>使用超类型通配符可以允许向持有某种类型的容器中写入其子类，即指定泛型<code>&lt;? super ClassName&gt;</code>，甚至可以使用类型参数<code>&lt;? super T&gt;</code>（但不能针对类型参数给出一个超类型边界<code>&lt;T super ClassName&gt;</code>）。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SuperType</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">writeTo</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> Apple<span class="token operator">></span> apples<span class="token punctuation">)</span> <span class="token punctuation">{</span>        apples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        apples<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Jonathan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>下面代码中<code>writeExact()</code>无法将<code>Apple</code>对象放入<code>List&lt;Fruit&gt;</code>中，即使是允许的。而使用了超类型通配符的<code>writeWithWildcard()</code>则以把<code>Apple</code>对象放入<code>List&lt;Fruit&gt;</code>。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">GenericWriting</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">writeExact</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">,</span> T item<span class="token punctuation">)</span> <span class="token punctuation">{</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> apples <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Fruit<span class="token operator">></span> fruits <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">writeExact</span><span class="token punctuation">(</span>apples<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//writeExact(fruits, new Apple()); // Error</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">writeWithWildcard</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> T<span class="token operator">></span> list<span class="token punctuation">,</span> T item<span class="token punctuation">)</span> <span class="token punctuation">{</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">writeWithWildcard</span><span class="token punctuation">(</span>apples<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">writeWithWildcard</span><span class="token punctuation">(</span>fruits<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>相对应的，读取的代码可以使用子类型通配符，使读取对象时实现向上转型。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">GenericReading</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">readExact</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Apple<span class="token operator">></span> apples <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> List<span class="token operator">&lt;</span>Fruit<span class="token operator">></span> fruits <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fruit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Apple a <span class="token operator">=</span> <span class="token function">readExact</span><span class="token punctuation">(</span>apples<span class="token punctuation">)</span><span class="token punctuation">;</span>        Fruit f <span class="token operator">=</span> <span class="token function">readExact</span><span class="token punctuation">(</span>fruits<span class="token punctuation">)</span><span class="token punctuation">;</span>        f <span class="token operator">=</span> <span class="token function">readExact</span><span class="token punctuation">(</span>apples<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Reader</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>        T <span class="token function">readExact</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        Reader<span class="token operator">&lt;</span>Fruit<span class="token operator">></span> fruitReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Reader</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">//Fruit a = fruitReader.readExact(apples); // Error</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CovariantReader</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>        T <span class="token function">readCovariant</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">T</span><span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        CovariantReader<span class="token operator">&lt;</span>Fruit<span class="token operator">></span> fruitCovariantReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CovariantReader</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Fruit f <span class="token operator">=</span> fruitCovariantReader<span class="token punctuation">.</span><span class="token function">readCovariant</span><span class="token punctuation">(</span>fruits<span class="token punctuation">)</span><span class="token punctuation">;</span>        Fruit a <span class="token operator">=</span> fruitCovariantReader<span class="token punctuation">.</span><span class="token function">readCovariant</span><span class="token punctuation">(</span>apples<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>在上面的代码中，静态方法<code>readExact()</code>由于类型参数由<code>list</code>决定，所以正确返回了<code>Apple</code>对象并向上转型。如果只是读取，可以不使用泛型。而在<code>f2()</code>中，由于创建泛型类时先指定了类型参数为<code>Fruit</code>，因此<code>Reader#readExact()</code>不能接受<code>List&lt;Apple&gt;</code>参数。此时使用子类通配符即可解决问题。</p><h3 id="无界通配符"><a href="#无界通配符" class="headerlink" title="无界通配符"></a>无界通配符</h3><ul><li>使用无界通配符表示，当前不知道（或者不需要知道）具体类型，但是不影响对其进行操作。例如可以从<code>List&lt;?&gt;</code>中取值出来（但是会丢失类型信息），不可以向其中写入。</li></ul><h3 id="捕获转换"><a href="#捕获转换" class="headerlink" title="捕获转换"></a>捕获转换</h3><ul><li>如果向一个使用<code>&lt;?&gt;</code>的方法传递原生类型，对于编译器来说，可能会推断出实际的类型参数，使得这个方法可以回转并调用另一个使用这个确切类型的方法，即捕获转换。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> T <span class="token function">f1</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span>T<span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        T t <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> t<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">f2</span><span class="token punctuation">(</span>List<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">f1</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        List list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">f1</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">f2</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上面代码中，<code>main()</code>方法中调用<code>f1(list)</code>是有警告的，而经过<code>f2()</code>的捕获转换后警告消失了。</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x06</title>
      <link href="/2019/07/02/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x06/"/>
      <url>/2019/07/02/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x06/</url>
      
        <content type="html"><![CDATA[<h1 id="泛型（一）"><a href="#泛型（一）" class="headerlink" title="泛型（一）"></a>泛型（一）</h1><h2 id="简单泛型"><a href="#简单泛型" class="headerlink" title="简单泛型"></a>简单泛型</h2><ul><li><p>让一个类能够持有多种类型的对象，可以使用泛型实现。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">A</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T i<span class="token punctuation">;</span>    <span class="token function">A</span><span class="token punctuation">(</span>T ii<span class="token punctuation">)</span> <span class="token punctuation">{</span>        i <span class="token operator">=</span> ii<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        A<span class="token operator">&lt;</span>Integer<span class="token operator">></span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> i <span class="token operator">=</span> a<span class="token punctuation">.</span>i<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// a.i = "str test"; // 错误</span>        A<span class="token operator">&lt;</span>String<span class="token operator">></span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">A</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        String s <span class="token operator">=</span> b<span class="token punctuation">.</span>i<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ul><h3 id="示例：元组"><a href="#示例：元组" class="headerlink" title="示例：元组"></a>示例：元组</h3><ul><li><p>元组是指将一组对象直接打包存储于其中的一个单一对象，这个容器对象允许读取其中的元素，但是不允许向其中存放新的对象。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TwoTuple</span><span class="token operator">&lt;</span>A<span class="token punctuation">,</span>B<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> A first<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> B second<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">TwoTuple</span><span class="token punctuation">(</span>A a<span class="token punctuation">,</span> B b<span class="token punctuation">)</span> <span class="token punctuation">{</span>        first <span class="token operator">=</span> a<span class="token punctuation">;</span>        second <span class="token operator">=</span> b<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> String <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"("</span> <span class="token operator">+</span> first <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> second <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>当希望某个方法返回两个及以上的参数是可以使用元组来实现，创建时填入类型即可。</p></li></ul><h2 id="泛型接口"><a href="#泛型接口" class="headerlink" title="泛型接口"></a>泛型接口</h2><ul><li><p>泛型可以应用于接口，例如生成器：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Generator</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre></li></ul><h2 id="泛型方法"><a href="#泛型方法" class="headerlink" title="泛型方法"></a>泛型方法</h2><ul><li><p>泛型同样可以在类中包含参数化方法，并且与类是否泛型无关。</p></li><li><p>如果使用泛型方法可以取代整个类泛型化，那么就应该只使用泛型方法</p></li><li><p>静态方法无法访问类成员中的泛型变量。如果希望静态方法拥有泛型能力，那么就需要让静态方法称为泛型方法。</p></li><li><p>定义泛型方法，只需将泛型参数列表置于返回值之前：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span>T x<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span></code></pre></li><li><p>调用泛型方法时，不需要指明参数类型，编译器会自动判断类型，即类型参数推断。</p></li></ul><blockquote><p>在Java 8以前，泛型方法的结果传递给另外一个方法时编译器不会进行推断，而Java 8 中编译器能够根据调用的方法和相应的声明来确定需要的参数类型。</p></blockquote><h2 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h2><ul><li>泛型可以用于匿名内部类，同样以生成器为例：</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Generator</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">static</span> Generator<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Generator</span><span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> String <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token string">"test"</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="擦除"><a href="#擦除" class="headerlink" title="擦除"></a>擦除</h2><ul><li>Java的泛型是使用擦除来实现的，这意味着在泛型代码内部，无法获得任何有关泛型参数类型的信息，即实际上，<code>List&lt;Integer&gt;</code>和<code>List&lt;String&gt;</code>在运行时是相同的类型<code>List</code>。</li><li>泛型类型参数将擦除到它的第一个边界，实际上编译器会把类型参数替换为它的擦除。</li><li>当希望代码能够跨多个类工作时，使用泛型才有所帮助。例如某个类有一个返回<code>T</code>的方法，那么泛型可以帮助该方法返回正确的类型。</li></ul><h2 id="补救擦除的缺陷"><a href="#补救擦除的缺陷" class="headerlink" title="补救擦除的缺陷"></a>补救擦除的缺陷</h2><ul><li>在需要类型信息而其已经被擦除时，必须显式地传递类型的Class对象。例如，<code>x instanceof T</code>是错误的表达，需要x先用<code>Class&lt;T&gt; ct</code>对象保存类型信息，再比较类型信息<code>ct.isInstnce(x)</code>。</li></ul><h3 id="创建泛型类型对象"><a href="#创建泛型类型对象" class="headerlink" title="创建泛型类型对象"></a>创建泛型类型对象</h3><ul><li>传递一个工厂对象到构造器中，并使用该工厂创建新对象。</li></ul><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ClassAsFactory</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T x<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">ClassAsFactory</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span>T<span class="token operator">></span> kind<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            x <span class="token operator">=</span> kind<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Employee</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ClassAsFactory<span class="token operator">&lt;</span>Employee<span class="token operator">></span> fe <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassAsFactory</span><span class="token punctuation">(</span>Employee<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上面代码中使用了无参构造器，如果传入的类型没有无参构造器则无法工作。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">interface</span> <span class="token class-name">FactoryI</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    T <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> T x<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token operator">&lt;</span>F <span class="token keyword">extends</span> <span class="token class-name">FactoryI</span><span class="token operator">&lt;</span>T<span class="token operator">>></span> <span class="token function">Foo</span><span class="token punctuation">(</span>F factory<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">//public Foo(FactoryI factory) { // Error</span>        x <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">IntegerFactory</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryI</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> Integer <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Widget</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Factory</span> <span class="token keyword">implements</span> <span class="token class-name">FactoryI</span><span class="token operator">&lt;</span>Widget<span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token keyword">public</span> Widget <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IntegerFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token operator">&lt;</span>Widget<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Widget<span class="token punctuation">.</span>Factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>使用了显式的工厂对象后，可以应用于任何一种类型，并且获得了编译期检查。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">GenericWithCreate</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token keyword">final</span> T element<span class="token punctuation">;</span>    <span class="token function">GenericWithCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        element <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">abstract</span> T <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">X</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">class</span> <span class="token class-name">Creator</span> <span class="token keyword">extends</span> <span class="token class-name">GenericWithCreate</span> <span class="token punctuation">{</span>    X <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">X</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Creator c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Creator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上面代码使用了模板方法。</p><h3 id="泛型数组"><a href="#泛型数组" class="headerlink" title="泛型数组"></a>泛型数组</h3><ul><li>一般情况下使用<code>ArrayList</code>。如果确实需要数组，则只能使用强制类型转换<code>(T[])new Object[size]</code>。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x05</title>
      <link href="/2019/07/01/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x05/"/>
      <url>/2019/07/01/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x05/</url>
      
        <content type="html"><![CDATA[<h1 id="类型信息"><a href="#类型信息" class="headerlink" title="类型信息"></a>类型信息</h1><h2 id="Class对象"><a href="#Class对象" class="headerlink" title="Class对象"></a>Class对象</h2><ul><li>Java使用<code>Class</code>对象来执行其RTTI。</li><li>类是程序的一部分，每个类都有一个<code>Class</code>对象</li><li>类加载过程（见<a href="2019/06/23/深入理解Java虚拟机笔记0x02/">深入理解Java虚拟机笔记0x02</a>）</li><li><code>Class</code>对象仅在需要的时候才被加载</li><li><code>Class.forName(String className)</code>可以取得<code>Class</code>对象的引用，参数为一个包含目标类的文本名（区分大小写）。注意此方法会使类加载并初始化，作为对比，使用<code>ClassLoader</code>对象的<code>loadClass()</code>方法只会对类进行加载，而不会初始化。</li><li><code>Object</code>对象有方法<code>getClass()</code>可以获取相应<code>Class</code>对象引用。</li><li><code>Class#getSimpleName()</code>返回不含包名的类名，<code>Class#getCanonicalName()</code>返回全限定的类名。</li><li><code>Class#getSuperclass()</code>返回其基类的<code>Class</code>对象</li></ul><blockquote><p>关于<code>Class#newInstance()</code>：该方法已于Java 9声明废弃，使用<code>Class#getDeclaredConstructor().newInstance()</code>代替。</p></blockquote><h3 id="泛化的Class引用"><a href="#泛化的Class引用" class="headerlink" title="泛化的Class引用"></a>泛化的Class引用</h3><ul><li>可以使用泛型将<code>Class</code>引用所指向的<code>Class</code>对象的类型进行限定，使其变得更为具体 。</li><li><code>Class&lt;?&gt;</code>与<code>Class</code>：<code>Class</code>没有表现出是否要限制<code>Class</code>的意思，而<code>Class&lt;?&gt;</code>则表示此处<code>Class</code>的限制是无限制。</li><li>向<code>Class</code>引用添加泛型语法的原因仅仅是为了提供编译期类型检查。</li></ul><h3 id="转型"><a href="#转型" class="headerlink" title="转型"></a>转型</h3><ul><li><code>Class#cast()</code>可以将参数对象转换为<code>Class</code>引用的类型</li></ul><h2 id="类型检查"><a href="#类型检查" class="headerlink" title="类型检查"></a>类型检查</h2><ul><li>关键字<code>instanceof</code>：判断对象是否为某种类型，用法：<code>x instanceof ClassName</code>。只可将其与命名类型比较，不能与<code>Class</code>对象比较。</li><li><code>Class#isInstance()</code>判断参数引用是否为<code>Class</code>引用的实例。</li><li>使用<code>instanceof</code>或者<code>Class#isInstance()</code>进行的判断是对象是否为目标类或者目标类的子类，而使用<code>==</code>或者<code>equals()</code>则表示对象是否确切的是目标类，而不是目标类的子类或者其他类。</li></ul><h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><ul><li>Java中使用<code>Class</code>类和<code>java.lang.reflect</code>共同支持反射。在类库中，<code>Constructor</code>用于创建新的对象，<code>get()</code>和<code>set()</code>方法用于修改与<code>Field</code>对象关联的字段，<code>invoke()</code>方法用于调用与<code>Method</code>对象关联的方法；此外，<code>getFields()</code>、<code>getMethods()</code>、<code>getConstructors()</code>方法可以分别获得表示字段、方法以及构造器对象的数组。</li><li>RTTI与反射的区别：对于RTTI来说，编译器在编译时打开和检查.class文件，而对于反射来说，.class文件在编译时是不可获取的。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x04</title>
      <link href="/2019/06/30/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x04/"/>
      <url>/2019/06/30/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x04/</url>
      
        <content type="html"><![CDATA[<h1 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h1><h2 id="不可变String"><a href="#不可变String" class="headerlink" title="不可变String"></a>不可变String</h2><ul><li><code>String</code>对象是不可变的。<code>String</code>类中每一个看起来会修改<code>String</code>值的方法，实际上都是创建了一个全新的<code>String</code>对象。</li><li>对于一个方法而言，参数是为该方法提供信息的，而不是想让该方法改变自己。</li></ul><h2 id="重载“-”与StringBuilder"><a href="#重载“-”与StringBuilder" class="headerlink" title="重载“+”与StringBuilder"></a>重载“+”与StringBuilder</h2><ul><li>重载：一个操作符在应用于特定的类时，赋予其特定的含义。</li><li>在Java中，用于<code>String</code>的<code>+</code>和<code>+=</code>是仅有的两个重载过的操作符，不允许程序员重载任何操作符。</li><li>Java编译器会自动优化<code>String</code>操作并使用<code>StringBuilder</code>,因为其高效，但是并不是所有的状况都会被优化。因此在需要大量操作<code>String</code>时使用<code>StringBuilder</code>是明智的选择。</li></ul><h2 id="无意识递归"><a href="#无意识递归" class="headerlink" title="无意识递归"></a>无意识递归</h2><ul><li>如果在<code>toString()</code>方法中使用<code>this</code>指针与其它字符串拼接，试图打印对象的地址，那么会引起无限的递归调用。[因为编译器试图把<code>this</code>指针转换为<code>String</code>类型，而转换的方法就是调用<code>this.toString()</code>。正确的做法是调用父类的<code>toString()</code>，即<code>super.toString()</code>。</li></ul><h2 id="格式化输出"><a href="#格式化输出" class="headerlink" title="格式化输出"></a>格式化输出</h2><h3 id="System-out-format"><a href="#System-out-format" class="headerlink" title="System.out.format()"></a>System.out.format()</h3><ul><li>类似于C语言中的<code>printf()</code>，接受一个简单的格式化字符串以及一串参数。</li></ul><h3 id="Formatter类"><a href="#Formatter类" class="headerlink" title="Formatter类"></a>Formatter类</h3><ul><li>创建<code>Formatter</code>对象时需要向构造器中传入输出目标，例如<code>System.out</code>。使用时调用<code>Formatter</code>对象的<code>format()</code>方法。</li></ul><h3 id="格式化说明符"><a href="#格式化说明符" class="headerlink" title="格式化说明符"></a>格式化说明符</h3><ul><li>抽象语法：<code>%[argument_index$][flags][width][.precision]conversion</code></li><li><code>width</code>：控制一个域的最小尺寸，在有必要时添加空格，来确保一个域至少达到某个长度。可以用于各种类型的数据转换。默认情况下数据是右对齐，可以使用<code>-</code>来改变对齐方向。</li><li><code>precision</code>：指明数据的最大尺寸。不能用于所有的数据类型转换，例如整数类型，并且应用于不同的数据类型转换时意义也不同。应用于<code>String</code>时表示打印<code>String</code>时输出的字符的最大数量；应用于浮点数时，表示小数部分要显示的位数（默认是6位），多则舍入，少则补0。</li></ul><h3 id="Formatter转换"><a href="#Formatter转换" class="headerlink" title="Formatter转换"></a>Formatter转换</h3><ul><li>常用的类型转换：</li></ul><table><thead><tr><th>类型转换字符</th><th>含义</th></tr></thead><tbody><tr><td>d</td><td>整数型（十进制）</td></tr><tr><td>c</td><td>Unicode字符</td></tr><tr><td>b</td><td>Boolean值</td></tr><tr><td>s</td><td>String</td></tr><tr><td>f</td><td>浮点数（十进制）</td></tr><tr><td>e</td><td>浮点数（科学计数）</td></tr><tr><td>x</td><td>整数（十六进制）</td></tr><tr><td>h</td><td>散列码（十六进制）</td></tr><tr><td>%</td><td>字符”%”</td></tr></tbody></table><ul><li>关于b转换，对于<code>boolean</code>基本类型和<code>Boolean</code>对象，其转换结果就是<code>true</code>或<code>false</code>；对于其它类型的参数，只要其不为<code>null</code>，那么转换结果就是<code>true</code>，即使是数字<code>0</code>，转换结果依然是<code>true</code>。</li></ul><h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><h3 id="基本构造"><a href="#基本构造" class="headerlink" title="基本构造"></a>基本构造</h3><table><thead><tr><th>字符</th><th>含义</th></tr></thead><tbody><tr><td>B</td><td>指定字符B</td></tr><tr><td>\xhh</td><td>十六进制值为0xhh的字符</td></tr><tr><td>\uhhhh</td><td>十六进制表示为0xhhhh的Unicode字符</td></tr><tr><td>\t</td><td>制表符Tab</td></tr><tr><td>\n</td><td>换行符</td></tr><tr><td>\r</td><td>回车</td></tr><tr><td>\f</td><td>换页</td></tr><tr><td>\e</td><td>转义（Escape）</td></tr></tbody></table><table><thead><tr><th>字符类</th><th>含义</th></tr></thead><tbody><tr><td>.</td><td>任意字符</td></tr><tr><td>[abc]</td><td>包含a、b、c的任何字符，同 a&#124;b&#124;c</td></tr><tr><td>[^abc]</td><td>除了a、b、c的任何字符（否定）</td></tr><tr><td>[a-zA-Z]</td><td>从a到z或从A到Z的任何字符</td></tr><tr><td>\s</td><td>空白符（空格、Tab、换行、换页和回车）</td></tr><tr><td>\S</td><td>非空白符</td></tr><tr><td>\d</td><td>数字，同[0-9]</td></tr><tr><td>\D</td><td>非数字，[^0-9]</td></tr><tr><td>\w</td><td>词字符，[a-zA-Z0-9]</td></tr><tr><td>\W</td><td>非词字符，[^\w]</td></tr></tbody></table><table><thead><tr><th>逻辑操作符</th><th>含义</th></tr></thead><tbody><tr><td>XY</td><td>Y跟在X后面</td></tr><tr><td>X&#124;Y</td><td>X或Y</td></tr><tr><td>(X)</td><td>捕获组，可以在表达式中使用\i来引用第i个捕获</td></tr></tbody></table><table><thead><tr><th>边界匹配符</th><th>含义</th></tr></thead><tbody><tr><td>^</td><td>一行的开始</td></tr><tr><td>$</td><td>一行的结束</td></tr><tr><td>\b</td><td>词的边界</td></tr><tr><td>\B</td><td>非词的边界</td></tr><tr><td>\G</td><td>前一个匹配的结束</td></tr></tbody></table><h3 id="量词"><a href="#量词" class="headerlink" title="量词"></a>量词</h3><ul><li>量词描述了一个模式吸收输入文本的方式</li><li>贪婪型：一次性地读入整个字符串，如果无法完成匹配就去掉最右边的一个字符再匹配，直到找到匹配的字符串或字符串的长度为0为止。它的宗旨是读尽可能多的字符，所以当读到第一个匹配时就立刻返回。</li><li>厌恶型：立刻进入匹配，如果无法匹配则多读一个字符串，直到匹配成功或者字符串读完。它尽量减少了匹配到的字符串，但同样读到第一个匹配的就返回。</li><li>占有型：仅匹配一次，失败不会再次尝试。</li></ul><h3 id="Pattern和Matcher"><a href="#Pattern和Matcher" class="headerlink" title="Pattern和Matcher"></a>Pattern和Matcher</h3><ul><li><p>正则表达式对象：位于<code>java.util.regex</code>包中，使用<code>Pattern.compile()</code>编译正则表达式，并返回一个<code>Pattern</code>对象。使用<code>Pattern</code>对象的<code>matcher()</code>方法检索一个字符串，会得到一个<code>Matcher</code>对象。</p></li><li><p><code>Pattern</code>对象的<code>split()</code>方法可以从匹配了正则表达式的地方分割输入的字符串，返回分割后的子字符串<code>String</code>数组。</p></li><li><p><code>Matcher</code>对象的<code>find()</code>方法可用来在<code>CharSequence</code>中查找多个匹配</p></li><li><p>组：是用括号划分的正则表达式，可以根据组的编号来引用某个组。组号为0便是整个正则表达式，组号1表示第一对括号括起来的组。</p></li><li><p><code>Matcher</code>对象中有许多关于组的方法：</p></li></ul><table><thead><tr><th>方法名</th><th>用途</th></tr></thead><tbody><tr><td><code>int groupCount()</code></td><td>返回<code>Matcher</code>对象中组数，不包含第0组</td></tr><tr><td><code>String group()</code></td><td>返回前一次匹配的第0组</td></tr><tr><td><code>String group(int i)</code></td><td>返回前一次匹配的指定组号，如果匹配成功但是指定的组没有匹配输入字符串的任何部分则返回<code>null</code></td></tr><tr><td><code>int start(int group)</code></td><td>返回前一次匹配操作中寻找到的组的起始索引</td></tr><tr><td><code>int end(int group)</code></td><td>返回前一次匹配操作中寻找到的组的最后一个字符索引加1的值</td></tr></tbody></table><h3 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h3><table><thead><tr><th>方法名</th><th>用途</th></tr></thead><tbody><tr><td><code>String replaceFirst(String replacement)</code></td><td>用<code>replacement</code>替换掉第一个匹配成功的部分</td></tr><tr><td><code>String replaceAll(String replacement)</code></td><td>用<code>replacement</code>替换所有匹配成功的部分</td></tr><tr><td><code>Matcher appendReplacement(StringBuffer sb, String replacement)</code></td><td>1. 先将不匹配的地方放入<code>sb</code>中，即从上次读取的位置开始，到本次<code>start() - 1</code>；2. 将<code>replacement</code>放入<code>sb</code>中；3. 将读取位置改为<code>end()</code></td></tr><tr><td><code>StringBuffer appendTail(StringBuffer sb)</code></td><td>在多次使用<code>appendReplacement()</code>方法后，使用此方法将把剩余部分的字符串直接放入<code>sb</code>中</td></tr></tbody></table><h3 id="reset"><a href="#reset" class="headerlink" title="reset()"></a>reset()</h3><ul><li><code>reset()</code>可以将现有的<code>Matcher</code>对象应用于一个新的字符序列。</li></ul><h2 id="扫描输入"><a href="#扫描输入" class="headerlink" title="扫描输入"></a>扫描输入</h2><h3 id="Scanner定界符"><a href="#Scanner定界符" class="headerlink" title="Scanner定界符"></a>Scanner定界符</h3><ul><li>默认情况下，<code>Scanner</code>对象使用空白字符对输入进行分词。使用<code>Scanner</code>对象的<code>useDelimiter()</code>并输入正则表达式作为参数可以修改成自定义的定界符。</li></ul><h3 id="用正则表达式扫描"><a href="#用正则表达式扫描" class="headerlink" title="用正则表达式扫描"></a>用正则表达式扫描</h3><ul><li><code>Scanner</code>对象的<code>hasNext()</code>和<code>next()</code>方法都支持输入一个<code>Pattern</code>对象，找到下一个匹配该模式的部分，调用<code>match()</code>就能获得匹配结果。如果正则表达式中有定界符，将永远不会匹配成功。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x03</title>
      <link href="/2019/06/28/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x03/"/>
      <url>/2019/06/28/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x03/</url>
      
        <content type="html"><![CDATA[<h1 id="通过异常处理错误"><a href="#通过异常处理错误" class="headerlink" title="通过异常处理错误"></a>通过异常处理错误</h1><h2 id="基本异常"><a href="#基本异常" class="headerlink" title="基本异常"></a>基本异常</h2><ul><li>异常是指组织当前方法或作用于继续执行的问题</li><li>与普通问题对比：普通问题在当前环境中能得到足够的信息，总能处理错误，而对于异常则在当前环境中无法获得足够信息来解决问题。</li><li>抛出异常：从当前环境跳出，并且把问题交给上一级环境</li><li>异常参数：异常类有两个构造器，一个是默认构造器，另一个接受一个字符串参数，能够输入自定义的错误信息</li></ul><h2 id="捕获异常"><a href="#捕获异常" class="headerlink" title="捕获异常"></a>捕获异常</h2><h3 id="try块"><a href="#try块" class="headerlink" title="try块"></a>try块</h3><ul><li>如果不希望在方法内遇到异常就结束，可以使用<code>try</code>包裹可能出现异常的代码来捕获异常</li><li>相较于不支持处理异常的语言，<code>try</code>可以不需要在每一次调用方法的前后设置错误检查的代码，从而使代码更容易编写和阅读</li></ul><h3 id="异常处理程序"><a href="#异常处理程序" class="headerlink" title="异常处理程序"></a>异常处理程序</h3><ul><li>用于处理<code>try</code>捕获的异常，关键字为<code>catch</code>，参数为错误类型以及标识符。</li></ul><h3 id="终止与恢复"><a href="#终止与恢复" class="headerlink" title="终止与恢复"></a>终止与恢复</h3><ul><li>终止模型：假设错误非常关键，以至于程序无法返回到异常发生的地方继续执行</li><li>恢复模型：异常处理程序的工作是修正错误，然后重新尝试调用出问题的方法，并任务第二次能成功</li><li>尽管恢复模型显得很吸引人，但是并不实用。其中的主要原因可能是它所导致的耦合：恢复性的处理程序需要了解异常抛出的地点，这势必要包含依赖于抛出位置的非通用代码。</li></ul><h2 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h2><ul><li>自定义异常需要从已有的异常类继承，最好是选择意思相近的异常类继承，也可以选择编程相关的所有异常的父类<code>Exception</code>继承。</li></ul><h2 id="异常说明"><a href="#异常说明" class="headerlink" title="异常说明"></a>异常说明</h2><ul><li>在方法声明中，形式参数列表后使用关键字<code>throw</code>，后面接一个所有潜在异常类型的列表，可以表示该方法可能会抛出相应的异常。调用此方法时，如果没有处理这些异常将无法通过编译。</li></ul><h2 id="捕获所有异常"><a href="#捕获所有异常" class="headerlink" title="捕获所有异常"></a>捕获所有异常</h2><ul><li>捕获时，使用<code>Exception</code>类可以捕获到所有编程相关的异常。最好将其放在处理程序的末尾，以防它抢在其它异常处理程序之前把异常捕获了。</li><li>栈轨迹：异常对象的<code>getStackTrace()</code>可以获得发生错误时调用序列，栈顶是调用序列中最后一个方法调用。</li><li>重新抛出异常：在<code>catch</code>块中可以使用<code>throw</code>重新抛出异常，将异常抛给上一级环境中的异常处理程序，后续的<code>catch</code>子句将被忽略。</li></ul><h3 id="异常链"><a href="#异常链" class="headerlink" title="异常链"></a>异常链</h3><ul><li>异常链是指在捕获一个异常后抛出另一个异常，并且希望保存原始异常的信息。</li><li><code>Throwable</code>的构造器可接受另一个<code>Throwable</code>对象作为原始异常（<code>cause</code>）来追踪异常最初发生的位置。</li><li><code>initCause()</code>方法可以为一个没有设置原始异常的<code>Throwable</code>对象设置原始异常。注意此方法仅能调用一次，并且如果该对象已经通过构造器设置原始异常或者该方法调用超过一次，那么会抛出<code>IllegalStateException</code>。</li></ul><h2 id="Java标准异常"><a href="#Java标准异常" class="headerlink" title="Java标准异常"></a>Java标准异常</h2><ul><li>运行时异常（<code>RuntimeException</code>），例如空指针异常（<code>NullPointerException</code>）会被Java虚拟机自动抛出，不需要在异常说明中添加这类异常，如果没有被捕获，它们将直达<code>main()</code>方法。</li></ul><h2 id="使用finally清理"><a href="#使用finally清理" class="headerlink" title="使用finally清理"></a>使用finally清理</h2><ul><li><code>finally</code>子句中的代码无论<code>try</code>块中是否抛出异常都会得到执行。</li><li>当要把除内存之外的资源恢复到它们的初始状态时，可以使用<code>finally</code>子句。例如关闭打开的文件或者网络连接等。</li><li>丢失异常：<code>try</code>块中的异常会被<code>finally</code>子句中的异常覆盖；如果在<code>finally</code>子句中返回，即使抛出异常也不会产生输出。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x02</title>
      <link href="/2019/06/28/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x02/"/>
      <url>/2019/06/28/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x02/</url>
      
        <content type="html"><![CDATA[<h1 id="持有对象"><a href="#持有对象" class="headerlink" title="持有对象"></a>持有对象</h1><h2 id="添加一组元素"><a href="#添加一组元素" class="headerlink" title="添加一组元素"></a>添加一组元素</h2><ul><li><code>Collections.addAll()</code>方法接受一个<code>Collection</code>对象，以及一个数组或者一个逗号分隔符列表，将元素添加到<code>Collection</code>中。推荐使用此方法。</li><li><code>Arrays.asList()</code>方法接受数组或列表，但是其返回的对象类型<code>List</code>并不是<code>java.util.List</code>，而是<code>Arrays</code>内的一个静态内部类，没有<code>add()</code>和<code>remove()</code>方法。</li></ul><h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><ul><li><code>List</code>在<code>Collection</code>中添加了大量方法，可以在<code>List</code>中间插入和移除元素</li></ul><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><ul><li><code>ArrayList</code>：长于随机访问元素，但是在<code>List</code>中间插入和移除元素较慢</li><li><code>LinkedList</code>：在中间插入和删除操作代价较低，提供了优化的顺序访问，但是随机访问相对较慢</li></ul><h3 id="部分方法"><a href="#部分方法" class="headerlink" title="部分方法"></a>部分方法</h3><ul><li><code>remove()</code>：此方法接受元素类型对象（调用其<code>equals()</code>方法）或者在<code>List</code>中的序号，来删除指定元素。注意如果<code>List</code>中元素为<code>Integer</code>类型时，删除值为<code>x</code>的方式为<code>remove((Integer) x)</code>而不是<code>remove(x)</code>，后者会删掉序号为<code>x</code>的元素。</li><li><code>subList()</code>：获取子列表</li><li><code>containsAll()</code>：是否包含参数序列中所有的值。与参数顺序无关。</li><li><code>retainsALL()</code>：参数为另一个<code>List</code>，求两个<code>List</code>交集，结果保存在调用对象里。</li></ul><h2 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h2><ul><li>实现了<code>List</code>的基本接口，添加了可以使其用作栈、队列或双端队列的方法。</li></ul><h2 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h2><h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><h3 id="类型-1"><a href="#类型-1" class="headerlink" title="类型"></a>类型</h3><ul><li><code>HashSet</code>：使用散列函数实现，查找速度较快</li><li><code>TreeSet</code>：基于红黑树实现</li><li><code>LinkedHashSet</code>：同样使用散列函数实现，但同时用链表维护了元素插入顺序</li></ul><h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><ul><li><code>offer()</code>：在允许的情况下将一个元素插入队尾，或者返回<code>false</code>。</li><li><code>PriorityQueue</code>：使用<code>offer()</code>插入时会对元素进行排序。默认顺序是元素在队列中的自然顺序，可通过修改<code>Comparator</code>来修改顺序。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x01</title>
      <link href="/2019/06/26/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x01/"/>
      <url>/2019/06/26/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x01/</url>
      
        <content type="html"><![CDATA[<h1 id="内部类"><a href="#内部类" class="headerlink" title="内部类"></a>内部类</h1><h2 id="链接到外部类"><a href="#链接到外部类" class="headerlink" title="链接到外部类"></a>链接到外部类</h2><ul><li>内部类拥有外围对象所有成员的访问权限，以及外围类的访问权限。</li></ul><h2 id="获取外部类引用"><a href="#获取外部类引用" class="headerlink" title="获取外部类引用"></a>获取外部类引用</h2><ul><li>在内部类中，使用外部类名称以及<code>.this</code>可以获得外部类对象的引用。</li></ul><h3 id="内部类访问外部类变量"><a href="#内部类访问外部类变量" class="headerlink" title="内部类访问外部类变量"></a><em>内部类访问外部类变量</em></h3><ul><li><em>如果内部类或者外围方法没有与外部类重名的变量，那么可以直接访问外部类的变量，如果有重名变量，则需要通过上述方法访问外部类变量。</em></li></ul><h2 id="创建内部类对象"><a href="#创建内部类对象" class="headerlink" title="创建内部类对象"></a>创建内部类对象</h2><ul><li>如果内部类不是静态的，需要通过外部类对象来创建，例如外部类<code>Test</code>的实例<code>test</code>，其包括一个内部类<code>Inner</code>，那么创建方式为<code>test.new Test.Inner()</code></li></ul><h2 id="匿名内部类"><a href="#匿名内部类" class="headerlink" title="匿名内部类"></a>匿名内部类</h2><ul><li>是指创建一个继承某个类的匿名类，通过<code>new</code>表达式返回的引用自动向上转型为父类的引用。</li><li>可以方便快速继承类重写方法或者实现接口。</li></ul><h2 id="内部类的用处"><a href="#内部类的用处" class="headerlink" title="内部类的用处"></a>内部类的用处</h2><ul><li>每个内部类都能独立地继承自一个（接口的）实现，所以无论外围类是否已经继承了某个（接口的）实现，对于内部类都没有影响，有效的实现了多重继承。</li></ul><h2 id="内部类用于回调"><a href="#内部类用于回调" class="headerlink" title="内部类用于回调"></a>内部类用于回调</h2><ul><li>回调函数：有些库函数需要传给它一个函数，好在合适的时候调用，以完成目标任务。这个被传入的、后又被调用的函数就称为回调函数。</li><li>通过内部类实现同名方法的不同实现，后通过回调可以选择向外部提供调用的方法。</li></ul><h2 id="内部类与控制框架"><a href="#内部类与控制框架" class="headerlink" title="内部类与控制框架"></a>内部类与控制框架</h2><ul><li>应用程序框架：用于解决某类特定问题的一个类或一组类</li><li>控制框架：一类特殊的应用程序框架，用来解决响应事件的请求</li></ul><h2 id="内部类与覆盖"><a href="#内部类与覆盖" class="headerlink" title="内部类与覆盖"></a>内部类与覆盖</h2><ul><li>内部类无法被子类的同名内部类覆盖。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java编程思想笔记0x00</title>
      <link href="/2019/06/25/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2019/06/25/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h1><h2 id="面向对象的程序设计方式"><a href="#面向对象的程序设计方式" class="headerlink" title="面向对象的程序设计方式"></a>面向对象的程序设计方式</h2><ol><li>万物皆对象</li><li>程序是对象的集合，它们通过发送消息来告知彼此要做的。</li><li>每个对象都有自己的、由其他对象所构成的存储</li><li>每个对象都有其类型</li><li>某一特定类型的所有对象都可以接受同样的消息</li></ol><h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><ul><li>只向客户端程序员暴露必须的部分，而隐藏其它部分</li><li>原因：<ol><li>让客户端程序员无法触及他们不应该触及的部分，关注对他们来说关键的东西。</li><li>允许库设计者可以改变类内部的工作方式而不必担心会影响到客户端程序员。</li></ol></li></ul><h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><ul><li>继承使用基类型和导出类型的概念表示了类型间的相似性。</li></ul><h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><ul><li>后期绑定：当向对象发送消息时，被调用代码直到运行时才能确定。编译器确保被调用方法存在，并对调用参数和返回值执行类型检查，但并不知道被执行的确切代码。</li><li>向上转型：在程序执行过程中，把导出类看做其基类的过程。</li></ul><h2 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h2><ul><li>基本类型的创建：创建一个并非是引用的“自动”变量，这个变量直接存储值并置于堆栈中。</li><li>基本类型占用的存储空间不随机器硬件架构变化而变化</li><li>所有的数值类型都有正负号</li></ul><h2 id="static"><a href="#static" class="headerlink" title="static"></a>static</h2><ul><li>当声明一个事物是<code>static</code>时，就意味着这个域或方法不会与包含它的那个类的任何对象实例关联在一起。即使从未创建过某个类的任何对象，也可以调用其<code>static</code>方法或访问其<code>staic</code>域。</li><li>在<code>static</code>内部不能调用非静态方法。</li></ul><h1 id="初始化与清理"><a href="#初始化与清理" class="headerlink" title="初始化与清理"></a>初始化与清理</h1><h2 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h2><ul><li>构造器是一种特殊类型的方法，因为它没有返回值。这与返回值为空是不同的。<code>new</code>表达式返回了对象的引用，但这并不是构造器的返回值。</li><li>构造器中对变量的初始化会覆盖该变量在定义时的初始化</li><li>如果类中没有构造器，那么编译器会自动创建一个默认的构造器，但是如果已经定义类一个构造器，无论是否有参数，编译器就不再创建默认构造器。</li></ul><h2 id="重载"><a href="#重载" class="headerlink" title="重载"></a>重载</h2><ul><li>如果传入的数据类型小于方法中声明的形式参数类型，实际数据的类型就会提升。但是<code>char</code>型略有不同，如果无法找到恰好接受<code>char</code>型的方法，就会把<code>char</code>直接提升到<code>int</code>型。</li></ul><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><ul><li>静态初始化只在必要的时候进行。如果不创建对象，或者不访问静态域，那么就不会进行静态初始化。</li><li>初始化的顺序是先静态对象，后其它对象。</li></ul><h2 id="可变参数列表"><a href="#可变参数列表" class="headerlink" title="可变参数列表"></a>可变参数列表</h2><ul><li>可以使用类似<code>Object... args</code>的参数形式来代替显示的声明数组。</li></ul><h1 id="访问权限控制"><a href="#访问权限控制" class="headerlink" title="访问权限控制"></a>访问权限控制</h1><h2 id="代码组织"><a href="#代码组织" class="headerlink" title="代码组织"></a>代码组织</h2><ul><li>一个Java源文件称为编译单元。一个编译单元中只能有一个public类，且该类的名称需与文件名称相同（包括大小写，不包括文件名后缀）。</li><li>类库中会有一组类文件，每个文件都由一个public类和任意数量的非public类组成，因此每个文件都由一个构件。如果希望这些构件从属于同一个群组，可以使用关键字<code>package</code>。</li></ul><h2 id="访问权限"><a href="#访问权限" class="headerlink" title="访问权限"></a>访问权限</h2><ul><li>包访问权限：是默认的访问权限，意味着当前包中的所有其它类对该成员都有访问权限。</li><li>默认包：如果没有给Java文件设置任何包名称，则编译器会把处于相同目录下的Java文件看作是属于该目录下的默认包之中。</li><li><code>public</code>：由<code>public</code>修饰的成员对任何类都是可用的。</li><li><code>private</code>：由<code>private</code>修饰的成员，除了包含该成员的类以外，其它任何类都无法访问这个成员。</li><li>如果使用<code>privatge</code>修饰构造器，那么将无法通过通常手段进行对象的创建，并且会阻碍对此类的继承。</li><li><code>protected</code>：由<code>protected</code>修饰的成员仅支持当前类、继承类以及相同包的其它类访问（即提供包访问权限）</li></ul><h1 id="复用类"><a href="#复用类" class="headerlink" title="复用类"></a>复用类</h1><h2 id="组合"><a href="#组合" class="headerlink" title="组合"></a>组合</h2><h2 id="继承-1"><a href="#继承-1" class="headerlink" title="继承"></a>继承</h2><ul><li>继承中的构建：在继承中，构建过程是从基类流向导出类的，因此基类在导出类构造器可以访问它之前就已经完成了初始化。即使导出类没有显式创建构造器，编译器也会自动创建一个默认的构造器，该构造器将调用基类的构造器。但是如果基类设置了有参构造器，那么在导出类中如果不显示声明调用基类的某个构造器，在创建过程中将会默认调用基类的无参构造器，如果基类没有声明无参构造器则编译不会通过。</li></ul><h2 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h2><ul><li>将一个成员对象置于要构造的类中，同时在新类中暴露该类所有的成员方法。</li></ul><h2 id="final"><a href="#final" class="headerlink" title="final"></a>final</h2><ul><li>使用<code>final</code>修饰的基本类型变量值不能改变，如果是引用类型变量则引用值不能改变，但是引用指向的对象自身是可以改变的。此外，使用<code>final</code>修饰的变量必须初始化（可以在声明时初始化或者在构造器中初始化）。</li><li>一个既是<code>static</code>又是<code>final</code>的变量只能占据一段不能改变的存储空间，并且必须在声明时初始化。</li><li>只有想要明确禁止覆盖方法时，才将方法设为final。</li></ul><h1 id="多态-1"><a href="#多态-1" class="headerlink" title="多态"></a>多态</h1><ul><li>协变返回类型：在导出类中的被覆盖方法可以返回基类方法的返回类型的某种导出类。</li></ul><h1 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h1><h2 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h2><ul><li>抽象类和抽象方法可以使类的抽象性明确起来，并且可以明确传达类的使用方法。此外，抽象类还是有用的重构工具。</li></ul><h2 id="接口-1"><a href="#接口-1" class="headerlink" title="接口"></a>接口</h2><ul><li>当组合接口时，如果存在两个方法重名、参数列表或返回值不一致，那么会产生冲突。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入理解Java虚拟机笔记0x03</title>
      <link href="/2019/06/23/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x03/"/>
      <url>/2019/06/23/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x03/</url>
      
        <content type="html"><![CDATA[<h1 id="Java线程"><a href="#Java线程" class="headerlink" title="Java线程"></a>Java线程</h1><h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><ul><li>当变量声明为volatile时，变量将具备以下两个特性：<ul><li>保证此变量对所有线程的可见性，即一个线程修改了volatile变量后，其余线程可以立即获得修改后的值。</li><li>禁止指令重排序优化，即设置内存屏障，保证volatile变量修改更新到所有CPU上</li></ul></li></ul><h2 id="Java线程实现"><a href="#Java线程实现" class="headerlink" title="Java线程实现"></a>Java线程实现</h2><ul><li>基于操作系统的原生线程模型。Windows和Linux下都使用一对一的线程模型。</li></ul><h2 id="线程状态及转换"><a href="#线程状态及转换" class="headerlink" title="线程状态及转换"></a>线程状态及转换</h2><ul><li>新建：创建后未启动的线程</li><li>运行：正在执行或者等待CPU为其分配运行时间</li><li>无限期等待：等待被其它线程显式地唤醒，不会被分配CPU时间，例如没有设置Timeout的<code>Object.wait()</code>或者<code>Thread.join()</code></li><li>限期等待：不会被分配CPU时间，但是不需要其它线程显式地唤醒，一定时间后会由系统自动唤醒，例如<code>Thread.sleep()</code>，设置了Timeout的<code>Object.wait()</code>或者<code>Thread.join()</code></li><li>阻塞：等待获取一个排他锁。</li><li>结束：已终止的线程状态。</li></ul><h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><h3 id="线程安全程度"><a href="#线程安全程度" class="headerlink" title="线程安全程度"></a>线程安全程度</h3><ol><li>不可变：无论是对象的方法实现还是方法的调用者，都不需要再采取任何的线程安全保障措施。例如final关键字修饰的变量</li><li>绝对线程安全：调用者不需要任何额外的同步措施。</li><li>相对线程安全：保证对对象的单独操作是安全的，调用者不需要做额外的保障措施。但对于一些特定顺序的连续调用，就可能需要在调用端使用额外的同步手段来保证调用的正确性（可以保证调用对象不同的方法时，不同的方法不会交叉执行，但是无法保证一组方法的调用顺序）。例如对<code>Vector</code>对象同时进行<code>remove()</code>和<code>get()</code>操作时可能会出现删除第i个元素后面是访问第i个元素的情况。在Java语言中，大部分的线程安全类都属于这种类型。</li><li>线程兼容：对象本身并不是线程安全的，但是可以通过在调用端正确地使用同步手段来保证对象在并发环境中可以安全使用。</li><li>线程对立：无论调用端是否采取同步措施，都无法在多线程环境中并发使用的代码。</li></ol><h3 id="线程安全的实现方法"><a href="#线程安全的实现方法" class="headerlink" title="线程安全的实现方法"></a>线程安全的实现方法</h3><h4 id="互斥同步"><a href="#互斥同步" class="headerlink" title="互斥同步"></a>互斥同步</h4><ul><li>保证共享数据在同一时刻只被一个（使用信号量的条件下是一些）线程使用</li><li>是一种悲观的同步策略</li><li>在Java中使用<code>synchronized</code>关键字进行同步。</li></ul><h4 id="非阻塞同步"><a href="#非阻塞同步" class="headerlink" title="非阻塞同步"></a>非阻塞同步</h4><ul><li>基于冲突检测的乐观并发策略，即先进行操作，如果没有其它线程竞争，那么操作成功；反之，再采取其它补偿措施（最常见的措施是不断重试，直到成功为止），需要硬件保证操作和冲突检测两个步骤具备原子性。</li><li>CAS指令：当且仅当内存值和预期值相等时，使用新值更新内存值，否则不更新。</li><li>ABA问题：在某线程获取变量值时是A，在检查之前被改为了B，然后又恢复了A，检查时会认为该变量没有修改过。多数情况下该问题不影响程序的并发，如需解决，改为使用互斥同步可能更有效。</li></ul><h4 id="无同步方案"><a href="#无同步方案" class="headerlink" title="无同步方案"></a>无同步方案</h4><ul><li>可重入代码：可以在代码执行的任何时刻中断它，转而去执行另外一段代码（包括递归调用它本身），在中断返回后，原来的程序不会出现任何错误。</li><li>线程本地存储：把使用共享数据的代码放入同一线程中。</li></ul><h3 id="锁优化"><a href="#锁优化" class="headerlink" title="锁优化"></a>锁优化</h3><h4 id="自旋锁"><a href="#自旋锁" class="headerlink" title="自旋锁"></a>自旋锁</h4><ul><li>让请求锁的线程进行短暂的等待，看锁是否很快就被释放。</li><li>避免了线程切换开销，但是等待时间过长会浪费CPU资源</li><li>自适应自旋锁：是否自旋、自旋时间不再确定，由前一次在同一个对象上的自旋锁时间和拥有者的状态决定。</li></ul><h4 id="锁消除"><a href="#锁消除" class="headerlink" title="锁消除"></a>锁消除</h4><ul><li>对一些代码上要求同步，但是被检测到不可能存在共享数据竞争的锁进行消除。判定依据来源于逃逸分析。</li><li>一些线程同步代码是内嵌的Java内部的，可以通过锁消除进行优化。</li></ul><h4 id="锁粗化"><a href="#锁粗化" class="headerlink" title="锁粗化"></a>锁粗化</h4><ul><li>如果有连续的对同一个对象加锁，则虚拟机会把加锁同步的范围扩大至整个操作序列外部，以减少加锁解锁带来的性能损耗。</li></ul><h4 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h4><ul><li>使用CAS操作和对象的Mark Word实现的锁机制。</li><li>前提是绝大部分的锁在同步周期内是不存在竞争的，因此CAS操作避免了使用互斥量的开销。但是如果存在锁竞争，轻量级锁比传统的互斥同步还多出CAS操作的消耗。</li></ul><h4 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h4><ul><li>该种锁偏向于第一个获得它的线程，在接下来的执行过程中，如果该锁没有被其它线程获取，则持有偏向锁的线程将永远不会进行同步。一旦有其它线程获取该锁，偏向模式即结束，转变为传统的互斥同步。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入理解Java虚拟机笔记0x02</title>
      <link href="/2019/06/23/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x02/"/>
      <url>/2019/06/23/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x02/</url>
      
        <content type="html"><![CDATA[<h1 id="虚拟机类加载机制"><a href="#虚拟机类加载机制" class="headerlink" title="虚拟机类加载机制"></a>虚拟机类加载机制</h1><h2 id="类加载时机"><a href="#类加载时机" class="headerlink" title="类加载时机"></a>类加载时机</h2><h3 id="类的生命周期"><a href="#类的生命周期" class="headerlink" title="类的生命周期"></a>类的生命周期</h3><ul><li>包括：加载、验证、准备、解析、初始化、使用、卸载。其中，验证、准备、解析统称为链接。</li></ul><h3 id="类初始化条件（当且仅当）"><a href="#类初始化条件（当且仅当）" class="headerlink" title="类初始化条件（当且仅当）"></a>类初始化条件（当且仅当）</h3><ol><li>遇到new、getstatic、putstatic、invokestatic字节码指令时，如果类没有初始化则触发其初始化。使用场景：<ul><li>使用new实例化对象</li><li>读取或设置一个类的静态字段（不含被final修饰、已在编译期把结果放入常量池的静态字段）</li><li>调用一个类的静态方法</li></ul></li><li>对类进行反射调用的时候，如果类没有初始化则触发其初始化。</li><li>初始化一个类的时候，如果发现其父类没有初始化，则触发其父类的初始化。</li><li>虚拟机启动时会先初始化用户指定的主类（包含main()方法）。</li><li>使用动态语言支持时*。</li></ol><h2 id="类加载过程"><a href="#类加载过程" class="headerlink" title="类加载过程"></a>类加载过程</h2><h3 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h3><h4 id="主要步骤"><a href="#主要步骤" class="headerlink" title="主要步骤"></a>主要步骤</h4><ol><li>通过一个类的全限定名来获取定义此类的二进制字节流</li><li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据结构。</li><li>在内存中生成一个代表这个类的java.lang.Class对象，作为方法区中这个类的各种数据的访问入口。</li></ol><h4 id="加载方式"><a href="#加载方式" class="headerlink" title="加载方式"></a>加载方式</h4><ul><li>对于非数组类的加载，可以使用系统提供的引导类加载器来完成，也可以由用户自定义的类加载器完成（重写loadClass()）</li><li>对于数组类的加载，主要遵循以下规则：<ul><li>如果数组的组件类型（去掉一个维度）是引用类型，那就递归进行组件类型的加载，数组类将在加载该组件类型的类加载器的类名称空间上被标识。</li><li>如果数组的组件类型不是引用类型，虚拟机将会把数组类标记为与引导类加载器关联。</li><li>数组类的可见性与它的组件类型一致，如果组件类型不是引用类型，那数组的可见性将默认为public。</li></ul></li></ul><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><ul><li>主要为了确保Class文件的字节流中包含的信息符合当前虚拟机要求，并且不会危害虚拟机自身的安全。大致包括4个方面：文件格式验证、元数据验证、字节码验证、符号引用验证。</li></ul><h4 id="文件格式验证"><a href="#文件格式验证" class="headerlink" title="文件格式验证"></a>文件格式验证</h4><ul><li>文件是否以魔数开头</li><li>主、次版本号是否在当前虚拟机的处理范围内</li><li>常量池中的常量是否有不支持的常量类型</li><li>…</li></ul><h4 id="元数据验证"><a href="#元数据验证" class="headerlink" title="元数据验证"></a>元数据验证</h4><ul><li>是否有父类（除java.lang.Object以外，所有类都应当有父类）</li><li>父类是否继承类不允许被继承的类（被final修饰的类）</li><li>非抽象类是否实现了其父类以及接口中所有要求实现的方法</li><li>类中的字段、方法是否与父类产生矛盾（覆盖了父类中的final字段，重载方法参数一致但返回类型不同等不合规则的重载）</li><li>…</li></ul><h4 id="字节码验证"><a href="#字节码验证" class="headerlink" title="字节码验证"></a>字节码验证</h4><ul><li>确保操作数栈的数据类型与指令代码操作匹配</li><li>确保跳转指令不会跳转到方法体以外的字节码指令上</li><li>确保方法体的类型转换是有效的（父类转换为子类、或者不相干的两种类型的数据互相转换是危险的）</li><li>…</li></ul><h4 id="符号引用验证"><a href="#符号引用验证" class="headerlink" title="符号引用验证"></a>符号引用验证</h4><ul><li>符号引用中通过字符串描述的全限定名是否能找到对应的类</li><li>在指定类中是否存在符合方法的字段描述符以及简单名称所描述的方法和字段</li><li>符号引用中的类、字段、方法的访问性（private、protected、public，default）是否可被当前类访问</li><li>…</li></ul><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><ul><li>为类变量分配内存并设置初始值，这些变量所使用的内存将在方法区中分配。<ul><li>分配内存的变量仅包括被static修饰的变量，不包括实例变量。</li><li>初始值为数据类型的零值，而如果变量的字段属表中存在ConstantValue属性（被final修饰）则初始值为定义的值。</li></ul></li></ul><h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><ul><li>将常量池内的符号引用替换为直接引用的过程</li><li>符号引用：以一组符号来描述所引用的目标，符号可以是任何形式的字面量，只要使用时能无歧义地定位带目标即可。</li><li>直接引用：可以是直接指向目标的指针、相对偏移量或是一个能间接定位到目标的句柄。</li></ul><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><ul><li>根据用户的程序制定的计划来初始化类变量和其他资源</li></ul><h2 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h2><ul><li>类加载器是在虚拟机外实现的、通过类的全限定名来获取描述此类的二进制字节流的模块，可以让应用程序自行决定如何去获取所需要的类。</li><li>对于任意一个类，都需要由加载它的类加载器和这个类本身一同确立其在Java虚拟机中的唯一性，每一个类加载器，都拥有一个独立的类名称空间。即使两个类来源于同一个Class文件、同时处于同一个虚拟机中，它们的类加载器不同，那么它们就不属于同一个类。</li></ul><h3 id="类加载器分类"><a href="#类加载器分类" class="headerlink" title="类加载器分类"></a>类加载器分类</h3><h4 id="对虚拟机而言"><a href="#对虚拟机而言" class="headerlink" title="对虚拟机而言"></a>对虚拟机而言</h4><ul><li>启动类加载器，是虚拟机的一部分</li><li>其他类加载器，独立于虚拟机外部</li></ul><h4 id="对开发人员而言"><a href="#对开发人员而言" class="headerlink" title="对开发人员而言"></a>对开发人员而言</h4><ul><li>启动类加载器，加载<code>&lt;JAVA_HOME&gt;/lib</code>目录下，或者是虚拟机配置中指定路径的，并且被虚拟机识别的（按文件名识别）的类库。</li><li>扩展类加载器，加载<code>&lt;JAVA_HOME&gt;/lib/ext</code>目录下，或被java.ext.dirs系统变量指定路径下的所有类库。</li><li>应用程序类加载器，加载用户类路径下所指定的类库，如果应用程序没有指定自己的类加载器，将默认使用该类加载器。</li><li>自定义类加载器。</li></ul><h3 id="双亲委派模型"><a href="#双亲委派模型" class="headerlink" title="双亲委派模型"></a>双亲委派模型</h3><p><img src="/images/2019-06-23_155659.png" alt="类加载器的双亲委派"></p><ul><li>如上图所示，这种类加载器的层次关系即类加载器的双亲委派模型。</li><li>工作过程：如果一个类加载器收到了类加载请求，它不会先去尝试加载该类，而是把该请求委派给父类加载器去加载，每一层都是如此，即所有类加载请求都会到顶层的启动类加载器中。只有当父加载器反馈在其搜索范围内没有搜索到所需的类，无法完成加载请求时，子加载器才会尝试自己去加载。</li><li>优点：使用双亲委派模型后，Java类随着它的类加载器一起具备了一种带有优先级的层级关系。例如类java.lang.Object，无论是哪一个类加载器需要加载这个类，最终都是交给启动类加载器来加载，保证了Object类在不同的类加载器环境中都是同一个类。</li></ul><h1 id="程序编译与代码优化"><a href="#程序编译与代码优化" class="headerlink" title="程序编译与代码优化"></a>程序编译与代码优化</h1><h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><ul><li>真实泛型：存在于任意阶段的代码，在系统运行期间生成，有自己的虚方法和类型数据。这种现象称为类型膨胀，基于这种方法实现的泛型称为真实泛型，例如C#。</li><li>伪泛型：泛型仅存在于源码，编译后仅剩原生类型（又称裸类型），并加入强制类型转换。这种方法称为类型擦除，基于这种方法实现的泛型称为伪泛型。Java泛型是伪泛型。</li></ul><h2 id="即时编译"><a href="#即时编译" class="headerlink" title="即时编译"></a>即时编译</h2><ul><li>在程序运行过程中，“热点代码”会被即时编译为机器码以提高运行速度，包括被多次调用的方法和被多次调用的循环体。</li><li>热点探测：用于判断一段代码是否为热点代码，是否需要触发即时编译，主要有两种技术：<ul><li>基于采样的热点探测：周期性检查各个线程的栈顶，如果发现某个或者某些方法经常在栈顶出现，则认为这个或这些方法为热点方法。优点是实现简单，高效，容易获得方法调用关系（展开调用堆栈），缺点是难以精确的判定方法的热度，易受线程阻塞等因素影响。</li><li>基于计数器的热点探测：设置计数器，统计方法调用次数；设置阈值，如果调用次数超过该阈值则认为其是热点方法。</li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入理解Java虚拟机笔记0x01</title>
      <link href="/2019/06/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x01/"/>
      <url>/2019/06/20/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x01/</url>
      
        <content type="html"><![CDATA[<h1 id="类文件结构"><a href="#类文件结构" class="headerlink" title="类文件结构"></a>类文件结构</h1><h2 id="魔数"><a href="#魔数" class="headerlink" title="魔数"></a>魔数</h2><ul><li><code>0xCAFEBABE</code>，用于表示文件类型，4字节。</li></ul><h2 id="Class文件版本"><a href="#Class文件版本" class="headerlink" title="Class文件版本"></a>Class文件版本</h2><ul><li>4字节，高版本能够兼容低版本，但是不能运行更新版本的Class文件。</li></ul><h2 id="常量池"><a href="#常量池" class="headerlink" title="常量池"></a>常量池</h2><ul><li>入口有表示常量池容量计数值。</li><li>主要包含字面量和符号引用。</li><li>字面量：接近Java语言层面的常量概念，例如文本字符串，声明为final的常量值等。</li><li>符号引用：包括类和接口的全限定名（含包名以及类名）、字段的名称和描述符、方法的名称和描述符。</li></ul><h2 id="访问标志"><a href="#访问标志" class="headerlink" title="访问标志"></a>访问标志</h2><ul><li>用于标识该Class是类还是接口、是否为public、是否为abstract、是类的话是否为final等。</li></ul><h2 id="类索引、父类索引与接口索引集合"><a href="#类索引、父类索引与接口索引集合" class="headerlink" title="类索引、父类索引与接口索引集合"></a>类索引、父类索引与接口索引集合</h2><ul><li>用于确定类的继承关系。</li></ul><h2 id="字段表集合"><a href="#字段表集合" class="headerlink" title="字段表集合"></a>字段表集合</h2><ul><li>用于描述接口或者类中声明的变量，包括类级变量以及实例级变量，但是不包括方法内部声明的局部变量。</li><li>字段描述信息包括：字段作用域（public、private、protected）、可变性（final）、并发可见性（volatile，是否强制从主内存读写）、可否被序列化（transient）、字段数据类型（基本类型、对象、数组）。</li></ul><h2 id="方法表集合"><a href="#方法表集合" class="headerlink" title="方法表集合"></a>方法表集合</h2><ul><li>类似字段表，同样包含类访问标志、名称索引、描述符索引、属性表集合等。</li><li>方法中的代码在属性表集合中。</li></ul><h2 id="属性表集合"><a href="#属性表集合" class="headerlink" title="属性表集合"></a>属性表集合</h2><h3 id="Code属性"><a href="#Code属性" class="headerlink" title="Code属性"></a>Code属性</h3><ul><li>Class文件中最重要的一个属性，主要包括方法编译后的字节码。</li><li>异常表也在Code属性中，表示确定的代码范围（开始行数到结束行数）如果出现了某些异常要跳转到到位置。</li></ul><h2 id="字节码"><a href="#字节码" class="headerlink" title="字节码"></a>字节码</h2><h3 id="支持的数据类型"><a href="#支持的数据类型" class="headerlink" title="支持的数据类型"></a>支持的数据类型</h3><ul><li>byte、short、int、long、float、double、char、reference</li></ul><h3 id="指令类型"><a href="#指令类型" class="headerlink" title="指令类型"></a>指令类型</h3><ul><li>加载和存储指令：常量读进操作栈、局部变量表读进操作栈、操作栈写入局部变量表</li><li>运算指令：加法、减法、乘法、除法、求余、取反、位移、按位与、按位或、按位异或、自增、比较</li><li>类型转换指令</li><li>对象创建与访问指令：创建类实例、创建数组、访问类与实例、加载数组元素、写回数组元素、取数组长度</li><li>操作数栈管理指令：出栈、复制栈顶元素并入栈、交换栈顶两个元素</li><li>控制转移指令：条件分支、复合条件分支、无条件分支</li><li>方法调用和返回指令</li><li>异常处理指令</li><li>同步指令</li></ul>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>深入理解Java虚拟机笔记0x00</title>
      <link href="/2019/06/19/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2019/06/19/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="JVM内存模型"><a href="#JVM内存模型" class="headerlink" title="JVM内存模型"></a>JVM内存模型</h1><ul><li>程序计数器：线程私有，用于表示当前执行的字节码地址。</li><li>虚拟机栈：线程私有，方法执行时创建一个栈帧，存储局部变量表、操作数栈、动态链接、方法出口等，服务于字节码。</li><li>本地方法栈：同虚拟机栈，但为本地方法服务。</li></ul><blockquote><p>本地方法：由Java调用非Java代码接口。</p></blockquote><ul><li>堆：存放对象实例。</li><li>方法区：已加载类的信息、常量、静态变量、即时编译后的代码。其中包括运行常量池。</li></ul><h1 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h1><h2 id="创建对象步骤"><a href="#创建对象步骤" class="headerlink" title="创建对象步骤"></a>创建对象步骤</h2><ol><li>检查类的符号引用，若没有则进行类加载过程。</li><li>分配内存。</li><li>内存空间初始化（不含对象头）。</li><li>配置对象头。</li><li>执行构造函数。</li></ol><h2 id="对象的内存分配"><a href="#对象的内存分配" class="headerlink" title="对象的内存分配"></a>对象的内存分配</h2><p>包括对象头，实例数据，对齐填充</p><h2 id="对象头"><a href="#对象头" class="headerlink" title="对象头"></a>对象头</h2><ul><li>存储自身运行时数据，例如HashCode、GC分代年龄、锁状态等。</li><li>类型指针。</li><li>如果为数组，则还要有用于记录数组长度等块。</li></ul><h2 id="对象等访问定位"><a href="#对象等访问定位" class="headerlink" title="对象等访问定位"></a>对象等访问定位</h2><p>通过栈 -&gt; reference -&gt; 堆来操作对象，可以通过句柄或者直接指针访问。</p><h1 id="Java-GC"><a href="#Java-GC" class="headerlink" title="Java GC"></a>Java GC</h1><h2 id="存活对象判断"><a href="#存活对象判断" class="headerlink" title="存活对象判断"></a>存活对象判断</h2><h3 id="引用计数算法"><a href="#引用计数算法" class="headerlink" title="引用计数算法"></a>引用计数算法</h3><ul><li>为对象添加引用计数器，每次产生引用加1，引用失效减1。</li><li>缺点：难以解决对象之间循环引用的问题。</li></ul><h3 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h3><ul><li>从GC Root节点沿引用链向下搜索，当从GC Root到某对象不可达时则该对象应该被回收。</li></ul><h2 id="垃圾收集算法"><a href="#垃圾收集算法" class="headerlink" title="垃圾收集算法"></a>垃圾收集算法</h2><ul><li>标记 - 清除算法：先通过可达性分析标记需要回收的对象，完成后统一回收所用被标记的对象。</li><li>复制算法：将内存划分为两块，每次只用其中一块。用尽时，将存活的对象复制到另外一块上，然后将该块内存全部清理。主要用于新生代的内存回收。缺点是会浪费部分内存。</li><li>标记 - 整理算法：标记步骤同标记 - 清除算法，整理则是将存活对象向内存的一端移动，然后清掉边界外的内存。</li><li>分代收集：根据对象存活周期的不同，将村村划分为几块。一般是把Java堆分成新生代和老年代。</li></ul><h2 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h2><h3 id="Serial收集器"><a href="#Serial收集器" class="headerlink" title="Serial收集器"></a>Serial收集器</h3><ul><li>单线程，STW 100ms以内。作用于新生代时采用复制算法，作用于老年代时使用标记 - 整理算法。</li></ul><h3 id="ParNew收集器"><a href="#ParNew收集器" class="headerlink" title="ParNew收集器"></a>ParNew收集器</h3><ul><li>Serial收集器的多线程版</li></ul><h3 id="Parallel-Scavenge收集器"><a href="#Parallel-Scavenge收集器" class="headerlink" title="Parallel Scavenge收集器"></a>Parallel Scavenge收集器</h3><ul><li>同ParNew收集器，回收新生代，目标为达到可控制的吞吐量。</li></ul><h3 id="CMS收集器"><a href="#CMS收集器" class="headerlink" title="CMS收集器"></a>CMS收集器</h3><ul><li>采用标记 - 清除算法。</li><li>步骤：<ol><li>初始标记，STW</li><li>并发标记，与其他线程同步运行</li><li>重新标记，STW</li><li>并发清除</li></ol></li><li>缺点：<ol><li>并发阶段会占用CPU资源而导致吞吐量下降</li><li>无法处理浮动垃圾（并发清除时产生的垃圾）</li><li>标记 - 清除带来的内存碎片问题</li></ol></li></ul><h3 id="G1收集器"><a href="#G1收集器" class="headerlink" title="G1收集器"></a>G1收集器</h3><ul><li>采用标记 - 整理算法。</li><li>优势：<ol><li>利用多CPU、多核，缩短STW</li><li>分代收集</li><li>使用复制算法减少碎片产生</li><li>可预测停顿</li></ol></li><li>G1收集器将堆划分成大小相同堆多个Region，新生代和老年代不再物理隔离。跟踪Region中垃圾价值大小，维护优先列表，优先回收价值最大的Region。</li><li>步骤：<ol><li>初始标记，STW</li><li>并发标记</li><li>最终标记，STW</li><li>筛选回收，STW</li></ol></li></ul><h2 id="内存分配与回收策略"><a href="#内存分配与回收策略" class="headerlink" title="内存分配与回收策略"></a>内存分配与回收策略</h2><ol><li>对象优先在Eden分配，若Eden区没有足够空间则出发minor GC</li><li>大对象直接进入老年代</li><li>长期存活对象进入老年代</li><li>动态的对象年龄判定：如果Survivor区相同年龄所有对象大小的总和大于Survivor区的一半，则年龄大于或等于该年龄的对象就可以直接进入老年代</li><li>空间分配担保<ul><li>老年代最大可用连续空间是否大于新生代所有对象空间，是则进行minor GC安全。</li><li>老年代最大可用连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，则minor GC有风险，可能会再次出发full GC，反之若小于，或者设置不允许冒险，则直接进行full GC。</li></ul></li></ol>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录：在CentOS下安装VirtualBox</title>
      <link href="/2017/12/25/%E8%AE%B0%E5%BD%95%EF%BC%9A%E5%9C%A8CentOS%E4%B8%8B%E5%AE%89%E8%A3%85VirtualBox/"/>
      <url>/2017/12/25/%E8%AE%B0%E5%BD%95%EF%BC%9A%E5%9C%A8CentOS%E4%B8%8B%E5%AE%89%E8%A3%85VirtualBox/</url>
      
        <content type="html"><![CDATA[<ul><li>安装<code>kernel-devel</code>，注意和系统内核版本对应。查看系统内核版本：</li></ul><pre class=" language-shell"><code class="language-shell">uname -r</code></pre><ul><li>安装其他依赖：</li></ul><pre class=" language-shell"><code class="language-shell">yum install -y SDL gcc make perl</code></pre><ul><li>到官网上下载CentOS对应的rpm安装包，下载并安装即可。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录：MySQL在Windows/CentOS下的安装</title>
      <link href="/2017/12/25/%E8%AE%B0%E5%BD%95%EF%BC%9Amysql%E5%9C%A8windows-centos%E4%B8%8B%E7%9A%84%E5%AE%89%E8%A3%85/"/>
      <url>/2017/12/25/%E8%AE%B0%E5%BD%95%EF%BC%9Amysql%E5%9C%A8windows-centos%E4%B8%8B%E7%9A%84%E5%AE%89%E8%A3%85/</url>
      
        <content type="html"><![CDATA[<h2 id="Windows-7下安装MySQL"><a href="#Windows-7下安装MySQL" class="headerlink" title="Windows 7下安装MySQL"></a>Windows 7下安装MySQL</h2><ul><li><p><a href="https://www.microsoft.com/zh-cn/download/details.aspx?id=17718" target="_blank" rel="noopener">www.microsoft.com</a>下载并安装<code>.NET Framework 4.0</code></p></li><li><p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=30653" target="_blank" rel="noopener">www.microsoft.com</a>下载并安装<code>.NET Framework 4.5</code></p></li><li><p><a href="https://www.microsoft.com/en-us/download/details.aspx?id=40784" target="_blank" rel="noopener">www.microsoft.com</a>下载并安装VC++ 2013运行库。注意，需要安装32位，64位可选。</p></li><li><p><a href="https://www.microsoft.com/zh-CN/download/details.aspx?id=48145" target="_blank" rel="noopener">www.microsoft.com</a>下载并安装VC++ 2015运行库。</p></li><li><p><a href="https://dev.mysql.com/downloads/windows/" target="_blank" rel="noopener">dev.mysql.com</a>下载并安装对应Windows的<code>MySQL Installer</code></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MySQL </tag>
            
            <tag> CentOS </tag>
            
            <tag> Database </tag>
            
            <tag> Windows </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录：给centos/rhel服务器安装GNOME以及VNC，实现界面远程控制服务器</title>
      <link href="/2017/12/24/%E8%AE%B0%E5%BD%95%EF%BC%9A%E7%BB%99centos-rhel%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85GNOME%E4%BB%A5%E5%8F%8AVNC%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%9B%BE%E5%BD%A2%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2017/12/24/%E8%AE%B0%E5%BD%95%EF%BC%9A%E7%BB%99centos-rhel%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%AE%89%E8%A3%85GNOME%E4%BB%A5%E5%8F%8AVNC%EF%BC%8C%E5%AE%9E%E7%8E%B0%E5%9B%BE%E5%BD%A2%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="服务器部分（CentOS-7）"><a href="#服务器部分（CentOS-7）" class="headerlink" title="服务器部分（CentOS 7）"></a>服务器部分（CentOS 7）</h2><ul><li>安装GNOME：</li></ul><pre class=" language-shell"><code class="language-shell">yum groupinstall -y "GNOME Desktop"</code></pre><ul><li>安装VNC</li></ul><pre class=" language-shell"><code class="language-shell">yum install vnc-server vnc*</code></pre><ul><li>修改<code>/etc/sysconfig/vncservers</code>：</li></ul><pre class=" language-config"><code class="language-config">VNCSERVERS="1:root"VNCSERVERARGS[1]="-geometry 1024x768 -alwaysshared -depth 24"</code></pre><ul><li>添加/修改<code>/root/.vnc/xstartup</code></li></ul><pre class=" language-config"><code class="language-config">#!/bin/shunset SESSION_MANAGER[ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup[ -r $HOME/.Xresources ] && xrdb $HOME/.Xresourcesxsetroot -solid grey vncconfig -iconic &gnome-session &</code></pre><ul><li><p>终端输入<code>vncpasswd</code>并根据提示设置密码。</p></li><li><p>终端输入<code>vncserver</code>以启动vncserver。</p></li><li><p>防火墙开启端口<code>5901</code>、<code>6001</code>：</p></li></ul><pre class=" language-shell"><code class="language-shell">iptables -A INPUT -p tcp --dport 3836 -j ACCEPTiptables -A INPUT -p tcp --sport 3836 -j ACCEPTiptables -A INPUT -p tcp --dport 9996 -j ACCEPTiptables -A INPUT -p tcp --sport 9996 -j ACCEPTiptables-save</code></pre><h2 id="客户端部分（Windows）"><a href="#客户端部分（Windows）" class="headerlink" title="客户端部分（Windows）"></a>客户端部分（Windows）</h2><ul><li><p>下载<code>VNC-Viewer</code>并安装。</p></li><li><p>建立连接，输入<code>&lt;ip&gt;:1</code>，其中<code>&lt;ip&gt;</code>为装有VNC的服务器地址，按回车后输入密码即可。</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记录：rhel中yum换centos源</title>
      <link href="/2017/12/24/%E8%AE%B0%E5%BD%95%EF%BC%9Arhel%E4%B8%ADyum%E6%8D%A2centos%E6%BA%90/"/>
      <url>/2017/12/24/%E8%AE%B0%E5%BD%95%EF%BC%9Arhel%E4%B8%ADyum%E6%8D%A2centos%E6%BA%90/</url>
      
        <content type="html"><![CDATA[<ul><li>删除原来的yum</li></ul><pre class=" language-shell"><code class="language-shell">rpm -qa | grep yum | xargs rpm -e --nodeps</code></pre><ul><li><p>使用<code>curl</code>或<code>wget</code>从<code>http://mirrors.163.com/centos/7/os/x86_64/</code>下载yum及其依赖安装包，包括<code>yum</code>、<code>yum-metadata-parser</code>、<code>yum-plugin-fastestmirror</code>、<code>python-urlgrabber</code>并安装。如果出现冲突则使用<code>rpm -i --force --nodeps</code>强制安装。有可能需要升级<code>rpm</code>，同样下载安装包并强制安装。</p></li><li><p>从<code>http://mirrors.163.com</code>的centos帮助文档中获取对应的repo文件，放入<code>/etc/yum.d.repo/</code>,然后执行：</p></li></ul><pre class=" language-shell"><code class="language-shell">yum clean allyum makecache</code></pre>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB笔记0x05</title>
      <link href="/2017/10/28/MongoDB%E7%AC%94%E8%AE%B00x05/"/>
      <url>/2017/10/28/MongoDB%E7%AC%94%E8%AE%B00x05/</url>
      
        <content type="html"><![CDATA[<h2 id="4-4-where查询"><a href="#4-4-where查询" class="headerlink" title="4.4 $where查询"></a>4.4 $where查询</h2><p><code>$where</code>可以进行任何的查询。比较常用的是比较文档中两个键的值是否相等。但是如果非必要，务必不要使用<code>$where</code>进行查询。因为<code>$where</code>查询要比常规查询慢很多，<code>$where</code>查询会把每个文档从BSON转换为JavaScript对象，然后再进行查询，而且<code>$where</code>不能使用索引。如果必须使用<code>$where</code>，也尽量先用常规查询进行过滤再使用<code>$where</code>来查询。</p><h2 id="4-5-游标"><a href="#4-5-游标" class="headerlink" title="4.5 游标"></a>4.5 游标</h2><p>游标可以保存一次查询的结果并提供逐条查看结果。例如：</p><pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> cursor <span class="token operator">=</span> db<span class="token punctuation">.</span>foo<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>此时游标仅是保存了查询的构造，而并没有向服务器发起查询。在执行：</p><pre class=" language-js"><code class="language-js">cursor<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>后，查询请求才会到达服务器，返回查询结果。接下来的<code>cursor.next()</code>以及<code>cursor.hasNext()</code>均是在本地执行的。</p><p>针对返回结果的限制的方法有<code>limit</code>、<code>skip</code>、<code>sort</code>。<code>limit</code>可以限制返回结果数量，即最多返回指定数量的文档；<code>skip</code>可以略过指定数量的文档，如果结果收少于指定数量则不返回结果；<code>sort</code>可以按照指定的键值大小进行文档的排序，例如：</p><pre class=" language-js"><code class="language-js">db<span class="token punctuation">.</span>c<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  username<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>  age<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>这表示针对<code>username</code>进行升序排列，针对<code>age</code>斤西瓜降序排列。这三种方法可以组合使用，链式写法即可。</p><p>此外，<code>sort</code>如果对类型不一致的键值进行排序时是有指定类型循序的：（1）最小值；（2）null；（3）数字（整型、长整型、双精度）；（4）字符串；（5）对象/文档；（6）数组；（7）二进制数据（8）对象ID；（9）布尔型；（10）日期型；（11）时间戳；（12）正则表达式；（13）最大值。</p><p>如果需要排序的结果集的大小超过32M，MongoDB就会报错，拒绝对过多的数据进行排序。</p><p>使用<code>skip</code>跳过大量的文档会变得很慢，因为这些需要略过的文档也需要被找出，然后再抛弃这些文档。</p><p>高级查询选项：如<code>find({&quot;foo&quot;: &quot;bar&quot;}).sort({&quot;x&quot;: 1})</code>在shell或者其它驱动程序中并不是直接发出<code>{&quot;foo&quot;: &quot;bar&quot;}</code>这样的查询请求，而是将它们封装进更大的查询文档中，像这样：</p><pre class=" language-js"><code class="language-js"><span class="token punctuation">{</span>  <span class="token string">"$query"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"foo"</span><span class="token punctuation">:</span> <span class="token string">"bar"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token string">"$orderby"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"x"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>此外还有一些其他的辅助查询操作，例如<code>$maxscan</code>（指定本次查询中扫描文档的上限）、<code>$min</code>（文档必须与索引的键完全匹配，并指定索引扫描的下边界）、<code>$max</code>（文档必须与索引的键完全匹配，并指定索引扫描的下边界）等。</p><p>像前文所说，MongoDB中文档是顺序存储的，如果对某个文档进行修改而使其体积变大，MongoDB会将其移动到所有文档后面存储。由于游标同样是向后查询文档，如果在前面修改了某个文档导致其变大被移动到了后面，游标向后移动时会再次查询到该文档。解决这个问题需要对查询结果进行快照，这样查询就在<code>_id</code>索引上遍历执行，保证每个文档只返回一次。使用快照会使查询变慢，所以应该只在必要的时候使用快照。</p><p>游标的生命周期：在服务端，游标占用内存等资源。当游标遍历了所有结果或者客户端发来信息要求终止，数据库会释放游标占用的资源。当然，还有一些其他情况会使得游标被删除，例如如果客户端的游标已经不在作用域内时，客户端会发出一个特殊的消息要求服务端销毁游标，或者10分钟内某个游标没有使用的话也会删除。</p><h2 id="4-6-数据库命令"><a href="#4-6-数据库命令" class="headerlink" title="4.6 数据库命令"></a>4.6 数据库命令</h2><p>数据库命令，例如<code>drop</code>，其实是一种特殊的查询，只不过服务端收到这类“查询”会进行特殊的逻辑处理。</p><h1 id="5-索引"><a href="#5-索引" class="headerlink" title="5 索引"></a>5 索引</h1><h2 id="5-1-索引简介"><a href="#5-1-索引简介" class="headerlink" title="5.1 索引简介"></a>5.1 索引简介</h2><p>索引可以根据给定字段组织数据，让MongoDB能够根据这些字段快速找到指定的文档。例如，为<code>username</code>创建索引：</p><pre class=" language-js"><code class="language-js">db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>建立索引所耗时间根据机器性能以及文档整体大小的不同而不同。虽然建立索引之后查询几乎会瞬间完成，但是其他操作，包括插入、更新、删除等将会消耗更多时间，因为这些操作会修改集合的结构，从而导致需要修改建立的索引。因此，MongoDB也限制每个集合上最多有64个索引，一般来说，一个特定的集合上不应该有两个以上的索引。挑选合适的字段建立索引非常重要。如果某个字段是常用的查询字段，那么在这个字段上建立索引是一个好选择，反之则没有必要建立索引。</p><p>索引的值是按照一定的顺序排列的，因此索引键对文档进行排序非常快。但是如果查询时没有首先使用索引键进行排序时，索引并不会发挥作用。不过可以针对多个字段建立复合索引。建立复合索引时优先考虑需要排序的键，将其放在首位索引键。</p><p>索引的排序方式并不重要，因为MongoDB可以在索引的任意方向进行便遍历。</p><p>有一些查询操作完全无法使用索引，例如<code>$where</code>、<code>$exists</code>、<code>$nin</code>查询只能进行全表扫描，而<code>$ne</code>、<code>$not</code>多数情况下也会进行全表扫描。</p><p><code>$or</code>查询实际上是两次查询，最后合并结果，这样的效率必然不如一次查询的效率高，因此尽可能使用<code>$in</code>代替。此外，MongoDB一次查询只能使用一个索引/复合索引，但是由于<code>$or</code>是两次独立的查询，所以它可以使用多个索引。</p><p>MongoDB可以针对嵌套文档的键建立索引，和建立普通的索引类似。例如文档：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"username"</span><span class="token operator">:</span> <span class="token string">"sid"</span><span class="token punctuation">,</span>  <span class="token property">"loc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"ip"</span><span class="token operator">:</span> <span class="token string">"1.2.3.4"</span><span class="token punctuation">,</span>    <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"Springfield"</span><span class="token punctuation">,</span>    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"NY"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>给<code>loc.city</code>建立索引：</p><pre class=" language-js"><code class="language-js">db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"loc.city"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>即可。但是注意和子文档<code>loc</code>的索引进行区分。如果建立的索引是子文档的索引，那么只有如下的查询才会使用子文档索引：</p><pre class=" language-js"><code class="language-js">db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token string">"loc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>    <span class="token string">"ip"</span><span class="token punctuation">:</span> <span class="token string">"123.234.111.222"</span><span class="token punctuation">,</span>    <span class="token string">"city"</span><span class="token punctuation">:</span> <span class="token string">"Shelbycille"</span><span class="token punctuation">,</span>    <span class="token string">"state"</span><span class="token punctuation">:</span> <span class="token string">"NY"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>即必须与子文档字段顺序完全匹配的子文档查询才能使用子文档索引，而：</p><pre class=" language-js"><code class="language-js">db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"loc.city"</span><span class="token punctuation">:</span> <span class="token string">"Shelbycille"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>才会使用子文档的键的索引。</p><p>同样可以给数组元素建立索引，但是不能给数组本身建立索引。给数组元素建立索引即给数组的每一个元素建立索引，因此数组索引的代价要高于单值索引的代价。并且，一个索引中的数组字段最多只允许有一个，以防止多个数组建立索引之后索引条目爆炸式增长。</p><p>多键索引：在索引中，如果某个键是数组，那么这个索引会被标记为多键索引。多键索引会比非多键慢一些，因为可能会有多个索引条目指向同一个文档，因此MongoDB在返回结果集时需要先去重。</p><p>索引基数：就是指某个字段对应不同值的数量。例如性别可能只有两种取值，这种字段的基数就比较低；像用户名、住址这类字段可能每个值和其他的都不一样，这类字段的基数就很高；也有介于两者之间的，例如年龄。通常情况下，一个字段的基数越高，那么对这个字段建立的索引越有价值，因为这个索引可以快速将查询范围缩小到一个比较小的结果集，以供下一步操作快速完成。因此建立索引应该选择基数高的字段，或者在复合索引中将基数高的字段提前。</p><h2 id="5-2-使用explain-和hint"><a href="#5-2-使用explain-和hint" class="headerlink" title="5.2 使用explain()和hint()"></a>5.2 使用explain()和hint()</h2><p><code>explain()</code>能够提供大量与查询相关的信息，其中返回的一些字段有助于发现查询速度慢的原因。以下列举一些字段：</p><p>（1）<code>cursor</code>：表示游标的类型。可以看出本次查询是否使用了索引以及使用的什么索引。</p><p>（2）<code>isMultiKey</code>：是否使用了多键索引。</p><p>（3）<code>n</code>：本次查询返回的文档数量。</p><p>（4）<code>nscannedObjects</code>：MongoDB按照索引指针去磁盘上查找文档的次数。如果查询包含的查询条件不是索引的一部分，或者要求返回的内容不在索引字段内，MongoDB就会从磁盘中读取原文档。</p><p>（5）<code>nscanned</code>：如果使用了索引，这个字段表示查找过的索引条目，如果没有使用索引，那么这个字段表示查找的文档数量。</p><p>（6）<code>scanAndOrder</code>：MongoDB是否对内存中的结果进行了排序。</p><p>（7）<code>indexOnly</code>：MongoDB是否只是用了索引就完成了此次查询，即包括查找字段以及返回的结果集都包含在索引中，又称覆盖索引。</p><p>（8）<code>nYields</code>：查询暂停次数，如果有写入请求，查询会周期性释放锁，以供写入执行。</p><p>（9）<code>millis</code>：查询所耗毫秒数。</p><p>（10）<code>indexBounds</code>：这个字段描述了索引的使用情况，给出了索引的遍历范围。</p><p><code>hint()</code>可以指定查询使用的索引。</p><p>查询优化器：与关系型数据库不同，当有多个索引可能适合本次查询时，MongoDB的查询优化器会并行执行这些查询，最早返回100个结果的索引就是“胜者”，并且这个索引会被缓存，在接下来的这个查询都会使用这个索引。如果建立了新的索引或者每执行1000次查询后，查询优化器就会重新评估查询计划。<code>explain()</code>返回的<code>allPlans</code>字段表示了本次查询尝试的每个查询计划。</p><h2 id="5-3-何时不应该使用索引"><a href="#5-3-何时不应该使用索引" class="headerlink" title="5.3 何时不应该使用索引"></a>5.3 何时不应该使用索引</h2><p>如果数据集较小时，索引会十分高效。但是当结果集在原集合中所占比例越大，索引查找的速度就越慢。因为使用索引需要进行两次查找，最坏情况下索引查找的时间是全表查找的两倍。一般来说，当查询需返回30%的文档或更多时，就需要对比索引查找和全表查找的速度。</p><h2 id="5-4-索引类型"><a href="#5-4-索引类型" class="headerlink" title="5.4 索引类型"></a>5.4 索引类型</h2><p>唯一索引：唯一索引可以确保集合的每一个文档的指定键都有唯一值。例如：</p><pre class=" language-js"><code class="language-js">db<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">ensureIndex</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"unique"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这样可以防止有重复键的插入。但是如果有第一个没有该键的文档插入时，该键将被创建，值会置为<code>null</code>，如果继续插入缺少该键的文档就会报错。</p><p>进行索引的所有字段都应当小于1024字节，否则这个条目将不会出现在索引中。如果唯一索引的字段超过8KB，唯一索引将会失效。</p><p>可以创建复合的唯一索引，复合唯一索引中，单个键的值可以重复，但是所有键的值的组合必须在集合中是唯一的。</p><p>稀疏索引：区别与关系型数据库中的稀疏索引，这里的稀疏索引是指如果文档包含指定字段，则为这些文档建立索引。如果和唯一索引一起使用，则这些字段的值必须唯一。</p><h2 id="5-5-索引管理"><a href="#5-5-索引管理" class="headerlink" title="5.5 索引管理"></a>5.5 索引管理</h2><p>索引的元信息保存在<code>system.indexes</code>中，可以通过<code>db.collectionName.getIndexes()</code>来查看集合的索引。</p><p>索引的标识形如<code>keyname1_dir1_keyname2_dir2_..._keynameN_dirN</code>，索引标识也是有长度限制的。</p><p>如果需要删除索引，可以使用<code>dropIndex</code>。</p>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB笔记0x04</title>
      <link href="/2017/10/27/MongoDB%E7%AC%94%E8%AE%B00x04/"/>
      <url>/2017/10/27/MongoDB%E7%AC%94%E8%AE%B00x04/</url>
      
        <content type="html"><![CDATA[<h1 id="4-查询"><a href="#4-查询" class="headerlink" title="4 查询"></a>4 查询</h1><h2 id="4-1-find"><a href="#4-1-find" class="headerlink" title="4.1 find"></a>4.1 find</h2><p>在MongoDB中，使用<code>find()</code>来进行查询操作。第一个参数是查询条件，类型为文档，其中包括希望返回结果满足的键值对的要求。如果有对个键值对，将视为“与”进行查询。</p><p><code>find()</code>的第二个参数为希望返回/不返回的键，类型为文档，键即文档的键，值为1则返回该键值对，值为0则不返回该键值对。<code>_id</code>默认是返回的，如果不希望返回<code>_id</code>，可以使用<code>&quot;_id&quot;: 0</code>。</p><h2 id="4-2-查询条件"><a href="#4-2-查询条件" class="headerlink" title="4.2 查询条件"></a>4.2 查询条件</h2><p>除了精确查询以外，还可以使用<code>$lt</code>、<code>$lte</code>、<code>$gt</code>、<code>$gte</code>来进行范围查询，它们分别表示<code>&lt;</code>、<code>&lt;=</code>、<code>&gt;</code>、<code>&gt;=</code>。例如：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"age"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"$gt"</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span>    <span class="token property">"$lt"</span><span class="token operator">:</span> <span class="token number">30</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>上述查询条件表示查找键名<code>&quot;age&quot;</code>值大于18小于30的文档。另外，<code>$ne</code>表示不相等。</p><p>关于<code>$in</code>、<code>$nin</code>：如果希望能查找某个键对应的多个值，可以使用<code>$in</code>。<code>$in</code>的参数为一个数组，数组中的值可以为任何类型，MongoDB会查找所有该键的值在数组中的文档。<code>$nin</code>则相反，会返回所有该键的值不在数组中的文档。</p><p>关于<code>$or</code>：<code>$or</code>可以进行不同键的“或”查询。和<code>$in</code>类似，其参数为一个数组，不过数组中的值均为文档类型。文档中即普通的查询条件。</p><p><code>$not</code>：<code>$not</code>会返回所有不符合参数中查询条件的文档。和<code>$and</code>、<code>$or</code>都被称为“元操作符”。</p><p><code>null</code>值：如果查询时设置值为<code>null</code>，则查询不仅会返回对应键值为<code>null</code>的文档，还会返回没有对应键的文档。如果不希望返回这些缺少键的文档，可以使用<code>$exist</code>来判断键值对是否存在。</p><p>正则表达式：进行匹配的值可以是正则表达式，所有含有匹配正则表达式的对应键值的文档都会被返回。使用正则表达式进行查询之前最好在shell中进行正则表达式的验证来防止出现问题。</p><p>数组查询：如果有一个文档：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"fruit"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"apple"</span><span class="token punctuation">,</span> <span class="token string">"banana"</span><span class="token punctuation">,</span> <span class="token string">"peach"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>如果查询条件如下：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"fruit"</span><span class="token operator">:</span> <span class="token string">"apple"</span><span class="token punctuation">}</span></code></pre><p>则之前的文档会成功匹配。即如上的查询条件意味着MongoDB会查找数组内部的值。但是如果查询条件如下：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"fruit"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"apple"</span><span class="token punctuation">,</span> <span class="token string">"banana"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>或</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"fruit"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"banana"</span><span class="token punctuation">,</span> <span class="token string">"apple"</span><span class="token punctuation">,</span> <span class="token string">"peach"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>都不会匹配所提供的文档。即值如果是数组的话会进行精确匹配，无论是缺项或者是乱序都不会匹配。</p><p><code>$all</code>：<code>$all</code>可以接受一个数组作为查询参数，只要对应键的数组中包含该数组内所有值的文档就会作为结果返回。其中<code>$all</code>的数组参数的顺序是无关紧要的。</p><p><code>$slice</code>：<code>$slice</code>可以限制返回的文档数。为正值时返回前面指定数目的文档，为负值时返回后面指定数目的文档。<code>$slice</code>还可以指定偏移，例如：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"comments"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"$slice"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>表示从第24个元素开始，返回10个文档，不足则全部返回。</p><p>数组和范围查询相互作用：例如文档：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">[</span>  <span class="token punctuation">{</span><span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span><span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span><span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span><span class="token property">"x"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span></code></pre><p>如果查询条件为：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"x"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"$gt"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>    <span class="token property">"$lt"</span><span class="token operator">:</span> <span class="token number">20</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>则结果会返回：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">[</span>  <span class="token punctuation">{</span><span class="token property">"x"</span><span class="token operator">:</span> <span class="token number">15</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span><span class="token property">"x"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span></code></pre><p>匹配<code>{&quot;x&quot;: [5, 25]}</code>的原因是<code>5</code>小于<code>20</code>且<code>25</code>大于<code>10</code>。</p><p>查询内嵌文档：如果直接进行查询的话需要内嵌文档完全一致（即和数组查询一样是精确匹配），而且不能针对内嵌文档进行范围等条件查询。使用<code>$elemMatch</code>来满足进行内嵌文档的查询。例如：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"comments"</span><span class="token operator">:</span><span class="token punctuation">{</span>    <span class="token property">"$elemMatch"</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token property">"author"</span><span class="token operator">:</span> <span class="token string">"Joe"</span><span class="token punctuation">,</span>      <span class="token property">"score"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"$gte"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>可以查到评论中Joe 大于等于5分的评论。</p>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB笔记0x03</title>
      <link href="/2017/10/24/MongoDB%E7%AC%94%E8%AE%B00x03/"/>
      <url>/2017/10/24/MongoDB%E7%AC%94%E8%AE%B00x03/</url>
      
        <content type="html"><![CDATA[<h1 id="3-3-更新文档"><a href="#3-3-更新文档" class="headerlink" title="3.3 更新文档"></a>3.3 更新文档</h1><p>更新<code>update()</code>可以接收两个参数，一个是查询条件，即需要修改哪个文档；另一个是需修改的内容。更新操作时不可分割的。如果有两个更新同时发生，则请求先到达服务器的先执行。系统则会保留最后的更新。<code>update</code>的第三个参数是<code>upsert</code>，类型为布尔值，为<code>true</code>则在查询过程中若没有找到符合条件的文档时会进行创建。第四个参数是是否修改查询得到的全部文档，默认为<code>false</code>，即只修改查询得到的第一个文档。</p><p>默认情况下，<code>update</code>中需修改的内容会被认为是替换原有文档，但是如果希望仅针对文档中的某键值修改的话，可以使用修改器，例如：</p><pre class=" language-js"><code class="language-js">db<span class="token punctuation">.</span>analytics<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>  <span class="token punctuation">{</span><span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"www.example.com"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token punctuation">{</span><span class="token string">"$inc"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"pageviews"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>不同的修改器修改文档的速度是不同的。例如只修改值的<code>$inc</code>修改器修改速度很快，因为不需要改变文档大小。但是可以修改文档大小的——例如<code>$set</code>——就会比较慢，由于MongoDB是给每个文档固定长度的存储空间，如果文档变大进而不能再原先位置存储，还需要移动的磁盘上的其他位置。文档有一个填充因子的参数，用于文档大小的增长。如果一个文档多次因变大而在磁盘上移动，则该文档的填充因子同样会增长。</p><p>一个修改操作中不能含有多个修改器，例如在某个修改请求中同时含有<code>$inc</code>和<code>$set</code>，这个请求就是非法的。</p><p>为防止多个线程/进程修改同一个文档而导致竞态，MongoDB提供了一个<code>findAndModify</code>方法，其查找和修改是原子操作，不会出现竞态。<code>findAndModify</code>不仅可以用于<code>update</code>，也可以用于<code>remove</code>。</p><p>写入安全：分为应答式写入和非应答式写入。应答式写入是指客户端提出写入请求后等待服务端返回写入结果，非应答式写入则相反。</p>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB笔记0x02</title>
      <link href="/2017/10/23/MongoDB%E7%AC%94%E8%AE%B00x02/"/>
      <url>/2017/10/23/MongoDB%E7%AC%94%E8%AE%B00x02/</url>
      
        <content type="html"><![CDATA[<h2 id="2-7-MongoDB-shell-的使用"><a href="#2-7-MongoDB-shell-的使用" class="headerlink" title="2.7 MongoDB shell 的使用"></a>2.7 MongoDB shell 的使用</h2><p>由于使用了V8引擎，MongoDB shell支持运行JavaScript代码，并且如果在启动MongoDB客户端时在<code>mongo</code>后面添加js文件，即可在shell可交互之前运行指定的js代码。如果有些js文件需要频繁运行，可以把这部分JavaScript代码写入一个名为<code>.mongorc.js</code>的文件，并放在用户主目录下；这时MongoDB shell运行时就会先执行<code>.mongorc.js</code>。</p><p><code>mongorc.js</code>中，可以：</p><p>（1）创建需要的全局变量；<br>（2）简化过长的名字，为其起一个别名；<br>（3）重写内置函数；<br>（4）移除比较危险的函数，例如<code>dropDatabase</code>以及<code>deleteIndexes</code>,让它们不能执行，防止误操作。这条是比较常用的。</p><p>shell中的提示是可以定制的，例如在查询过程中显示时间以及显示当前使用的Da名。</p><p>如果在shell中希望修改之前已经输入的行，可以在<code>.mongorc.js</code>中添加一行：</p><pre class=" language-js"><code class="language-js">EDITOR <span class="token operator">=</span> <span class="token string">"/usr/bin/vi"</span></code></pre><p>如此，需要修改某个变量时可以输入<code>edit post</code>即可修改<code>post</code>变量。</p><p>shell与集合命名：如果集合名中包含JavaScript的保留字或者不允许的字符，将不能使用<code>db.collectionName</code>的形式来访问集合，需要使用函数<code>db.getCollection()</code>来代替，也可以使用类似于<code>db[&#39;collectionName&#39;]</code>来访问。</p><h2 id="2-8-服务器端脚本"><a href="#2-8-服务器端脚本" class="headerlink" title="2.8 服务器端脚本"></a>2.8 服务器端脚本</h2><p>在服务器上执行脚本务必注意安全性问题。如果配置不当，很容易遭受注入攻击。例如：</p><pre class=" language-js"><code class="language-js">func <span class="token operator">=</span> <span class="token string">"function() { print('Hello, '"</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">"); }"</span></code></pre><p>此时用户如果传入的<code>name</code>为：</p><pre class=" language-js"><code class="language-js">name <span class="token operator">=</span> <span class="token string">"'); db.dropDatabase(); print('"</span></code></pre><p>这样和原脚本中拼接起来是合法的JavaScript代码时，就造成了注入攻击，导致数据库被删除。防范注入攻击主要是确保不要将用户输入的内容直接传递给mongod，例如应对上述的注入攻击可以使用作用域，以下为python的例子：</p><pre class=" language-python"><code class="language-python">func <span class="token operator">=</span> pymongo<span class="token punctuation">.</span>code<span class="token punctuation">.</span>Code<span class="token punctuation">(</span><span class="token string">"function() { print('Hello, ' + username + '!'); }"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"username"</span><span class="token punctuation">:</span> name<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>如此再输入之前的内容，则输出结果会变为：</p><pre><code>Hello, &#39;); db.dropDatabase(); print(&#39;!</code></pre><h1 id="3-创建、更新和删除文档"><a href="#3-创建、更新和删除文档" class="headerlink" title="3 创建、更新和删除文档"></a>3 创建、更新和删除文档</h1><h2 id="3-1-插入并保存文档"><a href="#3-1-插入并保存文档" class="headerlink" title="3.1 插入并保存文档"></a>3.1 插入并保存文档</h2><p>批量插入：除了使用<code>insert</code>插入单条数据，还可以使用<code>batchInsert</code>进行批量插入，它接受一个文档数组。MongoDB接受的最长消息为48MB，如果超过48MB，多数的驱动程序会将插入请求拆分成多个。如果在插入的过程中某个文档插入错误，则这个文档之前的文档均插入成功，之后的文档均插入失败。可以设置<code>continueOnError</code>参数，跳过插入有误的文档，继续进行插入。所有的驱动程序均支持该参数，但shell不支持。</p><p>插入校验：插入文档时，会进行基本的数据校验，例如检查有没有<code>_id</code>字段，没有则会自动生成一个；会检查文档的大小，单个文档的大小不能超过16M，以防止不良的设计模式，保持性能的一致；会检查有误非utf-8字符存在等等。但尽管如此，向MongoDB中插入非法数据是十分容易的，所以应当只允许信任源连接数据库是必要的。</p><h2 id="3-2-删除文档"><a href="#3-2-删除文档" class="headerlink" title="3.2 删除文档"></a>3.2 删除文档</h2><p>使用<code>remove()</code>进行文档删除时，会删除集合中的所有文档，但不会删除集合本身，以及集合的元信息。<code>remove()</code>也可以接受一个条件参数，来删除指定的文档。删除时永久性的，不可撤销，也不可恢复。</p><p>使用<code>drop()</code>的删除速度要远远超过<code>remove()</code>，但是如此之后集合也会被删除，也不能指定条件。</p>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB笔记0x01</title>
      <link href="/2017/10/21/MongoDB%E7%AC%94%E8%AE%B00x01/"/>
      <url>/2017/10/21/MongoDB%E7%AC%94%E8%AE%B00x01/</url>
      
        <content type="html"><![CDATA[<h2 id="2-5-MongoDB-shell"><a href="#2-5-MongoDB-shell" class="headerlink" title="2.5 MongoDB shell"></a>2.5 MongoDB shell</h2><p>MongoDB的shell包含Google的V8引擎，可以执行JavaScript代码，支持JavaScript标准库。打开shell时将会自动连接到本地的MongoDB服务器，也可以指定连接到远端的MongoDB服务器。此外，MongoDB的shell也提供一些方便的语法糖，供习惯于SQL shell的用户使用。</p><a id="more"></a><h2 id="2-6-数据类型"><a href="#2-6-数据类型" class="headerlink" title="2.6 数据类型"></a>2.6 数据类型</h2><p>MongoDB中包含JSON中的几种基本数据类型，还包括了一些其他的扩展类型，以下举出常用的数据类型：<br>（1）null：空值或值不存在；<br>（2）布尔值：true或false；<br>（3）数值：shell中默认使用64位的浮点数，如果想表示整数，可以使用整数类<code>NumberInt</code>（4字节有符号整数）或<code>NumberLong</code>（8字节有符号整数）；<br>（4）字符串：utf-8的字符串；<br>（5）日期：<code>Date</code>类，使用<code>new Date()</code>创建；<br>（6）正则表达式：与JavaScript的正则表达式相同；<br>（7）内嵌文档：将一个文档作为另一个文档的值；<br>（8）对象id：<code>ObjectId</code>类，作为文档的唯一标识；<br>（9）数组：由一系列可以不同类型的数据构成。</p><p>关于日期：如果不使用<code>new Date()</code>创建日期对象而使用形如<code>Date(...)</code>的构造函数，返回的将是字符串而不是毫秒数。</p><p>关于内嵌文档：内嵌文档可以让数据存储更加自然、高效、立体。例如：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Joe"</span><span class="token punctuation">,</span>  <span class="token property">"address"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"street"</span><span class="token operator">:</span> <span class="token string">"123 Park Street"</span><span class="token punctuation">,</span>    <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"X town"</span><span class="token punctuation">,</span>    <span class="token property">"state"</span><span class="token operator">:</span> <span class="token string">"NY"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>如果将这段数据存入关系型数据库中，一般来说会拆分成复数个表，会比较复杂。但是，MongoDB如此做的缺点是造成数据冗余。例如某城市的拼写有误，在关系型数据库中只需要修改城市表中有误的项，而对于MongoDB来说则是对属于该城市的每个人的信息进行修改。</p><p>关于<code>_id</code>：在MongoDB中，每个文档都必须有<code>_id</code>，其值可以是任意类型的任何值。在同一个集合的不同文档，其<code>_id</code>不能相同。</p><p>关于<code>ObjectId</code>：这是一种轻量型生成ID的类，可以在不同的机器上使用同种方法生成全局唯一的ID。由于传统数据库中使用的自增主键很难在分布式数据库中同步生成，所以MongoDB采用了这种方法。</p><p><code>ObjectId</code>构成：<code>ObjectId</code>占用12字节的空间，其中0-3字节是秒级的时间戳，标明文档的创建时间；4-6字节是机器名的hash值，以保证不同机器产生的<code>ObjectId</code>不同；7-8字节是PID，以保证在同一机器上并发的进程产生的文档的<code>ObjectId</code>不同；9-11字节是一个自增的计数器，以保证同一进程在1秒内创建的文档的<code>ObjectId</code>不同，一个进程在一秒内最多可以拥有2563个不同的<code>ObjectId</code>。</p><p>插入文档时如果没有<code>_id</code>，系统会自动生成<code>ObjectId</code>。虽然可以由MongoDB服务器来做这件事，但通常是由客户端的驱动程序来完成。这体现了MongoDB的哲学理念：能交给客户端驱动程序做的事就不要交给服务器来做。因为扩展应用层比扩展数据库层简单很多，将部分工作交给客户端来完成，也能够减少服务器的负担。</p>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB笔记0x00</title>
      <link href="/2017/10/20/MongoDB%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2017/10/20/MongoDB%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<h1 id="1-MongoDB简介"><a href="#1-MongoDB简介" class="headerlink" title="1 MongoDB简介"></a>1 MongoDB简介</h1><p>MongoDB是一个面向文档的数据库，与传统的关系型数据库不同，MongoDB中没有行的概念，取而代之的是文档中的内容和数组。这种形式可以灵活的表现各种复杂的层次关系，加快开发者开发进程。</p><a id="more"></a><p>当数据积累到一定程度，当前的服务器性能不足以胜任计算性能和存储空间要求时，应当进行数据库的纵向扩展或者横向扩展。纵向扩展是指单纯提高服务器的硬件性能，横向扩展是指向服务器集群中添加更多的服务器。显然纵向扩展是有极限的，而MongoDB可以进行较为方便的横向扩展，以提高数据库集群的计算能力以及存储空间。</p><p>MongoDB支持索引、聚合、特殊的集合类型、文件存储的功能，但是例如连接和复杂的多行事物等是不支持的，这是由于这些功能不方便在分布式系统上实现。</p><h1 id="2-基础部分"><a href="#2-基础部分" class="headerlink" title="2 基础部分"></a>2 基础部分</h1><h2 id="2-1-文档"><a href="#2-1-文档" class="headerlink" title="2.1 文档"></a>2.1 文档</h2><p>文档是一组有序键值对的集合。注意：（1）键中不能含有<code>\0</code>（表示字符串结尾），<code>.</code>和<code>$</code>有特殊含义，不能随意使用；（2）键不能重复；（3）键字符串可以是任意utf-8符号。</p><h2 id="2-2-集合"><a href="#2-2-集合" class="headerlink" title="2.2 集合"></a>2.2 集合</h2><p>集合是一组文档。虽然可以将不同结构的文档，但是出于方便管理、为集合建立索引以及查询性能的考虑，建议把同种结构、包括同类内容的文档归入同一集合内。这也是为什么设计集合的原因。</p><p>类似于文档键的命名规则，集合名的命名规则有：（1）不能为<code>&quot;&quot;</code>；（2）不能包含<code>\0</code>、<code>$</code>；（3）不能以<code>system.</code>开头，这些是系统集合的保留前缀。</p><p>可以用<code>.</code>来进行子集合的组织，构成各种不同的集合子命名空间。</p><h2 id="2-3-数据库"><a href="#2-3-数据库" class="headerlink" title="2.3 数据库"></a>2.3 数据库</h2><p>数据库由多个集合组成。每个数据库都是独立的，无论是权限还是磁盘存储位置。</p><p>与集合名、文档键名类似，数据库名也有相应的命名规则：（1）不能为<code>&quot;&quot;</code>；（2）不能包含<code>\</code>、<code>/</code>、<code>*</code>、<code>&quot;</code>、<code>&lt;</code>、<code>&gt;</code>、<code>|</code>、<code>?</code>、<code></code>、<code>$</code>、<code>\0</code>，推荐使用ASCII中的字母和数字；（3）区分字母大小写，简单起见，均使用小写字母；（4）数据库名最长为64字节。</p><p>有一些数据库名是保留的，它们有相应的功能：（1）admin：如果将一个用户加入该数据库，它将获得所有数据库的权限，另外有一些指令必须从admin数据库中启动；（2）local：所有本地的集合都会存到这个数据库中，此外，该数据库不能复制；（3）config：分片信息会保存到这个数据库中。</p><h2 id="2-4-安装MongoDB以及启动"><a href="#2-4-安装MongoDB以及启动" class="headerlink" title="2.4 安装MongoDB以及启动"></a>2.4 安装MongoDB以及启动</h2><p>安装环境为CentOS 7。</p><p>添加官方源到<code>/etc/yum.repos.d/mongo-2.6.repo</code>：</p><pre><code>[mongodb-org-2.6]name=MongoDB Repositorybaseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/2.6/x86_64/gpgcheck=1enabled=1gpgkey=https://www.mongodb.org/static/pgp/server-2.6.asc</code></pre><p>使用<code>yum</code>开始安装：</p><pre class=" language-shell"><code class="language-shell">yum -y install mongodb-org</code></pre><p>启动MongoDB服务：</p><pre class=" language-shell"><code class="language-shell">systemctl start mongod</code></pre>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>建立docker镜像仓库</title>
      <link href="/2017/10/02/%E5%BB%BA%E7%AB%8Bdocker%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93/"/>
      <url>/2017/10/02/%E5%BB%BA%E7%AB%8Bdocker%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>操作系统为CentOS 7。</p><h1 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h1><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><pre class=" language-shell"><code class="language-shell">yum install -y yum-utils device-mapper-persistent-data lvm2</code></pre><h2 id="添加阿里源"><a href="#添加阿里源" class="headerlink" title="添加阿里源"></a>添加阿里源</h2><pre class=" language-shell"><code class="language-shell">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</code></pre><h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><pre class=" language-shell"><code class="language-shell">yum install docker-ce</code></pre><h2 id="启动Docker"><a href="#启动Docker" class="headerlink" title="启动Docker"></a>启动Docker</h2><pre class=" language-shell"><code class="language-shell">systemctl enable dockersystemctl start docker</code></pre><h1 id="registry安装"><a href="#registry安装" class="headerlink" title="registry安装"></a>registry安装</h1><h2 id="安装registry及运行"><a href="#安装registry及运行" class="headerlink" title="安装registry及运行"></a>安装registry及运行</h2><p>docker-registry本身也是docker镜像，从官方仓库拉取对应镜像。在仓库服务器上执行：</p><pre class=" language-shell"><code class="language-shell">docker pull registry:2</code></pre><p>运行该镜像：</p><pre class=" language-shell"><code class="language-shell">docker run -d -p 5000:5000 --restart=always --name registry -v /var/data:/var/lib/registry registry:2</code></pre><h2 id="镜像拉取"><a href="#镜像拉取" class="headerlink" title="镜像拉取"></a>镜像拉取</h2><p>在仓库服务器上上传本地镜像：</p><pre class=" language-shell"><code class="language-shell">docker load < centos:1docker tag centos:1 localhost:5000/centos:1docker push localhost:5000/centos:1</code></pre><p>在客户端通过HTTP访问仓库，需要先修改<code>/etc/docker/daemon.json</code>：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"insecure-registries"</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">"192.168.59.137:5000"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></code></pre><p>之后输入命令：</p><pre class=" language-shell"><code class="language-shell">systemctl restart dockerdocker pull 192.168.59.137:5000/centos:1</code></pre><h2 id="使用registry-API"><a href="#使用registry-API" class="headerlink" title="使用registry API"></a>使用registry API</h2><p>例如在不知道镜像名称以及版本号时，则需要向registry发起查询。此时可以使用registry提供的API。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> requestsurl <span class="token operator">=</span> <span class="token string">'http://192.168.59.137:5000/v2/'</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'_catalog'</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># {"repositories":["busybox"]}</span>r <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url <span class="token operator">+</span> <span class="token string">'busybox/tags/list'</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># {"name":"busybox","tags":["1.25.1-musl"]}</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FluentPython笔记0x07</title>
      <link href="/2017/09/15/FluentPython%E7%AC%94%E8%AE%B00x07/"/>
      <url>/2017/09/15/FluentPython%E7%AC%94%E8%AE%B00x07/</url>
      
        <content type="html"><![CDATA[<h2 id="Mappings-with-Flexible-Key-Lookup（p70）"><a href="#Mappings-with-Flexible-Key-Lookup（p70）" class="headerlink" title="Mappings with Flexible Key Lookup（p70）"></a>Mappings with Flexible Key Lookup（p70）</h2><ul><li><p><code>defaultdict</code>：类似与<code>dict.default()</code>，可创建一个带有默认值类型的<code>dict</code>，例如<code>defaultdict(int)</code>，则遇到不存在的Key时，其取值为0。这个过程中会调用<code>default_factory</code>，进而会调用special method <code>__missing__</code>。</p></li><li><p><code>__missing__</code>：该special method没有在<code>dict</code>中定义，但如果在<code>dict</code>的子类中定义<code>__missing__</code>，则<code>__getitem__</code>在遇到缺失的key时不会抛出<code>KeyError</code>，而是会转而调用<code>__missing__</code>。<code>__missing__</code>在其他时候不会被调用，例如<code>__contains__</code>。</p></li><li><p>例3-7：</p></li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">StrKeyDict0</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__missing__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">if</span> isinstance<span class="token punctuation">(</span>key<span class="token punctuation">,</span> str<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">raise</span> KeyError<span class="token punctuation">(</span>key<span class="token punctuation">)</span>        <span class="token keyword">return</span> self<span class="token punctuation">[</span>str<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> default<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">[</span>key<span class="token punctuation">]</span>        <span class="token keyword">except</span> KeyError<span class="token punctuation">:</span>            <span class="token keyword">return</span> default    <span class="token keyword">def</span> <span class="token function">__contains__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">or</span> str<span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre><p>有两处需要注意：<br>1.在<code>__missing__</code>中，<code>isinstance</code>的检查不可少。<code>__missing__</code>被调用时，情况有三种：（1）是<code>int</code>型，但其<code>str</code>型在<code>dict</code>中；（2）是<code>int</code>型，且<code>str</code>型不在<code>dict</code>中；（3）是<code>str</code>型但不在<code>dict</code>中。如果没有<code>isinstance</code>的过滤，<code>str</code>型也不在<code>dict</code>中时<code>self[str(key)]</code>还会调用<code>__missing__</code>，陷入死循环。<br>2.在<code>__contains__</code>中，没有使用<code>key in dict</code>而是用<code>key in dict.keys()</code>是因为前者依然会调用<code>__missing__</code>，而导致<code>int</code>型的<code>2</code>也会在<code>dict</code>的<code>keys</code>中。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PostgreSQL安装及初始化</title>
      <link href="/2017/08/28/PostgreSQL%E5%AE%89%E8%A3%85%E5%8F%8A%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
      <url>/2017/08/28/PostgreSQL%E5%AE%89%E8%A3%85%E5%8F%8A%E5%88%9D%E5%A7%8B%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<p>参考：<a href="https://www.mtyun.com/library/28/how-to-install-postgresql9/" target="_blank" rel="noopener">https://www.mtyun.com/library/28/how-to-install-postgresql9/</a><br>本文安装环境为CentOS 6.4，安装PostgreSQL版本为9.3</p><a id="more"></a><h1 id="安装ca-certificates"><a href="#安装ca-certificates" class="headerlink" title="安装ca-certificates"></a>安装ca-certificates</h1><p>由于官网提供的yum仓库为https，需要安装<code>ca-certificates</code>：</p><pre class=" language-shell"><code class="language-shell">yum install ca-certificates</code></pre><h1 id="安装PostgreSQL-9-3"><a href="#安装PostgreSQL-9-3" class="headerlink" title="安装PostgreSQL 9.3"></a>安装PostgreSQL 9.3</h1><pre class=" language-shell"><code class="language-shell">yum install http://yum.postgresql.org/9.3/redhat/rhel-6-x86_64/pgdg-centos93-9.3-2.noarch.rpmyum install postgresql93-server postgresql93-contrib</code></pre><h1 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h1><p>新建数据库物理文件的存放目录：</p><pre class=" language-shell"><code class="language-shell">mkdir -p /home/postgres/data</code></pre><p>使用用户<code>postgres</code>管理PostgreSQL并配置环境变量：</p><pre class=" language-shell"><code class="language-shell">su - postgrescp /etc/skel/.bash* /var/lib/pgsql</code></pre><p>修改<code>/var/lib/pgsql/.bashrc</code>：</p><pre><code>export PGDATA=/home/postgres/dataexport PATH=/usr/pgsql-9.3/bin:$PATH</code></pre><p>其中<code>PGDATA</code>为数据库物理文件的存放目录。<br>重新加载<code>.bashrc</code>：</p><pre class=" language-shell"><code class="language-shell">source .bashrc</code></pre><h1 id="初始化并启动数据库"><a href="#初始化并启动数据库" class="headerlink" title="初始化并启动数据库"></a>初始化并启动数据库</h1><pre class=" language-shell"><code class="language-shell">initdbpg_ctl start</code></pre><h1 id="修改账户密码"><a href="#修改账户密码" class="headerlink" title="修改账户密码"></a>修改账户密码</h1><p>在终端输入<code>psql</code>进入PostgreSQL交互界面：</p><pre class=" language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">user</span> postgres <span class="token keyword">with</span> password <span class="token string">'password'</span><span class="token punctuation">;</span></code></pre>]]></content>
      
      
      <categories>
          
          <category> Database </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PostgreSQL </tag>
            
            <tag> CentOS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FluentPython笔记0x06</title>
      <link href="/2017/08/17/FluentPython%E7%AC%94%E8%AE%B00x06/"/>
      <url>/2017/08/17/FluentPython%E7%AC%94%E8%AE%B00x06/</url>
      
        <content type="html"><![CDATA[<h1 id="Chapter-3"><a href="#Chapter-3" class="headerlink" title="Chapter 3"></a>Chapter 3</h1><h2 id="Generic-Mapping-Types（p64"><a href="#Generic-Mapping-Types（p64" class="headerlink" title="Generic Mapping Types（p64)"></a>Generic Mapping Types（p64)</h2><ul><li>可哈希：如果一个对象在它的生命周期中有一个不会改变的哈希值（它需要有<code>__hash__()</code>函数），并且它能够和其他对象进行比较（需要有<code>__eq__()</code>函数）。可哈希的对象相等必须拥有相同的哈希值。<code>str</code>、<code>bytes</code>以及数类型都是可哈希的；<code>frozenset</code>也总是可哈希的，因为它的元素必须可哈希；<code>tuple</code>仅当它包含的所有元素可哈希是它才是可哈希的。例：</li></ul><a id="more"></a><pre class=" language-python"><code class="language-python">tt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>hash<span class="token punctuation">(</span>tt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 8027212646858338501</span>tl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>hash<span class="token punctuation">(</span>tl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># TypeError: unhashable type: 'list'</span></code></pre><ul><li>建立<code>dict</code>：</li></ul><pre class=" language-python"><code class="language-python">a <span class="token operator">=</span> dict<span class="token punctuation">(</span>one<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> two<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> three<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>b <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'one'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">}</span>c <span class="token operator">=</span> dict<span class="token punctuation">(</span>zip<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'one'</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">,</span> <span class="token string">'three'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>d <span class="token operator">=</span> dict<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'three'</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'one'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b <span class="token operator">==</span> c <span class="token operator">==</span> d<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># True</span></code></pre><h2 id="dict-Comprehesions（p66）"><a href="#dict-Comprehesions（p66）" class="headerlink" title="dict Comprehesions（p66）"></a>dict Comprehesions（p66）</h2><ul><li>类似与listcomp，<code>dict</code>也有dictcomp。</li></ul><pre class=" language-python"><code class="language-python">DIAL_CODES <span class="token operator">=</span> <span class="token punctuation">[</span>  <span class="token punctuation">(</span><span class="token number">86</span><span class="token punctuation">,</span> <span class="token string">'China'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">91</span><span class="token punctuation">,</span> <span class="token string">'India'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'United States'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">62</span><span class="token punctuation">,</span> <span class="token string">'Indonesia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">,</span> <span class="token string">'Brazil'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">92</span><span class="token punctuation">,</span> <span class="token string">'Pakistan'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">880</span><span class="token punctuation">,</span> <span class="token string">'Bangladesh'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">234</span><span class="token punctuation">,</span> <span class="token string">'Nigeria'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token string">'Russia'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token punctuation">(</span><span class="token number">81</span><span class="token punctuation">,</span> <span class="token string">'Japan'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span>country_code <span class="token operator">=</span> <span class="token punctuation">{</span>country<span class="token punctuation">:</span> code <span class="token keyword">for</span> code<span class="token punctuation">,</span> country <span class="token keyword">in</span> DIAL_CODES<span class="token punctuation">}</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span>country_code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># {'China': 86, 'India': 91, 'United States': 1, 'Indonesia': 62, 'Brazil': 55, 'Pakistan': 92, 'Bangladesh': 880, 'Nigeria': 234, 'Russia': 7, 'Japan': 81}</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span><span class="token punctuation">{</span>code<span class="token punctuation">:</span> country<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> country<span class="token punctuation">,</span> code <span class="token keyword">in</span> country_code<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> code <span class="token operator">&lt;</span> <span class="token number">66</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># {1: 'UNITED STATES', 62: 'INDONESIA', 55: 'BRAZIL', 7: 'RUSSIA'}</span></code></pre><ul><li>鸭子类型（duck typing，参考<a href="https://zh.wikipedia.org/wiki/%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B" target="_blank" rel="noopener">维基百科</a>）：“当看到一只鸟走起来像鸭子、游泳起来像鸭子、叫起来也像鸭子，那么这只鸟就可以被称为鸭子。”鸭子类型是动态类型的一种风格。在这种风格中，一个对象有效的语义，不是由继承自特定的类或实现特定的接口，而是由”当前方法和属性的集合”决定。</li></ul><h2 id="Handling-Missing-Keys-with-setdefault（p68）"><a href="#Handling-Missing-Keys-with-setdefault（p68）" class="headerlink" title="Handling Missing Keys with setdefault（p68）"></a>Handling Missing Keys with setdefault（p68）</h2><ul><li><code>d.get</code>和<code>d.setdefault</code>：<code>d.get(k, default)</code>是一种比较方便来处理<code>KeyError</code>的方法，在没有<code>k</code>值时会返回<code>default</code>。但是如果想更新字典中键值对使用<code>setdefault</code>会更加方便。</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> sys<span class="token keyword">import</span> reWORD_RE <span class="token operator">=</span> re<span class="token punctuation">.</span>compile<span class="token punctuation">(</span><span class="token string">'\w+'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dict_get</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">:</span>    index <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> line_no<span class="token punctuation">,</span> line <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> match <span class="token keyword">in</span> WORD_RE<span class="token punctuation">.</span>finditer<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>            word <span class="token operator">=</span> match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>            column_no <span class="token operator">=</span> match<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>            location <span class="token operator">=</span> <span class="token punctuation">(</span>line_no<span class="token punctuation">,</span> column_no<span class="token punctuation">)</span>            occurrences <span class="token operator">=</span> index<span class="token punctuation">.</span>get<span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            occurrences<span class="token punctuation">.</span>append<span class="token punctuation">(</span>location<span class="token punctuation">)</span>            index<span class="token punctuation">[</span>word<span class="token punctuation">]</span> <span class="token operator">=</span> occurrences    <span class="token keyword">for</span> word <span class="token keyword">in</span> sorted<span class="token punctuation">(</span>index<span class="token punctuation">,</span> key<span class="token operator">=</span>str<span class="token punctuation">.</span>upper<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> index<span class="token punctuation">[</span>word<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">dict_setdefault</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">:</span>    index <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">for</span> line_no<span class="token punctuation">,</span> line <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>fp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> match <span class="token keyword">in</span> WORD_RE<span class="token punctuation">.</span>finditer<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">:</span>            word <span class="token operator">=</span> match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span>            column_no <span class="token operator">=</span> match<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>            location <span class="token operator">=</span> <span class="token punctuation">(</span>line_no<span class="token punctuation">,</span> column_no<span class="token punctuation">)</span>            index<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span>word<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>location<span class="token punctuation">)</span>    <span class="token keyword">for</span> word <span class="token keyword">in</span> sorted<span class="token punctuation">(</span>index<span class="token punctuation">,</span> key<span class="token operator">=</span>str<span class="token punctuation">.</span>upper<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> index<span class="token punctuation">[</span>word<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">with</span> open<span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fp<span class="token punctuation">:</span>        dict_get<span class="token punctuation">(</span>fp<span class="token punctuation">)</span>        dict_setdefault<span class="token punctuation">(</span>fp<span class="token punctuation">)</span></code></pre><p>对比<code>dict_get</code>和<code>dict_setdefault</code>两种方法可发现<code>setdefault</code>更加方便。</p><ul><li>有关于字典排序：对于字典<code>d</code>，如果希望对其进行按<code>key</code>排序，可以直接使用<code>sorted(d)</code>，如果希望对其进行值的排序，则可以：</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">for</span> key <span class="token keyword">in</span> sorted<span class="token punctuation">(</span>d<span class="token punctuation">,</span> key<span class="token operator">=</span>d<span class="token punctuation">.</span>get<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> d<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><ul><li>关于正则表达式匹配的几个函数<code>match</code>、<code>search</code>、<code>findall</code>、<code>finditer</code>：<code>match</code>成功匹配会返回<code>Match</code>对象，失败会返回<code>None</code>；<code>search</code>类似<code>match</code>，但只返回第一个匹配字符串；<code>findall</code>返回为数组形式的结果；<code>finditer</code>返回迭代器形式的结果。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FluentPython笔记0x05</title>
      <link href="/2017/08/02/FluentPython%E7%AC%94%E8%AE%B00x05/"/>
      <url>/2017/08/02/FluentPython%E7%AC%94%E8%AE%B00x05/</url>
      
        <content type="html"><![CDATA[<h2 id="NumPy-and-SciPy（p52）"><a href="#NumPy-and-SciPy（p52）" class="headerlink" title="NumPy and SciPy（p52）"></a>NumPy and SciPy（p52）</h2><ul><li><code>numpy.ndarray</code>的基础操作：</li></ul><a id="more"></a><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpya <span class="token operator">=</span> numpy<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11])</span><span class="token comment" spellcheck="true"># type(a): numpy.ndarray</span><span class="token comment" spellcheck="true"># a.shape: (12,)</span>a<span class="token punctuation">.</span>shape <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token triple-quoted-string string">'''array([[0, 1, 2, 3],       [4, 5, 6, 7],       [8, 9 ,10, 11]])'''</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 8, 9, 10, 11</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 9</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 1, 5, 9</span>a<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''array([[0, 4, 8],       [1, 5, 9],       [2, 6, 10],       [3, 7, 11]])'''</span></code></pre><h2 id="Deques-and-Other-Queues（p55）"><a href="#Deques-and-Other-Queues（p55）" class="headerlink" title="Deques and Other Queues（p55）"></a>Deques and Other Queues（p55）</h2><ul><li><code>deque</code>：如果把<code>list</code>当做栈使用性能上十分低下，此时应该使用<code>deque</code>代替。</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> collections <span class="token keyword">import</span> dequedq <span class="token operator">=</span> deque<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> maxlen<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># deque([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]， maxlen=10)</span>dq<span class="token punctuation">.</span>rotate<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># deque([1, 2, 3, 4, 5, 6, 7, 8, 9, 0], maxlen=10)</span><span class="token comment" spellcheck="true"># rotate(n)当n>0时将n项从最右移到最左，n&lt;0反之。</span>dp<span class="token punctuation">.</span>appendleft<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># deque([-1, 1, 2, 3, 4, 5, 6, 7, 8, 9], maxlen=10)</span><span class="token comment" spellcheck="true"># deque会保持长度，最右侧的0被移除</span>dq<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># deque([3, 4, 5, 6, 7, 8, 9, 11, 22, 33], maxlen=10)</span>dq<span class="token punctuation">.</span>extendleft<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># deque([40, 30, 20, 10, 3, 4, 5, 6, 7, 8], maxlen=10)</span><span class="token comment" spellcheck="true"># 从左加入列表中的数据时会反转</span></code></pre><p>在<code>deque</code>的方法中，注意<code>remove</code>的实现是严格按照数据从序列两端进出的，故性能并不佳；<code>append</code>和<code>popleft</code>是原子操作，在LIFO和多线程操作的情况下不需要锁。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FluentPython笔记0x04</title>
      <link href="/2017/08/01/FluentPython%E7%AC%94%E8%AE%B00x04/"/>
      <url>/2017/08/01/FluentPython%E7%AC%94%E8%AE%B00x04/</url>
      
        <content type="html"><![CDATA[<h2 id="p32"><a href="#p32" class="headerlink" title="p32"></a>p32</h2><ul><li>和列表相比，元组除了无法修改其中的值以外，只有一处和列表不同：元组无法使用<code>__reversed__</code>，但是可以使用以下方法代替：</li></ul><a id="more"></a><pre class=" language-python"><code class="language-python">t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>tuple<span class="token punctuation">(</span>reversed<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><ul><li>元组和列表可以与<code>int</code>型整数相乘，含义为返回对应的元组或列表，里边包括重复整数次的原来的元组或列表的内容。</li></ul><h2 id="p33"><a href="#p33" class="headerlink" title="p33"></a>p33</h2><ul><li><p>像元组、列表等序列切片时为什么排除结束标号的项：1.可以简单的看出切片得到的长度，例<code>range(3)</code>以及<code>my_list[:3]</code>；2.可以简单地计算切片长度，只需结束序号减去开始序号；3.可以只使用一个序号就能把序列切成两部分，例如<code>my_list[:x]</code>和<code>my_list[x:]</code>。</p></li><li><p>切片的实现是一个切片类：<code>slice(start, stop, step)</code>。例：</p></li></ul><pre class=" language-python"><code class="language-python">source <span class="token operator">=</span> <span class="token triple-quoted-string string">'''0.......8....120 AXL         51 August      62 key        10'''</span>INDEX <span class="token operator">=</span> slice<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>NAME <span class="token operator">=</span> slice<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>POINT <span class="token operator">=</span> slice<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> None<span class="token punctuation">)</span>line_items <span class="token operator">=</span> source<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token keyword">for</span> item <span class="token keyword">in</span> line_items<span class="token punctuation">:</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span>POINT<span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">[</span>NAME<span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><ul><li>切片赋值操作：</li></ul><pre class=" language-python"><code class="language-python">l <span class="token operator">=</span> list<span class="token punctuation">(</span>range<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]</span>l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># [0, 1, 20, 30, 5, 6, 7, 8, 9]</span><span class="token keyword">del</span> l<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># [0, 1, 20, 30, 5, 8, 9]</span>l<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># [0, 1, 20, 11, 5, 22, 9]</span>l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token comment" spellcheck="true"># 错误，左面是列表右面对应应该也是列表等可迭代对象</span>l<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true"># [0, 1, 100, 22, 9]</span></code></pre><h2 id="p40"><a href="#p40" class="headerlink" title="p40"></a>p40</h2><ul><li>有关修改元组中列表的问题：代码如下。</li></ul><pre class=" language-python"><code class="language-python">t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">]</span><span class="token punctuation">)</span>t<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">]</span></code></pre><p>终端报错如下</p><pre><code>TypeError: &#39;tuple&#39; object does not support item assignment</code></pre><p>但是此时打印<code>t</code>会显示</p><pre class=" language-python"><code class="language-python"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">)</span></code></pre><p>根据Python生成的字节码，元组<code>+=</code>这个操作的关键步骤为：1.将<code>t[2]</code>的值压栈（位于栈顶）；2.执行<code>栈顶值 += [50, 60]</code>，如果栈顶值不为可变变量的话会报错。但此处栈顶为<code>list</code>，故成功执行；3.执行<code>t[2] = 栈顶值</code>，如果<code>t</code>为不可变变量则会报错，此处<code>t</code>为元组故会出现报错。综上最终结果就是<code>list</code>的值改变了但是出现了报错。</p><p>总结：1.不建议在元组中填入可变项；2.自增不是原子操作，错误抛出可以在自增中的任何一个环节独立抛出，而不影响前面已执行的部分；3.如果遇到类似问题可以尝试阅读Python字节码，它并不难懂。</p><h2 id="p42"><a href="#p42" class="headerlink" title="p42"></a>p42</h2><ul><li><code>list.sort</code>和<code>sorted</code>：<code>list.sort</code>只能用于可变序列，会改变列表，返回值为<code>None</code>。<code>sorted</code>可以用于任何序列，它总是会返回一个新的序列而不改变原序列。</li></ul><h2 id="p44"><a href="#p44" class="headerlink" title="p44"></a>p44</h2><ul><li>使用<code>bisect</code>进行有序序列的查找和插入：<code>bisect</code>即二分查找。</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> bisect<span class="token keyword">import</span> sysHAYSTACK <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">]</span>NEEDLES <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">]</span>ROW_FMT <span class="token operator">=</span> <span class="token string">'{0:2d} @ {1:2d}     {2}{0:2d}'</span><span class="token keyword">def</span> <span class="token function">demo</span><span class="token punctuation">(</span>bisect_fn<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> needle <span class="token keyword">in</span> reversed<span class="token punctuation">(</span>NEEDLES<span class="token punctuation">)</span><span class="token punctuation">:</span>        position <span class="token operator">=</span> bisect_fn<span class="token punctuation">(</span>HAYSTACK<span class="token punctuation">,</span> needle<span class="token punctuation">)</span>        offset <span class="token operator">=</span> position <span class="token operator">*</span> <span class="token string">'  |'</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>ROW_FMT<span class="token punctuation">.</span>format<span class="token punctuation">(</span>needle<span class="token punctuation">,</span> position<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'left'</span><span class="token punctuation">:</span>        bisect_fn <span class="token operator">=</span> bisect<span class="token punctuation">.</span>bisect_left    <span class="token keyword">else</span><span class="token punctuation">:</span>        bisect_fn <span class="token operator">=</span> bisect<span class="token punctuation">.</span>bisect    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'DEMO:'</span><span class="token punctuation">,</span> bisect_fn<span class="token punctuation">.</span>__name__<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'haystack ->'</span><span class="token punctuation">,</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string">'%2d'</span> <span class="token operator">%</span> n <span class="token keyword">for</span> n <span class="token keyword">in</span> HAYSTACK<span class="token punctuation">)</span><span class="token punctuation">)</span>    demo<span class="token punctuation">(</span>bisect_fn<span class="token punctuation">)</span></code></pre><p>其中<code>bisect.bisect</code>和<code>bisect.bisect_right</code>是等价的，它们和<code>bisect.bisect_left</code>的区别在于遇到相等的值是插入的位置不同。一般情况下看不出区别，但是像<code>1</code>与<code>1.0</code>这样的还是有所区别的。</p><p><code>bisect.bisect</code>有个有趣的应用：给连续的数值分级。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">grade</span><span class="token punctuation">(</span>score<span class="token punctuation">,</span> breakpoints<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">,</span> grades<span class="token operator">=</span><span class="token string">'FDCBA'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  i <span class="token operator">=</span> bisect<span class="token punctuation">.</span>bisect<span class="token punctuation">(</span>breakpoints<span class="token punctuation">,</span> score<span class="token punctuation">)</span>  <span class="token keyword">return</span> grades<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">[</span>grade<span class="token punctuation">(</span>score<span class="token punctuation">)</span> <span class="token keyword">for</span> score <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># FACCBAA</span></code></pre><p>此外，<code>bisect.insort</code>是向有序序列中插入值而不破坏有序，和<code>bisect.bisect</code>类似。</p><h2 id="p48"><a href="#p48" class="headerlink" title="p48"></a>p48</h2><ul><li><p>如果对序列有特殊需求，<code>list</code>不一定是最好的选择。例如，如果你想保存10M个浮点数，<code>array</code>比<code>list</code>更加有效，因为<code>array</code>没有保存每一个<code>float</code>对象的全部。另外如果需要实现类似队列或者栈则可以使用<code>deque</code>。</p></li><li><p><code>array</code>需要先指定类型，即<code>array</code>只能存储一种类型的数据，但是这换来的是极大的性能提升。<code>array.fromfile</code>和<code>array.tofile</code>分别可以读取文件创建序列和将序列写入文件，这两种操作要比读写文本文件加上解析转换要快很多。以下为<code>array</code>支持的初始化类型：</p></li></ul><style>table th, table td {  text-align: center;  padding: 5px;}</style><table><thead><tr><th>类型码</th><th>C类型</th><th>Python类型</th><th>最小占用字节</th></tr></thead><tbody><tr><td>c</td><td>char</td><td>character</td><td>1</td></tr><tr><td>b</td><td>signed char</td><td>int</td><td>1</td></tr><tr><td>B</td><td>unsigned char</td><td>int</td><td>1</td></tr><tr><td>u</td><td>Py_UNICODE</td><td>Unicode character</td><td>2</td></tr><tr><td>h</td><td>signed short</td><td>int</td><td>2</td></tr><tr><td>H</td><td>unsigned short</td><td>int</td><td>2</td></tr><tr><td>i</td><td>signed int</td><td>int</td><td>2</td></tr><tr><td>I</td><td>unsigned int</td><td>long</td><td>2</td></tr><tr><td>l</td><td>signed long</td><td>int</td><td>4</td></tr><tr><td>L</td><td>unsigned long</td><td>long</td><td>4</td></tr><tr><td>f</td><td>float</td><td>float</td><td>4</td></tr><tr><td>d</td><td>double</td><td>float</td><td>8</td></tr></tbody></table><h2 id="p51"><a href="#p51" class="headerlink" title="p51"></a>p51</h2><ul><li><code>memorview</code>：内存查看对象，能够使用支持缓冲区协议的数据类型进行包装，在不需要复制的情况下用Python代码访问以及等大小修改。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FluentPython笔记0x03</title>
      <link href="/2017/07/27/FluentPython%E7%AC%94%E8%AE%B00x03/"/>
      <url>/2017/07/27/FluentPython%E7%AC%94%E8%AE%B00x03/</url>
      
        <content type="html"><![CDATA[<p>唔，如果把这本书涉及到但是没提到的点拓展开，我什么时候能读完这本书呢？</p><h2 id="p26"><a href="#p26" class="headerlink" title="p26"></a>p26</h2><ul><li>元组不仅仅是不可变的列表，还可以存储记录。</li></ul><a id="more"></a><h2 id="p27"><a href="#p27" class="headerlink" title="p27"></a>p27</h2><pre class=" language-python"><code class="language-python">lax_coordinates <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">33.9425</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">118.408056</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 洛杉矶国际机场的经纬度</span>city<span class="token punctuation">,</span> year<span class="token punctuation">,</span> pop<span class="token punctuation">,</span> chg<span class="token punctuation">,</span> area <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Tokyo'</span><span class="token punctuation">,</span> <span class="token number">2003</span><span class="token punctuation">,</span> <span class="token number">32450</span><span class="token punctuation">,</span> <span class="token number">0.66</span><span class="token punctuation">,</span> <span class="token number">8014</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 有关东京的数据：名称，年份，人口（百万），人口变化，面积（平方公里）</span>traveler_ids <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'USA'</span><span class="token punctuation">,</span> <span class="token string">'31195855'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'BRA'</span><span class="token punctuation">,</span> <span class="token string">'CE342567'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'ESP'</span><span class="token punctuation">,</span> <span class="token string">'XDA205856'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token keyword">for</span> passport <span class="token keyword">in</span> traveler_ids<span class="token punctuation">:</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'%s/%s'</span> <span class="token operator">%</span> passport<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 上面对元组的操作称为元组解包</span><span class="token keyword">for</span> country<span class="token punctuation">,</span> _ <span class="token keyword">in</span> traveler_ids<span class="token punctuation">:</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>country<span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 使用 _ 作为占位符，可以只获取元组中需要的字段</span>b<span class="token punctuation">,</span> a <span class="token operator">=</span> a<span class="token punctuation">,</span> b<span class="token comment" spellcheck="true"># 一个优雅的交换两个变量值的操作</span><span class="token keyword">print</span><span class="token punctuation">(</span>divmod<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>divmod<span class="token punctuation">(</span><span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 使用 * 来解包元组传参</span></code></pre><h2 id="p29"><a href="#p29" class="headerlink" title="p29"></a>p29</h2><ul><li><code>*</code>还可以获取多余的项。</li></ul><pre class=" language-python"><code class="language-python">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> rest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 结果：(0, 1, [2, 3, 4])</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> rest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 结果：(0, 1, [2])</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">*</span>rest <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> rest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 结果：(0, 1, [])</span>a<span class="token punctuation">,</span> <span class="token operator">*</span>body<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> body<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 结果：(0, [1, 2], 3, 4)</span><span class="token operator">*</span>head<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d <span class="token operator">=</span> range<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 结果：([0, 1], 2, 3, 4)</span></code></pre><p>可见前缀<code>*</code>可以出现在任意位置。</p><ul><li>嵌套元组解包：</li></ul><pre class=" language-python"><code class="language-python">metro_areas <span class="token operator">=</span> <span class="token punctuation">[</span>    <span class="token punctuation">(</span><span class="token string">'Tokyo'</span><span class="token punctuation">,</span> <span class="token string">'JP'</span><span class="token punctuation">,</span> <span class="token number">36.933</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">35.689722</span><span class="token punctuation">,</span> <span class="token number">139.691667</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token string">'Delhi NCR'</span><span class="token punctuation">,</span> <span class="token string">'IN'</span><span class="token punctuation">,</span> <span class="token number">21.935</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">28.613889</span><span class="token punctuation">,</span> <span class="token number">77.208889</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token string">'Mexico City'</span><span class="token punctuation">,</span> <span class="token string">'MX'</span><span class="token punctuation">,</span> <span class="token number">20.142</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">19.433333</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">99.133333</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token string">'New York-Newark'</span><span class="token punctuation">,</span> <span class="token string">'US'</span><span class="token punctuation">,</span> <span class="token number">20.104</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">40.808611</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">74.020386</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token punctuation">(</span><span class="token string">'Sao Paulo'</span><span class="token punctuation">,</span> <span class="token string">'BR'</span><span class="token punctuation">,</span> <span class="token number">19.649</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">23.547778</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">46.635833</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'{:15} | {:^9} | {:^9}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token string">'lat.'</span><span class="token punctuation">,</span> <span class="token string">'long.'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>fmt <span class="token operator">=</span> <span class="token string">'{:15} | {:9.4f} | {:9.4f}'</span><span class="token keyword">for</span> name<span class="token punctuation">,</span> cc<span class="token punctuation">,</span> pop<span class="token punctuation">,</span> <span class="token punctuation">(</span>latitude<span class="token punctuation">,</span> longitude<span class="token punctuation">)</span> <span class="token keyword">in</span> metro_areas<span class="token punctuation">:</span>    <span class="token keyword">if</span> longitude <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>fmt<span class="token punctuation">.</span>format<span class="token punctuation">(</span>name<span class="token punctuation">,</span> latitude<span class="token punctuation">,</span> longitude<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token triple-quoted-string string">'''结果：                |   lat.    |   long.  Mexico City     |   19.4333 |  -99.1333New York-Newark |   40.8086 |  -74.0204Sao Paulo       |  -23.5478 |  -46.6358'''</span></code></pre><ul><li>格式字符串<code>str.format</code>（参考<a href="http://blog.xiayf.cn/2013/01/26/python-string-format/" target="_blank" rel="noopener">blog.xiayf.cn</a>）: 其实<code>%</code>这种格式输出已经很老了，<code>str.format</code>可以更加方便的格式输出以及提供更多功能。下表为一些基础的数格式输出。</li></ul><style>table th, table td {  text-align: center;  padding: 5px;}</style><table><thead><tr><th>数</th><th>格式</th><th>输出</th><th>描述</th></tr></thead><tbody><tr><td>3.1415926</td><td>{:.2f}</td><td>3.14</td><td>保留小数点后两位</td></tr><tr><td>3.1415926</td><td>{:+.2f}</td><td>+3.14</td><td>带符号保留小数后两位</td></tr><tr><td>-1</td><td>{:+.2f}</td><td>-1.00</td><td>带符号保留小数后两位</td></tr><tr><td>2.71828</td><td>{:.0f}</td><td>3</td><td>不带小数</td></tr><tr><td>5</td><td>{:0&gt;2d}</td><td>05</td><td>数左补0，宽度到2</td></tr><tr><td>5</td><td>{:x&lt;4d}</td><td>5xxx</td><td>数右补x，宽度到4</td></tr><tr><td>10</td><td>{:x&lt;4d}</td><td>10xx</td><td>数右补x，宽度到4</td></tr><tr><td>1000000</td><td>{:,}</td><td>1,000,000</td><td>使用逗号分隔</td></tr><tr><td>0.25</td><td>{:.2%}</td><td>25.00%</td><td>百分比格式，两位小数</td></tr><tr><td>1000000000</td><td>{:.2e}</td><td>1.00e+09</td><td>科学计数法</td></tr><tr><td>13</td><td>{:10d}</td><td>······13</td><td>右对齐，默认，宽度为10</td></tr><tr><td>13</td><td>{:&lt;10d}</td><td>13······</td><td>左对齐，宽度为10</td></tr><tr><td>13</td><td>{:^10d}</td><td>···13···</td><td>居中，宽度为10</td></tr></tbody></table><p>有关于<code>str.format</code>的用法：</p><pre class=" language-python"><code class="language-python">s1 <span class="token operator">=</span> <span class="token string">"so much depends upon {}"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"a red wheel barrow"</span><span class="token punctuation">)</span>s2 <span class="token operator">=</span> <span class="token string">"glazed with {} water beside the {} chickens"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"rain"</span><span class="token punctuation">,</span> <span class="token string">"white"</span><span class="token punctuation">)</span></code></pre><p>这里<code>{}</code>即充当占位符，和<code>%s</code>的功能类似，会将<code>format</code>的参数依次填入。当然你也可以指定顺序填入，见下。</p><pre class=" language-python"><code class="language-python">s1 <span class="token operator">=</span> <span class="token string">" {0} is better than {1} "</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"emacs"</span><span class="token punctuation">,</span> <span class="token string">"vim"</span><span class="token punctuation">)</span>s2 <span class="token operator">=</span> <span class="token string">" {1} is better than {0} "</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"emacs"</span><span class="token punctuation">,</span> <span class="token string">"vim"</span><span class="token punctuation">)</span></code></pre><p>此外，这样能够标记序号的好处还有防止漏掉变量，见下。</p><pre class=" language-python"><code class="language-python">set <span class="token operator">=</span>  <span class="token string">'(%s, %s, %s, %s, %s, %s, %s, %s)'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">,</span> g<span class="token punctuation">,</span> h<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># i是多余的</span>set <span class="token operator">=</span> <span class="token string">'({0}, {1}, {2}, {3}, {4}, {5}, {6}, {7})'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f<span class="token punctuation">,</span> g<span class="token punctuation">)</span></code></pre><p><code>format</code>可以为占位符命名，这样就不需要严格的顺序了。</p><pre class=" language-python"><code class="language-python">madlib <span class="token operator">=</span> <span class="token string">" I {verb} the {object} off the {place} "</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>verb<span class="token operator">=</span><span class="token string">"took"</span><span class="token punctuation">,</span> object<span class="token operator">=</span><span class="token string">"cheese"</span><span class="token punctuation">,</span> place<span class="token operator">=</span><span class="token string">"table"</span><span class="token punctuation">)</span></code></pre><p>可以重复使用同一变量。</p><pre class=" language-python"><code class="language-python">str <span class="token operator">=</span> <span class="token string">"Oh {0}, {0}! wherefore art thou {0}?"</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"Romeo"</span><span class="token punctuation">)</span></code></pre><p>可以转换进制。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"{0:d} - {0:x} - {0:o} - {0:b} "</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>可以把<code>format</code>当做方法使用。</p><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 定义格式</span>email_f <span class="token operator">=</span> <span class="token string">"Your email address was {email}"</span><span class="token punctuation">.</span>format<span class="token comment" spellcheck="true"># 在另一个地方使用</span><span class="token keyword">print</span><span class="token punctuation">(</span>email_f<span class="token punctuation">(</span>email<span class="token operator">=</span><span class="token string">"bob@example.com"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>如果你需要显示大括号，只要写两次就可以了。</p><pre class=" language-python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">" The {} set is often represented as { {0} } "</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span><span class="token string">"empty"</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><h2 id="p30"><a href="#p30" class="headerlink" title="p30"></a>p30</h2><ul><li>含名称元组<code>collections.namedtuple</code>：在前文中提到过。注意使用<code>namedtuple</code>所需的内存是小于使用<code>class</code>的，因为<code>namedtuple</code>不会把参数存到完整实例<code>__dict__</code>中。</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtupleCity <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'City'</span><span class="token punctuation">,</span> <span class="token string">'name country population coordinates'</span><span class="token punctuation">)</span>tokyo <span class="token operator">=</span> City<span class="token punctuation">(</span><span class="token string">'Tokyo'</span><span class="token punctuation">,</span> <span class="token string">'JP'</span><span class="token punctuation">,</span> <span class="token number">36.933</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">35.689722</span><span class="token punctuation">,</span> <span class="token number">139.691667</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>在创建一个<code>namedtuple</code>时，既可以像之前一样使用列表包含属性，也可以使用空格分隔的字符串。</p><h2 id="p31"><a href="#p31" class="headerlink" title="p31"></a>p31</h2><ul><li>含名称元组的参数和方法：</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span>City<span class="token punctuation">.</span>_fields<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># ('name', 'country', 'population', 'coordinates')</span>LatLong <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">'LatLong'</span><span class="token punctuation">,</span> <span class="token string">'lat long'</span><span class="token punctuation">)</span>delhi_data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">'Delhi NCR'</span><span class="token punctuation">,</span> <span class="token string">'IN'</span><span class="token punctuation">,</span> <span class="token number">21.935</span><span class="token punctuation">,</span> LatLong<span class="token punctuation">(</span><span class="token number">28.613889</span><span class="token punctuation">,</span> <span class="token number">77.208889</span><span class="token punctuation">)</span><span class="token punctuation">)</span>delhi <span class="token operator">=</span> City<span class="token punctuation">.</span>_make<span class="token punctuation">(</span>delhi_data<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>repr<span class="token punctuation">(</span>delhi<span class="token punctuation">.</span>_asdict<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># OrderedDict([('name', 'Delhi NCR'), ('country', 'IN'), ('population', 21.935), ('coordinates', LatLong(lat=28.613889, long=77.208889))])</span><span class="token keyword">for</span> key<span class="token punctuation">,</span> value <span class="token keyword">in</span> delhi<span class="token punctuation">.</span>_asdict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>key <span class="token operator">+</span> <span class="token string">':'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token triple-quoted-string string">'''name: Delhi NCRcountry: INpopulation: 21.935coordinates: LatLong(lat=28.613889, long=77.208889)'''</span></code></pre><p>其中<code>City._make(delhi_data)</code>与<code>City(*delhi_data)</code>等价。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>FluentPython笔记0x02</title>
      <link href="/2017/07/26/FluentPython%E7%AC%94%E8%AE%B00x02/"/>
      <url>/2017/07/26/FluentPython%E7%AC%94%E8%AE%B00x02/</url>
      
        <content type="html"><![CDATA[<p>嗯，记点单词。</p><h2 id="p14"><a href="#p14" class="headerlink" title="p14"></a>p14</h2><ul><li>augmented assignment: 增量赋值，例<code>i += 1</code>。</li></ul><a id="more"></a><ul><li>aspect-oriented programming: 面向侧面编程（AOP），又称面向方面编程，是对面向对象编程的补充。侧面是一种新的模块化机制，用来描述分散在对象、类或函数中的横切关注点，即关键的逻辑部分。例如Python的装饰器，某装饰器可以包含执行某一过程前后的日志记录，那么这种编程方法即可称为面向侧面编程。</li></ul><h1 id="Chapter-2"><a href="#Chapter-2" class="headerlink" title="Chapter 2"></a>Chapter 2</h1><h2 id="p21"><a href="#p21" class="headerlink" title="p21"></a>p21</h2><ul><li>list生成：比较两种方法的可读性。</li></ul><pre class=" language-python"><code class="language-python">symbols <span class="token operator">=</span> <span class="token string">'abcdef'</span>codes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> symbol <span class="token keyword">in</span> symbols<span class="token punctuation">:</span>  codes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>symbol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>codes<span class="token punctuation">)</span></code></pre><pre class=" language-python"><code class="language-python">symbols <span class="token operator">=</span> <span class="token string">'abcdef'</span>codes <span class="token operator">=</span> <span class="token punctuation">[</span>ord<span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token keyword">for</span> symbol <span class="token keyword">in</span> symbols<span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>codes<span class="token punctuation">)</span></code></pre><p>for循环的功能有很多，诸如扫描队列并取出元素、计算总和等等，但是listcomp(list comprehension, 列表推导式)的功能就只有生成一个新列表。从这个角度来看后者可读性更高。</p><ul><li>在Python 2中，如果列表推导式、生成器表达式的作用域中的变量名和外面有重复的话是会产生冲突的。虽然Python 3解决了这一问题，但是在写代码时还是避免这种情况。</li></ul><h2 id="p23"><a href="#p23" class="headerlink" title="p23"></a>p23</h2><ul><li>Cartesian product: 笛卡尔积。下面的代码为推荐写法。</li></ul><pre class=" language-python"><code class="language-python">colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'black'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">]</span>sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">]</span>tshirts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>color<span class="token punctuation">,</span> size<span class="token punctuation">)</span> <span class="token keyword">for</span> color <span class="token keyword">in</span> colors                         <span class="token keyword">for</span> size <span class="token keyword">in</span> sizes<span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span>tshirts<span class="token punctuation">)</span></code></pre><h2 id="p25"><a href="#p25" class="headerlink" title="p25"></a>p25</h2><ul><li>generator expression: 生成器表达式。</li></ul><pre class=" language-python"><code class="language-python">symbols <span class="token operator">=</span> <span class="token string">'abcdef'</span><span class="token keyword">print</span><span class="token punctuation">(</span>tuple<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token keyword">for</span> symbol <span class="token keyword">in</span> symbols<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">import</span> array<span class="token keyword">print</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token string">'I'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ord<span class="token punctuation">(</span>symbol<span class="token punctuation">)</span> <span class="token keyword">for</span> symbol <span class="token keyword">in</span> symbols<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre><p>当生成器表达式单独作为参数时不需要加括号。但像在<code>array</code>中接受两个参数时，生成器表达式需要加上圆括号。上述的T恤的代码用生成器表达式改写：</p><pre class=" language-python"><code class="language-python">colors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'black'</span><span class="token punctuation">,</span> <span class="token string">'white'</span><span class="token punctuation">]</span>sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'S'</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">]</span><span class="token keyword">for</span> tshirt <span class="token keyword">in</span> <span class="token punctuation">(</span><span class="token string">'%s %s'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>c<span class="token punctuation">,</span> s<span class="token punctuation">)</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> colors <span class="token keyword">for</span> s <span class="token keyword">in</span> sizes<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>tshirt<span class="token punctuation">)</span></code></pre><p>注意生成器的结果不会全部保存在内存中，它一次只会给<code>for</code>循环一个结果。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fluent Python笔记0x01</title>
      <link href="/2017/07/19/FluentPython%E7%AC%94%E8%AE%B00x01/"/>
      <url>/2017/07/19/FluentPython%E7%AC%94%E8%AE%B00x01/</url>
      
        <content type="html"><![CDATA[<p>划了两周水……</p><h2 id="p8"><a href="#p8" class="headerlink" title="p8"></a>p8</h2><ul><li>special methods是由Python解释器调用，不需要你来调用（虽然也可以亲自调用）。</li><li>对于内置类型如<code>list</code>，<code>str</code>，<code>bytearray</code>等来说，调用<code>len()</code>则是由CPython直接返回<code>PyVarObject</code>（C的struct）中关于长度的变量，这比调用<code>__len__</code>要快很多。</li></ul><a id="more"></a><h2 id="p10"><a href="#p10" class="headerlink" title="p10"></a>p10</h2><ul><li>例子1-2：</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> math <span class="token keyword">import</span> hypot<span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token punctuation">:</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>x <span class="token operator">=</span> x        self<span class="token punctuation">.</span>y <span class="token operator">=</span> y    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token string">'Vector(%r, %r)'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__abs__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> hypot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__bool__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> bool<span class="token punctuation">(</span>abs<span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__add__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        x <span class="token operator">=</span> self<span class="token punctuation">.</span>x <span class="token operator">+</span> other<span class="token punctuation">.</span>x        y <span class="token operator">=</span> self<span class="token punctuation">.</span>y <span class="token operator">+</span> other<span class="token punctuation">.</span>y        <span class="token keyword">return</span> Vector<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__mul__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> Vector<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x <span class="token operator">*</span> other<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y <span class="token operator">*</span> other<span class="token punctuation">)</span></code></pre><h2 id="p11"><a href="#p11" class="headerlink" title="p11"></a>p11</h2><ul><li>关于<code>__str__</code>和<code>__repr__</code>的区别（参考：<a href="https://stackoverflow.com/questions/1436703/difference-between-str-and-repr-in-python" target="_blank" rel="noopener">StackOverflow</a>）</li></ul><p>简单来说<code>__repr__</code>是为了保证无歧义，而<code>__str__</code>是为了提供可读性。在Python提供的类中，使用<code>__repr__</code>返回的结果都是格式化的数据，是符合Python语法的；<code>__str__</code>则是面向一般用户，提供可读性，但不保证无歧义，例如int型的3和str的3满足：</p><pre class=" language-python"><code class="language-python">str<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> str<span class="token punctuation">(</span><span class="token string">'3'</span><span class="token punctuation">)</span></code></pre><h2 id="p12"><a href="#p12" class="headerlink" title="p12"></a>p12</h2><ul><li>关于运算符：例1-2中声明的<code>__add__</code>和<code>__mul__</code>是针对<code>+</code>和<code>*</code>的重载。注意这里乘法参数顺序必须为向量在前数在后。</li><li>布尔值：在Python中，任何对象都有布尔值。如果对象未声明<code>__bool__</code>或<code>__len__</code>，则其布尔值恒为<code>True</code>。如果声明了<code>__bool__</code>则<code>bool()</code>会使用其返回值。如果没有声明<code>__bool__</code>而声明了<code>__len__</code>则会使用<code>len()</code>的返回值，为0则为<code>False</code>，否则为<code>True</code>。</li><li>有关例1-2中<code>Vector.__bool__</code>一个更加便捷的声明：</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">__bool__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> bool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>x <span class="token operator">or</span> self<span class="token punctuation">.</span>y<span class="token punctuation">)</span></code></pre><p>这样可以避免使用<code>abs()</code>。</p>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>VMWare共享文件夹设置</title>
      <link href="/2017/07/19/VMWare%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E5%A4%B9%E8%AE%BE%E7%BD%AE/"/>
      <url>/2017/07/19/VMWare%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E5%A4%B9%E8%AE%BE%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<p>参考：<a href="http://www.itread01.com/articles/1476103217.html" target="_blank" rel="noopener">http://www.itread01.com/articles/1476103217.html</a></p><p>讲道理还是在Windows下写代码舒服一些，那么就需要把代码同步到Linux虚拟机上。<br>使用VMWare的共享文件夹是个好方法。<br>虚拟机为CentOS7。</p><a id="more"></a><p>首先给Windows和Linux虚拟机均安装VMWare Tools，下面为Linux下安装VMWare Tools：</p><pre class=" language-shell"><code class="language-shell">yum install open-vm-tools open-vm-tools-desktop</code></pre><p>配置服务：</p><pre class=" language-shell"><code class="language-shell">vi /etc/systemd/system/mnt.hgfs.service</code></pre><p>内容为：</p><pre><code>[Unit]Description=Load VMware shared foldersRequires=vmware-vmblock-fuse.serviceAfter=vmware-vmblock-fuse.serviceConditionPathExists=.host:/ConditionVirtualization=vmware[Service]Type=oneshotRemainAfterExit=yesExecStart=ExecStart=/usr/bin/vmhgfs-fuse -o allow_other -o auto_unmount .host:/ /mnt/hgfs[Install]WantedBy=multi-user.target</code></pre><p>保存然后启动服务：</p><pre class=" language-shell"><code class="language-shell">systemctl enable mnt.hgfs.service</code></pre><p>创建挂载文件夹：</p><pre class=" language-shell"><code class="language-shell">mkdir -p /mnt/hgfs</code></pre><p>重启虚拟机应该就能看到共享的文件夹了。</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> VMWare </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fluent Python笔记0x00</title>
      <link href="/2017/07/05/FluentPython%E7%AC%94%E8%AE%B00x00/"/>
      <url>/2017/07/05/FluentPython%E7%AC%94%E8%AE%B00x00/</url>
      
        <content type="html"><![CDATA[<p>鬼使神差地买了一本英文的，想想还是写个笔记。版本为东南大学的影印版，原版***贵。</p><h1 id="Chapter-1"><a href="#Chapter-1" class="headerlink" title="Chapter 1"></a>Chapter 1</h1><h2 id="p4"><a href="#p4" class="headerlink" title="p4"></a>p4</h2><ul><li>Python中类似于<code>__getitem__</code>这种方法称为special method，作者称其为“dunder-getitem”。此外，类似<code>__x</code>是有其他含义的。</li></ul><a id="more"></a><h2 id="p5"><a href="#p5" class="headerlink" title="p5"></a>p5</h2><ul><li>collections: 包含一些数据类型，例如namedtuple等。</li></ul><p>参考: <a href="http://www.zlovezl.cn/articles/collections-in-python/" target="_blank" rel="noopener">http://www.zlovezl.cn/articles/collections-in-python/</a></p><ul><li>collections.namedtuple(): 构建一个可以用名称取值的tuple，例如：</li></ul><pre class=" language-python"><code class="language-python">Point <span class="token operator">=</span> collections<span class="token punctuation">.</span>namedtuple<span class="token punctuation">(</span><span class="token string">'Point'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'x'</span><span class="token punctuation">,</span> <span class="token string">'y'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>point <span class="token operator">=</span> Point<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>point<span class="token punctuation">.</span>x<span class="token punctuation">)</span></code></pre><p>参考: <a href="http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001411031239400f7181f65f33a4623bc42276a605debf6000" target="_blank" rel="noopener">http://www.liaoxuefeng.com/wiki/001374738125095c955c1e6d8bb493182103fac9270762a000/001411031239400f7181f65f33a4623bc42276a605debf6000</a></p><ul><li>例子1-1：</li></ul><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> collectionsCard <span class="token operator">=</span> collections<span class="token punctuation">.</span>namedtuple<span class="token punctuation">(</span><span class="token string">'Card'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'rank'</span><span class="token punctuation">,</span> <span class="token string">'suit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">class</span> <span class="token class-name">FrenchDeck</span><span class="token punctuation">:</span>    ranks <span class="token operator">=</span> <span class="token punctuation">[</span>str<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> list<span class="token punctuation">(</span><span class="token string">'JQKA'</span><span class="token punctuation">)</span>    suits <span class="token operator">=</span> <span class="token string">'spades diamonds clubs hearts'</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        self<span class="token punctuation">.</span>_cards <span class="token operator">=</span> <span class="token punctuation">[</span>Card<span class="token punctuation">(</span>rank<span class="token punctuation">,</span> suit<span class="token punctuation">)</span> <span class="token keyword">for</span> suit <span class="token keyword">in</span> self<span class="token punctuation">.</span>suits <span class="token keyword">for</span> rank <span class="token keyword">in</span> self<span class="token punctuation">.</span>ranks<span class="token punctuation">]</span>    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> len<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_cards<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> position<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_cards<span class="token punctuation">[</span>position<span class="token punctuation">]</span></code></pre><p>其中，使用collections.namedtuple建立了一张扑克牌的模型，FrenchDeck则建立了所有的扑克牌。<br>此时在Python shell中输入：</p><pre><code>&gt;&gt;&gt; deck[3]</code></pre><p>会得到如下结果：</p><pre><code>Card(rank=&#39;K&#39;, suit=&#39;hearts&#39;)</code></pre><p>这是由<code>__getitem__</code>方法提供的。</p><ul><li>对于Python数据模型来说，special method 的优点：<ol><li>统一标准操作（例如，用户不需要记住每种数据模型对应的获取长度的方法是<code>.size()</code>还是<code>.length()</code>）。</li><li>通过提供统一的special method，可以丰富Python标准库（例如上述的random.rich），也可以支持Python中包含的运算符操作（例如FrenchDeck支持迭代，也支持[]操作符）。</li></ol></li><li>使用<code>in</code>操作时，如果数据模型没有实现<code>__contains__</code>方法，Python会进行顺序扫描。</li><li>目前的<code>_cards</code>中扑克牌序列是不能被打乱的，在Chapter 11中会介绍<code>__setitem__</code>方法来实现。</li></ul>]]></content>
      
      
      <categories>
          
          <category> Python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
            <tag> Python </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
